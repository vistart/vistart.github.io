<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­‰é¢æœ¬æ¯è¿˜æ¬¾è®¡ç®—å™¨ - æ•°å­¦åˆ†æ</title>
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 24px;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 32px;
            margin-bottom: 24px;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .header-icon {
            font-size: 32px;
        }
        
        h1 {
            font-size: 30px;
            font-weight: bold;
            color: #1f2937;
        }
        
        h2 {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 16px;
        }
        
        h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .formula-section {
            background: #eef2ff;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .formula-title {
            font-size: 20px;
            font-weight: 600;
            color: #312e81;
            margin-bottom: 16px;
        }
        
        .formula-box {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
            margin-bottom: 16px;
        }
        
        .formula-content {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            margin: 8px 0;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .stat-card {
            border-radius: 8px;
            padding: 16px;
            color: white;
        }
        
        .stat-card-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .stat-card-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-card-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .stat-card-purple { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-extra {
            font-size: 12px;
            opacity: 0.75;
            margin-top: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead {
            background: #f3f4f6;
        }
        
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
        }
        
        th:not(:first-child) {
            text-align: right;
        }
        
        td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td:not(:first-child) {
            text-align: right;
        }
        
        tbody tr:hover {
            background: #f9fafb;
        }
        
        .info-box {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .info-box-blue {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
        }
        
        .info-box-amber {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
        }
        
        .info-box-red {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        
        .info-box-green {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
        }
        
        .info-box-purple {
            background: #faf5ff;
            border-left: 4px solid #a855f7;
        }
        
        .border-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid;
        }
        
        .border-blue { border-color: #93c5fd; }
        .border-green { border-color: #86efac; }
        .border-purple { border-color: #d8b4fe; }
        
        .comparison-card {
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .comparison-green {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #10b981;
        }
        
        .comparison-yellow {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #f59e0b;
        }
        
        .comparison-red {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #ef4444;
        }
        
        .chart-container {
            position: relative;
            height: 450px;
            margin-bottom: 24px;
        }
        
        .chart-container-small {
            position: relative;
            height: 350px;
            margin-bottom: 24px;
        }
        
        .chart-container-medium {
            position: relative;
            height: 400px;
            margin-bottom: 24px;
        }
        
        ul {
            list-style: none;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .text-sm { font-size: 14px; }
        .text-xs { font-size: 12px; }
        .text-gray-700 { color: #374151; }
        .text-gray-600 { color: #4b5563; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-mono { font-family: 'Courier New', monospace; }
        
        @media (max-width: 768px) {
            body { padding: 12px; }
            .card { padding: 16px; }
            h1 { font-size: 24px; }
            h2 { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <div class="header-icon">ğŸ§®</div>
                <h1>ç­‰é¢æœ¬æ¯è¿˜æ¬¾è®¡ç®—å™¨</h1>
            </div>
            
            <div class="formula-section">
                <div class="formula-title">æ•°å­¦æ¨¡å‹ï¼ˆç¦»æ•£å‡½æ•°ï¼‰</div>
                <div id="formulas"></div>
            </div>
            
            <div class="grid-3">
                <div class="input-group">
                    <label>è´·æ¬¾æœ¬é‡‘ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="principal" value="1000000">
                </div>
                <div class="input-group">
                    <label>å¹´åˆ©ç‡ï¼ˆ%ï¼‰</label>
                    <input type="number" step="0.01" id="annualRate" value="5.0">
                </div>
                <div class="input-group">
                    <label>è´·æ¬¾æœˆæ•°</label>
                    <input type="number" id="months" value="360">
                </div>
            </div>
            
            <div class="grid-4">
                <div class="stat-card stat-card-blue">
                    <div class="stat-label">æ¯æœˆè¿˜æ¬¾é¢</div>
                    <div class="stat-value" id="monthlyPayment">Â¥0.00</div>
                </div>
                <div class="stat-card stat-card-green">
                    <div class="stat-label">æ€»è¿˜æ¬¾é¢</div>
                    <div class="stat-value" id="totalPayment">Â¥0.00</div>
                </div>
                <div class="stat-card stat-card-orange">
                    <div class="stat-label">æ€»åˆ©æ¯</div>
                    <div class="stat-value" id="totalInterest">Â¥0.00</div>
                </div>
                <div class="stat-card stat-card-purple">
                    <div class="stat-label">æœ€åä¸€æœŸè¿˜æ¬¾</div>
                    <div class="stat-value" id="lastPayment">Â¥0.00</div>
                    <div class="stat-extra" id="lastPaymentDiff">å·®å¼‚: Â¥0.00</div>
                </div>
            </div>
            
            <div>
                <h3>è¿˜æ¬¾æ˜ç»†ï¼ˆå‰12æœŸï¼‰</h3>
                <div style="overflow-x: auto;">
                    <table id="scheduleTable"></table>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>ç¦»æ•£å‡½æ•° vs è¿ç»­è¿‘ä¼¼</h2>
            <div class="info-box info-box-blue">
                <p class="text-sm font-semibold" style="margin-bottom: 8px;" id="chartDescription"></p>
                <div class="text-xs text-gray-600">
                    <p>â€¢ æ©™è‰²å®çº¿ï¼šç¦»æ•£å…¬å¼ï¼ˆè™½ç„¶æ•°å­¦ä¸Šå¯å¯¹å®æ•°næ±‚å€¼ï¼Œä½†å®é™…åªåœ¨æ•´æ•°ç‚¹æœ‰æ„ä¹‰ï¼‰</p>
                    <p>â€¢ è“è‰²è™šçº¿ï¼šæŒ‡æ•°è¿‘ä¼¼ (1+Î±)^n â‰ˆ e^(Î±n)</p>
                    <p>â€¢ ç»¿è‰²ç‚¹çº¿ï¼šè¿ç»­è¿˜æ¬¾æ¨¡å‹</p>
                    <p>â€¢ æ©™è‰²æ•£ç‚¹ï¼šå®é™…åº”ç”¨ä¸­çš„ç¦»æ•£ç‚¹ï¼ˆæ•´æ•°æœˆï¼‰</p>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>æŒ‡æ•°è¿‘ä¼¼çš„ç›¸å¯¹è¯¯å·®</h2>
            <div class="info-box info-box-amber">
                <p class="text-sm">ç›¸å¯¹è¯¯å·® = (ç¦»æ•£å…¬å¼ - æŒ‡æ•°è¿‘ä¼¼) / ç¦»æ•£å…¬å¼ Ã— 100%</p>
                <p class="text-xs text-gray-600" style="margin-top: 8px;">
                    è¯¯å·®éå¸¸å°ï¼ˆå°äº 0.3%ï¼‰ï¼Œè¯´æ˜æŒ‡æ•°è¿‘ä¼¼ e^(Î±n) éå¸¸å‡†ç¡®ï¼Œè¿™è¯æ˜äº†ç­‰é¢æœ¬æ¯å…¬å¼ä¸è‡ªç„¶å¯¹æ•°åº• e çš„æ·±åˆ»è”ç³»ã€‚
                </p>
            </div>
            <div class="chart-container-small">
                <canvas id="errorChart"></canvas>
            </div>
            
            <div style="margin-top: 24px;">
                <h3>å…³é”®æœŸæ•°çš„æ•°å€¼å¯¹æ¯”</h3>
                <div style="overflow-x: auto;">
                    <table id="comparisonTable"></table>
                </div>
            </div>
            
            <div class="info-box info-box-green" style="margin-top: 24px;">
                <p class="text-sm font-semibold" style="margin-bottom: 8px;">âœ… ç»“è®º</p>
                <ul class="text-sm text-gray-700">
                    <li>â€¢ ç­‰é¢æœ¬æ¯å…¬å¼è™½ç„¶åœ¨å®é™…ä¸­æ˜¯<strong>ç¦»æ•£çš„</strong>ï¼ˆæ•´æ•°æœˆï¼‰ï¼Œä½†æ•°å­¦ä¸Šæ˜¯å…³äºå®æ•° n çš„<strong>è¿ç»­å‡½æ•°</strong></li>
                    <li>â€¢ å½“ Î± è¾ƒå°æ—¶ï¼Œ(1+Î±)^n â‰ˆ e^(Î±n) çš„è¿‘ä¼¼éå¸¸ç²¾ç¡®ï¼ˆè¯¯å·®å°äº 0.3%ï¼‰</li>
                    <li>â€¢ è¿™è¯´æ˜æŒ‰æ­è´·æ¬¾å…¬å¼ä¸è‡ªç„¶å¯¹æ•°åº• e æœ‰<strong>æ·±åˆ»çš„å†…åœ¨è”ç³»</strong></li>
                    <li>â€¢ è¿ç»­è¿˜æ¬¾æ¨¡å‹ä¸æŒ‡æ•°è¿‘ä¼¼åœ¨æ•°å€¼ä¸Šå‡ ä¹ä¸€è‡´ï¼Œè¯æ˜äº†ç¦»æ•£å¤åˆ©ä¸è¿ç»­å¤åˆ©çš„ç­‰ä»·æ€§</li>
                </ul>
            </div>
        </div>
        
        <div class="card">
            <h2>è¾¹é™…æ•ˆç›Šé€’å‡åˆ†æï¼šä¸ºä½•é•¿æœŸè´·æ¬¾æˆä¸º"æ°¸ç»­å€º"</h2>
            <div class="info-box info-box-red">
                <p class="font-semibold text-sm" style="margin-bottom: 8px;">æ ¸å¿ƒæ´å¯Ÿ</p>
                <p class="text-sm text-gray-700">
                    ä»å‡½æ•°æ›²çº¿å¯ä»¥çœ‹å‡ºï¼Œéšç€è´·æ¬¾æœŸé™å¢åŠ ï¼Œ<strong>æ¯å¢åŠ ä¸€å¹´æœŸé™ï¼Œæœˆä¾›å‡å°‘çš„å¹…åº¦è¶Šæ¥è¶Šå°</strong>ã€‚
                    è¿™æ„å‘³ç€ï¼šå»¶é•¿è´·æ¬¾æœŸé™çš„è¾¹é™…æ”¶ç›Šé€’å‡ï¼Œè¶…è¿‡30å¹´åå‡ ä¹æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œåè€Œä½¿è´·æ¬¾æˆä¸º"æ°¸ç»­å€º"ã€‚
                </p>
            </div>
            
            <div class="grid-2">
                <div class="info-box info-box-blue">
                    <h3 style="color: #1e40af;">å˜åŒ–ç‡å¯¹æ¯”ï¼ˆå•ä½æœ¬é‡‘ P=1ï¼‰</h3>
                    <div id="derivativeStats"></div>
                </div>
                
                <div class="info-box info-box-amber">
                    <h3 style="color: #92400e;">å®é™…å«ä¹‰è§£è¯»</h3>
                    <ul class="text-sm text-gray-700">
                        <li style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <span style="color: #059669; font-weight: bold;">âœ“</span>
                            <span><strong>5-15å¹´ï¼š</strong>æ¯å¢åŠ 1å¹´æœŸé™ï¼Œæœˆä¾›æ˜¾è‘—é™ä½ï¼Œå€¼å¾—è€ƒè™‘</span>
                        </li>
                        <li style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <span style="color: #d97706; font-weight: bold;">â–²</span>
                            <span><strong>15-30å¹´ï¼š</strong>æœˆä¾›ç»§ç»­é™ä½ï¼Œä½†å¹…åº¦å¼€å§‹å‡ç¼“</span>
                        </li>
                        <li style="display: flex; gap: 8px;">
                            <span style="color: #dc2626; font-weight: bold;">âœ—</span>
                            <span><strong>30å¹´ä»¥ä¸Šï¼š</strong>æœˆä¾›å‡ ä¹ä¸å†é™ä½ï¼Œä½†æ€»åˆ©æ¯æŒç»­æ¿€å¢ï¼Œæˆä¸º"æ°¸ç»­å€º"</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="chart-container-medium">
                <canvas id="derivativeChart"></canvas>
            </div>
            
            <div class="grid-3" style="margin-top: 24px;">
                <div class="comparison-card comparison-green" id="comparison1020"></div>
                <div class="comparison-card comparison-yellow" id="comparison2030"></div>
                <div class="comparison-card comparison-red" id="comparison3040"></div>
            </div>
            
            <div class="info-box info-box-purple" style="margin-top: 24px;" id="mathExplanation"></div>
        </div>
    </div>

    <script>
        // è®¡ç®—å‡½æ•°
        function calculateDiscretePayment(P, yearRate, n) {
            const alpha = yearRate / 100 / 12;
            if (alpha === 0) return P / n;
            if (n === 0) return Infinity;
            return P * alpha * Math.pow(1 + alpha, n) / (Math.pow(1 + alpha, n) - 1);
        }

        function calculateExponentialApprox(P, yearRate, n) {
            const alpha = yearRate / 100 / 12;
            if (alpha === 0) return P / n;
            if (n === 0) return Infinity;
            return P * alpha * Math.exp(alpha * n) / (Math.exp(alpha * n) - 1);
        }

        function calculateContinuousPayment(P, yearRate, n) {
            const alpha = yearRate / 100 / 12;
            if (alpha === 0) return P / n;
            if (n === 0) return Infinity;
            return P * alpha / (1 - Math.exp(-alpha * n));
        }

        // æ¸²æŸ“LaTeX
        function renderLatex(element, latex, displayMode = false) {
            if (window.katex) {
                katex.render(latex, element, { throwOnError: false, displayMode });
            } else {
                element.textContent = latex;
            }
        }

        // å…¨å±€å˜é‡
        let comparisonChart, errorChart, derivativeChart;

        // åˆå§‹åŒ–
        function init() {
            renderFormulas();
            calculate();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById('principal').addEventListener('input', calculate);
            document.getElementById('annualRate').addEventListener('input', calculate);
            document.getElementById('months').addEventListener('input', calculate);
        }

        function renderFormulas() {
            const container = document.getElementById('formulas');
            container.innerHTML = `
                <div class="formula-box">
                    <p class="text-sm text-gray-600" style="margin-bottom: 8px;">ç­‰é¢æœ¬æ¯æœˆä¾›å…¬å¼ï¼ˆç¦»æ•£ï¼‰ï¼š</p>
                    <div class="formula-content" id="mainFormula"></div>
                    <div class="text-sm text-gray-600" style="margin-top: 12px;">
                        <p>å…¶ä¸­ï¼š<span id="vars"></span></p>
                        <p style="color: #1d4ed8; font-weight: 500; margin-top: 8px;">
                            æ³¨æ„ï¼šè™½ç„¶æ•°å­¦ä¸Šè¯¥å¼å¯¹å®æ•°næœ‰å®šä¹‰ï¼Œä½†å®é™…åº”ç”¨ä¸­nå¿…é¡»ä¸ºæ­£æ•´æ•°ï¼ˆæœˆæ•°ï¼‰
                        </p>
                    </div>
                </div>
                <div class="grid-3">
                    <div class="border-card border-blue">
                        <p class="font-semibold" style="color: #1e40af; margin-bottom: 8px;">æŒ‡æ•°è¿‘ä¼¼ï¼š</p>
                        <div class="text-sm" style="text-align: center;">
                            <div id="expApprox"></div>
                            <p class="text-gray-600" style="margin-top: 8px;">å½“Î±è¾ƒå°æ—¶</p>
                        </div>
                    </div>
                    <div class="border-card border-green">
                        <p class="font-semibold" style="color: #047857; margin-bottom: 8px;">è¿ç»­è¿˜æ¬¾æ¨¡å‹ï¼š</p>
                        <div class="text-sm" style="text-align: center;">
                            <div id="contModel"></div>
                            <p class="text-gray-600" style="margin-top: 8px;">ç†æƒ³åŒ–è¿ç»­å¿è¿˜</p>
                        </div>
                    </div>
                    <div class="border-card border-purple">
                        <p class="font-semibold" style="color: #7c3aed; margin-bottom: 8px;">æ¸è¿‘çº¿ï¼š</p>
                        <div class="text-sm" style="text-align: center;">
                            <div id="asymptote"></div>
                            <p class="text-gray-600" style="margin-top: 8px;">æ°¸ç»­å¹´é‡‘ï¼ˆåªè¿˜åˆ©æ¯ï¼‰</p>
                        </div>
                    </div>
                </div>
            `;
            
            renderLatex(document.getElementById('mainFormula'), 'M = P \\cdot \\frac{\\alpha (1+\\alpha)^n}{(1+\\alpha)^n - 1}', true);
            
            const varsSpan = document.createElement('span');
            renderLatex(varsSpan, 'P');
            const varsText = ' = æœ¬é‡‘ï¼Œ';
            const alphaSpan = document.createElement('span');
            renderLatex(alphaSpan, '\\alpha = r/12');
            const varsText2 = ' = æœˆåˆ©ç‡ï¼Œ';
            const nSpan = document.createElement('span');
            renderLatex(nSpan, 'n');
            const varsText3 = ' = è¿˜æ¬¾æœˆæ•°ï¼ˆæ•´æ•°ï¼‰';
            
            const varsContainer = document.getElementById('vars');
            varsContainer.appendChild(varsSpan);
            varsContainer.appendChild(document.createTextNode(varsText));
            varsContainer.appendChild(alphaSpan);
            varsContainer.appendChild(document.createTextNode(varsText2));
            varsContainer.appendChild(nSpan);
            varsContainer.appendChild(document.createTextNode(varsText3));
            
            renderLatex(document.getElementById('expApprox'), '(1+\\alpha)^n \\approx e^{\\alpha n}', true);
            renderLatex(document.getElementById('contModel'), 'M_c = P \\cdot \\frac{\\alpha}{1 - e^{-\\alpha n}}', true);
            renderLatex(document.getElementById('asymptote'), '\\lim_{n \\to \\infty} M = P \\cdot \\alpha', true);
        }

        function calculate() {
            const principal = Number(document.getElementById('principal').value);
            const annualRate = Number(document.getElementById('annualRate').value);
            const months = Number(document.getElementById('months').value);
            const alpha = annualRate / 100 / 12;
            
            // è®¡ç®—è¿˜æ¬¾æ•°æ®
            const monthlyPayment = calculateDiscretePayment(principal, annualRate, months);
            const totalPayment = monthlyPayment * months;
            const totalInterest = totalPayment - principal;
            
            // è®¡ç®—æœ€åä¸€æœŸ
            const lastPeriodPrincipal = principal * Math.pow(1 + alpha, months - 1) - 
                monthlyPayment * (Math.pow(1 + alpha, months - 1) - 1) / alpha;
            const lastPayment = lastPeriodPrincipal * (1 + alpha);
            
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('monthlyPayment').textContent = 'Â¥' + monthlyPayment.toFixed(2);
            document.getElementById('totalPayment').textContent = 'Â¥' + totalPayment.toFixed(2);
            document.getElementById('totalInterest').textContent = 'Â¥' + totalInterest.toFixed(2);
            document.getElementById('lastPayment').textContent = 'Â¥' + lastPayment.toFixed(2);
            document.getElementById('lastPaymentDiff').textContent = 'å·®å¼‚: Â¥' + (lastPayment - monthlyPayment).toFixed(2);
            
            // ç”Ÿæˆè¿˜æ¬¾æ˜ç»†è¡¨
            generateScheduleTable(principal, annualRate, months);
            
            // æ›´æ–°å›¾è¡¨æè¿°
            document.getElementById('chartDescription').textContent = 
                `å›¾è¡¨è¯´æ˜ï¼šæœ¬é‡‘æ ‡å‡†åŒ–ä¸º P=1ï¼Œå¹´åˆ©ç‡ r=${annualRate}%ï¼ˆæœˆåˆ©ç‡ Î±=${alpha.toFixed(6)}ï¼‰`;
            
            // ç”Ÿæˆå›¾è¡¨
            generateComparisonChart(annualRate, alpha);
            generateErrorChart(annualRate);
            generateComparisonTable(annualRate);
            generateDerivativeChart(annualRate);
            generateComparisonCards(principal, annualRate);
            generateMathExplanation(alpha);
        }

        function generateScheduleTable(principal, annualRate, months) {
            const alpha = annualRate / 100 / 12;
            const M = calculateDiscretePayment(principal, annualRate, months);
            let remainingPrincipal = principal;
            
            let html = '<thead><tr><th>æœŸæ•°</th><th>è¿˜æ¬¾é¢</th><th>æœ¬é‡‘</th><th>åˆ©æ¯</th><th>å‰©ä½™æœ¬é‡‘</th></tr></thead><tbody>';
            
            for (let i = 1; i <= Math.min(12, months); i++) {
                const interestPayment = remainingPrincipal * alpha;
                let principalPayment = M - interestPayment;
                
                if (i === months) {
                    principalPayment = remainingPrincipal;
                    const actualPayment = principalPayment + interestPayment;
                    html += `<tr>
                        <td>${i}</td>
                        <td>Â¥${actualPayment.toFixed(2)}</td>
                        <td>Â¥${principalPayment.toFixed(2)}</td>
                        <td>Â¥${interestPayment.toFixed(2)}</td>
                        <td>Â¥0.00</td>
                    </tr>`;
                } else {
                    remainingPrincipal -= principalPayment;
                    html += `<tr>
                        <td>${i}</td>
                        <td>Â¥${M.toFixed(2)}</td>
                        <td>Â¥${principalPayment.toFixed(2)}</td>
                        <td>Â¥${interestPayment.toFixed(2)}</td>
                        <td>Â¥${remainingPrincipal.toFixed(2)}</td>
                    </tr>`;
                }
            }
            
            html += '</tbody>';
            document.getElementById('scheduleTable').innerHTML = html;
        }

        function generateComparisonChart(annualRate, alpha) {
            const data = [];
            const labels = [];
            const discreteData = [];
            const exponentialData = [];
            const continuousData = [];
            const scatterData = [];
            
            for (let n = 0.5; n <= 400; n += 0.5) {
                labels.push(n);
                discreteData.push(calculateDiscretePayment(1, annualRate, n));
                exponentialData.push(calculateExponentialApprox(1, annualRate, n));
                continuousData.push(calculateContinuousPayment(1, annualRate, n));
            }
            
            for (let n = 1; n <= 400; n += 6) {
                scatterData.push({ x: n, y: calculateDiscretePayment(1, annualRate, n) });
            }
            
            const ctx = document.getElementById('comparisonChart');
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ç¦»æ•£å…¬å¼ï¼ˆå®æ•°nï¼‰',
                            data: discreteData,
                            borderColor: '#f97316',
                            borderWidth: 2.5,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'æŒ‡æ•°è¿‘ä¼¼ e^(Î±n)',
                            data: exponentialData,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'è¿ç»­è¿˜æ¬¾æ¨¡å‹',
                            data: continuousData,
                            borderColor: '#10b981',
                            borderWidth: 1.5,
                            borderDash: [3, 3],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            type: 'scatter',
                            label: 'ç¦»æ•£ç‚¹ï¼ˆæ•´æ•°æœˆï¼‰',
                            data: scatterData,
                            backgroundColor: '#f97316',
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: alpha,
                                    yMax: alpha,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: `æ¸è¿‘çº¿ M = Î± = ${alpha.toFixed(6)}`,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'è´·æ¬¾æœŸé™ n (æœˆ)'
                            },
                            min: 0,
                            max: 400
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æœˆä¾›é¢ï¼ˆå•ä½æœ¬é‡‘ï¼‰'
                            },
                            min: 0
                        }
                    }
                }
            });
        }

        function generateErrorChart(annualRate) {
            const labels = [];
            const errorData = [];
            
            for (let n = 1; n <= 400; n++) {
                labels.push(n);
                const discrete = calculateDiscretePayment(1, annualRate, n);
                const exponential = calculateExponentialApprox(1, annualRate, n);
                errorData.push(((discrete - exponential) / discrete) * 100);
            }
            
            const ctx = document.getElementById('errorChart');
            
            if (errorChart) {
                errorChart.destroy();
            }
            
            errorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç›¸å¯¹è¯¯å·®',
                        data: errorData,
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'è´·æ¬¾æœŸé™ n (æœˆ)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ç›¸å¯¹è¯¯å·® (%)'
                            }
                        }
                    }
                }
            });
        }

        function generateComparisonTable(annualRate) {
            let html = '<thead><tr><th>æœŸæ•° n</th><th>ç¦»æ•£å…¬å¼</th><th>æŒ‡æ•°è¿‘ä¼¼</th><th>è¿ç»­æ¨¡å‹</th><th>ç›¸å¯¹è¯¯å·®</th></tr></thead><tbody>';
            
            [12, 60, 120, 240, 360].forEach(n => {
                const discrete = calculateDiscretePayment(1, annualRate, n);
                const exponential = calculateExponentialApprox(1, annualRate, n);
                const continuous = calculateContinuousPayment(1, annualRate, n);
                const error = ((discrete - exponential) / discrete * 100);
                
                html += `<tr>
                    <td>${n} (${(n/12).toFixed(1)}å¹´)</td>
                    <td class="font-mono">${discrete.toFixed(6)}</td>
                    <td class="font-mono">${exponential.toFixed(6)}</td>
                    <td class="font-mono">${continuous.toFixed(6)}</td>
                    <td class="font-mono" style="color: #ea580c;">${error.toFixed(4)}%</td>
                </tr>`;
            });
            
            html += '</tbody>';
            document.getElementById('comparisonTable').innerHTML = html;
        }

        function generateDerivativeChart(annualRate) {
            const labels = [];
            const derivativeData = [];
            const yearlyData = [];
            
            for (let years = 5; years <= 50; years++) {
                const n = years * 12;
                const M_current = calculateExponentialApprox(1, annualRate, n);
                const M_next = calculateExponentialApprox(1, annualRate, n + 12);
                const derivative = Math.abs((M_current - M_next) * 1000);
                
                labels.push(years);
                derivativeData.push(derivative);
                yearlyData.push({ years, derivative });
            }
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const range1 = yearlyData.filter(d => d.years >= 5 && d.years <= 30);
            const range2 = yearlyData.filter(d => d.years > 30);
            const avgDerivative1 = range1.reduce((sum, d) => sum + d.derivative, 0) / range1.length;
            const avgDerivative2 = range2.reduce((sum, d) => sum + d.derivative, 0) / range2.length;
            const ratio = avgDerivative1 / avgDerivative2;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('derivativeStats').innerHTML = `
                <div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-bottom: 8px;">
                        <span class="text-sm">5-30å¹´å¹³å‡å˜åŒ–ç‡ï¼š</span>
                        <span class="font-mono font-bold" style="color: #2563eb;">${avgDerivative1.toFixed(6)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-bottom: 8px;">
                        <span class="text-sm">30-50å¹´å¹³å‡å˜åŒ–ç‡ï¼š</span>
                        <span class="font-mono font-bold" style="color: #ea580c;">${avgDerivative2.toFixed(6)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: linear-gradient(to right, #fef3c7, #fde68a); border-radius: 4px; border: 1px solid #fbbf24;">
                        <span class="font-semibold text-sm">è¡°å‡æ¯”ä¾‹ï¼š</span>
                        <span class="font-mono font-bold" style="color: #b91c1c;">${ratio.toFixed(2)}å€</span>
                    </div>
                </div>
                <p class="text-xs text-gray-600" style="margin-top: 12px;">
                    å‰æœŸå˜åŒ–ç‡æ˜¯åæœŸçš„ <strong>${ratio.toFixed(1)}å€</strong>ï¼Œè¯´æ˜å‰30å¹´å»¶é•¿æœŸé™çš„æ•ˆæœè¿œå¥½äº30å¹´åã€‚
                </p>
            `;
            
            const ctx = document.getElementById('derivativeChart');
            
            if (derivativeChart) {
                derivativeChart.destroy();
            }
            
            derivativeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å˜åŒ–ç‡ |dM/d(å¹´)|',
                        data: derivativeData,
                        borderColor: '#8b5cf6',
                        borderWidth: 3,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    xMin: 30,
                                    xMax: 30,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: '30å¹´åˆ†ç•Œçº¿',
                                        position: 'start'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'è´·æ¬¾æœŸé™ï¼ˆå¹´ï¼‰'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æ¯å¢åŠ 1å¹´ï¼Œæœˆä¾›å‡å°‘é¢ (Ã—1000)'
                            }
                        }
                    }
                }
            });
        }

        function generateComparisonCards(principal, annualRate) {
            const p1020 = calculateExponentialApprox(principal, annualRate, 120);
            const p2030 = calculateExponentialApprox(principal, annualRate, 240);
            const p3040a = calculateExponentialApprox(principal, annualRate, 360);
            const p3040b = calculateExponentialApprox(principal, annualRate, 480);
            
            document.getElementById('comparison1020').innerHTML = `
                <p class="text-sm font-semibold" style="color: #065f46; margin-bottom: 8px;">ğŸ“Š 10å¹´ â†’ 20å¹´</p>
                <p class="text-xs text-gray-700">
                    æœˆä¾›ä» ${p1020.toFixed(2)} å…ƒé™è‡³ ${p2030.toFixed(2)} å…ƒ
                </p>
                <p class="font-bold" style="color: #047857; font-size: 18px; margin-top: 8px;">
                    å‡å°‘ ${(p1020 - p2030).toFixed(2)} å…ƒ
                </p>
            `;
            
            document.getElementById('comparison2030').innerHTML = `
                <p class="text-sm font-semibold" style="color: #92400e; margin-bottom: 8px;">ğŸ“Š 20å¹´ â†’ 30å¹´</p>
                <p class="text-xs text-gray-700">
                    æœˆä¾›ä» ${p2030.toFixed(2)} å…ƒé™è‡³ ${p3040a.toFixed(2)} å…ƒ
                </p>
                <p class="font-bold" style="color: #b45309; font-size: 18px; margin-top: 8px;">
                    å‡å°‘ ${(p2030 - p3040a).toFixed(2)} å…ƒ
                </p>
            `;
            
            document.getElementById('comparison3040').innerHTML = `
                <p class="text-sm font-semibold" style="color: #991b1b; margin-bottom: 8px;">ğŸ“Š 30å¹´ â†’ 40å¹´</p>
                <p class="text-xs text-gray-700">
                    æœˆä¾›ä» ${p3040a.toFixed(2)} å…ƒé™è‡³ ${p3040b.toFixed(2)} å…ƒ
                </p>
                <p class="font-bold" style="color: #b91c1c; font-size: 18px; margin-top: 8px;">
                    ä»…å‡å°‘ ${(p3040a - p3040b).toFixed(2)} å…ƒ
                </p>
            `;
        }

        function generateMathExplanation(alpha) {
            const container = document.getElementById('mathExplanation');
            container.innerHTML = `
                <p class="font-semibold text-sm" style="margin-bottom: 8px;">ğŸ”¬ æ•°å­¦è§£é‡Š</p>
                <div class="text-sm text-gray-700">
                    <p>å¯¹äºå‡½æ•° <span id="func1"></span>ï¼Œå…¶å¯¼æ•°ä¸ºï¼š</p>
                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; margin: 8px 0;" id="derivative"></div>
                    <p>å½“ n å¢å¤§æ—¶ï¼Œ<span id="exp1"></span>ï¼Œå¯¼è‡´ <span id="exp2"></span>ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ›²çº¿è¶Šæ¥è¶Šå¹³ç¼“ï¼Œå»¶é•¿æœŸé™çš„æ•ˆæœè¶Šæ¥è¶Šå·®ã€‚</p>
                    <p style="color: #b91c1c; font-weight: 600; margin-top: 12px;">
                        ç»“è®ºï¼šè¶…è¿‡30å¹´çš„è´·æ¬¾ï¼Œæœˆä¾›è™½ç„¶ç•¥ä½ï¼Œä½†ç”±äºæœŸé™è¿‡é•¿ã€æ€»åˆ©æ¯å·¨å¤§ï¼Œå®è´¨ä¸Šå˜æˆäº†"æ°¸ç»­å€º"ï¼Œè´·æ¬¾äººå‡ ä¹ä¸€è¾ˆå­éƒ½åœ¨è¿˜åˆ©æ¯ã€‚
                    </p>
                </div>
            `;
            
            renderLatex(document.getElementById('func1'), 'M(n) = P \\cdot \\frac{\\alpha}{1 - e^{-\\alpha n}}');
            renderLatex(document.getElementById('derivative'), '\\frac{dM}{dn} = -P \\cdot \\frac{\\alpha^2 e^{-\\alpha n}}{(1 - e^{-\\alpha n})^2}', true);
            renderLatex(document.getElementById('exp1'), 'e^{-\\alpha n} \\to 0');
            renderLatex(document.getElementById('exp2'), '|dM/dn| \\to 0');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
