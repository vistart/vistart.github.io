<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CORS äº¤äº’å¼æ¼”ç¤º</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --indigo: #4f46e5;
      --indigo-600: #4f46e5;
      --indigo-500: #6366f1;
      --blue: #2563eb;
      --green: #16a34a;
      --red: #dc2626;
      --amber: #d97706;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #eef2ff 0%, #f8fafc 40%, #ffffff 100%);
      color: var(--text);
    }

    .page {
      min-height: 100vh;
      padding: 20px;
    }

    .wrap {
      max-width: 860px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin: 8px 0 18px;
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    .header p {
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--muted);
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .tab-btn {
      padding: 10px 0;
      font-size: 13px;
      font-weight: 600;
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: color 0.2s ease, border-color 0.2s ease;
    }
    .tab-btn.active {
      color: var(--indigo-600);
      border-bottom-color: var(--indigo-600);
    }

    .card {
      background: var(--panel);
      border: 1px solid #edf0f4;
      border-radius: 14px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .text-muted { color: var(--muted); }
    .text-xs { font-size: 12px; }
    .text-sm { font-size: 13px; }
    .text-lg { font-size: 18px; }
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: 700; }

    .code {
      font-family: var(--mono);
      background: #eef2ff;
      color: #3730a3;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .row {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
      background: #ffffff;
    }
    .row.hover-green { border-color: #86efac; background: #f0fdf4; }
    .row.hover-red { border-color: #fca5a5; background: #fef2f2; }

    .badge {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 999px;
      display: inline-block;
    }
    .badge-green { background: #dcfce7; color: #15803d; }
    .badge-red { background: #fee2e2; color: #b91c1c; }

    .note {
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #fde68a;
      background: #fffbeb;
    }

    .pill-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      background: #f3f4f6;
      color: #374151;
      transition: all 0.15s ease;
    }
    .pill.active { background: #2563eb; color: #fff; }

    .terminal {
      background: #0f172a;
      color: #86efac;
      padding: 14px;
      border-radius: 12px;
      font-family: var(--mono);
      font-size: 12px;
      margin: 12px 0;
    }
    .terminal .muted { color: #64748b; }
    .terminal .accent { color: #fbbf24; }

    .btn-primary {
      width: 100%;
      padding: 10px 12px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

    .result {
      margin-top: 12px;
      border-radius: 12px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      background: #f8fafc;
    }
    .result.success { border-color: #86efac; background: #f0fdf4; }
    .result.fail { border-color: #fca5a5; background: #fef2f2; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #dbeafe;
      color: #1d4ed8;
    }

    .code-block {
      background: #0f172a;
      color: #86efac;
      padding: 14px;
      border-radius: 12px;
      font-size: 12px;
      font-family: var(--mono);
      max-height: 260px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .progress {
      display: flex;
      align-items: center;
      gap: 4px;
      margin: 12px 0;
    }
    .progress .dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      background: #e5e7eb;
      color: #6b7280;
    }
    .progress .dot.active { background: var(--indigo); color: #fff; }
    .progress .bar {
      height: 2px;
      width: 24px;
      background: #e5e7eb;
    }
    .progress .bar.active { background: #818cf8; }

    .step {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .step.blue { background: #dbeafe; border-color: #93c5fd; color: #1e3a8a; }
    .step.yellow { background: #fef3c7; border-color: #fcd34d; color: #78350f; }
    .step.purple { background: #ede9fe; border-color: #c4b5fd; color: #4c1d95; }
    .step.green { background: #dcfce7; border-color: #86efac; color: #166534; }

    .footer {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin: 14px 0 8px;
    }

    @media (max-width: 720px) {
      .tabs { grid-template-columns: 1fr 1fr; }
      .grid-2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <div class="header">
        <h1>ğŸŒ æµè§ˆå™¨è·¨åŸŸé—®é¢˜</h1>
        <p>äº¤äº’å¼æ•™å­¦æ¼”ç¤º</p>
      </div>

      <div class="tabs" id="tabs"></div>

      <div class="card" id="content"></div>

      <div class="footer">æ¼”ç¤ºåŸŸå: rho.im / rho.social</div>
    </div>
  </div>

  <script>
    const TABS = ["åŸç†å›¾è§£", "å®æ—¶æ¼”ç¤º", "SSO æµç¨‹", "è§£å†³æ–¹æ¡ˆ"];

    const state = {
      activeTab: 0,
      originHover: null,
      live: {
        selectedApi: 0,
        loading: false,
        result: null,
      },
      sso: {
        mode: "cookie",
        step: 0,
      },
      solutions: {
        selected: 0,
      },
    };

    const originBaseUrl = "https://app.rho.im";
    const originExamples = [
      { url: "https://app.rho.im/api/data", same: true, reason: "åè®® âœ“ åŸŸå âœ“ ç«¯å£ âœ“" },
      { url: "http://app.rho.im/api", same: false, reason: "åè®®ä¸åŒ (http â‰  https)" },
      { url: "https://api.rho.im/data", same: false, reason: "å­åŸŸåä¸åŒ (api â‰  app)" },
      { url: "https://app.rho.social/page", same: false, reason: "åŸŸåä¸åŒ (rho.social â‰  rho.im)" },
      { url: "https://app.rho.im:8443/api", same: false, reason: "ç«¯å£ä¸åŒ (8443 â‰  443)" },
    ];

    const apis = [
      {
        name: "æ­£å¸¸åŒæºè¯·æ±‚",
        url: "https://jsonplaceholder.typicode.com/todos/1",
        desc: "ç›´æ¥è¯·æ±‚æœ‰ CORS å¤´çš„å…¬å¼€ APIï¼ˆæ¨¡æ‹ŸåŒæºï¼‰",
        expectSuccess: true,
      },
      {
        name: "è·¨åŸŸè¯·æ±‚ (æ—  CORS)",
        url: "https://www.google.com/",
        desc: "è¯·æ±‚æœªè®¾ç½® CORS å¤´çš„ç«™ç‚¹ â†’ è¢«æµè§ˆå™¨é˜»æ­¢",
        expectSuccess: false,
      },
      {
        name: "å¸¦é¢„æ£€çš„è¯·æ±‚",
        url: "https://jsonplaceholder.typicode.com/posts",
        desc: "POST + JSON Content-Type â†’ è§¦å‘ OPTIONS é¢„æ£€",
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: "test", body: "demo", userId: 1 }),
        expectSuccess: true,
      },
    ];

    const cookieSteps = [
      {
        title: "ç”¨æˆ·è®¿é—®åº”ç”¨",
        from: "ç”¨æˆ·", to: "app1.rho.im",
        desc: "ç”¨æˆ·è®¿é—® app1.rho.imï¼Œæ²¡æœ‰ç™»å½•æ€",
        detail: "æµè§ˆå™¨æ£€æŸ¥ Cookieï¼Œæ²¡æœ‰æ‰¾åˆ° domain=.rho.im çš„æœ‰æ•ˆ token",
        color: "blue",
      },
      {
        title: "é‡å®šå‘åˆ° SSO",
        from: "app1.rho.im", to: "sso.rho.im",
        desc: "302 é‡å®šå‘åˆ°è®¤è¯ä¸­å¿ƒ",
        detail: "Location: https://sso.rho.im/login?redirect=https://app1.rho.im/dashboard",
        color: "yellow",
      },
      {
        title: "ç”¨æˆ·ç™»å½•",
        from: "ç”¨æˆ·", to: "sso.rho.im",
        desc: "ç”¨æˆ·åœ¨ SSO é¡µé¢è¾“å…¥è´¦å·å¯†ç ",
        detail: "POST https://sso.rho.im/login { username, password }",
        color: "purple",
      },
      {
        title: "è®¾ç½®å…±äº« Cookie",
        from: "sso.rho.im", to: "æµè§ˆå™¨",
        desc: "SSO è®¾ç½® domain=.rho.im çš„ Cookie",
        detail: "Set-Cookie: token=eyJhbG...; Domain=.rho.im; Path=/; Secure; HttpOnly",
        color: "green",
      },
      {
        title: "å›åˆ°åº”ç”¨",
        from: "sso.rho.im", to: "app1.rho.im",
        desc: "é‡å®šå‘å›åŸåº”ç”¨ï¼ŒCookie è‡ªåŠ¨æºå¸¦",
        detail: "å› ä¸º Cookie çš„ Domain=.rho.imï¼Œæ‰€æœ‰ *.rho.im å­åŸŸéƒ½èƒ½è®¿é—®æ­¤ Cookie",
        color: "green",
      },
      {
        title: "è®¿é—®å¦ä¸€ä¸ªåº”ç”¨",
        from: "ç”¨æˆ·", to: "app2.rho.im",
        desc: "ç”¨æˆ·è®¿é—® app2.rho.imï¼Œè‡ªåŠ¨ç™»å½•ï¼",
        detail: "æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ domain=.rho.im çš„ Cookie â†’ æ— éœ€å†æ¬¡ç™»å½•",
        color: "green",
      },
    ];

    const oauthSteps = [
      {
        title: "ç”¨æˆ·è®¿é—®åº”ç”¨",
        from: "ç”¨æˆ·", to: "app.rho.social",
        desc: "ç”¨æˆ·è®¿é—® rho.social åŸŸä¸‹çš„åº”ç”¨",
        detail: "ä¸ rho.im å®Œå…¨ä¸åŒçš„åŸŸåï¼ŒCookie æ— æ³•å…±äº«",
        color: "blue",
      },
      {
        title: "é‡å®šå‘åˆ° SSO",
        from: "app.rho.social", to: "sso.rho.im",
        desc: "å¸¦ä¸Š redirect_uri å‚æ•°é‡å®šå‘",
        detail: "Location: https://sso.rho.im/authorize?client_id=social&redirect_uri=https://app.rho.social/callback",
        color: "yellow",
      },
      {
        title: "SSO éªŒè¯ç™»å½•æ€",
        from: "sso.rho.im", to: "sso.rho.im",
        desc: "SSO æ£€æŸ¥è‡ªå·±åŸŸä¸‹çš„ Cookie",
        detail: "ç”¨æˆ·ä¹‹å‰å·²åœ¨ sso.rho.im ç™»å½•è¿‡ â†’ æœ‰æœ‰æ•ˆ session â†’ æ— éœ€å†æ¬¡è¾“å…¥å¯†ç ",
        color: "purple",
      },
      {
        title: "ç”Ÿæˆæˆæƒç ",
        from: "sso.rho.im", to: "app.rho.social",
        desc: "é‡å®šå‘å›åº”ç”¨ï¼Œæºå¸¦ä¸€æ¬¡æ€§æˆæƒç ",
        detail: "Location: https://app.rho.social/callback?code=AUTHZ_CODE_7f3a9b",
        color: "yellow",
      },
      {
        title: "åç«¯æ¢ Token",
        from: "app.rho.social (åç«¯)", to: "sso.rho.im",
        desc: "åç«¯ç”¨æˆæƒç æ¢å– access_token",
        detail: "POST https://sso.rho.im/token { code, client_secret } â†’ åç«¯åˆ°åç«¯ï¼Œä¸å— CORS é™åˆ¶ï¼",
        color: "green",
      },
      {
        title: "ç™»å½•å®Œæˆ",
        from: "app.rho.social", to: "ç”¨æˆ·",
        desc: "åº”ç”¨è®¾ç½®è‡ªå·±åŸŸçš„ Cookieï¼Œç™»å½•æˆåŠŸ",
        detail: "Set-Cookie: session=xxx; Domain=app.rho.social; æ­¤åè¯¥åŸŸä¸‹çš„è¯·æ±‚éƒ½å¸¦æ­¤ Cookie",
        color: "green",
      },
    ];

    const solutions = [
      {
        name: "CORS å“åº”å¤´",
        difficulty: "â­â­",
        desc: "æœåŠ¡å™¨æ·»åŠ  Access-Control-Allow-Origin ç­‰å¤´",
        pros: ["æ ‡å‡†è§„èŒƒ", "çµæ´»æ§åˆ¶", "æ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³•"],
        cons: ["éœ€è¦ä¿®æ”¹æœåŠ¡ç«¯", "é…ç½®ä¸å½“ä¼šæœ‰å®‰å…¨é£é™©"],
        code: `// Express.js ç¤ºä¾‹\napp.use((req, res, next) => {\n  res.header('Access-Control-Allow-Origin',\n    'https://app.rho.im');\n  res.header('Access-Control-Allow-Methods',\n    'GET, POST, PUT, DELETE');\n  res.header('Access-Control-Allow-Headers',\n    'Content-Type, Authorization');\n  res.header('Access-Control-Allow-Credentials',\n    'true');\n  if (req.method === 'OPTIONS') {\n    return res.sendStatus(204);\n  }\n  next();\n});`,
        best: "å‰åç«¯åˆ†ç¦»çš„ API æœåŠ¡",
      },
      {
        name: "åå‘ä»£ç†",
        difficulty: "â­â­â­",
        desc: "é€šè¿‡ Nginx/ç½‘å…³å°†ä¸åŒæœåŠ¡ç»Ÿä¸€åˆ°åŒä¸€æº",
        pros: ["å‰ç«¯æ— æ„ŸçŸ¥", "æ— éœ€æ”¹ä¸šåŠ¡ä»£ç ", "ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ"],
        cons: ["éœ€è¦è¿ç»´é…ç½®", "å¢åŠ ç½‘ç»œé“¾è·¯"],
        code: `# Nginx é…ç½®\nserver {\n  server_name app.rho.im;\n  \n  location / {\n    root /var/www/frontend;\n    try_files $uri /index.html;\n  }\n  \n  location /api/ {\n    proxy_pass http://backend:3000/;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP\n      $remote_addr;\n  }\n}`,
        best: "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²",
      },
      {
        name: "postMessage",
        difficulty: "â­â­",
        desc: "çª—å£é—´å®‰å…¨é€šä¿¡ API",
        pros: ["å®˜æ–¹ API", "å®‰å…¨ï¼ˆå¯éªŒè¯æ¥æºï¼‰", "åŒå‘é€šä¿¡"],
        cons: ["ä»…é™çª—å£é—´é€šä¿¡", "éœ€è¦ä¸¤ç«¯é…åˆ"],
        code: `// å‘é€æ–¹ (app.rho.im)\nconst iframe = document\n  .getElementById('sso-frame');\niframe.contentWindow.postMessage(\n  { action: 'getToken' },\n  'https://sso.rho.social'\n);\n\n// æ¥æ”¶æ–¹ (sso.rho.social)\nwindow.addEventListener('message', (e) => {\n  if (e.origin !== 'https://app.rho.im')\n    return; // å®‰å…¨éªŒè¯ï¼\n  if (e.data.action === 'getToken') {\n    e.source.postMessage(\n      { token: '...' },\n      e.origin\n    );\n  }\n});`,
        best: "SSOã€iframe åµŒå…¥ã€å¾®å‰ç«¯",
      },
    ];

    function renderTabs() {
      const el = document.getElementById("tabs");
      el.innerHTML = "";
      TABS.forEach((name, i) => {
        const btn = document.createElement("button");
        btn.className = `tab-btn ${state.activeTab === i ? "active" : ""}`;
        btn.textContent = name;
        btn.addEventListener("click", () => {
          state.activeTab = i;
          renderApp();
        });
        el.appendChild(btn);
      });
    }

    function renderOriginExplainer() {
      const container = document.createElement("div");
      container.innerHTML = `
        <h3 class="text-lg font-semibold">åŒæºç­–ç•¥åˆ¤å®š</h3>
        <p class="text-sm text-muted">åŸºå‡†æºï¼š<span class="code">${originBaseUrl}</span></p>
      `;

      const list = document.createElement("div");
      list.className = "list";

      originExamples.forEach((ex, i) => {
        const parts = ex.url.match(/^(https?):\/\/([^:/]+):?(\d+)?(\/.*)?$/);
        const baseP = originBaseUrl.match(/^(https?):\/\/([^:/]+):?(\d+)?(\/.*)?$/);
        const protoDiff = parts[1] !== baseP[1];
        const hostDiff = parts[2] !== baseP[2];
        const portA = parts[3] || (parts[1] === "https" ? "443" : "80");
        const portB = baseP[3] || (baseP[1] === "https" ? "443" : "80");
        const portDiff = portA !== portB;

        const row = document.createElement("div");
        row.className = `row ${state.originHover === i ? (ex.same ? "hover-green" : "hover-red") : ""}`;
        row.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <code class="text-sm" style="font-family: var(--mono);">
              <span style="${protoDiff ? "background:#fecaca;padding:2px 4px;border-radius:4px;" : "color:#374151;"}">${parts[1]}://</span>
              <span style="${hostDiff ? "background:#fecaca;padding:2px 4px;border-radius:4px;" : "color:#374151;"}">${parts[2]}</span>
              ${parts[3] ? `<span style=\"${portDiff ? "background:#fecaca;padding:2px 4px;border-radius:4px;" : "color:#374151;"}\">:${parts[3]}</span>` : ""}
              <span style="color:#9ca3af;">${parts[4] || "/"}</span>
            </code>
            <span class="badge ${ex.same ? "badge-green" : "badge-red"}">${ex.same ? "âœ… åŒæº" : "âŒ è·¨åŸŸ"}</span>
          </div>
          ${state.originHover === i ? `<p class="text-xs text-muted" style="margin:6px 0 0;">${ex.reason}</p>` : ""}
        `;

        row.addEventListener("mouseenter", () => { state.originHover = i; renderApp(); });
        row.addEventListener("mouseleave", () => { state.originHover = null; renderApp(); });
        list.appendChild(row);
      });

      const note = document.createElement("div");
      note.className = "note";
      note.innerHTML = `
        <p class="text-sm font-semibold" style="margin:0 0 6px; color:#92400e;">âš ï¸ å…³é”®ç†è§£</p>
        <p class="text-sm" style="margin:0; color:#b45309;">
          åŒæºç­–ç•¥<strong>ä¸é˜»æ­¢è¯·æ±‚å‘å‡º</strong>ï¼Œè€Œæ˜¯<strong>é˜»æ­¢æµè§ˆå™¨è¯»å–å“åº”</strong>ã€‚
          æœåŠ¡å™¨å®é™…ä¸Šæ”¶åˆ°äº†è¯·æ±‚å¹¶è¿”å›äº†å“åº”â€”â€”æµè§ˆå™¨åªæ˜¯æ‹’ç»å°†å“åº”æš´éœ²ç»™ JavaScriptã€‚
        </p>
      `;

      container.appendChild(list);
      container.appendChild(note);
      return container;
    }

    function renderLiveDemo() {
      const container = document.createElement("div");
      const api = apis[state.live.selectedApi];

      container.innerHTML = `
        <h3 class="text-lg font-semibold">å®æ—¶è·¨åŸŸè¯·æ±‚æ¼”ç¤º</h3>
        <p class="text-xs text-muted">æç¤ºï¼šè¯·æ‰“å¼€æµè§ˆå™¨ DevToolsï¼ˆF12ï¼‰â†’ Network é¢æ¿è§‚å¯Ÿè¯·æ±‚è¯¦æƒ…</p>
      `;

      const pills = document.createElement("div");
      pills.className = "pill-group";
      apis.forEach((a, i) => {
        const btn = document.createElement("button");
        btn.className = `pill ${state.live.selectedApi === i ? "active" : ""}`;
        btn.textContent = a.name;
        btn.addEventListener("click", () => {
          state.live.selectedApi = i;
          state.live.result = null;
          renderApp();
        });
        pills.appendChild(btn);
      });

      const terminal = document.createElement("div");
      terminal.className = "terminal";
      terminal.innerHTML = `
        <div class="muted">// è¯·æ±‚è¯¦æƒ…</div>
        <div><span class="accent">${api.method || "GET"}</span> ${api.url}</div>
        ${api.headers ? `<div class="muted">Headers: ${JSON.stringify(api.headers)}</div>` : ""}
        <div class="muted" style="margin-top:6px;">// é¢„æœŸ: ${api.expectSuccess ? "âœ… æˆåŠŸ" : "âŒ CORS é”™è¯¯"}</div>
      `;

      const btn = document.createElement("button");
      btn.className = "btn-primary";
      btn.textContent = state.live.loading ? "è¯·æ±‚ä¸­..." : "â–¶ å‘é€è¯·æ±‚";
      btn.disabled = state.live.loading;
      btn.addEventListener("click", runRequest);

      container.appendChild(pills);
      container.appendChild(terminal);
      container.appendChild(btn);

      if (state.live.result) {
        const result = state.live.result;
        const box = document.createElement("div");
        box.className = `result ${result.success ? "success" : "fail"}`;
        box.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <span class="font-bold" style="color:${result.success ? "#15803d" : "#b91c1c"};">
              ${result.success ? "âœ… è¯·æ±‚æˆåŠŸ" : "âŒ è¯·æ±‚å¤±è´¥ï¼ˆCORS é˜»æ­¢ï¼‰"}
            </span>
            <span class="text-xs text-muted">${result.elapsed}ms</span>
          </div>
          ${result.success ? `
            <div class="text-sm" style="display:grid; gap:8px;">
              <div><strong>Status:</strong> ${result.status}</div>
              <div>
                <strong>å“åº”å¤´ (éƒ¨åˆ†):</strong>
                <pre class="code-block" style="background:#fff; color:#0f172a; max-height:120px;">${JSON.stringify(result.headers, null, 2)}</pre>
              </div>
              <div>
                <strong>å“åº”ä½“é¢„è§ˆ:</strong>
                <pre class="code-block" style="background:#fff; color:#0f172a; max-height:120px;">${result.bodyPreview}</pre>
              </div>
            </div>
          ` : `
            <div class="text-sm" style="display:grid; gap:8px;">
              <div style="color:#dc2626;"><strong>Error:</strong> ${result.error}</div>
              <div class="text-xs" style="background:#fff; padding:8px; border-radius:8px; color:#ef4444;">${result.explanation}</div>
            </div>
          `}
        `;
        container.appendChild(box);
      }

      return container;
    }

    async function runRequest() {
      const api = apis[state.live.selectedApi];
      state.live.loading = true;
      state.live.result = null;
      renderApp();

      const startTime = performance.now();

      try {
        const options = { method: api.method || "GET", mode: "cors" };
        if (api.headers) options.headers = api.headers;
        if (api.body) options.body = api.body;

        const response = await fetch(api.url, options);
        const data = await response.text();
        const elapsed = Math.round(performance.now() - startTime);

        state.live.result = {
          success: true,
          status: response.status,
          headers: Object.fromEntries([...response.headers.entries()].slice(0, 8)),
          bodyPreview: data.substring(0, 300),
          elapsed,
        };
      } catch (error) {
        const elapsed = Math.round(performance.now() - startTime);
        state.live.result = {
          success: false,
          error: error.message,
          elapsed,
          explanation: "æµè§ˆå™¨é˜»æ­¢äº†å“åº”çš„è¯»å–ã€‚æ‰“å¼€ DevTools â†’ Console å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„ CORS é”™è¯¯ä¿¡æ¯ã€‚",
        };
      } finally {
        state.live.loading = false;
        renderApp();
      }
    }

    function renderSSOFlow() {
      const container = document.createElement("div");
      const steps = state.sso.mode === "cookie" ? cookieSteps : oauthSteps;
      const step = steps[state.sso.step];

      container.innerHTML = `
        <h3 class="text-lg font-semibold">SSO å•ç‚¹ç™»å½•æµç¨‹</h3>
      `;

      const modeSwitch = document.createElement("div");
      modeSwitch.className = "pill-group";
      const cookieBtn = document.createElement("button");
      cookieBtn.className = `pill ${state.sso.mode === "cookie" ? "active" : ""}`;
      cookieBtn.textContent = "ğŸª å…±äº« Cookieï¼ˆåŒçˆ¶åŸŸï¼‰";
      cookieBtn.addEventListener("click", () => {
        state.sso.mode = "cookie";
        state.sso.step = 0;
        renderApp();
      });
      const oauthBtn = document.createElement("button");
      oauthBtn.className = `pill ${state.sso.mode === "oauth" ? "active" : ""}`;
      oauthBtn.textContent = "ğŸ”‘ OAuth æˆæƒç ï¼ˆè·¨åŸŸï¼‰";
      oauthBtn.addEventListener("click", () => {
        state.sso.mode = "oauth";
        state.sso.step = 0;
        renderApp();
      });
      modeSwitch.appendChild(cookieBtn);
      modeSwitch.appendChild(oauthBtn);

      const hint = document.createElement("div");
      hint.className = "text-xs text-muted";
      hint.style.margin = "8px 0";
      hint.textContent = state.sso.mode === "cookie"
        ? "é€‚ç”¨åœºæ™¯: *.rho.im åŒä¸€çˆ¶åŸŸä¸‹çš„å¤šä¸ªå­åº”ç”¨"
        : "é€‚ç”¨åœºæ™¯: rho.im â†” rho.social å®Œå…¨ä¸åŒçš„åŸŸ";

      const progress = document.createElement("div");
      progress.className = "progress";
      steps.forEach((_, i) => {
        const dot = document.createElement("div");
        dot.className = `dot ${i <= state.sso.step ? "active" : ""}`;
        dot.textContent = i + 1;
        dot.addEventListener("click", () => { state.sso.step = i; renderApp(); });
        progress.appendChild(dot);
        if (i < steps.length - 1) {
          const bar = document.createElement("div");
          bar.className = `bar ${i < state.sso.step ? "active" : ""}`;
          progress.appendChild(bar);
        }
      });

      const stepCard = document.createElement("div");
      stepCard.className = `step ${step.color}`;
      stepCard.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
          <span class="font-bold">æ­¥éª¤ ${state.sso.step + 1}: ${step.title}</span>
          <span class="text-xs" style="opacity:0.7;">${step.from} â†’ ${step.to}</span>
        </div>
        <p class="text-sm" style="margin:0 0 6px;">${step.desc}</p>
        <code class="text-xs" style="display:block; background: rgba(255,255,255,0.6); padding:8px; border-radius:8px;">${step.detail}</code>
      `;

      const nav = document.createElement("div");
      nav.style.display = "flex";
      nav.style.gap = "8px";

      const prev = document.createElement("button");
      prev.className = "pill";
      prev.style.flex = "1";
      prev.textContent = "â† ä¸Šä¸€æ­¥";
      prev.disabled = state.sso.step === 0;
      prev.style.opacity = prev.disabled ? "0.4" : "1";
      prev.addEventListener("click", () => {
        state.sso.step = Math.max(0, state.sso.step - 1);
        renderApp();
      });

      const next = document.createElement("button");
      next.className = "pill";
      next.style.flex = "1";
      next.style.background = "#4f46e5";
      next.style.color = "#fff";
      next.textContent = "ä¸‹ä¸€æ­¥ â†’";
      next.disabled = state.sso.step === steps.length - 1;
      next.style.opacity = next.disabled ? "0.4" : "1";
      next.addEventListener("click", () => {
        state.sso.step = Math.min(steps.length - 1, state.sso.step + 1);
        renderApp();
      });

      nav.appendChild(prev);
      nav.appendChild(next);

      container.appendChild(modeSwitch);
      container.appendChild(hint);
      container.appendChild(progress);
      container.appendChild(stepCard);
      container.appendChild(nav);
      return container;
    }

    function renderSolutions() {
      const container = document.createElement("div");
      const sol = solutions[state.solutions.selected];

      container.innerHTML = `
        <h3 class="text-lg font-semibold">è§£å†³æ–¹æ¡ˆå¯¹æ¯”</h3>
      `;

      const pills = document.createElement("div");
      pills.className = "pill-group";
      solutions.forEach((s, i) => {
        const btn = document.createElement("button");
        btn.className = `pill ${state.solutions.selected === i ? "active" : ""}`;
        btn.textContent = s.name;
        btn.addEventListener("click", () => { state.solutions.selected = i; renderApp(); });
        pills.appendChild(btn);
      });

      const meta = document.createElement("div");
      meta.style.display = "flex";
      meta.style.alignItems = "center";
      meta.style.gap = "10px";
      meta.style.margin = "10px 0";
      meta.innerHTML = `
        <span class="text-sm text-muted">å¤æ‚åº¦: ${sol.difficulty}</span>
        <span class="chip">æœ€é€‚åˆ: ${sol.best}</span>
      `;

      const desc = document.createElement("p");
      desc.className = "text-sm";
      desc.textContent = sol.desc;

      const grid = document.createElement("div");
      grid.className = "grid-2";
      const pros = document.createElement("div");
      pros.style.background = "#ecfdf5";
      pros.style.borderRadius = "10px";
      pros.style.padding = "10px";
      pros.innerHTML = `<p class="text-xs font-bold" style="color:#15803d; margin:0 0 6px;">âœ… ä¼˜ç‚¹</p>`
        + sol.pros.map(p => `<p class="text-xs" style="color:#16a34a; margin:0 0 4px;">â€¢ ${p}</p>`).join("");

      const cons = document.createElement("div");
      cons.style.background = "#fef2f2";
      cons.style.borderRadius = "10px";
      cons.style.padding = "10px";
      cons.innerHTML = `<p class="text-xs font-bold" style="color:#b91c1c; margin:0 0 6px;">âš ï¸ æ³¨æ„</p>`
        + sol.cons.map(c => `<p class="text-xs" style="color:#dc2626; margin:0 0 4px;">â€¢ ${c}</p>`).join("");

      grid.appendChild(pros);
      grid.appendChild(cons);

      const code = document.createElement("div");
      code.innerHTML = `
        <p class="text-xs font-bold text-muted" style="margin:10px 0 6px;">ä»£ç ç¤ºä¾‹</p>
        <pre class="code-block">${sol.code}</pre>
      `;

      container.appendChild(pills);
      container.appendChild(meta);
      container.appendChild(desc);
      container.appendChild(grid);
      container.appendChild(code);
      return container;
    }

    function renderContent() {
      const content = document.getElementById("content");
      content.innerHTML = "";
      let node;
      if (state.activeTab === 0) node = renderOriginExplainer();
      if (state.activeTab === 1) node = renderLiveDemo();
      if (state.activeTab === 2) node = renderSSOFlow();
      if (state.activeTab === 3) node = renderSolutions();
      content.appendChild(node);
    }

    function renderApp() {
      renderTabs();
      renderContent();
    }

    renderApp();
  </script>
</body>
</html>
