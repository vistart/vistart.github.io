<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš–ï¸ ç»©æ•ˆæ”¹å–„ â†’ è§£é™¤åŠ³åŠ¨åˆåŒ Â· AIè¾…åŠ©å…¨æµç¨‹ç®¡ç†</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.4/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  .animate-spin { animation: spin 1s linear infinite; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ===== OpenRouter Config (user-provided) =====
const _cfg = { key: "", model: "" };
const setCfg = (k, m) => { _cfg.key = k; _cfg.model = m; };
const getCfg = () => _cfg;
const hasCfg = () => _cfg.key.length > 10 && _cfg.model.length > 1;

const orChat = async (sys, usr, maxTk = 4000) => {
  if (!hasCfg()) throw new Error("æœªé…ç½® API Key æˆ–æ¨¡å‹å");
  const r = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${_cfg.key}` },
    body: JSON.stringify({ model: _cfg.model, messages: [{ role: "system", content: sys }, { role: "user", content: usr }], temperature: 0.7, max_tokens: maxTk }),
  });
  if (!r.ok) throw new Error(`API ${r.status}`);
  const d = await r.json();
  return d.choices?.[0]?.message?.content || "";
};

const orJSON = async (sys, usr) => {
  const txt = await orChat(sys, usr);
  const c = txt.replace(/```json\s*/g, "").replace(/```\s*/g, "").trim();
  return JSON.parse(c);
};

// ===== Employee Templates for Generation =====
const EMP_TEMPLATES = [
  { name: "å¼ æ˜è¿œ", gender: "ç”·", dept: "äº§å“ç ”å‘éƒ¨", position: "é«˜çº§äº§å“ç»ç†", level: "P7", joinYear: 2019, salary: 38000, ratings: ["B+","B","C+","C"], hasEquity: true, equityDetail: "æœŸæƒ12000è‚¡(æœªå½’å±8000è‚¡)", nonCompete: true, managesTeam: true, teamSize: 5, hasTrade: true, tradeDetail: "äº§å“è·¯çº¿å›¾/ç”¨æˆ·æ•°æ®", specialRisk: "none" },
  { name: "ææ€çª", gender: "å¥³", dept: "å¸‚åœºè¥é”€éƒ¨", position: "è¥é”€æ€»ç›‘", level: "P8", joinYear: 2017, salary: 52000, ratings: ["B","C+","C","C"], hasEquity: true, equityDetail: "RSU 5000è‚¡(æœªå½’å±3200è‚¡)", nonCompete: true, managesTeam: true, teamSize: 12, hasTrade: true, tradeDetail: "å®¢æˆ·èµ„æº/æ¸ é“åè®®", specialRisk: "none" },
  { name: "ç‹æµ©ç„¶", gender: "ç”·", dept: "æŠ€æœ¯æ¶æ„éƒ¨", position: "æ¶æ„å¸ˆ", level: "P8", joinYear: 2016, salary: 62000, ratings: ["A","B+","C","C+"], hasEquity: true, equityDetail: "æœŸæƒ20000è‚¡(æœªå½’å±15000è‚¡)", nonCompete: true, managesTeam: false, teamSize: 0, hasTrade: true, tradeDetail: "æ ¸å¿ƒæŠ€æœ¯æ¶æ„/ä¸“åˆ©", specialRisk: "none" },
  { name: "é™ˆé›…å©·", gender: "å¥³", dept: "è¿è¥éƒ¨", position: "è¿è¥ç»ç†", level: "P6", joinYear: 2021, salary: 25000, ratings: ["B","B","C+","C"], hasEquity: false, equityDetail: "", nonCompete: false, managesTeam: true, teamSize: 3, hasTrade: false, tradeDetail: "", specialRisk: "pregnant" },
  { name: "åˆ˜å»ºå›½", gender: "ç”·", dept: "é”€å”®éƒ¨", position: "å¤§å®¢æˆ·æ€»ç›‘", level: "P7", joinYear: 2015, salary: 45000, ratings: ["A","B","C","D"], hasEquity: true, equityDetail: "æœŸæƒ8000è‚¡(å·²å…¨éƒ¨å½’å±)", nonCompete: true, managesTeam: true, teamSize: 8, hasTrade: true, tradeDetail: "å¤§å®¢æˆ·ä¿¡æ¯/æŠ¥ä»·ä½“ç³»", specialRisk: "nearRetirement" },
  { name: "èµµé›ªæ™´", gender: "å¥³", dept: "æ•°æ®åˆ†æéƒ¨", position: "æ•°æ®åˆ†æå¸ˆ", level: "P5", joinYear: 2022, salary: 18000, ratings: ["C+","C","C","C"], hasEquity: false, equityDetail: "", nonCompete: false, managesTeam: false, teamSize: 0, hasTrade: false, tradeDetail: "", specialRisk: "none" },
];

const buildEmpFromTemplate = (t) => {
  const now = new Date();
  const joinDate = `${t.joinYear}-${String(Math.floor(Math.random()*6)+3).padStart(2,'0')}-${String(Math.floor(Math.random()*20)+5).padStart(2,'0')}`;
  const wy = parseFloat(((now - new Date(joinDate)) / (365.25*86400000)).toFixed(1));
  const N = Math.ceil(wy);
  const base = Math.min(t.salary, 31000);
  return {
    name: t.name, gender: t.gender, empId: `EMP-${t.joinYear}-${String(Math.floor(Math.random()*9000)+1000)}`,
    dept: t.dept, position: t.position, level: t.level, joinDate,
    contractEnd: `${now.getFullYear()+1}-${String(Math.floor(Math.random()*6)+6).padStart(2,'0')}-30`,
    monthlySalary: t.salary, workYears: wy, recentRatings: t.ratings,
    hasEquity: t.hasEquity, equityDetail: t.equityDetail, nonCompete: t.nonCompete,
    managesTeam: t.managesTeam, teamSize: t.teamSize, hasTrade: t.hasTrade, tradeDetail: t.tradeDetail,
    isPregnant: t.specialRisk === "pregnant", hasWorkInjury: t.specialRisk === "injury",
    nearRetirement: t.specialRisk === "nearRetirement",
    socialInsuranceBase: base,
    estimatedN: N, estimatedCompMin: N * base, estimatedCompNPlus1: (N + 1) * base,
  };
};

// ===== Prompt Builders =====
const buildPrompt = (type, ctx) => {
  const P = {
    emp_generate: `ä½ æ˜¯ä¸€ä½èµ„æ·±HRæ³•å¾‹é¡¾é—®ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ¨¡æ¿ä¿¡æ¯ï¼Œç”Ÿæˆè¯¥å‘˜å·¥çš„è¯¦ç»†æƒ…å†µæ¦‚è¿°ï¼Œä¾›HRå†³ç­–å‚è€ƒã€‚

å‘˜å·¥åŸºæœ¬ä¿¡æ¯ï¼š
- å§“åï¼š${ctx.name}ï¼Œ${ctx.gender}ï¼Œ${ctx.dept} ${ctx.position}(${ctx.level})
- å·¥é¾„ï¼šçº¦${ctx.workYears}å¹´ï¼Œæœˆè–ªï¼šÂ¥${ctx.salary?.toLocaleString()}
- è¿‘4å­£åº¦ç»©æ•ˆï¼š${ctx.ratings}
- è‚¡æƒï¼š${ctx.equityDetail || "æ— "}
- ç«ä¸šé™åˆ¶ï¼š${ctx.nonCompete ? "æœ‰" : "æ— "}
- ç®¡ç†å›¢é˜Ÿï¼š${ctx.managesTeam ? ctx.teamSize + "äºº" : "æ— "}
- ç‰¹æ®Šæƒ…å†µï¼š${ctx.specialRisk || "æ— "}

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š
{"summary":"[ç”¨2-3å¥è¯æ¦‚æ‹¬è¯¥å‘˜å·¥ç»©æ•ˆé—®é¢˜çš„æ ¸å¿ƒè¡¨ç°]","performanceIssues":["[å…·ä½“ç»©æ•ˆé—®é¢˜1]","[å…·ä½“ç»©æ•ˆé—®é¢˜2]","[å…·ä½“ç»©æ•ˆé—®é¢˜3]"],"terminationCostEstimate":"[é¢„ä¼°ç›´æ¥è§£é™¤æˆæœ¬åŒºé—´ï¼Œå¦‚N+1æ ‡å‡†]","keyRisks":["[å…³é”®é£é™©1]","[å…³é”®é£é™©2]"],"recommendation":"[ç®€è¦å»ºè®®ï¼šæ˜¯å¦é€‚åˆè¿›å…¥PIPæµç¨‹]"}`,

    pip_plan: `ä½ æ˜¯ä¸€ä½èµ„æ·±HRæ³•å¾‹é¡¾é—®ã€‚è¯·ä¸ºä»¥ä¸‹å‘˜å·¥ç”Ÿæˆ3ä¸ªç»©æ•ˆæ”¹å–„è®¡åˆ’(PIP)æ–¹æ¡ˆã€‚

å‘˜å·¥ä¿¡æ¯ï¼š${ctx.name}ï¼Œ${ctx.position}(${ctx.level})ï¼Œå·¥é¾„çº¦${ctx.workYears}å¹´
è¿‘æœŸç»©æ•ˆè¯„çº§ï¼š${ctx.ratings}
ç»©æ•ˆé—®é¢˜ï¼š${ctx.issues || "æŒç»­ç»©æ•ˆä¸‹æ»‘"}

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ•°ç»„æ ¼å¼è¾“å‡ºï¼Œä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ï¼š
[
  {"id":1,"title":"æ–¹æ¡ˆAï¼š[æ ‡é¢˜]","content":"[è¯¦ç»†å†…å®¹å«KPIã€æ—¶é—´ã€è¯„ä¼°æ–¹å¼ã€æ³•å¾‹æç¤º]","tag":"æ¨è","risk":"ä½","duration":60,"evidencePoints":["[è¯æ®è¦ç‚¹1]","[è¯æ®è¦ç‚¹2]"]},
  {"id":2,"title":"æ–¹æ¡ˆBï¼š[æ ‡é¢˜]","content":"[è¯¦ç»†å†…å®¹]","tag":"ç¨³å¦¥","risk":"ä½","duration":90,"evidencePoints":["[è¯æ®è¦ç‚¹1]","[è¯æ®è¦ç‚¹2]"]},
  {"id":3,"title":"æ–¹æ¡ˆCï¼š[æ ‡é¢˜]","content":"[è¯¦ç»†å†…å®¹]","tag":"æ¿€è¿›","risk":"é«˜","duration":30,"evidencePoints":["[è¯æ®è¦ç‚¹1]","[è¯æ®è¦ç‚¹2]"]}
]

è¦æ±‚ï¼š
- æ¯ä¸ªæ–¹æ¡ˆéœ€åŒ…å«å¯é‡åŒ–KPIã€è¯„ä¼°å‘¨æœŸã€å¼•ç”¨ã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹æ¡æ¬¾
- evidencePointsåˆ—å‡ºè¯¥æ–¹æ¡ˆä¸­åº”ç•™å­˜çš„å…³é”®è¯æ®ï¼ˆç”¨äºåº”å¯¹ä»²è£ï¼‰
- contentä¸­ç”¨\\nè¡¨ç¤ºæ¢è¡Œ`,

    notification_draft: `ä½ æ˜¯ä¸€ä½èµ„æ·±HRæ³•å¾‹é¡¾é—®ã€‚è¯·ä¸ºPIPé€šçŸ¥ç”Ÿæˆ2ä¸ªç‰ˆæœ¬çš„é€šçŸ¥ä¹¦ã€‚

å‘˜å·¥ï¼š${ctx.name}ï¼Œæ”¹å–„å‘¨æœŸï¼š${ctx.duration || 60}å¤©ï¼ŒåŸå› ï¼šè¿‘ä¸¤å­£åº¦ç»©æ•ˆC+/Cï¼Œæœªè¾¾${ctx.level}å²—ä½è¦æ±‚ã€‚

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ•°ç»„æ ¼å¼è¾“å‡ºï¼š
[
  {"id":1,"title":"æ­£å¼ä¹¦é¢é€šçŸ¥","content":"[æ­£å¼é€šçŸ¥å…¨æ–‡ï¼Œå«æ”¹å–„åŸå› ã€å‘¨æœŸã€ç›®æ ‡ã€è¯„ä¼°æ–¹å¼ã€ç­¾æ”¶è¦æ±‚ã€å‘˜å·¥æƒåˆ©å‘ŠçŸ¥]","tag":"æ¨è","evidenceNotes":"[è¯¥é€šçŸ¥çš„è¯æ®æ•ˆåŠ›è¯´æ˜å’Œç­¾æ”¶æ³¨æ„äº‹é¡¹]"},
  {"id":2,"title":"æ¸©å’Œæ²Ÿé€šç‰ˆæœ¬","content":"[æ¸©å’Œæªè¾ç‰ˆæœ¬]","tag":"æ¸©å’Œ","evidenceNotes":"[æªè¾å§”å©‰ç‰ˆæœ¬çš„è¯æ®æ•ˆåŠ›åˆ†æåŠæ½œåœ¨é£é™©]"}
]

contentä¸­ç”¨\\nè¡¨ç¤ºæ¢è¡Œã€‚`,

    eval_result: `ä½ æ˜¯ä¸€ä½èµ„æ·±HRæ³•å¾‹é¡¾é—®ã€‚è¯·ä¸ºPIPè¯„ä¼°ç”Ÿæˆ2ä¸ªå¯èƒ½çš„è¯„ä¼°ç»“è®ºã€‚

å‘˜å·¥ï¼š${ctx.name}ï¼Œæ”¹å–„æœŸï¼š${ctx.duration || 60}å¤©ï¼ŒèŒä½ï¼š${ctx.position || "é«˜çº§äº§å“ç»ç†"}(${ctx.level || "P7"})ã€‚

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ•°ç»„æ ¼å¼è¾“å‡ºï¼š
[
  {"id":1,"title":"è¯„ä¼°ç»“è®ºï¼šæœªè¾¾æ ‡","content":"[å«3ä¸ªå…·ä½“æŒ‡æ ‡è¯„ä¼°æ•°æ®ã€ç»¼åˆè¯„å®šã€åç»­è·¯å¾„å»ºè®®ï¼Œå¼•ç”¨åŠ³åŠ¨åˆåŒæ³•]","arbitrationDefense":"[æœªè¾¾æ ‡ç»“è®ºåœ¨ä»²è£ä¸­çš„è¯æ®æ•ˆåŠ›åˆ†æå’Œæ³¨æ„äº‹é¡¹]"},
  {"id":2,"title":"è¯„ä¼°ç»“è®ºï¼šéƒ¨åˆ†è¾¾æ ‡","content":"[éƒ¨åˆ†è¾¾æ ‡æƒ…å†µè¯´æ˜ã€å»¶é•¿æ”¹å–„æœŸvsç›´æ¥è§£é™¤çš„é£é™©å¯¹æ¯”]","arbitrationDefense":"[éƒ¨åˆ†è¾¾æ ‡æ—¶ç›´æ¥è§£é™¤çš„ä»²è£é£é™©åˆ†æ]"}
]

contentä¸­ç”¨\\nè¡¨ç¤ºæ¢è¡Œï¼Œç”¨â€¢è¡¨ç¤ºåˆ—è¡¨é¡¹ã€‚`,

    compensation: `ä½ æ˜¯ä¸€ä½èµ„æ·±HRæ³•å¾‹é¡¾é—®ã€‚è¯·ä¸ºè§£é™¤åŠ³åŠ¨åˆåŒç”Ÿæˆ2ä¸ªç»æµè¡¥å¿æ–¹æ¡ˆã€‚

å‘˜å·¥ï¼š${ctx.name}ï¼Œå·¥é¾„ï¼š${ctx.workYears}å¹´ï¼Œæœˆè–ªï¼šÂ¥${ctx.salary?.toLocaleString()}ï¼Œç¤¾ä¿åŸºæ•°ï¼šÂ¥${ctx.socialBase?.toLocaleString()}ã€‚
æŒæœ‰æœªå½’å±æœŸæƒï¼š${ctx.equityDetail || "æ— "}ã€‚N=${Math.ceil(ctx.workYears)}ã€‚

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ•°ç»„æ ¼å¼è¾“å‡ºï¼š
[
  {"id":1,"title":"ç»æµè¡¥å¿æ–¹æ¡ˆï¼ˆN+1ï¼‰","content":"[æ ¹æ®åŠ³åŠ¨åˆåŒæ³•ç¬¬40æ¡+ç¬¬47æ¡è¯¦ç»†è®¡ç®—ï¼Œå«å·¥ä½œå¹´é™ã€æœˆå·¥èµ„åŸºæ•°ã€ä»£é€šçŸ¥é‡‘ã€åˆè®¡é‡‘é¢ï¼Œæ³¨æ˜ç¤¾å¹³å·¥èµ„3å€å°é¡¶è§„åˆ™]","tag":"æ³•å®šæ ‡å‡†","totalAmount":"[å…·ä½“é‡‘é¢]","arbitrationRisk":"[è¯¥æ–¹æ¡ˆçš„ä»²è£èƒœè¯‰ç‡è¯„ä¼°]"},
  {"id":2,"title":"åå•†è§£é™¤æ–¹æ¡ˆï¼ˆN+Xï¼‰","content":"[åœ¨æ³•å®šæ ‡å‡†ä¸ŠåŠ åå•†æº¢ä»·å’ŒæœŸæƒæŠ˜ç°å¤„ç†ï¼Œç»™å‡ºåˆè®¡é‡‘é¢]","tag":"æ¨è","risk":"ä½","totalAmount":"[å…·ä½“é‡‘é¢]","arbitrationRisk":"[åå•†æ–¹æ¡ˆçš„é£é™©å¯¹æ¯”åˆ†æ]"}
]

è¯·ç”¨å…·ä½“æ•°å­—è®¡ç®—ã€‚contentä¸­ç”¨\\nè¡¨ç¤ºæ¢è¡Œã€‚`,

    noncompete: `ä½ æ˜¯ä¸€ä½èµ„æ·±HRæ³•å¾‹é¡¾é—®ã€‚è¯·ä¸ºç«ä¸šé™åˆ¶å¤„ç†ç”Ÿæˆ2ä¸ªæ–¹æ¡ˆã€‚

å‘˜å·¥ï¼š${ctx.name}ï¼Œ${ctx.position}ï¼Œæ¥è§¦æ ¸å¿ƒäº§å“è·¯çº¿å›¾åŠå•†ä¸šæ•°æ®ï¼Œæœˆè–ªï¼šÂ¥${ctx.salary?.toLocaleString()}ã€‚

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ•°ç»„æ ¼å¼è¾“å‡ºï¼š
[
  {"id":1,"title":"å¯åŠ¨ç«ä¸šé™åˆ¶","content":"[å«é™åˆ¶æœŸé™ã€ç«ä¸šè¡¥å¿é‡‘é¢(ä¸ä½äºæœˆè–ª30%)ã€è¡¥å¿æ€»é¢ã€é™åˆ¶èŒƒå›´ã€æœªæŒ‰æ—¶æ”¯ä»˜çš„æ³•å¾‹åæœ]","costEstimate":"[æ€»æˆæœ¬]"},
  {"id":2,"title":"ä¸å¯åŠ¨ç«ä¸šé™åˆ¶","content":"[åˆ†ææˆæœ¬ã€æŒ–è§’å¯èƒ½æ€§ã€ä¿¡æ¯æ—¶æ•ˆæ€§ï¼Œå»ºè®®æ›¿ä»£æªæ–½å¦‚ä¿å¯†æ‰¿è¯ºå‡½]","costEstimate":"[æ›¿ä»£æªæ–½æˆæœ¬]"}
]

contentä¸­ç”¨\\nè¡¨ç¤ºæ¢è¡Œï¼Œç”¨â€¢è¡¨ç¤ºåˆ—è¡¨é¡¹ã€‚`,

    legal_counsel: `ä½ æ˜¯ä¸€ä½ä¸è¯¥å…¬å¸åˆä½œçš„å¤–éƒ¨å¾‹å¸ˆï¼Œä¸“ç²¾ä¸­å›½åŠ³åŠ¨æ³•ã€‚è¯·é’ˆå¯¹å½“å‰HRæ“ä½œæ­¥éª¤ç»™å‡ºä¸“ä¸šæ³•å¾‹é£é™©æç¤ºå’Œå»ºè®®ã€‚

å½“å‰æ­¥éª¤ï¼š${ctx.stepName}
å‘˜å·¥æƒ…å†µï¼š${ctx.name}ï¼Œ${ctx.position}(${ctx.level})ï¼Œå·¥é¾„${ctx.workYears}å¹´ï¼Œè¿‘4å­£åº¦ç»©æ•ˆ${ctx.ratings}
${ctx.specialInfo || ""}

è¯·ä»ä»¥ä¸‹è§’åº¦ç»™å‡º300-500å­—çš„ä¸“ä¸šå»ºè®®ï¼š
1. å½“å‰æ­¥éª¤çš„æ³•å¾‹åˆè§„è¦ç‚¹
2. å¯èƒ½å¼•å‘ä»²è£/è¯‰è®¼çš„é£é™©ç‚¹
3. è¯æ®ç•™å­˜çš„å…·ä½“å»ºè®®
4. æ˜¯å¦æœ‰æ›´ä¼˜çš„æ“ä½œæ–¹å¼

ç›´æ¥è¾“å‡ºå»ºè®®æ–‡æœ¬ï¼Œä¸è¦JSONã€‚`,

    arbitration_risk: `ä½ æ˜¯ä¸€ä½èµ„æ·±åŠ³åŠ¨æ³•å¾‹å¸ˆã€‚è¯·å¯¹å½“å‰æ¡ˆä»¶è¿›è¡Œä»²è£é£é™©è¯„ä¼°ã€‚

æ¡ˆä»¶æ¦‚å†µï¼š
- å‘˜å·¥ï¼š${ctx.name}ï¼Œ${ctx.position}(${ctx.level})ï¼Œå·¥é¾„${ctx.workYears}å¹´
- ç»©æ•ˆè®°å½•ï¼š${ctx.ratings}
- å¤„ç†è·¯å¾„ï¼š${ctx.path}
- å·²é‡‡å–æ­¥éª¤ï¼š${ctx.steps}
- æ³•å¾‹é¡¾é—®å»ºè®®é‡‡çº³æƒ…å†µï¼š${ctx.counselAdoption}
- ç‰¹æ®Šå› ç´ ï¼š${ctx.specialFactors}

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
{"overallRisk":"[é«˜/ä¸­/ä½]","winRate":"[é¢„ä¼°ä¼ä¸šèƒœè¯‰ç‡ç™¾åˆ†æ¯”]","keyRisks":[{"point":"[é£é™©ç‚¹]","severity":"[é«˜/ä¸­/ä½]","mitigation":"[ç¼“è§£å»ºè®®]"}],"evidenceChecklist":["[å¿…è¦è¯æ®1]","[å¿…è¦è¯æ®2]","[å¿…è¦è¯æ®3]"],"summary":"[200å­—ç»¼åˆè¯„ä¼°]"}`,
  };
  return P[type] || "";
};

// Fallback data
const getFallback = (type, ctx) => {
  const F = {
    emp_generate: { summary: `${ctx.name}è¿‘ä¸¤å­£åº¦ç»©æ•ˆæŒç»­ä¸‹æ»‘ï¼Œä»Bçº§é™è‡³Cçº§ï¼Œæœªè¾¾${ctx.level}å²—ä½æ ¸å¿ƒè¦æ±‚ã€‚`, performanceIssues: ["å­£åº¦OKRå®Œæˆç‡ä¸è¶³60%", "è·¨éƒ¨é—¨åä½œè¯„åˆ†è¿ç»­ä½äºåŠæ ¼çº¿", "æ ¸å¿ƒé¡¹ç›®äº¤ä»˜å»¶æœŸ"], terminationCostEstimate: `N+1æ ‡å‡†çº¦Â¥${((Math.ceil(ctx.workYears)+1)*Math.min(ctx.salary,31000)).toLocaleString()}`, keyRisks: ctx.specialRisk !== "none" ? ["å­˜åœ¨ç‰¹æ®Šä¿æŠ¤æƒ…å½¢ï¼Œéœ€é¢å¤–è¯„ä¼°"] : ["å·¥é¾„è¾ƒé•¿ï¼Œè¡¥å¿æˆæœ¬è¾ƒé«˜"], recommendation: "å»ºè®®è¿›å…¥PIPæµç¨‹ï¼Œå®Œå–„è¯æ®é“¾åå†åšè§£é™¤å†³ç­–ã€‚" },
    pip_plan: [
      { id: 1, title: "æ–¹æ¡ˆAï¼šäº§å‡ºå¯¼å‘å‹ï¼ˆ60å¤©ï¼‰", content: `[å¤‡ç”¨] é’ˆå¯¹${ctx.name}è®¾å®š60å¤©æ”¹å–„è®¡åˆ’ï¼ŒåŒ…å«3ä¸ªé‡åŒ–KPIç›®æ ‡ã€‚\n\nâš ï¸ æ­¤ä¸ºç¦»çº¿å¤‡ç”¨æ–¹æ¡ˆã€‚`, tag: "æ¨è", risk: "ä½", duration: 60, evidencePoints: ["ä¹¦é¢PIPé€šçŸ¥ç­¾æ”¶è®°å½•", "åŒå‘¨reviewä¼šè®®çºªè¦"] },
      { id: 2, title: "æ–¹æ¡ˆBï¼šèƒ½åŠ›æå‡å‹ï¼ˆ90å¤©ï¼‰", content: "[å¤‡ç”¨] 90å¤©æ·±åº¦æ”¹å–„ï¼Œå«åŸ¹è®­+è¾…å¯¼+ç‹¬ç«‹è¯„ä¼°ä¸‰é˜¶æ®µã€‚", tag: "ç¨³å¦¥", risk: "ä½", duration: 90, evidencePoints: ["åŸ¹è®­ç­¾åˆ°è®°å½•", "è¾…å¯¼æ—¥å¿—"] },
      { id: 3, title: "æ–¹æ¡ˆCï¼šå¿«é€Ÿè¯„ä¼°å‹ï¼ˆ30å¤©ï¼‰", content: "[å¤‡ç”¨] 30å¤©å¿«é€Ÿè¯„ä¼°ï¼Œé£é™©è¾ƒé«˜ã€‚", tag: "æ¿€è¿›", risk: "é«˜", duration: 30, evidencePoints: ["æ¯å‘¨è¯„ä¼°è®°å½•"] },
    ],
    notification_draft: [
      { id: 1, title: "æ­£å¼ä¹¦é¢é€šçŸ¥", content: "[å¤‡ç”¨] PIPæ­£å¼é€šçŸ¥ä¹¦æ¨¡æ¿ã€‚", tag: "æ¨è", evidenceNotes: "éœ€å‘˜å·¥ç­¾å­—ç¡®è®¤æ”¶åˆ°" },
      { id: 2, title: "æ¸©å’Œæ²Ÿé€šç‰ˆæœ¬", content: "[å¤‡ç”¨] æ¸©å’Œç‰ˆé€šçŸ¥æ¨¡æ¿ã€‚", tag: "æ¸©å’Œ", evidenceNotes: "æªè¾æ¸©å’Œä½†è¯æ®æ•ˆåŠ›ç¨å¼±" },
    ],
    eval_result: [
      { id: 1, title: "è¯„ä¼°ç»“è®ºï¼šæœªè¾¾æ ‡", content: "[å¤‡ç”¨] æ”¹å–„æœŸè¯„ä¼°æœªè¾¾æ ‡ã€‚", arbitrationDefense: "éœ€ç¡®ä¿è¯„ä¼°æ ‡å‡†äº‹å…ˆå‘ŠçŸ¥" },
      { id: 2, title: "è¯„ä¼°ç»“è®ºï¼šéƒ¨åˆ†è¾¾æ ‡", content: "[å¤‡ç”¨] éƒ¨åˆ†è¾¾æ ‡ï¼Œå»ºè®®å»¶é•¿æ”¹å–„æœŸã€‚", arbitrationDefense: "éƒ¨åˆ†è¾¾æ ‡æ—¶ç›´æ¥è§£é™¤é£é™©è¾ƒé«˜" },
    ],
    compensation: [
      { id: 1, title: "ç»æµè¡¥å¿æ–¹æ¡ˆï¼ˆN+1ï¼‰", content: "[å¤‡ç”¨] æ³•å®šæ ‡å‡†è¡¥å¿æ–¹æ¡ˆã€‚", tag: "æ³•å®šæ ‡å‡†", totalAmount: `Â¥${((Math.ceil(ctx.workYears||7)+1)*Math.min(ctx.salary||38000,31000)).toLocaleString()}`, arbitrationRisk: "ç¬¦åˆæ³•å®šæ ‡å‡†ï¼Œä»²è£é£é™©ä½" },
      { id: 2, title: "åå•†è§£é™¤æ–¹æ¡ˆï¼ˆN+Xï¼‰", content: "[å¤‡ç”¨] åå•†æº¢ä»·æ–¹æ¡ˆã€‚", tag: "æ¨è", risk: "ä½", totalAmount: `Â¥${((Math.ceil(ctx.workYears||7)+3)*Math.min(ctx.salary||38000,31000)).toLocaleString()}`, arbitrationRisk: "åå•†æ–¹æ¡ˆé£é™©æœ€ä½" },
    ],
    noncompete: [
      { id: 1, title: "å¯åŠ¨ç«ä¸šé™åˆ¶", content: "[å¤‡ç”¨] ç«ä¸šé™åˆ¶æ–¹æ¡ˆã€‚", costEstimate: `çº¦Â¥${(Math.min(ctx.salary||38000,31000)*0.3*12).toLocaleString()}` },
      { id: 2, title: "ä¸å¯åŠ¨ç«ä¸šé™åˆ¶", content: "[å¤‡ç”¨] ä¸å¯åŠ¨æ–¹æ¡ˆã€‚", costEstimate: "ä»…ä¿å¯†åè®®æˆæœ¬" },
    ],
  };
  return F[type];
};

const llmGenerate = async (type, ctx) => {
  const prompt = buildPrompt(type, ctx);
  if (!prompt) return getFallback(type, ctx);
  try {
    const sys = type === "legal_counsel" ? "ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½åŠ³åŠ¨æ³•çš„å¤–éƒ¨åˆä½œå¾‹å¸ˆã€‚ç›´æ¥è¾“å‡ºå»ºè®®æ–‡æœ¬ã€‚" : "ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­å›½åŠ³åŠ¨æ³•çš„èµ„æ·±HRæ³•å¾‹é¡¾é—®ã€‚ä½ çš„å›å¤å¿…é¡»æ˜¯çº¯JSONï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ã€è§£é‡Šæ–‡å­—æˆ–ä»»ä½•å…¶ä»–å†…å®¹ã€‚ç›´æ¥è¾“å‡ºJSONã€‚";
    const txt = await orChat(sys, prompt);
    if (type === "legal_counsel") return txt.trim();
    const c = txt.replace(/```json\s*/g, "").replace(/```\s*/g, "").trim();
    const parsed = JSON.parse(c);
    return parsed;
  } catch (e) {
    console.error("LLM failed:", e);
    return getFallback(type, ctx);
  }
};

// ===== Node Definitions =====
const NODES = {
  employee_select: { id: "employee_select", label: "é€‰æ‹©/ç”Ÿæˆå‘˜å·¥æ¡£æ¡ˆ", icon: "ğŸ‘¤", desc: "é€‰æ‹©é¢„è®¾å‘˜å·¥æˆ–AIç”Ÿæˆå‘˜å·¥ä¿¡æ¯", phase: "å‡†å¤‡é˜¶æ®µ" },
  employee_info: { id: "employee_info", label: "å‘˜å·¥ä¿¡æ¯ç¡®è®¤ä¸é£é™©é¢„è¯„", icon: "ğŸ“‹", desc: "ç¡®è®¤å‘˜å·¥ä¿¡æ¯ï¼ŒAIé¢„è¯„è§£é™¤æˆæœ¬ä¸é£é™©", phase: "å‡†å¤‡é˜¶æ®µ" },
  pip_reason: { id: "pip_reason", label: "ç»©æ•ˆé—®é¢˜è®¤å®š", icon: "ğŸ“Š", desc: "æ˜ç¡®ç»©æ•ˆä¸è¾¾æ ‡çš„äº‹å®ä¾æ®", phase: "å‡†å¤‡é˜¶æ®µ" },
  pip_plan: { id: "pip_plan", label: "æ”¹å–„è®¡åˆ’åˆ¶å®š", icon: "ğŸ“", desc: "AIç”ŸæˆPIPæ–¹æ¡ˆï¼ˆå«è¯æ®è¦ç‚¹ï¼‰", phase: "PIPé˜¶æ®µ" },
  pip_notify: { id: "pip_notify", label: "é€šçŸ¥é€è¾¾", icon: "ğŸ“¨", desc: "ç”Ÿæˆé€šçŸ¥æ–‡ä¹¦å¹¶é€è¾¾å‘˜å·¥", phase: "PIPé˜¶æ®µ" },
  pip_monitor: { id: "pip_monitor", label: "æ”¹å–„æœŸè·Ÿè¸ª", icon: "ğŸ“…", desc: "è®°å½•æ”¹å–„æœŸé—´çš„è·Ÿè¸ªæ•°æ®", phase: "PIPé˜¶æ®µ" },
  pip_eval: { id: "pip_eval", label: "æ”¹å–„è¯„ä¼°", icon: "âœ…", desc: "AIç»¼åˆè¯„ä¼°æ”¹å–„ç»“æœ", phase: "è¯„ä¼°é˜¶æ®µ" },
  decision: { id: "decision", label: "è·¯å¾„å†³ç­–", icon: "ğŸ”€", desc: "åŸºäºè¯„ä¼°ç»“æœé€‰æ‹©åç»­è·¯å¾„", phase: "å†³ç­–é˜¶æ®µ" },
  termination_prep: { id: "termination_prep", label: "è§£é™¤åˆè§„å®¡æŸ¥", icon: "âš–ï¸", desc: "æ³•å¾‹åˆè§„æ£€æŸ¥ä¸ææ–™å‡†å¤‡", phase: "è§£é™¤è·¯å¾„" },
  compensation: { id: "compensation", label: "è¡¥å¿æ–¹æ¡ˆ", icon: "ğŸ’°", desc: "è®¡ç®—å¹¶ç¡®å®šç»æµè¡¥å¿æ–¹æ¡ˆ", phase: "è§£é™¤è·¯å¾„" },
  special_handling: { id: "special_handling", label: "ç‰¹æ®Šäº‹é¡¹å¤„ç†", icon: "ğŸ”’", desc: "æœŸæƒ/ç«ä¸šé™åˆ¶/äº¤æ¥ç­‰", phase: "è§£é™¤è·¯å¾„" },
  arbitration_assess: { id: "arbitration_assess", label: "ä»²è£é£é™©ç»ˆè¯„", icon: "ğŸ›¡ï¸", desc: "AIè¯„ä¼°å…¨æµç¨‹ä»²è£é£é™©", phase: "é£æ§é˜¶æ®µ" },
  final_docs: { id: "final_docs", label: "æ–‡ä¹¦ç”Ÿæˆ", icon: "ğŸ“„", desc: "ç”Ÿæˆå…¨å¥—æ³•å¾‹æ–‡ä¹¦", phase: "æ‰§è¡Œé˜¶æ®µ" },
  result_terminated: { id: "result_terminated", label: "è§£é™¤å®Œæˆ", icon: "ğŸ", desc: "åŠ³åŠ¨åˆåŒè§£é™¤æµç¨‹å®Œæˆ", phase: "å®Œæˆ" },
  result_transferred: { id: "result_transferred", label: "è°ƒå²—å®Œæˆ", icon: "ğŸ”„", desc: "å‘˜å·¥è°ƒå²—å®‰æ’å®Œæˆ", phase: "å®Œæˆ" },
  result_improved: { id: "result_improved", label: "æ”¹å–„è¾¾æ ‡", icon: "ğŸ‰", desc: "å‘˜å·¥ç»©æ•ˆæ”¹å–„è¾¾æ ‡", phase: "å®Œæˆ" },
};

const getNextNode = (id, s) => {
  const m = {
    employee_select: "employee_info",
    employee_info: "pip_reason",
    pip_reason: "pip_plan",
    pip_plan: "pip_notify",
    pip_notify: "pip_monitor",
    pip_monitor: "pip_eval",
    pip_eval: st => st.evalResult === "pass" ? "result_improved" : "decision",
    decision: st => {
      if (st.decisionPath === "transfer") return "result_transferred";
      if (st.decisionPath === "extend_pip") return "pip_monitor";
      return "termination_prep";
    },
    termination_prep: "compensation",
    compensation: "special_handling",
    special_handling: "arbitration_assess",
    arbitration_assess: "final_docs",
    final_docs: "result_terminated",
  };
  const n = m[id];
  return typeof n === "function" ? n(s) : n;
};

// ===== UI Components =====
const Badge = ({ children, color = "blue" }) => {
  const c = { blue: "bg-blue-100 text-blue-700", red: "bg-red-100 text-red-700", green: "bg-green-100 text-green-700", amber: "bg-amber-100 text-amber-700", purple: "bg-purple-100 text-purple-700", gray: "bg-gray-100 text-gray-600", emerald: "bg-emerald-100 text-emerald-700" };
  return <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${c[color] || c.blue}`}>{children}</span>;
};

// ===== Legal Counsel Panel (Enhanced) =====
const LegalCounselPanel = ({ stepId, stepName, emp, state, onAdvice, counselLog }) => {
  const [open, setOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const [advice, setAdvice] = useState(null);
  const [src, setSrc] = useState("ai");
  const [decision, setDecision] = useState(counselLog?.[stepId] || null);

  const getAdvice = async () => {
    setLoading(true); setSrc("ai");
    try {
      const specialInfo = [
        emp?.hasEquity ? `æŒæœ‰${emp.equityDetail}` : "",
        emp?.nonCompete ? "ç­¾æœ‰ç«ä¸šé™åˆ¶åè®®" : "",
        emp?.isPregnant ? "âš ï¸ä¸‰æœŸå¥³èŒå·¥" : "",
        emp?.nearRetirement ? "âš ï¸è·é€€ä¼‘ä¸è¶³5å¹´" : "",
        state?.pipPlan ? `å·²é€‰PIPæ–¹æ¡ˆï¼š${state.pipPlan.title}` : "",
        state?.decisionPath ? `å†³ç­–è·¯å¾„ï¼š${state.decisionPath}` : "",
      ].filter(Boolean).join("ï¼›");
      const txt = await llmGenerate("legal_counsel", {
        stepName, name: emp?.name, position: emp?.position, level: emp?.level,
        workYears: emp?.workYears, ratings: emp?.recentRatings?.join("â†’"),
        specialInfo,
      });
      if (typeof txt === "string" && txt.length > 20) { setAdvice(txt); }
      else throw new Error("bad response");
    } catch {
      setAdvice("å½“å‰æ­¥éª¤å»ºè®®ï¼šç¡®ä¿æ‰€æœ‰æ“ä½œæœ‰ä¹¦é¢è®°å½•ï¼Œé‡è¦æ²Ÿé€šåº”æœ‰ç¬¬ä¸‰æ–¹åœ¨åœºè§è¯ã€‚å…·ä½“æ³•å¾‹æ„è§éœ€ç»“åˆæ¡ˆä»¶ç»†èŠ‚è¿›ä¸€æ­¥åˆ†æã€‚");
      setSrc("fallback");
    }
    setLoading(false);
  };

  const handleDecision = (d) => { setDecision(d); onAdvice?.(stepId, d); };

  return (
    <div className="border-t border-dashed border-amber-300 mt-4 pt-3">
      <button onClick={() => { setOpen(!open); if (!open && !advice) getAdvice(); }}
        className="flex items-center gap-2 text-sm text-amber-700 hover:text-amber-900 font-medium w-full text-left">
        <span>âš–ï¸</span>
        <span className="flex-1">{open ? "æ”¶èµ·æ³•å¾‹é¡¾é—®å»ºè®®" : "å’¨è¯¢æ³•å¾‹é¡¾é—®"}</span>
        {decision && <Badge color={decision === "accept" ? "green" : decision === "partial" ? "amber" : "gray"}>
          {decision === "accept" ? "å·²é‡‡çº³" : decision === "partial" ? "éƒ¨åˆ†é‡‡çº³" : "æœªé‡‡çº³"}
        </Badge>}
        <span className="text-xs text-amber-500">Â· å¤–éƒ¨åˆä½œå¾‹å¸ˆ</span>
      </button>
      {open && (
        <div className="mt-3 bg-amber-50 border border-amber-200 rounded-xl p-4">
          {loading ? (
            <div className="flex items-center gap-2 text-sm text-amber-600">
              <span className="animate-spin">â³</span> æ³•å¾‹é¡¾é—®æ­£åœ¨åˆ†æï¼ˆæ¨¡æ‹Ÿå¤–éƒ¨å¾‹å¸ˆå“åº”ï¼‰...
            </div>
          ) : advice ? (
            <div>
              <div className="text-xs text-amber-500 mb-2 font-medium flex items-center gap-1">
                ğŸ“‹ æ³•å¾‹é¡¾é—®æ„è§
                {src === "ai" && <span className="text-emerald-500">Â· AI ç”Ÿæˆ</span>}
                {src === "fallback" && <span className="text-gray-400">Â· å¤‡ç”¨å»ºè®®</span>}
                <span className="text-gray-400 ml-auto">âš ï¸ ç°å®ä¸­æ­¤ç¯èŠ‚å¯èƒ½äº§ç”Ÿå¾‹å¸ˆå’¨è¯¢è´¹ç”¨</span>
              </div>
              <div className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">{advice}</div>
              <div className="mt-3 pt-3 border-t border-amber-200">
                <div className="text-xs text-amber-600 mb-2 font-medium">ç”¨äººå•ä½å†³å®šï¼š</div>
                <div className="flex gap-2">
                  <button onClick={() => handleDecision("accept")} className={`text-xs px-3 py-1.5 rounded-lg transition-all ${decision === "accept" ? "bg-emerald-600 text-white" : "bg-amber-600 text-white hover:bg-amber-700"}`}>
                    âœ… å…¨éƒ¨é‡‡çº³
                  </button>
                  <button onClick={() => handleDecision("partial")} className={`text-xs px-3 py-1.5 rounded-lg transition-all ${decision === "partial" ? "bg-amber-500 text-white" : "border border-amber-400 text-amber-700 hover:bg-amber-100"}`}>
                    âš¡ éƒ¨åˆ†é‡‡çº³
                  </button>
                  <button onClick={() => handleDecision("reject")} className={`text-xs px-3 py-1.5 rounded-lg transition-all ${decision === "reject" ? "bg-gray-500 text-white" : "text-gray-500 hover:text-gray-700"}`}>
                    âŒ æš‚ä¸é‡‡çº³
                  </button>
                </div>
                {decision === "reject" && (
                  <div className="mt-2 text-xs text-red-500 bg-red-50 p-2 rounded-lg">
                    âš ï¸ æœªé‡‡çº³æ³•å¾‹é¡¾é—®å»ºè®®å¯èƒ½å¢åŠ åç»­ä»²è£é£é™©ï¼Œè¯·ç¡®è®¤å·²çŸ¥æ™“ç›¸å…³é£é™©ã€‚
                  </div>
                )}
              </div>
            </div>
          ) : null}
        </div>
      )}
    </div>
  );
};

// ===== LLM Options Component =====
const LLMOptions = ({ type, context, onSelect, extraAction }) => {
  const [opts, setOpts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [sel, setSel] = useState(null);
  const [src, setSrc] = useState("ai");

  const doGen = useCallback(() => {
    setLoading(true); setSrc("ai");
    llmGenerate(type, context).then(o => {
      if (Array.isArray(o)) {
        setOpts(o);
        if (o[0]?.content?.startsWith("[å¤‡ç”¨]") || o[0]?.content?.startsWith("[Fallback]")) setSrc("fallback");
      }
      setLoading(false);
    }).catch(() => setLoading(false));
  }, [type]);

  useEffect(() => { doGen(); }, [type]);

  if (loading) return (
    <div className="py-6 text-center space-y-2">
      <div className="inline-flex items-center gap-2 text-sm text-blue-600 bg-blue-50 px-4 py-2 rounded-full">
        <span className="animate-spin">ğŸ¤–</span> AI æ­£åœ¨ç”Ÿæˆæ–¹æ¡ˆ...
      </div>
    </div>
  );

  return (
    <div className="space-y-3">
      <div className="text-xs text-gray-500 flex items-center gap-1">
        ğŸ¤– AI ç”Ÿæˆäº† {opts.length} ä¸ªæ–¹æ¡ˆ
        {src === "fallback" && <span className="text-amber-500">ï¼ˆAPIå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ï¼‰</span>}
        {src === "ai" && <span className="text-emerald-500">Â· ç”± {getCfg().model} ç”Ÿæˆ</span>}
      </div>
      {opts.map(opt => (
        <div key={opt.id} onClick={() => setSel(opt.id)}
          className={`p-4 rounded-xl border-2 cursor-pointer transition-all ${sel === opt.id ? "border-blue-500 bg-blue-50 shadow-md" : "border-gray-200 hover:border-gray-300"}`}>
          <div className="flex items-center gap-2 mb-2 flex-wrap">
            <span className="font-semibold text-sm">{opt.title}</span>
            {opt.tag && <Badge color={opt.tag === "æ¨è" ? "green" : opt.tag === "ç¨³å¦¥" ? "blue" : opt.tag === "æ¿€è¿›" ? "red" : opt.tag === "æ³•å®šæ ‡å‡†" ? "blue" : opt.tag === "æ¸©å’Œ" ? "amber" : "gray"}>{opt.tag}</Badge>}
            {opt.risk && <Badge color={opt.risk === "ä½" ? "green" : opt.risk === "é«˜" ? "red" : "amber"}>é£é™©{opt.risk}</Badge>}
            {opt.totalAmount && <Badge color="purple">{opt.totalAmount}</Badge>}
            {opt.costEstimate && <Badge color="purple">{opt.costEstimate}</Badge>}
          </div>
          <div className="text-xs text-gray-600 leading-relaxed whitespace-pre-wrap max-h-48 overflow-y-auto">{opt.content}</div>
          {opt.evidencePoints && (
            <div className="mt-2 pt-2 border-t border-gray-100">
              <div className="text-xs font-medium text-blue-600 mb-1">ğŸ“ è¯æ®ç•™å­˜è¦ç‚¹ï¼š</div>
              {opt.evidencePoints.map((ep, i) => <div key={i} className="text-xs text-blue-500">â€¢ {ep}</div>)}
            </div>
          )}
          {opt.evidenceNotes && (
            <div className="mt-2 pt-2 border-t border-gray-100">
              <div className="text-xs text-amber-600">ğŸ“ è¯æ®æ•ˆåŠ›ï¼š{opt.evidenceNotes}</div>
            </div>
          )}
          {opt.arbitrationDefense && (
            <div className="mt-2 pt-2 border-t border-gray-100">
              <div className="text-xs text-purple-600">ğŸ›¡ï¸ ä»²è£åˆ†æï¼š{opt.arbitrationDefense}</div>
            </div>
          )}
          {opt.arbitrationRisk && (
            <div className="mt-2 pt-2 border-t border-gray-100">
              <div className="text-xs text-purple-600">ğŸ›¡ï¸ ä»²è£é£é™©ï¼š{opt.arbitrationRisk}</div>
            </div>
          )}
        </div>
      ))}
      {sel && (
        <button onClick={() => onSelect(opts.find(o => o.id === sel))}
          className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">
          ç¡®è®¤é€‰æ‹©æ­¤æ–¹æ¡ˆ
        </button>
      )}
      {extraAction}
      {src === "ai" && (
        <button onClick={doGen} className="w-full py-1.5 text-xs text-gray-400 hover:text-blue-500">
          ğŸ”„ ä¸æ»¡æ„ï¼Ÿé‡æ–°ç”Ÿæˆ
        </button>
      )}
    </div>
  );
};

// ===== Step: Employee Select =====
const StepEmployeeSelect = ({ onNext }) => {
  const [mode, setMode] = useState(null); // "preset" | "ai"
  const [selIdx, setSelIdx] = useState(null);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiEmp, setAiEmp] = useState(null);
  const [aiProfile, setAiProfile] = useState(null);

  const selectPreset = (idx) => {
    setSelIdx(idx);
    const emp = buildEmpFromTemplate(EMP_TEMPLATES[idx]);
    setAiEmp(emp);
    setAiProfile(null);
    // Auto-generate AI profile
    generateProfile(emp, EMP_TEMPLATES[idx]);
  };

  const generateProfile = async (emp, tpl) => {
    setAiLoading(true);
    try {
      const result = await llmGenerate("emp_generate", {
        name: emp.name, gender: emp.gender, dept: emp.dept, position: emp.position, level: emp.level,
        workYears: emp.workYears, salary: emp.monthlySalary, ratings: emp.recentRatings.join("â†’"),
        equityDetail: emp.equityDetail, nonCompete: emp.nonCompete, managesTeam: emp.managesTeam,
        teamSize: emp.teamSize, specialRisk: tpl?.specialRisk || "none",
      });
      setAiProfile(result);
    } catch { setAiProfile(null); }
    setAiLoading(false);
  };

  const generateRandom = async () => {
    setMode("ai"); setAiLoading(true);
    const tpl = EMP_TEMPLATES[Math.floor(Math.random() * EMP_TEMPLATES.length)];
    const emp = buildEmpFromTemplate(tpl);
    setAiEmp(emp); setSelIdx(null);
    await generateProfile(emp, tpl);
  };

  return (
    <div className="space-y-4">
      <div className="text-xs text-gray-500 bg-gray-50 p-3 rounded-xl">
        ğŸ’¡ æ¼”ç¤ºè¯´æ˜ï¼šçœŸå®ç¯å¢ƒä¸‹å‘˜å·¥ä¿¡æ¯ä»ERPç³»ç»Ÿå¯¼å…¥ã€‚è¿™é‡Œå¯é€‰æ‹©é¢„è®¾æ¡ˆä¾‹æˆ–è®©AIéšæœºç”Ÿæˆã€‚
      </div>

      <div className="grid grid-cols-2 gap-2">
        <button onClick={() => setMode("preset")} className={`p-3 rounded-xl border-2 text-sm font-medium transition-all ${mode === "preset" ? "border-blue-500 bg-blue-50" : "border-gray-200 hover:border-gray-300"}`}>
          ğŸ“ é€‰æ‹©é¢„è®¾æ¡ˆä¾‹
        </button>
        <button onClick={generateRandom} className={`p-3 rounded-xl border-2 text-sm font-medium transition-all ${mode === "ai" ? "border-purple-500 bg-purple-50" : "border-gray-200 hover:border-gray-300"}`}>
          ğŸ¤– AIéšæœºç”Ÿæˆ
        </button>
      </div>

      {mode === "preset" && (
        <div className="space-y-2">
          {EMP_TEMPLATES.map((t, i) => (
            <button key={i} onClick={() => selectPreset(i)}
              className={`w-full text-left p-3 rounded-xl border-2 transition-all ${selIdx === i ? "border-blue-500 bg-blue-50" : "border-gray-200 hover:border-gray-300"}`}>
              <div className="flex items-center gap-2 mb-1">
                <span className="font-semibold text-sm">{t.name}</span>
                <Badge color="blue">{t.level}</Badge>
                <Badge color="gray">{t.dept}</Badge>
                {t.specialRisk === "pregnant" && <Badge color="red">ä¸‰æœŸ</Badge>}
                {t.specialRisk === "nearRetirement" && <Badge color="red">ä¸´é€€ä¼‘</Badge>}
              </div>
              <div className="text-xs text-gray-500">
                {t.position} Â· ç»©æ•ˆ{t.ratings.join("â†’")} Â· æœˆè–ªÂ¥{t.salary.toLocaleString()}
                {t.hasEquity && " Â· æœ‰æœŸæƒ"}{t.nonCompete && " Â· ç«ä¸šé™åˆ¶"}
              </div>
            </button>
          ))}
        </div>
      )}

      {aiLoading && (
        <div className="py-4 text-center">
          <div className="inline-flex items-center gap-2 text-sm text-purple-600 bg-purple-50 px-4 py-2 rounded-full">
            <span className="animate-spin">ğŸ¤–</span> AIæ­£åœ¨åˆ†æå‘˜å·¥æ¡£æ¡ˆ...
          </div>
        </div>
      )}

      {aiEmp && !aiLoading && (
        <div className="bg-white border border-gray-200 rounded-xl p-4 space-y-3">
          <div className="flex items-center justify-between">
            <span className="font-bold text-sm">{aiEmp.name} çš„æ¡£æ¡ˆé¢„è§ˆ</span>
            <Badge color="blue">{aiEmp.level} Â· {aiEmp.position}</Badge>
          </div>
          <div className="grid grid-cols-2 gap-1 text-xs">
            <div className="text-gray-500">å·¥é¾„ï¼š<span className="text-gray-800 font-medium">{aiEmp.workYears}å¹´</span></div>
            <div className="text-gray-500">æœˆè–ªï¼š<span className="text-gray-800 font-medium">Â¥{aiEmp.monthlySalary.toLocaleString()}</span></div>
            <div className="text-gray-500">ç»©æ•ˆï¼š<span className="text-gray-800 font-medium">{aiEmp.recentRatings.join("â†’")}</span></div>
            <div className="text-gray-500">é¢„ä¼°N+1ï¼š<span className="text-red-600 font-medium">Â¥{aiEmp.estimatedCompNPlus1.toLocaleString()}</span></div>
          </div>
          {aiProfile && (
            <div className="bg-purple-50 rounded-lg p-3 space-y-2">
              <div className="text-xs font-medium text-purple-700">ğŸ¤– AI åˆ†ææ‘˜è¦</div>
              <div className="text-xs text-gray-700">{aiProfile.summary}</div>
              {aiProfile.performanceIssues && (
                <div>
                  <div className="text-xs font-medium text-gray-600 mt-1">ç»©æ•ˆé—®é¢˜ï¼š</div>
                  {aiProfile.performanceIssues.map((p, i) => <div key={i} className="text-xs text-gray-600">â€¢ {p}</div>)}
                </div>
              )}
              {aiProfile.terminationCostEstimate && (
                <div className="text-xs text-red-600 font-medium">ğŸ’° é¢„ä¼°è§£é™¤æˆæœ¬ï¼š{aiProfile.terminationCostEstimate}</div>
              )}
              {aiProfile.keyRisks && (
                <div>
                  <div className="text-xs font-medium text-amber-600">âš ï¸ å…³é”®é£é™©ï¼š</div>
                  {aiProfile.keyRisks.map((r, i) => <div key={i} className="text-xs text-amber-600">â€¢ {r}</div>)}
                </div>
              )}
              {aiProfile.recommendation && (
                <div className="text-xs text-blue-700 font-medium pt-1 border-t border-purple-200">
                  ğŸ“Œ {aiProfile.recommendation}
                </div>
              )}
            </div>
          )}
          <button onClick={() => onNext({ employee: aiEmp, aiProfile })}
            className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">
            é€‰æ‹©æ­¤å‘˜å·¥ï¼Œè¿›å…¥æµç¨‹
          </button>
        </div>
      )}
    </div>
  );
};

// ===== Step: Employee Info Confirm =====
const StepEmployeeInfo = ({ emp, profile, onNext }) => {
  const [confirmed, setConfirmed] = useState(false);
  const fields = [
    ["å§“å", emp.name], ["å·¥å·", emp.empId], ["éƒ¨é—¨", emp.dept],
    ["èŒä½", `${emp.position}(${emp.level})`], ["å…¥èŒæ—¥æœŸ", emp.joinDate],
    ["åˆåŒåˆ°æœŸ", emp.contractEnd], ["æœˆè–ª", `Â¥${emp.monthlySalary.toLocaleString()}`],
    ["å·¥é¾„", `${emp.workYears}å¹´`], ["è¿‘4å­£åº¦ç»©æ•ˆ", emp.recentRatings.join(" â†’ ")],
  ];
  const flags = [
    emp.hasEquity && ["ğŸ¦ è‚¡æƒæ¿€åŠ±", emp.equityDetail],
    emp.nonCompete && ["ğŸ”’ ç«ä¸šé™åˆ¶åè®®", ""],
    emp.managesTeam && ["ğŸ‘¥ ç®¡ç†å›¢é˜Ÿ", `${emp.teamSize}äºº`],
    emp.hasTrade && ["ğŸ”‘ æ¥è§¦å•†ä¸šæœºå¯†", emp.tradeDetail],
  ].filter(Boolean);
  const risks = [
    emp.isPregnant && "âš ï¸ ä¸‰æœŸå¥³èŒå·¥ â€” ä¸å¾—ä¾æ®ç¬¬40æ¡è§£é™¤ï¼ˆç¬¬42æ¡ï¼‰",
    emp.hasWorkInjury && "âš ï¸ å·¥ä¼¤èŒå·¥ â€” éœ€ç¡®è®¤æ˜¯å¦åœ¨åŒ»ç–—æœŸ",
    emp.nearRetirement && "âš ï¸ è·é€€ä¼‘ä¸è¶³5å¹´ â€” ä¸å¾—ä¾æ®ç¬¬40æ¡è§£é™¤ï¼ˆç¬¬42æ¡ï¼‰",
  ].filter(Boolean);

  return (
    <div className="space-y-4">
      <div className="bg-gray-50 rounded-xl p-4">
        <div className="text-xs text-gray-400 mb-2">ğŸ“¡ ERPç³»ç»Ÿæ•°æ®ï¼ˆæ¼”ç¤ºï¼‰</div>
        <div className="grid grid-cols-2 gap-2">
          {fields.map(([k, v]) => (
            <div key={k} className="flex justify-between text-sm py-1">
              <span className="text-gray-500">{k}</span>
              <span className="font-medium text-gray-800">{v}</span>
            </div>
          ))}
        </div>
      </div>
      <div className="bg-blue-50 rounded-xl p-3 space-y-1 text-xs">
        <div className="font-medium text-blue-700 mb-1">ğŸ’° è§£é™¤æˆæœ¬é¢„ä¼°</div>
        <div className="text-blue-600">N+1æ³•å®šæ ‡å‡†ï¼šçº¦Â¥{emp.estimatedCompNPlus1.toLocaleString()} ï¼ˆN={emp.estimatedN}ï¼ŒåŸºæ•°Â¥{Math.min(emp.monthlySalary, emp.socialInsuranceBase).toLocaleString()}ï¼‰</div>
        {emp.nonCompete && <div className="text-blue-600">ç«ä¸šé™åˆ¶ï¼ˆ12ä¸ªæœˆï¼‰ï¼šçº¦Â¥{(Math.min(emp.monthlySalary, emp.socialInsuranceBase) * 0.3 * 12).toLocaleString()}</div>}
        {emp.hasEquity && <div className="text-purple-600">æœŸæƒå¤„ç†ï¼š{emp.equityDetail}ï¼ˆéœ€å¦è¡Œåå•†ï¼‰</div>}
      </div>
      {flags.length > 0 && (
        <div className="bg-purple-50 rounded-xl p-3 space-y-1">
          <div className="text-xs font-medium text-purple-700 mb-1">ğŸ“Œ ç‰¹æ®Šæ ‡è®°</div>
          {flags.map(([l, d]) => <div key={l} className="text-xs text-purple-600">{l} {d && <span className="text-purple-400">Â· {d}</span>}</div>)}
        </div>
      )}
      {risks.length > 0 ? (
        <div className="bg-red-50 rounded-xl p-3 border border-red-200">
          <div className="text-xs font-bold text-red-700 mb-1">ğŸš¨ æ³•å®šé™åˆ¶è­¦å‘Š</div>
          {risks.map(r => <div key={r} className="text-xs text-red-600">{r}</div>)}
          <div className="text-xs text-red-500 mt-2 pt-2 border-t border-red-200">
            âš ï¸ å­˜åœ¨æ³•å®šè§£é™¤é™åˆ¶ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘åå•†è§£é™¤è·¯å¾„ï¼Œå¹¶åŠ¡å¿…å’¨è¯¢æ³•å¾‹é¡¾é—®ã€‚
          </div>
        </div>
      ) : (
        <div className="bg-green-50 rounded-xl p-3 border border-green-200">
          <div className="text-xs text-green-700">âœ… æœªæ£€æµ‹åˆ°æ³•å®šè§£é™¤é™åˆ¶æƒ…å½¢ï¼ˆç¬¬42æ¡ï¼‰</div>
        </div>
      )}
      <label className="flex items-start gap-2 bg-blue-50 p-3 rounded-xl cursor-pointer">
        <input type="checkbox" checked={confirmed} onChange={e => setConfirmed(e.target.checked)} className="mt-0.5" />
        <span className="text-xs text-gray-600">æˆ‘å·²æ ¸å®ä»¥ä¸Šä¿¡æ¯å‡†ç¡®æ— è¯¯ï¼Œç¡®è®¤å¯¹è¯¥å‘˜å·¥å‘èµ·ç»©æ•ˆæ”¹å–„æµç¨‹ï¼Œå¹¶å·²çŸ¥æ™“è§£é™¤æˆæœ¬é¢„ä¼°åŠæ½œåœ¨é£é™©</span>
      </label>
      {confirmed && <button onClick={() => onNext({})} className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">ç¡®è®¤å¹¶ç»§ç»­</button>}
    </div>
  );
};

// ===== Step: PIP Reason =====
const StepPipReason = ({ onNext }) => {
  const [reasons, setReasons] = useState([]);
  const [detail, setDetail] = useState("");
  const opts = ["è¿ç»­ä¸¤ä¸ªå­£åº¦ç»©æ•ˆè¯„çº§Cæˆ–ä»¥ä¸‹", "æœªå®Œæˆå²—ä½æ ¸å¿ƒKPI", "å¤šæ¬¡æœªæŒ‰æ—¶äº¤ä»˜é¡¹ç›®", "è·¨éƒ¨é—¨åä½œåé¦ˆå·®", "è¿åå·¥ä½œæµç¨‹è§„èŒƒ", "å®¢æˆ·/ä¸šåŠ¡æ–¹é‡å¤§æŠ•è¯‰"];
  return (
    <div className="space-y-4">
      <div className="bg-amber-50 p-3 rounded-xl text-xs text-amber-700">
        âš ï¸ ä»²è£å…³é”®ï¼šç»©æ•ˆä¸è¾¾æ ‡çš„äº‹å®è®¤å®šæ˜¯æ•´ä¸ªæµç¨‹çš„åŸºç¡€ã€‚é€‰æ‹©çš„ç†ç”±éœ€æœ‰å¯¹åº”çš„ä¹¦é¢è¯æ®æ”¯æ’‘ã€‚
      </div>
      <div className="text-xs text-gray-500">é€‰æ‹©é€‚ç”¨çš„ç»©æ•ˆé—®é¢˜ï¼ˆå¯å¤šé€‰ï¼‰ï¼š</div>
      <div className="space-y-2">
        {opts.map(o => (
          <label key={o} className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${reasons.includes(o) ? "border-blue-400 bg-blue-50" : "border-gray-200 hover:border-gray-300"}`}>
            <input type="checkbox" checked={reasons.includes(o)} onChange={() => setReasons(p => p.includes(o) ? p.filter(x => x !== o) : [...p, o])} />
            <span className="text-sm">{o}</span>
          </label>
        ))}
      </div>
      <textarea value={detail} onChange={e => setDetail(e.target.value)} placeholder="è¡¥å……å…·ä½“äº‹å®æè¿°ï¼ˆå¼ºçƒˆå»ºè®®å¡«å†™ï¼Œä»²è£æ—¶éœ€å…·ä½“äº‹å®æ”¯æ’‘ï¼‰..." className="w-full h-24 p-3 border border-gray-200 rounded-xl text-sm focus:border-blue-400 focus:outline-none resize-none" />
      <div className="bg-blue-50 p-3 rounded-xl text-xs text-blue-600">
        ğŸ“ è¯æ®æç¤ºï¼šè¯·ç¡®ä¿ä»¥ä¸‹è¯æ®å·²ç•™å­˜â€”â€”ç»©æ•ˆè€ƒæ ¸åˆ¶åº¦ï¼ˆç»æ°‘ä¸»ç¨‹åºå…¬ç¤ºï¼‰ã€è¿‘æœŸç»©æ•ˆè¯„åˆ†è®°å½•ã€å…·ä½“é—®é¢˜äº‹ä»¶çš„ä¹¦é¢è®°å½•ã€‚
      </div>
      {reasons.length > 0 && <button onClick={() => onNext({ reasons, reasonDetail: detail })} className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆæ”¹å–„è®¡åˆ’</button>}
    </div>
  );
};

// ===== Step: Decision =====
const StepDecision = ({ state, onNext }) => {
  const paths = [
    { value: "negotiate", label: "ğŸ¤ åå•†è§£é™¤", desc: "ä¸å‘˜å·¥åå•†ä¸€è‡´è§£é™¤åŠ³åŠ¨åˆåŒï¼Œæ”¯ä»˜ç»æµè¡¥å¿é‡‘", badge: "æ¨èÂ·é£é™©æœ€ä½", color: "green" },
    { value: "unilateral", label: "ğŸ“‹ å•æ–¹è§£é™¤(ç¬¬40æ¡)", desc: "ä¸èƒ½èƒœä»»â†’åŸ¹è®­/è°ƒå²—â†’ä»ä¸èƒ½èƒœä»»â†’æå‰30å¤©é€šçŸ¥è§£é™¤", badge: "éœ€å……åˆ†ä¸¾è¯", color: "amber" },
    { value: "transfer", label: "ğŸ”„ è°ƒå²—", desc: "å®‰æ’è‡³å…¶ä»–é€‚åˆå²—ä½ï¼ˆç¬¬40æ¡å‰ç½®æ¡ä»¶ï¼‰", badge: "åˆè§„éœ€è¦", color: "blue" },
    { value: "extend_pip", label: "ğŸ“ å»¶é•¿æ”¹å–„æœŸ", desc: "ç»™äºˆé¢å¤–30å¤©æ”¹å–„æœºä¼š", badge: "æ¸©å’Œ", color: "gray" },
  ];
  const [sel, setSel] = useState(null);
  return (
    <div className="space-y-3">
      <div className="bg-gray-50 p-3 rounded-xl text-xs text-gray-600">
        ğŸ“Š è¯„ä¼°ç»“è®ºï¼šæ”¹å–„æœŸå†…{state.evalResult === "partial" ? "éƒ¨åˆ†æŒ‡æ ‡è¾¾æ ‡" : "æœªè¾¾æ ‡"} | PIPè®°å½• {state.pipDuration || 60} å¤©
      </div>
      <div className="bg-amber-50 p-3 rounded-xl text-xs text-amber-700">
        âš–ï¸ æ³•å¾‹æç¤ºï¼šåå•†è§£é™¤ï¼ˆç¬¬36æ¡ï¼‰é£é™©æœ€ä½ã€‚å•æ–¹è§£é™¤ï¼ˆç¬¬40æ¡ï¼‰éœ€æ»¡è¶³"ä¸èƒ½èƒœä»»â†’åŸ¹è®­æˆ–è°ƒå²—â†’ä»ä¸èƒ½èƒœä»»"å…¨éƒ¨è¦ä»¶ï¼Œä¸”éœ€æå‰30å¤©ä¹¦é¢é€šçŸ¥æˆ–é¢å¤–æ”¯ä»˜ä¸€ä¸ªæœˆå·¥èµ„ã€‚
      </div>
      {paths.map(p => (
        <button key={p.value} onClick={() => setSel(p.value)}
          className={`w-full text-left p-4 rounded-xl border-2 transition-all ${sel === p.value ? "border-blue-500 bg-blue-50 shadow-md" : "border-gray-200 hover:border-gray-300"}`}>
          <div className="flex items-center gap-2">
            <span className="font-semibold text-sm">{p.label}</span>
            <Badge color={p.color}>{p.badge}</Badge>
          </div>
          <div className="text-xs text-gray-500 mt-1">{p.desc}</div>
        </button>
      ))}
      {sel && <button onClick={() => onNext({ decisionPath: sel })} className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">ç¡®è®¤è·¯å¾„</button>}
    </div>
  );
};

// ===== Step: Arbitration Risk Assessment =====
const StepArbitrationAssess = ({ state, emp, counselLog, onNext }) => {
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const run = async () => {
      const counselEntries = Object.entries(counselLog || {});
      const adopted = counselEntries.filter(([,v]) => v === "accept").length;
      const partial = counselEntries.filter(([,v]) => v === "partial").length;
      const rejected = counselEntries.filter(([,v]) => v === "reject").length;
      const total = counselEntries.length;

      try {
        const r = await llmGenerate("arbitration_risk", {
          name: emp.name, position: emp.position, level: emp.level,
          workYears: emp.workYears, ratings: emp.recentRatings?.join("â†’"),
          path: state.decisionPath === "negotiate" ? "åå•†è§£é™¤" : state.decisionPath === "unilateral" ? "å•æ–¹è§£é™¤(ç¬¬40æ¡)" : "è§£é™¤",
          steps: `PIP ${state.pipDuration||60}å¤© â†’ è¯„ä¼°${state.evalResult} â†’ ${state.decisionPath}`,
          counselAdoption: `å…±${total}æ­¥å’¨è¯¢ï¼Œå…¨éƒ¨é‡‡çº³${adopted}æ¬¡ï¼Œéƒ¨åˆ†é‡‡çº³${partial}æ¬¡ï¼Œæœªé‡‡çº³${rejected}æ¬¡`,
          specialFactors: [
            emp.isPregnant ? "ä¸‰æœŸå¥³èŒå·¥" : "",
            emp.nearRetirement ? "ä¸´é€€ä¼‘å‘˜å·¥" : "",
            emp.hasEquity ? "æŒæœ‰æœªå½’å±æœŸæƒ" : "",
            emp.nonCompete ? "ç«ä¸šé™åˆ¶" : "",
          ].filter(Boolean).join("ã€") || "æ— ç‰¹æ®Šå› ç´ ",
        });
        setResult(r);
      } catch {
        setResult({
          overallRisk: "ä¸­", winRate: "65%",
          keyRisks: [{ point: "éœ€ç¡®ä¿PIPæµç¨‹å®Œæ•´è®°å½•", severity: "ä¸­", mitigation: "è¡¥å……ä¹¦é¢ææ–™" }],
          evidenceChecklist: ["ç»©æ•ˆè€ƒæ ¸åˆ¶åº¦å…¬ç¤ºè®°å½•", "PIPé€šçŸ¥ç­¾æ”¶è®°å½•", "æ”¹å–„æœŸè¯„ä¼°æŠ¥å‘Š", "è§£é™¤é€šçŸ¥é€è¾¾è®°å½•"],
          summary: "ç»¼åˆè¯„ä¼°ä»²è£é£é™©ä¸­ç­‰ï¼Œå»ºè®®ä¼˜å…ˆåå•†è§£é™¤ä»¥é™ä½é£é™©ã€‚",
        });
      }
      setLoading(false);
    };
    run();
  }, []);

  if (loading) return (
    <div className="py-8 text-center">
      <div className="inline-flex items-center gap-2 text-sm text-purple-600 bg-purple-50 px-4 py-2 rounded-full">
        <span className="animate-spin">ğŸ›¡ï¸</span> AIæ­£åœ¨è¯„ä¼°å…¨æµç¨‹ä»²è£é£é™©...
      </div>
    </div>
  );

  const riskColor = result?.overallRisk === "ä½" ? "green" : result?.overallRisk === "é«˜" ? "red" : "amber";

  return (
    <div className="space-y-4">
      <div className={`p-4 rounded-xl border-2 ${riskColor === "green" ? "border-green-300 bg-green-50" : riskColor === "red" ? "border-red-300 bg-red-50" : "border-amber-300 bg-amber-50"}`}>
        <div className="flex items-center justify-between mb-2">
          <span className="font-bold text-sm">æ•´ä½“ä»²è£é£é™©è¯„ä¼°</span>
          <div className="flex gap-2">
            <Badge color={riskColor}>é£é™©{result?.overallRisk}</Badge>
            <Badge color={riskColor}>é¢„ä¼°ä¼ä¸šèƒœè¯‰ç‡ {result?.winRate}</Badge>
          </div>
        </div>
        <div className="text-xs text-gray-700 leading-relaxed">{result?.summary}</div>
      </div>

      {result?.keyRisks && (
        <div className="space-y-2">
          <div className="text-xs font-medium text-gray-700">âš ï¸ å…³é”®é£é™©ç‚¹ï¼š</div>
          {result.keyRisks.map((r, i) => (
            <div key={i} className="bg-white border border-gray-200 rounded-lg p-3">
              <div className="flex items-center gap-2 mb-1">
                <Badge color={r.severity === "é«˜" ? "red" : r.severity === "ä¸­" ? "amber" : "green"}>{r.severity}</Badge>
                <span className="text-sm font-medium">{r.point}</span>
              </div>
              <div className="text-xs text-gray-500">ç¼“è§£æªæ–½ï¼š{r.mitigation}</div>
            </div>
          ))}
        </div>
      )}

      {result?.evidenceChecklist && (
        <div className="bg-blue-50 rounded-xl p-3">
          <div className="text-xs font-medium text-blue-700 mb-2">ğŸ“‹ å¿…è¦è¯æ®æ¸…å•ï¼š</div>
          {result.evidenceChecklist.map((e, i) => (
            <div key={i} className="flex items-center gap-2 text-xs text-blue-600 py-0.5">
              <span>â˜</span> {e}
            </div>
          ))}
        </div>
      )}

      {/* Counsel adoption summary */}
      <div className="bg-gray-50 rounded-xl p-3">
        <div className="text-xs font-medium text-gray-700 mb-2">ğŸ“Š æ³•å¾‹é¡¾é—®å»ºè®®é‡‡çº³æƒ…å†µï¼š</div>
        {Object.entries(counselLog || {}).length === 0 ? (
          <div className="text-xs text-gray-400">æœªå’¨è¯¢æ³•å¾‹é¡¾é—®ï¼ˆå¯èƒ½å¢åŠ ä»²è£é£é™©ï¼‰</div>
        ) : (
          <div className="space-y-1">
            {Object.entries(counselLog).map(([step, d]) => (
              <div key={step} className="flex items-center justify-between text-xs">
                <span className="text-gray-600">{NODES[step]?.label || step}</span>
                <Badge color={d === "accept" ? "green" : d === "partial" ? "amber" : "red"}>
                  {d === "accept" ? "å·²é‡‡çº³" : d === "partial" ? "éƒ¨åˆ†é‡‡çº³" : "æœªé‡‡çº³"}
                </Badge>
              </div>
            ))}
          </div>
        )}
      </div>

      <button onClick={() => onNext({ arbitrationAssessment: result })} className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">
        ç¡®è®¤é£é™©è¯„ä¼°ï¼Œç”Ÿæˆæ–‡ä¹¦
      </button>
    </div>
  );
};

// ===== Step: Special Handling =====
const StepSpecialHandling = ({ emp, state, onNext }) => {
  const [items, setItems] = useState({ equity: null, noncompete: null });
  const [phase, setPhase] = useState(emp.hasEquity ? "equity" : emp.nonCompete ? "noncompete" : "done");

  if (phase === "equity") {
    return (
      <div className="space-y-3">
        <div className="text-sm font-medium text-gray-700 mb-2">ğŸ“¦ ç¬¬1é¡¹ï¼šæœªå½’å±æœŸæƒå¤„ç†</div>
        <div className="bg-purple-50 p-3 rounded-xl text-xs text-gray-600">
          è¯¥å‘˜å·¥æŒæœ‰ {emp.equityDetail}ï¼Œéœ€åœ¨è§£é™¤åè®®ä¸­æ˜ç¡®å¤„ç†æ–¹å¼ã€‚
        </div>
        {[
          { id: "buyback", label: "å…¬å¸å›è´­ï¼ˆæŒ‰çº¦å®šä»·æ ¼ï¼‰", desc: "åœ¨è§£é™¤åè®®ä¸­çº¦å®šå·²å½’å±éƒ¨åˆ†çš„å›è´­ä»·æ ¼å’Œæ—¶é—´" },
          { id: "accelerate", label: "åŠ é€Ÿå½’å±ï¼ˆä½œä¸ºåå•†ç­¹ç ï¼‰", desc: "å°†éƒ¨åˆ†æœªå½’å±æœŸæƒåŠ é€Ÿå½’å±ï¼Œçº³å…¥è¡¥å¿æ–¹æ¡ˆ" },
          { id: "forfeit", label: "æŒ‰åŸåè®®è‡ªç„¶å¤±æ•ˆ", desc: "æœªå½’å±éƒ¨åˆ†æŒ‰è‚¡æƒæ¿€åŠ±åè®®çº¦å®šåœ¨ç¦»èŒæ—¶è‡ªåŠ¨å¤±æ•ˆ" },
        ].map(opt => (
          <button key={opt.id} onClick={() => { setItems(p => ({ ...p, equity: opt.id })); setPhase(emp.nonCompete ? "noncompete" : "done"); }}
            className="w-full text-left p-3 rounded-xl border-2 border-gray-200 hover:border-blue-400 transition-all">
            <div className="text-sm font-medium">{opt.label}</div>
            <div className="text-xs text-gray-500">{opt.desc}</div>
          </button>
        ))}
      </div>
    );
  }
  if (phase === "noncompete") {
    return (
      <div>
        <div className="text-sm font-medium text-gray-700 mb-3">ğŸ“¦ {emp.hasEquity ? "ç¬¬2é¡¹" : "ç¬¬1é¡¹"}ï¼šç«ä¸šé™åˆ¶å¤„ç†</div>
        <LLMOptions type="noncompete" context={{ name: emp.name, salary: emp.monthlySalary }}
          onSelect={opt => { setItems(p => ({ ...p, noncompete: opt.id })); onNext({ specialItems: { ...items, noncompete: opt.id } }); }} />
      </div>
    );
  }
  if (phase === "done" || (!emp.hasEquity && !emp.nonCompete)) {
    return (
      <div className="space-y-3">
        <div className="text-sm text-green-700 bg-green-50 p-3 rounded-xl">âœ… æ— éœ€å¤„ç†ç‰¹æ®Šäº‹é¡¹</div>
        <button onClick={() => onNext({ specialItems: {} })} className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">ç»§ç»­</button>
      </div>
    );
  }
};

// ===== Doc Generation =====
const DOC_NAMES = {
  termination_notice: "è§£é™¤åŠ³åŠ¨åˆåŒé€šçŸ¥ä¹¦", compensation_confirm: "ç»æµè¡¥å¿é‡‘ç¡®è®¤å•",
  negotiation_agreement: "åå•†è§£é™¤åè®®ä¹¦", unilateral_decision: "å•æ–¹è§£é™¤å†³å®šä¹¦",
  noncompete_confirm: "ç«ä¸šé™åˆ¶ä¹‰åŠ¡ç¡®è®¤å‡½", equity_confirm: "è‚¡æƒæ¿€åŠ±å¤„ç†ç¡®è®¤ä¹¦",
  handover_list: "å·¥ä½œäº¤æ¥æ¸…å•", separation_cert: "ç¦»èŒè¯æ˜",
};

const buildDocPrompt = (key, emp, st) => {
  const hdr = `ç”¨äººå•ä½ï¼š[ç¤ºä¾‹ç§‘æŠ€æœ‰é™å…¬å¸]ï¼ˆä»¥ä¸‹ç®€ç§°"ç”²æ–¹"ï¼‰\nå‘˜å·¥ï¼š${emp.name}ï¼Œå·¥å·${emp.empId}ï¼ˆä»¥ä¸‹ç®€ç§°"ä¹™æ–¹"ï¼‰\néƒ¨é—¨/èŒä½ï¼š${emp.dept} ${emp.position}(${emp.level})\nå…¥èŒæ—¥æœŸï¼š${emp.joinDate}ï¼ŒåˆåŒåˆ°æœŸï¼š${emp.contractEnd}\næœˆè–ªï¼šÂ¥${emp.monthlySalary.toLocaleString()}ï¼Œå·¥é¾„ï¼š${emp.workYears}å¹´ï¼Œç¤¾ä¿åŸºæ•°ï¼šÂ¥${emp.socialInsuranceBase.toLocaleString()}\nè¿‘4å­£åº¦ç»©æ•ˆï¼š${emp.recentRatings?.join("â†’")}`;
  const N = Math.ceil(emp.workYears);
  const isNeg = st.decisionPath === "negotiate";
  const P = {
    termination_notice: `è¯·ç”Ÿæˆä¸€ä»½æ­£å¼çš„ã€Šè§£é™¤åŠ³åŠ¨åˆåŒé€šçŸ¥ä¹¦ã€‹ã€‚\n\n${hdr}\n\nPIPæ”¹å–„å‘¨æœŸï¼š${st.pipDuration||60}å¤©ï¼Œæ”¹å–„è¯„ä¼°ç»“æœï¼šæœªè¾¾å²—ä½è¦æ±‚ã€‚\nè§£é™¤æ–¹å¼ï¼š${isNeg ? "åŒæ–¹åå•†ä¸€è‡´è§£é™¤ï¼ˆã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬36æ¡ï¼‰" : "ç”¨äººå•ä½å•æ–¹è§£é™¤ï¼ˆã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬40æ¡ç¬¬2æ¬¾ï¼šåŠ³åŠ¨è€…ä¸èƒ½èƒœä»»å·¥ä½œï¼Œç»è¿‡åŸ¹è®­æˆ–è°ƒæ•´å·¥ä½œå²—ä½ï¼Œä»ä¸èƒ½èƒœä»»å·¥ä½œï¼‰"}\n\nè¦æ±‚ï¼š\n1. åŒ…å«æ­£å¼æ–‡ä¹¦ç¼–å·ï¼ˆå¦‚ï¼š[ç¤ºä¾‹]äººå­—ã€”2026ã€•è§£å­—ç¬¬XXXå·ï¼‰\n2. è¯¦è¿°è§£é™¤åŸå› ï¼šå¼•ç”¨å…·ä½“ç»©æ•ˆæ•°æ®å’ŒPIPè¿‡ç¨‹\n3. æ˜ç¡®æ³•å¾‹ä¾æ®æ¡æ¬¾\n4. è½½æ˜è§£é™¤æ—¥æœŸï¼ˆé€šçŸ¥é€è¾¾30æ—¥åæˆ–é¢å¤–æ”¯ä»˜1ä¸ªæœˆå·¥èµ„ï¼‰\n5. è–ªèµ„ç»“ç®—æˆªæ­¢æ—¥ã€å¹´å‡æŠ˜ç®—ã€ç¤¾ä¿å…¬ç§¯é‡‘æˆªæ­¢æœˆ\n6. ç»æµè¡¥å¿é‡‘å®‰æ’ï¼ˆå¼•ç”¨ç¬¬47æ¡ï¼‰\n7. å·¥ä½œäº¤æ¥è¦æ±‚ä¸æœŸé™\n8. å‘˜å·¥æƒåˆ©å‘ŠçŸ¥ï¼ˆå¦‚å¯¹è§£é™¤æœ‰å¼‚è®®ï¼Œå¯åœ¨ä¸€å¹´å†…ç”³è¯·åŠ³åŠ¨ä»²è£ï¼‰\n9. ç­¾æ”¶ç¡®è®¤æ ï¼ˆå«"æœ¬äººå·²æ”¶åˆ°å¹¶é˜…è¯»ä¸Šè¿°é€šçŸ¥"å­—æ ·ã€ç­¾åã€æ—¥æœŸï¼‰\n10. è½æ¬¾ï¼šå…¬å¸åç§°ã€å…¬ç« ä½ç½®ã€æ—¥æœŸ`,
    compensation_confirm: `è¯·ç”Ÿæˆä¸€ä»½æ­£å¼çš„ã€Šç»æµè¡¥å¿é‡‘ç¡®è®¤å•ã€‹ã€‚\n\n${hdr}\nN=${N}\n${st.compensationPlan ? "é€‰å®šæ–¹æ¡ˆï¼š" + st.compensationPlan.title : ""}\n\nè¦æ±‚ï¼š\n1. æ ‡é¢˜å’Œç¼–å·\n2. è¯¦ç»†è®¡ç®—è¿‡ç¨‹è¡¨æ ¼å½¢å¼ï¼š\n   - å·¥ä½œå¹´é™ï¼š${emp.workYears}å¹´ï¼Œè®¡ä¸º${N}ä¸ªæœˆ\n   - æœˆå·¥èµ„åŸºæ•°ï¼šÂ¥${Math.min(emp.monthlySalary, emp.socialInsuranceBase).toLocaleString()}ï¼ˆå–è§£é™¤å‰12ä¸ªæœˆå¹³å‡å·¥èµ„ï¼Œæ³¨æ˜æ˜¯å¦è§¦å‘å½“åœ°ç¤¾å¹³å·¥èµ„3å€å°é¡¶ï¼Œå½“åœ°ä¸Šå¹´åº¦èŒå·¥æœˆå¹³å‡å·¥èµ„æŒ‰Â¥12000è®¡ç®—å‚è€ƒï¼‰\n   - ç»æµè¡¥å¿é‡‘ï¼š${N} Ã— Â¥${Math.min(emp.monthlySalary, emp.socialInsuranceBase).toLocaleString()} = Â¥${(N * Math.min(emp.monthlySalary, emp.socialInsuranceBase)).toLocaleString()}\n   - ä»£é€šçŸ¥é‡‘ï¼ˆå¦‚é€‚ç”¨ï¼‰ï¼š1 Ã— Â¥${Math.min(emp.monthlySalary, emp.socialInsuranceBase).toLocaleString()}\n   - åˆè®¡é‡‘é¢\n3. å¼•ç”¨ã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬47æ¡åŸæ–‡è¦ç‚¹\n4. æ”¯ä»˜æ–¹å¼ï¼ˆé“¶è¡Œè½¬è´¦ï¼‰å’Œæ—¶é—´ï¼ˆè§£é™¤ä¹‹æ—¥èµ·15ä¸ªå·¥ä½œæ—¥å†…ï¼‰\n5. ä¸ªäººæ‰€å¾—ç¨å¤„ç†è¯´æ˜\n6. åŒæ–¹ç­¾å­—ç¡®è®¤æ `,
    negotiation_agreement: `è¯·ç”Ÿæˆä¸€ä»½æ­£å¼çš„ã€Šåå•†è§£é™¤åŠ³åŠ¨åˆåŒåè®®ä¹¦ã€‹ã€‚\n\n${hdr}\n${st.compensationPlan ? "è¡¥å¿æ–¹æ¡ˆï¼š" + st.compensationPlan.title : ""}\n${emp.hasEquity ? "æœŸæƒæƒ…å†µï¼š" + emp.equityDetail + "ï¼Œå¤„ç†æ–¹å¼ï¼š" + (st.specialItems?.equity === "buyback" ? "å…¬å¸æŒ‰çº¦å®šä»·æ ¼å›è´­" : st.specialItems?.equity === "accelerate" ? "éƒ¨åˆ†åŠ é€Ÿå½’å±" : "æŒ‰åŸåè®®è‡ªç„¶å¤±æ•ˆ") : ""}\n${emp.nonCompete ? "ç«ä¸šé™åˆ¶ï¼šå·²ç­¾è®¢ç«ä¸šé™åˆ¶åè®®" : ""}\n\nè¦æ±‚ï¼š\n1. åè®®ç¼–å·\n2. é‰´äºæ¡æ¬¾ï¼šè¯´æ˜åŒæ–¹ç»å‹å¥½åå•†ä¸€è‡´\n3. ç¬¬ä¸€æ¡ï¼šè§£é™¤æ—¥æœŸ\n4. ç¬¬äºŒæ¡ï¼šç»æµè¡¥å¿æ¡æ¬¾ï¼ˆå…·ä½“é‡‘é¢ã€æ”¯ä»˜æ–¹å¼ã€æ—¶é—´ï¼‰\n5. ç¬¬ä¸‰æ¡ï¼šå·¥èµ„ç»“ç®—ä¸å¹´å‡æŠ˜ç®—\n6. ç¬¬å››æ¡ï¼šå·¥ä½œäº¤æ¥ï¼ˆæœŸé™ã€å†…å®¹ã€äº¤æ¥äººï¼‰\n7. ç¬¬äº”æ¡ï¼šä¿å¯†ä¹‰åŠ¡ï¼ˆç¦»èŒåç»§ç»­æœ‰æ•ˆï¼‰\n${emp.nonCompete ? "8. ç¬¬Xæ¡ï¼šç«ä¸šé™åˆ¶ï¼ˆç¡®è®¤ç”Ÿæ•ˆã€è¡¥å¿é‡‘é¢Â¥" + (emp.monthlySalary * 0.3).toLocaleString() + "/æœˆã€æœŸé™12ä¸ªæœˆã€è¿çº¦é‡‘ï¼‰" : ""}\n${emp.hasEquity ? "9. ç¬¬Xæ¡ï¼šè‚¡æƒæ¿€åŠ±å¤„ç†ï¼ˆå·²å½’å±/æœªå½’å±åˆ†åˆ«å¤„ç†æ–¹å¼ï¼‰" : ""}\n10. æƒåˆ©æ”¾å¼ƒæ¡æ¬¾ï¼šåŒæ–¹ç¡®è®¤æœ¬åè®®ä¸ºå…¨éƒ¨å’Œæœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼Œä¹™æ–¹ç¡®è®¤ä¸å†å°±åŠ³åŠ¨å…³ç³»å‘ç”²æ–¹ä¸»å¼ å…¶ä»–æƒåˆ©\n11. äº‰è®®è§£å†³ï¼šåå•†â†’åŠ³åŠ¨ä»²è£\n12. åè®®ä»½æ•°ã€æ•ˆåŠ›\n13. åŒæ–¹ç­¾å­—ç›–ç« æ `,
    unilateral_decision: `è¯·ç”Ÿæˆä¸€ä»½æ­£å¼çš„ã€Šè§£é™¤åŠ³åŠ¨åˆåŒå†³å®šä¹¦ã€‹ï¼ˆå•æ–¹è§£é™¤ï¼‰ã€‚\n\n${hdr}\nPIPå‘¨æœŸï¼š${st.pipDuration||60}å¤©\n\nè¦æ±‚ï¼š\n1. æ–‡ä¹¦ç¼–å·\n2. äº‹å®éƒ¨åˆ†ï¼šè¯¦è¿°ç»©æ•ˆä¸è¾¾æ ‡çš„å…·ä½“è¡¨ç°ï¼ˆå¼•ç”¨ç»©æ•ˆè¯„çº§æ•°æ®B+â†’Bâ†’C+â†’Cï¼‰\n3. PIPè¿‡ç¨‹ï¼šè¯´æ˜å·²ç»™äºˆ${st.pipDuration||60}å¤©æ”¹å–„æœŸï¼Œæä¾›äº†åŸ¹è®­/è¾…å¯¼æ”¯æŒ\n4. è¯„ä¼°ç»“è®ºï¼šæ”¹å–„æœŸæ»¡ä»æœªè¾¾å²—ä½è¦æ±‚\n5. æ³•å¾‹ä¾æ®ï¼šã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬40æ¡ç¬¬ï¼ˆäºŒï¼‰é¡¹\n6. è§£é™¤å†³å®šï¼šæå‰30å¤©ä¹¦é¢é€šçŸ¥æˆ–é¢å¤–æ”¯ä»˜1ä¸ªæœˆå·¥èµ„\n7. ç»æµè¡¥å¿å®‰æ’\n8. å‘˜å·¥æƒåˆ©å‘ŠçŸ¥ï¼šå¯¹æœ¬å†³å®šæœ‰å¼‚è®®çš„ï¼Œå¯ä¾æ³•ç”³è¯·åŠ³åŠ¨ä»²è£\n9. å·¥ä¼šæ„è§ï¼šå·²äº‹å…ˆé€šçŸ¥å·¥ä¼šï¼ˆã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬43æ¡ï¼‰\n10. ç­¾æ”¶æ `,
    noncompete_confirm: `è¯·ç”Ÿæˆä¸€ä»½ã€Šç«ä¸šé™åˆ¶ä¹‰åŠ¡ç¡®è®¤å‡½ã€‹ã€‚\n\n${hdr}\n\nè¦æ±‚ï¼š\n1. ç¡®è®¤å‡½ç¼–å·\n2. ç¡®è®¤åŒæ–¹äºå…¥èŒæ—¶ç­¾è®¢çš„ç«ä¸šé™åˆ¶åè®®è‡ªç¦»èŒä¹‹æ—¥èµ·ç”Ÿæ•ˆ\n3. ç«ä¸šé™åˆ¶æœŸé™ï¼š12ä¸ªæœˆï¼ˆè‡ªåŠ³åŠ¨åˆåŒè§£é™¤ä¹‹æ—¥èµ·è®¡ç®—ï¼‰\n4. ç«ä¸šé™åˆ¶èŒƒå›´ï¼š\n   - ç«äº‰ä¼ä¸šæ¸…å•ï¼ˆåˆ—5-8å®¶è¡Œä¸šå†…ä¸»è¦ç«äº‰å¯¹æ‰‹ï¼Œç”¨[ç«å“A][ç«å“B]ç­‰æ›¿ä»£ï¼‰\n   - é™åˆ¶åœ°åŸŸèŒƒå›´\n   - é™åˆ¶è¡Œä¸ºèŒƒå›´\n5. ç«ä¸šé™åˆ¶è¡¥å¿é‡‘ï¼šÂ¥${(emp.monthlySalary * 0.3).toLocaleString()}/æœˆï¼Œå…±è®¡Â¥${(emp.monthlySalary * 0.3 * 12).toLocaleString()}ï¼ŒæŒ‰æœˆæ”¯ä»˜\n6. æ”¯ä»˜æ–¹å¼ï¼šæ¯æœˆXæ—¥å‰æ”¯ä»˜è‡³ä¹™æ–¹æŒ‡å®šé“¶è¡Œè´¦æˆ·\n7. ç”²æ–¹è¿ç»­3ä¸ªæœˆæœªæ”¯ä»˜çš„ï¼Œä¹™æ–¹æœ‰æƒè§£é™¤ç«ä¸šé™åˆ¶ä¹‰åŠ¡\n8. è¿çº¦è´£ä»»ï¼šè¿çº¦é‡‘ä¸ºå·²æ”¯ä»˜è¡¥å¿é‡‘æ€»é¢çš„Xå€\n9. ä¹™æ–¹å®šæœŸæŠ¥å‘Šä¹‰åŠ¡ï¼ˆæ¯æœˆæŠ¥å‘Šå°±ä¸šçŠ¶æ€ï¼‰\n10. åŒæ–¹ç­¾å­—ç¡®è®¤æ \nå¼•ç”¨ã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬23æ¡ã€ç¬¬24æ¡`,
    equity_confirm: `è¯·ç”Ÿæˆä¸€ä»½ã€Šè‚¡æƒæ¿€åŠ±å¤„ç†ç¡®è®¤ä¹¦ã€‹ã€‚\n\n${hdr}\næœŸæƒæƒ…å†µï¼š${emp.equityDetail}\nå¤„ç†æ–¹å¼ï¼š${st.specialItems?.equity === "buyback" ? "å…¬å¸å›è´­å·²å½’å±éƒ¨åˆ†" : st.specialItems?.equity === "accelerate" ? "éƒ¨åˆ†åŠ é€Ÿå½’å±ä½œä¸ºè¡¥å¿" : "æœªå½’å±éƒ¨åˆ†æŒ‰åŸåè®®æ¡æ¬¾å¤±æ•ˆ"}\n\nè¦æ±‚ï¼š\n1. ç¡®è®¤ä¹¦ç¼–å·\n2. ç¡®è®¤ä¹™æ–¹å‚ä¸çš„è‚¡æƒæ¿€åŠ±è®¡åˆ’åç§°å’Œæˆäºˆæ—¥æœŸ\n3. æˆªè‡³ç¦»èŒæ—¥çš„å½’å±æƒ…å†µï¼š\n   - å·²å½’å±è‚¡ä»½/æœŸæƒæ•°é‡åŠå¤„ç†\n   - æœªå½’å±è‚¡ä»½/æœŸæƒæ•°é‡åŠå¤„ç†\n4. ${st.specialItems?.equity === "buyback" ? "å›è´­ä»·æ ¼è®¡ç®—æ–¹å¼ã€æ”¯ä»˜æ—¶é—´" : st.specialItems?.equity === "accelerate" ? "åŠ é€Ÿå½’å±çš„æ•°é‡ã€æ¡ä»¶ã€è¡Œæƒå®‰æ’" : "å¤±æ•ˆæ¡æ¬¾å¼•ç”¨åŠç¡®è®¤"}\n5. ç¨åŠ¡å¤„ç†è¯´æ˜\n6. ä¿å¯†ä¹‰åŠ¡ï¼ˆä¸å¾—æ³„éœ²å…¬å¸ä¼°å€¼ç­‰ä¿¡æ¯ï¼‰\n7. åŒæ–¹ç¡®è®¤æ— å…¶ä»–è‚¡æƒäº‰è®®\n8. ç­¾å­—ç¡®è®¤æ `,
    handover_list: `è¯·ç”Ÿæˆä¸€ä»½è¯¦ç»†çš„ã€Šå·¥ä½œäº¤æ¥æ¸…å•ã€‹ã€‚\n\n${hdr}\n${emp.managesTeam ? "ç›´æ¥ä¸‹å±ï¼š" + emp.teamSize + "äºº" : ""}\n${emp.hasTrade ? "æ¶‰åŠå•†ä¸šä¿¡æ¯ï¼š" + emp.tradeDetail : ""}\n\nè¦æ±‚æŒ‰ä»¥ä¸‹åˆ†ç±»åˆ—å‡ºäº¤æ¥äº‹é¡¹ï¼ˆæ¯é¡¹æœ‰"äº¤æ¥å†…å®¹"ã€"æ¥æ”¶äºº"ã€"å®ŒæˆçŠ¶æ€"åˆ—ï¼‰ï¼š\n1. å·¥ä½œæ–‡æ¡£ä¸èµ„æ–™ï¼šé¡¹ç›®æ–‡æ¡£ã€æŠ€æœ¯æ–‡æ¡£ã€ä¼šè®®çºªè¦ã€å®¢æˆ·èµ„æ–™ç­‰\n2. è¿›è¡Œä¸­é¡¹ç›®ï¼šåˆ—å‡º3-5ä¸ªå…¸å‹é¡¹ç›®åç§°åŠå½“å‰çŠ¶æ€å’Œäº¤æ¥è¦æ±‚\n3. ç³»ç»Ÿè´¦å·ä¸æƒé™ï¼šé‚®ç®±ã€OAã€ä»£ç åº“ã€äº§å“ç®¡ç†å·¥å…·ã€äº‘æœåŠ¡ç­‰\n4. å®ç‰©èµ„äº§ï¼šç”µè„‘ã€æ‰‹æœºã€é—¨ç¦å¡ã€å·¥ç‰Œç­‰\n${emp.managesTeam ? "5. å›¢é˜Ÿç®¡ç†æƒç§»äº¤ï¼šç›´æ¥æ±‡æŠ¥å…³ç³»è°ƒæ•´ã€å›¢é˜Ÿæˆå‘˜1:1æ²Ÿé€šå®‰æ’ã€å›¢é˜ŸOKR/KPIç§»äº¤" : ""}\n${emp.hasTrade ? "6. æœºå¯†ä¿¡æ¯ç¡®è®¤ï¼šç¡®è®¤å·²å½’è¿˜/åˆ é™¤æ‰€æœ‰æœºå¯†èµ„æ–™çš„å‰¯æœ¬ï¼Œç­¾ç½²ä¿¡æ¯æ¸…é™¤ç¡®è®¤ä¹¦" : ""}\n7. è´¢åŠ¡ç»“ç®—ï¼šæŠ¥é”€å•æ®ã€å€Ÿæ¬¾å½’è¿˜ã€é¢„ç®—æƒé™\n8. å®¢æˆ·/å¤–éƒ¨å…³ç³»äº¤æ¥ï¼šéœ€é€šçŸ¥çš„å®¢æˆ·å’Œåˆä½œæ–¹åˆ—è¡¨\n\nåº•éƒ¨åŒ…å«ï¼šäº¤æ¥å®Œæˆç¡®è®¤æ ï¼ˆäº¤å‡ºäººã€æ¥æ”¶äººã€ç›‘äº¤äººä¸‰æ–¹ç­¾å­—ï¼‰ã€äº¤æ¥æœŸé™`,
    separation_cert: `è¯·ç”Ÿæˆä¸€ä»½ã€Šç¦»èŒè¯æ˜ã€‹ã€‚\n\n${hdr}\n\nè¦æ±‚ä¸¥æ ¼éµå®ˆã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬50æ¡çš„è§„å®šï¼š\n1. æ ¼å¼æ­£å¼ç®€æ´\n2. å¿…é¡»åŒ…å«ï¼šåŠ³åŠ¨åˆåŒæœŸé™ã€è§£é™¤æˆ–ç»ˆæ­¢æ—¥æœŸã€å·¥ä½œå²—ä½ã€åœ¨æœ¬å•ä½çš„å·¥ä½œå¹´é™\n3. é‡è¦ï¼šä¸å¾—è®°è½½å¯¹åŠ³åŠ¨è€…ä¸åˆ©çš„å†…å®¹ï¼ˆä¸å†™ç»©æ•ˆè¯„ä»·ã€ä¸å†™è§£é™¤åŸå› ã€ä¸å†™PIPï¼‰\n4. ä»…å®¢è§‚é™ˆè¿°äº‹å®\n5. è½æ¬¾ï¼šå…¬å¸å…¨ç§°ã€å…¬ç« ä½ç½®ã€å‡ºå…·æ—¥æœŸ\n6. ç¼–å·\n\næ³¨æ„ï¼šè¿™æ˜¯æ³•å®šå¿…é¡»å‡ºå…·çš„æ–‡ä»¶ï¼Œå†…å®¹è¦ä¸­æ€§å®¢è§‚ï¼Œä»…è¯æ˜åŠ³åŠ¨å…³ç³»å­˜ç»­æœŸé—´çš„åŸºæœ¬äº‹å®ã€‚`,
  };
  return P[key] || `è¯·ç”Ÿæˆ${DOC_NAMES[key]}ã€‚\n\n${hdr}`;
};

// ===== Step: Final Docs =====
const StepFinalDocs = ({ state, emp, onNext }) => {
  const [contents, setContents] = useState({});
  const [loadMap, setLoadMap] = useState({});
  const [expandMap, setExpandMap] = useState({});
  const [batchRunning, setBatchRunning] = useState(false);
  const batchRef = useRef(false);

  const docList = [
    { key: "termination_notice", icon: "ğŸ“„" },
    { key: "compensation_confirm", icon: "ğŸ’°" },
    { key: state.decisionPath === "negotiate" ? "negotiation_agreement" : "unilateral_decision", icon: "ğŸ¤" },
    ...(emp?.nonCompete ? [{ key: "noncompete_confirm", icon: "ğŸ”’" }] : []),
    ...(emp?.hasEquity && state.specialItems?.equity ? [{ key: "equity_confirm", icon: "ğŸ¦" }] : []),
    { key: "handover_list", icon: "ğŸ“‹" },
    { key: "separation_cert", icon: "ğŸ“œ" },
  ];

  const genSingle = async (key, force) => {
    if (contents[key] && !force) { setExpandMap(p => ({ ...p, [key]: !p[key] })); return; }
    setLoadMap(p => ({ ...p, [key]: true }));
    setExpandMap(p => ({ ...p, [key]: true }));
    if (force) setContents(p => { const n = { ...p }; delete n[key]; return n; });
    try {
      const txt = await orChat(
        "ä½ æ˜¯ä¸€ä½èµ„æ·±HRæ³•å¾‹é¡¾é—®å…¼æ³•å¾‹æ–‡ä¹¦ä¸“å®¶ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä¸­å›½åŠ³åŠ¨æ³•è§„å®šç”Ÿæˆæ­£å¼æ³•å¾‹æ–‡ä¹¦ã€‚ç›´æ¥è¾“å‡ºæ–‡ä¹¦å…¨æ–‡æ­£æ–‡ã€‚ä¸è¦è¾“å‡ºJSONã€markdownä»£ç å—ã€é¢å¤–è¯´æ˜æˆ–å¯’æš„è¯­ã€‚æ³¨æ„è¿™æ˜¯æ¼”ç¤ºç”¨é€”ï¼Œå…¬å¸åç§°ç”¨[ç¤ºä¾‹ç§‘æŠ€æœ‰é™å…¬å¸]æ›¿ä»£ã€‚",
        buildDocPrompt(key, emp, state), 3000
      );
      setContents(p => ({ ...p, [key]: txt.replace(/```/g, "").trim() }));
    } catch {
      setContents(p => ({ ...p, [key]: `âš ï¸ ${DOC_NAMES[key]} ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç‚¹å‡»"ğŸ”„ é‡æ–°ç”Ÿæˆ"é‡è¯•ã€‚` }));
    }
    setLoadMap(p => ({ ...p, [key]: false }));
  };

  const genAll = async () => {
    setBatchRunning(true); batchRef.current = true;
    for (const d of docList) {
      if (!batchRef.current) break;
      if (!contents[d.key]) {
        setLoadMap(p => ({ ...p, [d.key]: true }));
        setExpandMap(p => ({ ...p, [d.key]: true }));
        try {
          const txt = await orChat(
            "ä½ æ˜¯ä¸€ä½èµ„æ·±HRæ³•å¾‹é¡¾é—®å…¼æ³•å¾‹æ–‡ä¹¦ä¸“å®¶ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä¸­å›½åŠ³åŠ¨æ³•è§„å®šç”Ÿæˆæ­£å¼æ³•å¾‹æ–‡ä¹¦ã€‚ç›´æ¥è¾“å‡ºæ–‡ä¹¦å…¨æ–‡æ­£æ–‡ã€‚ä¸è¦è¾“å‡ºJSONã€markdownä»£ç å—ã€é¢å¤–è¯´æ˜æˆ–å¯’æš„è¯­ã€‚æ³¨æ„è¿™æ˜¯æ¼”ç¤ºç”¨é€”ï¼Œå…¬å¸åç§°ç”¨[ç¤ºä¾‹ç§‘æŠ€æœ‰é™å…¬å¸]æ›¿ä»£ã€‚",
            buildDocPrompt(d.key, emp, state), 3000
          );
          setContents(p => ({ ...p, [d.key]: txt.replace(/```/g, "").trim() }));
        } catch {
          setContents(p => ({ ...p, [d.key]: `âš ï¸ ${DOC_NAMES[d.key]} ç”Ÿæˆå¤±è´¥ã€‚` }));
        }
        setLoadMap(p => ({ ...p, [d.key]: false }));
      }
    }
    setBatchRunning(false); batchRef.current = false;
  };

  const stopBatch = () => { batchRef.current = false; setBatchRunning(false); };

  const doneCount = docList.filter(d => contents[d.key]).length;
  const allDone = doneCount === docList.length;

  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between mb-1">
        <div className="text-xs text-gray-500">å…± {docList.length} ä»½æ–‡ä¹¦ Â· å·²ç”Ÿæˆ {doneCount}</div>
        {batchRunning ? (
          <button onClick={stopBatch} className="text-xs px-3 py-1 rounded-lg bg-red-100 text-red-600 hover:bg-red-200">â¹ åœæ­¢ç”Ÿæˆ</button>
        ) : (
          <button onClick={genAll} disabled={allDone}
            className={`text-xs px-3 py-1 rounded-lg transition-all ${allDone ? "bg-green-100 text-green-600" : "bg-blue-100 text-blue-600 hover:bg-blue-200"}`}>
            {allDone ? "âœ… å…¨éƒ¨å°±ç»ª" : "ğŸ¤– ä¸€é”®ç”Ÿæˆå…¨éƒ¨"}
          </button>
        )}
      </div>

      {/* progress bar */}
      <div className="h-1.5 bg-gray-100 rounded-full overflow-hidden">
        <div className="h-full bg-emerald-500 rounded-full transition-all duration-500" style={{ width: `${(doneCount / docList.length) * 100}%` }} />
      </div>

      {docList.map(d => (
        <div key={d.key} className="border border-gray-200 rounded-xl overflow-hidden">
          <button onClick={() => genSingle(d.key)}
            className="w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors text-left">
            <div className="flex items-center gap-2 text-sm">
              <span>{d.icon}</span>
              <span className="font-medium">{DOC_NAMES[d.key]}</span>
            </div>
            <div className="flex items-center gap-2">
              {loadMap[d.key] && <span className="animate-spin text-xs">â³</span>}
              <Badge color={contents[d.key] ? (contents[d.key].startsWith("âš ï¸") ? "red" : "green") : "gray"}>
                {contents[d.key] ? (contents[d.key].startsWith("âš ï¸") ? "å¤±è´¥" : "å·²ç”Ÿæˆ") : "ç‚¹å‡»ç”Ÿæˆ"}
              </Badge>
              <span className="text-gray-300 text-xs">{expandMap[d.key] ? "â–¼" : "â–¶"}</span>
            </div>
          </button>
          {expandMap[d.key] && (
            <div className="border-t border-gray-100 bg-gray-50">
              {loadMap[d.key] ? (
                <div className="text-center text-sm text-blue-600 py-8">
                  <span className="animate-spin inline-block mr-2">ğŸ¤–</span>æ­£åœ¨ç”Ÿæˆã€Š{DOC_NAMES[d.key]}ã€‹...
                  <div className="text-xs text-gray-400 mt-1">AIæ ¹æ®æ¡ˆä»¶ä¿¡æ¯æ’°å†™ä¸­ï¼Œè¯·ç¨å€™</div>
                </div>
              ) : contents[d.key] ? (
                <div className="p-3 space-y-2">
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-xs text-gray-800 leading-relaxed whitespace-pre-wrap max-h-80 overflow-y-auto" style={{ fontFamily: "SimSun, serif, system-ui" }}>
                    {contents[d.key]}
                  </div>
                  <div className="flex items-center gap-3 pt-1">
                    <button onClick={(e) => { e.stopPropagation(); genSingle(d.key, true); }}
                      className="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                    <button onClick={(e) => { e.stopPropagation(); navigator.clipboard?.writeText(contents[d.key]); }}
                      className="text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1">ğŸ“‹ å¤åˆ¶å†…å®¹</button>
                    <span className="text-xs text-gray-300 ml-auto">çº¦{contents[d.key].length}å­—</span>
                  </div>
                </div>
              ) : null}
            </div>
          )}
        </div>
      ))}

      <div className="bg-amber-50 p-3 rounded-xl text-xs text-amber-700 space-y-1">
        <div>âš ï¸ é‡è¦æç¤ºï¼š</div>
        <div>â€¢ ä»¥ä¸Šæ–‡ä¹¦ä¸ºAIæ ¹æ®æ¡ˆä»¶ä¿¡æ¯ç”Ÿæˆçš„å‚è€ƒç‰ˆæœ¬ï¼Œéœ€ç»æ³•å¾‹é¡¾é—®å®¡æ ¸åæ–¹å¯ä½¿ç”¨</div>
        <div>â€¢ æ­£å¼ç­¾ç½²å‰åº”ç”±å…¬å¸æ³•åŠ¡éƒ¨é—¨æ ¡å¯¹æ‰€æœ‰æ³•å¾‹æ¡æ¬¾å¼•ç”¨å’Œé‡‘é¢è®¡ç®—</div>
        <div>â€¢ å»ºè®®ç­¾ç½²è¿‡ç¨‹å…¨ç¨‹å½•éŸ³/å½•åƒï¼Œå®‰æ’ç¬¬ä¸‰æ–¹è§è¯äººåœ¨åœº</div>
        <div>â€¢ å‘˜å·¥æ‹’ç­¾æ—¶åº”é‡‡å–å½“é¢å®£è¯»+EMSé‚®å¯„+ç”µå­é€è¾¾å¹¶è¡Œæ–¹å¼</div>
      </div>

      <button onClick={() => onNext({ docsGenerated: true, docContents: contents })}
        disabled={!allDone}
        className={`w-full py-2.5 rounded-xl text-sm font-medium transition-all ${allDone ? "bg-emerald-600 text-white hover:bg-emerald-700" : "bg-gray-200 text-gray-400 cursor-not-allowed"}`}>
        {allDone ? "âœ… ç¡®è®¤å…¨éƒ¨æ–‡ä¹¦å¹¶å®Œæˆæµç¨‹" : `è¯·å…ˆç”Ÿæˆå…¨éƒ¨æ–‡ä¹¦ï¼ˆ${doneCount}/${docList.length}ï¼‰`}
      </button>
    </div>
  );
};

// ===== Step: Result =====
const StepResult = ({ state, type, emp, counselLog }) => {
  const msgs = {
    result_terminated: { icon: "ğŸ", title: "åŠ³åŠ¨åˆåŒè§£é™¤æµç¨‹å®Œæˆ", color: "blue" },
    result_transferred: { icon: "ğŸ”„", title: "å‘˜å·¥è°ƒå²—å®‰æ’å®Œæˆ", color: "green" },
    result_improved: { icon: "ğŸ‰", title: "ç»©æ•ˆæ”¹å–„è¾¾æ ‡", color: "emerald" },
  };
  const m = msgs[type] || msgs.result_terminated;
  const counselCount = Object.keys(counselLog || {}).length;
  const adoptedCount = Object.values(counselLog || {}).filter(v => v === "accept").length;

  return (
    <div className="space-y-4 py-2">
      <div className="text-center text-3xl mb-2">{m.icon}</div>
      <div className="text-center font-bold text-lg text-gray-800">{m.title}</div>
      <div className="bg-gray-50 rounded-xl p-4 text-xs text-gray-600 space-y-2">
        <div>å‘˜å·¥ï¼š{emp?.name} ({emp?.empId})</div>
        {state.compensationPlan && <div>è¡¥å¿æ–¹æ¡ˆï¼š{state.compensationPlan.title}</div>}
        {state.decisionPath && <div>å¤„ç†è·¯å¾„ï¼š{state.decisionPath === "negotiate" ? "åå•†è§£é™¤" : state.decisionPath === "unilateral" ? "å•æ–¹è§£é™¤" : "è°ƒå²—"}</div>}
        {state.arbitrationAssessment && (
          <div>ä»²è£é£é™©è¯„çº§ï¼š{state.arbitrationAssessment.overallRisk} Â· é¢„ä¼°èƒœè¯‰ç‡ {state.arbitrationAssessment.winRate}</div>
        )}
        <div className="pt-2 border-t border-gray-200">
          æ³•å¾‹é¡¾é—®å’¨è¯¢ï¼šå…±{counselCount}æ­¥ Â· é‡‡çº³{adoptedCount}æ¬¡
        </div>
        <div className="pt-2 text-gray-400">å…¨éƒ¨æµç¨‹è®°å½•å·²å½’æ¡£ï¼Œå¯åœ¨æ¡ˆä»¶ç®¡ç†ç³»ç»Ÿä¸­æŸ¥é˜…</div>
      </div>
      {type === "result_terminated" && (
        <div className="bg-blue-50 rounded-xl p-3 text-xs text-blue-700">
          ğŸ“Œ åç»­æ³¨æ„äº‹é¡¹ï¼šä¿ç•™å…¨éƒ¨åŸå§‹è¯æ®è‡³å°‘2å¹´ï¼ˆä»²è£æ—¶æ•ˆ1å¹´ï¼‰ã€‚å¦‚æ”¶åˆ°ä»²è£ç”³è¯·ï¼Œç«‹å³è”ç³»æ³•å¾‹é¡¾é—®å‡†å¤‡ç­”è¾©ææ–™ã€‚
        </div>
      )}
    </div>
  );
};

// ===== Main App =====
function App() {
  const [curId, setCurId] = useState("employee_select");
  const [state, setState] = useState({});
  const [emp, setEmp] = useState(null);
  const [history, setHistory] = useState([]);
  const [counselLog, setCounselLog] = useState({});
  const ref = useRef(null);
  const [apiKey, setApiKey] = useState("");
  const [modelName, setModelName] = useState("");
  const [cfgReady, setCfgReady] = useState(false);
  const [cfgCollapsed, setCfgCollapsed] = useState(false);

  const applyConfig = () => {
    setCfg(apiKey.trim(), modelName.trim());
    setCfgReady(hasCfg());
    if (hasCfg()) setCfgCollapsed(true);
  };

  const node = NODES[curId];

  const advance = useCallback((payload) => {
    const ns = { ...state, ...payload };
    if (payload?.employee) setEmp(payload.employee);
    setState(ns);
    const next = getNextNode(curId, ns);
    if (next) {
      setHistory(h => [...h, { id: curId, label: node.label, icon: node.icon, ts: new Date().toLocaleTimeString() }]);
      setCurId(next);
      setTimeout(() => ref.current?.scrollIntoView({ behavior: "smooth" }), 100);
    }
  }, [curId, node, state]);

  const timeTravel = (idx) => {
    setHistory(h => h.slice(0, idx));
    setCurId(history[idx].id);
  };

  const handleCounsel = (stepId, decision) => {
    setCounselLog(p => ({ ...p, [stepId]: decision }));
  };

  const isResult = curId?.startsWith("result_");
  const showCounsel = !isResult && !["employee_select", "employee_info"].includes(curId);

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 p-3">
      <div className="max-w-lg mx-auto">
        <div className="text-center mb-4 pt-2">
          <h1 className="text-lg font-bold text-gray-800">âš–ï¸ ç»©æ•ˆæ”¹å–„ â†’ è§£é™¤åŠ³åŠ¨åˆåŒ</h1>
          <p className="text-xs text-gray-500 mt-1">AIè¾…åŠ© Â· æ³•å¾‹åˆè§„ Â· ä»²è£é˜²å¾¡ Â· å…¨æµç¨‹ç®¡ç†</p>
          {emp && (
            <div className="mt-2 inline-flex items-center gap-2 bg-white px-3 py-1 rounded-full shadow-sm border text-xs">
              <span>ğŸ‘¤ {emp.name}</span>
              <Badge color="blue">{emp.level}</Badge>
              <span className="text-gray-400">Â¥{emp.monthlySalary.toLocaleString()}/æœˆ</span>
            </div>
          )}
        </div>

        {/* API Config Panel */}
        <div className={`mb-4 rounded-2xl border overflow-hidden transition-all ${cfgReady ? "bg-emerald-50 border-emerald-200" : "bg-white border-amber-300 shadow-lg"}`}>
          <button onClick={() => setCfgCollapsed(!cfgCollapsed)}
            className="w-full flex items-center justify-between p-3 text-left hover:bg-gray-50 transition-colors">
            <div className="flex items-center gap-2 text-sm font-medium">
              <span>{cfgReady ? "ğŸŸ¢" : "ğŸ”´"}</span>
              <span className={cfgReady ? "text-emerald-700" : "text-amber-700"}>
                {cfgReady ? `å·²è¿æ¥ Â· ${getCfg().model}` : "è¯·å…ˆé…ç½® OpenRouter API"}
              </span>
            </div>
            <span className="text-xs text-gray-400">{cfgCollapsed ? "â–¶ å±•å¼€" : "â–¼ æ”¶èµ·"}</span>
          </button>
          {!cfgCollapsed && (
            <div className="px-4 pb-4 space-y-3 border-t border-gray-100 pt-3">
              {!cfgReady && (
                <div className="text-xs text-amber-600 bg-amber-50 p-2 rounded-lg">
                  âš ï¸ æœ¬åº”ç”¨æ‰€æœ‰AIåŠŸèƒ½ä¾èµ– OpenRouter APIã€‚è¯·å¡«å…¥æ‚¨çš„ API Key å’Œæ¨¡å‹åç§°åæ‰èƒ½ä½¿ç”¨å…¨éƒ¨åŠŸèƒ½ã€‚æœªé…ç½®æ—¶å°†ä½¿ç”¨é™æ€å¤‡ç”¨æ•°æ®ã€‚
                </div>
              )}
              <div>
                <label className="text-xs text-gray-500 font-medium block mb-1">OpenRouter API Key</label>
                <input type="password" value={apiKey} onChange={e => { setApiKey(e.target.value); setCfgReady(false); }}
                  placeholder="sk-or-v1-..."
                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:border-blue-400 focus:outline-none font-mono" />
              </div>
              <div>
                <label className="text-xs text-gray-500 font-medium block mb-1">æ¨¡å‹åç§°</label>
                <input type="text" value={modelName} onChange={e => { setModelName(e.target.value); setCfgReady(false); }}
                  placeholder="ä¾‹å¦‚ openrouter/pony-alpha æˆ– anthropic/claude-sonnet-4"
                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:border-blue-400 focus:outline-none font-mono" />
              </div>
              <div className="flex items-center gap-3">
                <button onClick={applyConfig}
                  disabled={!apiKey.trim() || !modelName.trim()}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${apiKey.trim() && modelName.trim() ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-400 cursor-not-allowed"}`}>
                  âœ… ç¡®è®¤é…ç½®
                </button>
                {cfgReady && <span className="text-xs text-emerald-600">âœ“ å·²ç”Ÿæ•ˆ</span>}
              </div>
              <div className="text-xs text-gray-400 space-y-0.5">
                <div>ğŸ”’ API Key ä»…åœ¨å½“å‰é¡µé¢å†…å­˜ä¸­ä½¿ç”¨ï¼Œä¸ä¼šå­˜å‚¨æˆ–å‘é€åˆ°ç¬¬ä¸‰æ–¹</div>
                <div>ğŸ“¡ API è¯·æ±‚ç›´æ¥ä»æ‚¨çš„æµè§ˆå™¨å‘é€åˆ° OpenRouter æœåŠ¡å™¨</div>
                <div>ğŸ’¡ è·å– API Keyï¼š<span className="text-blue-500">openrouter.ai/keys</span></div>
              </div>
            </div>
          )}
        </div>

        {/* Counsel Score Bar */}
        {Object.keys(counselLog).length > 0 && (
          <div className="mb-3 bg-white rounded-xl shadow-sm border p-2 flex items-center gap-2">
            <span className="text-xs text-gray-500">âš–ï¸ æ³•å¾‹åˆè§„æŒ‡æ•°</span>
            <div className="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
              <div className="h-full rounded-full transition-all" style={{
                width: `${Math.round((Object.values(counselLog).filter(v => v === "accept").length * 100 + Object.values(counselLog).filter(v => v === "partial").length * 50) / (Object.keys(counselLog).length * 100) * 100)}%`,
                backgroundColor: Object.values(counselLog).some(v => v === "reject") ? "#f59e0b" : "#10b981"
              }} />
            </div>
            <span className="text-xs font-medium">
              {Math.round((Object.values(counselLog).filter(v => v === "accept").length * 100 + Object.values(counselLog).filter(v => v === "partial").length * 50) / (Object.keys(counselLog).length * 100) * 100)}%
            </span>
          </div>
        )}

        {/* History */}
        {history.length > 0 && (
          <div className="mb-4 bg-white rounded-2xl shadow-sm border p-3">
            <div className="text-xs font-medium text-gray-500 mb-2">ğŸ“ å·²å®Œæˆæ­¥éª¤ï¼ˆç‚¹å‡»å¯å›æº¯ï¼‰</div>
            <div className="space-y-1">
              {history.map((h, i) => (
                <button key={i} onClick={() => timeTravel(i)}
                  className="w-full flex items-center gap-2 text-left px-2 py-1.5 rounded-lg hover:bg-blue-50 transition-colors group">
                  <span className="w-5 h-5 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs">âœ”</span>
                  <span className="text-xs text-gray-600 flex-1">{h.icon} {h.label}</span>
                  {counselLog[h.id] && (
                    <Badge color={counselLog[h.id] === "accept" ? "green" : counselLog[h.id] === "partial" ? "amber" : "red"}>
                      {counselLog[h.id] === "accept" ? "å¾‹" : counselLog[h.id] === "partial" ? "å¾‹Â½" : "å¾‹âœ—"}
                    </Badge>
                  )}
                  <span className="text-xs text-gray-300 group-hover:text-blue-500">âª</span>
                </button>
              ))}
            </div>
          </div>
        )}

        {/* Current Step */}
        <div ref={ref} className={`bg-white rounded-2xl shadow-lg border overflow-hidden ${isResult ? "border-emerald-200" : "border-gray-100"}`}>
          <div className={`p-4 border-b ${isResult ? "bg-gradient-to-r from-emerald-50 to-green-50 border-emerald-100" : "bg-gradient-to-r from-white to-blue-50 border-gray-100"}`}>
            <div className="flex items-center gap-2 mb-1">
              <Badge color={isResult ? "green" : "blue"}>{node?.phase}</Badge>
              <span className="text-xs text-gray-400">æ­¥éª¤ {history.length + 1}</span>
            </div>
            <h2 className="text-base font-bold text-gray-800">{node?.icon} {node?.label}</h2>
            <p className="text-xs text-gray-500 mt-0.5">{node?.desc}</p>
          </div>
          <div className="p-4">
            {curId === "employee_select" && <StepEmployeeSelect onNext={advance} />}
            {curId === "employee_info" && emp && <StepEmployeeInfo emp={emp} profile={state.aiProfile} onNext={advance} />}
            {curId === "pip_reason" && <StepPipReason onNext={advance} />}
            {curId === "pip_plan" && (
              <LLMOptions type="pip_plan" context={{ name: emp?.name, ratings: emp?.recentRatings?.join("â†’"), position: emp?.position, level: emp?.level, workYears: emp?.workYears, issues: state.reasons?.join("ï¼›") }}
                onSelect={opt => advance({ pipPlan: opt, pipDuration: opt.duration || (opt.id === 1 ? 60 : opt.id === 2 ? 90 : 30) })} />
            )}
            {curId === "pip_notify" && (
              <LLMOptions type="notification_draft" context={{ name: emp?.name, duration: state.pipDuration, level: emp?.level }}
                onSelect={opt => advance({ notification: opt })} />
            )}
            {curId === "pip_monitor" && (
              <div className="space-y-3">
                <div className="bg-blue-50 p-3 rounded-xl text-xs text-blue-700">ğŸ“… æ”¹å–„æœŸï¼š{state.pipDuration || 60}å¤© | å»ºè®®æ¯ä¸¤å‘¨è¿›è¡Œä¸€æ¬¡reviewå¹¶è®°å½•</div>
                <div className="bg-amber-50 p-3 rounded-xl text-xs text-amber-700">ğŸ“ è¯æ®æç¤ºï¼šæ¯æ¬¡reviewé¡»æœ‰ä¹¦é¢çºªè¦ã€åŒæ–¹ç­¾å­—ã€‚è·Ÿè¸ªæ•°æ®åº”å®¢è§‚é‡åŒ–ï¼Œé¿å…ä¸»è§‚è¯„ä»·ã€‚</div>
                <textarea placeholder="è®°å½•æœ¬æ¬¡è·Ÿè¸ªè¦ç‚¹ï¼ˆæ—¥æœŸã€å…·ä½“è¡¨ç°ã€æ•°æ®æŒ‡æ ‡ï¼‰..." className="w-full h-24 p-3 border border-gray-200 rounded-xl text-sm focus:border-blue-400 focus:outline-none resize-none" />
                <button onClick={() => advance({ monitoring: "recorded" })} className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">æ”¹å–„æœŸç»“æŸï¼Œè¿›å…¥è¯„ä¼°</button>
              </div>
            )}
            {curId === "pip_eval" && (
              <div className="space-y-3">
                <LLMOptions type="eval_result" context={{ name: emp?.name, duration: state.pipDuration, position: emp?.position, level: emp?.level }}
                  onSelect={opt => advance({ evalResult: opt.id === 2 ? "partial" : "fail", evalDetail: opt })} />
                <button onClick={() => advance({ evalResult: "pass" })} className="w-full py-2 border-2 border-dashed border-green-300 text-green-700 rounded-xl text-sm hover:bg-green-50">âœ… å‘˜å·¥è¾¾æ ‡ï¼Œç»“æŸPIPæµç¨‹</button>
              </div>
            )}
            {curId === "decision" && <StepDecision state={state} onNext={advance} />}
            {curId === "termination_prep" && (
              <div className="space-y-3">
                <div className="text-xs text-gray-500 mb-2">ğŸ“‹ åˆè§„æ£€æŸ¥æ¸…å•ï¼ˆä»²è£å¿…æŸ¥é¡¹ï¼‰ï¼š</div>
                {[
                  ["ç»©æ•ˆè€ƒæ ¸åˆ¶åº¦ç»æ°‘ä¸»ç¨‹åºåˆ¶å®šå¹¶å…¬ç¤º", true],
                  ["PIPè®¡åˆ’å·²ä¹¦é¢é€šçŸ¥å¹¶ç­¾æ”¶", !!state.notification],
                  ["æ”¹å–„æœŸä¸å°‘äº30å¤©", (state.pipDuration || 0) >= 30],
                  ["è¯„ä¼°æ ‡å‡†äº‹å…ˆå‘ŠçŸ¥å‘˜å·¥", true],
                  ["è¯„ä¼°è¿‡ç¨‹æœ‰ä¹¦é¢è®°å½•", !!state.evalDetail],
                  ["ä¸å­˜åœ¨æ³•å®šä¸å¾—è§£é™¤çš„æƒ…å½¢(ç¬¬42æ¡)", !emp?.isPregnant && !emp?.nearRetirement && !emp?.hasWorkInjury],
                  ["å·¥ä¼šæ„è§å¾è¯¢ï¼ˆå¦‚æœ‰å·¥ä¼šï¼‰", true],
                ].map(([l, ok]) => (
                  <div key={l} className={`flex items-center gap-2 p-2.5 rounded-lg text-sm ${ok ? "bg-green-50 text-green-700" : "bg-red-50 text-red-700"}`}>
                    <span>{ok ? "âœ…" : "âŒ"}</span>{l}
                  </div>
                ))}
                <button onClick={() => advance({ complianceChecked: true })} className="w-full py-2.5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">åˆè§„æ£€æŸ¥é€šè¿‡ï¼Œä¸‹ä¸€æ­¥</button>
              </div>
            )}
            {curId === "compensation" && (
              <LLMOptions type="compensation" context={{ workYears: emp?.workYears, salary: emp?.monthlySalary, name: emp?.name, socialBase: emp?.socialInsuranceBase, equityDetail: emp?.equityDetail }}
                onSelect={opt => advance({ compensationPlan: opt })} />
            )}
            {curId === "special_handling" && <StepSpecialHandling emp={emp} state={state} onNext={advance} />}
            {curId === "arbitration_assess" && <StepArbitrationAssess state={state} emp={emp} counselLog={counselLog} onNext={advance} />}
            {curId === "final_docs" && <StepFinalDocs state={state} emp={emp} onNext={advance} />}
            {isResult && <StepResult state={state} type={curId} emp={emp} counselLog={counselLog} />}
          </div>

          {showCounsel && (
            <div className="px-4 pb-4">
              <LegalCounselPanel stepId={curId} stepName={node?.label} emp={emp} state={state}
                onAdvice={handleCounsel} counselLog={counselLog} />
            </div>
          )}
        </div>

        <div className="mt-4 text-center text-xs text-gray-400 space-y-1">
          <div>åŸºäºã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ã€ŠåŠ³åŠ¨äº‰è®®è°ƒè§£ä»²è£æ³•ã€‹ç­‰ Â· ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæ³•å¾‹æ„è§</div>
          <div>å…¨æµç¨‹ä»¥åº”å¯¹åŠ³åŠ¨ä»²è£/è¯‰è®¼ä¸ºå¯¼å‘è®¾è®¡ Â· æ”¯æŒä»ä»»æ„æ­¥éª¤å›æº¯</div>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
