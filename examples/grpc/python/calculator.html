<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gRPC Calculator Demo</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #4fc3f7;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 10px;
        }
        .file-section {
            background: #2d2d2d;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid #404040;
        }
        .file-header {
            background: #404040;
            padding: 12px 20px;
            color: #fff;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .file-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        .code-content {
            padding: 20px;
            background: #1e1e1e;
            overflow-x: auto;
        }
        pre {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .command-section {
            background: #0d47a1;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .step {
            background: #2e7d32;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: bold;
        }
        .keyword { color: #ff7043; }
        .string { color: #66bb6a; }
        .comment { color: #616161; font-style: italic; }
        .function { color: #42a5f5; }
        .number { color: #ab47bc; }
        
        .demo-controls {
            background: #424242;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .demo-controls button {
            background: #4fc3f7;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .demo-controls button:hover {
            background: #29b6f6;
        }
        .output {
            background: #1a1a1a;
            border: 1px solid #404040;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            min-height: 100px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 gRPC Calculator Service - Python3 Complete Demo</h1>
        
        <div class="step">步骤 1: 定义Protocol Buffer服务接口</div>
        
        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">📄</span>
                calculator.proto
            </div>
            <div class="code-content">
                <pre><code><span class="comment">// Protocol Buffer 定义文件</span>
<span class="keyword">syntax</span> = <span class="string">"proto3"</span>;

<span class="keyword">package</span> calculator;

<span class="comment">// 计算器服务定义</span>
<span class="keyword">service</span> <span class="function">Calculator</span> {
    <span class="comment">// 加法运算</span>
    <span class="keyword">rpc</span> <span class="function">Add</span>(<span class="function">BinaryOperation</span>) <span class="keyword">returns</span> (<span class="function">Result</span>);
    
    <span class="comment">// 减法运算</span>
    <span class="keyword">rpc</span> <span class="function">Subtract</span>(<span class="function">BinaryOperation</span>) <span class="keyword">returns</span> (<span class="function">Result</span>);
    
    <span class="comment">// 乘法运算</span>
    <span class="keyword">rpc</span> <span class="function">Multiply</span>(<span class="function">BinaryOperation</span>) <span class="keyword">returns</span> (<span class="function">Result</span>);
    
    <span class="comment">// 除法运算</span>
    <span class="keyword">rpc</span> <span class="function">Divide</span>(<span class="function">BinaryOperation</span>) <span class="keyword">returns</span> (<span class="function">Result</span>);
    
    <span class="comment">// 流式计算 - 发送多个运算，返回运算历史</span>
    <span class="keyword">rpc</span> <span class="function">CalculateStream</span>(<span class="keyword">stream</span> <span class="function">BinaryOperation</span>) <span class="keyword">returns</span> (<span class="keyword">stream</span> <span class="function">Result</span>);
}

<span class="comment">// 二元运算消息</span>
<span class="keyword">message</span> <span class="function">BinaryOperation</span> {
    <span class="keyword">double</span> a = <span class="number">1</span>;
    <span class="keyword">double</span> b = <span class="number">2</span>;
    <span class="keyword">string</span> operation = <span class="number">3</span>; <span class="comment">// "add", "subtract", "multiply", "divide"</span>
}

<span class="comment">// 计算结果消息</span>
<span class="keyword">message</span> <span class="function">Result</span> {
    <span class="keyword">double</span> value = <span class="number">1</span>;
    <span class="keyword">string</span> message = <span class="number">2</span>;
    <span class="keyword">bool</span> success = <span class="number">3</span>;
}</code></pre>
            </div>
        </div>

        <div class="command-section">
            <h3>🔧 生成Python代码命令</h3>
            <pre><code># 安装依赖
pip install grpcio grpcio-tools

# 生成Python gRPC代码
python -m grpc_tools.protoc --proto_path=. --python_out=. --grpc_python_out=. calculator.proto</code></pre>
        </div>

        <div class="step">步骤 2: 实现gRPC服务端</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">🐍</span>
                calculator_server.py
            </div>
            <div class="code-content">
                <pre><code><span class="keyword">import</span> grpc
<span class="keyword">from</span> concurrent <span class="keyword">import</span> futures
<span class="keyword">import</span> time
<span class="keyword">import</span> logging

<span class="comment"># 导入生成的gRPC代码</span>
<span class="keyword">import</span> calculator_pb2
<span class="keyword">import</span> calculator_pb2_grpc

<span class="comment"># 配置日志</span>
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

<span class="keyword">class</span> <span class="function">CalculatorServicer</span>(calculator_pb2_grpc.CalculatorServicer):
    <span class="string">"""计算器服务实现"""</span>
    
    <span class="keyword">def</span> <span class="function">Add</span>(<span class="keyword">self</span>, request, context):
        <span class="string">"""加法运算"""</span>
        result = request.a + request.b
        logger.info(<span class="string">f"Add: {request.a} + {request.b} = {result}"</span>)
        
        <span class="keyword">return</span> calculator_pb2.Result(
            value=result,
            message=<span class="string">f"{request.a} + {request.b} = {result}"</span>,
            success=<span class="keyword">True</span>
        )
    
    <span class="keyword">def</span> <span class="function">Subtract</span>(<span class="keyword">self</span>, request, context):
        <span class="string">"""减法运算"""</span>
        result = request.a - request.b
        logger.info(<span class="string">f"Subtract: {request.a} - {request.b} = {result}"</span>)
        
        <span class="keyword">return</span> calculator_pb2.Result(
            value=result,
            message=<span class="string">f"{request.a} - {request.b} = {result}"</span>,
            success=<span class="keyword">True</span>
        )
    
    <span class="keyword">def</span> <span class="function">Multiply</span>(<span class="keyword">self</span>, request, context):
        <span class="string">"""乘法运算"""</span>
        result = request.a * request.b
        logger.info(<span class="string">f"Multiply: {request.a} * {request.b} = {result}"</span>)
        
        <span class="keyword">return</span> calculator_pb2.Result(
            value=result,
            message=<span class="string">f"{request.a} * {request.b} = {result}"</span>,
            success=<span class="keyword">True</span>
        )
    
    <span class="keyword">def</span> <span class="function">Divide</span>(<span class="keyword">self</span>, request, context):
        <span class="string">"""除法运算"""</span>
        <span class="keyword">if</span> request.b == <span class="number">0</span>:
            logger.warning(<span class="string">"Division by zero attempted"</span>)
            <span class="keyword">return</span> calculator_pb2.Result(
                value=<span class="number">0</span>,
                message=<span class="string">"错误：除数不能为零"</span>,
                success=<span class="keyword">False</span>
            )
        
        result = request.a / request.b
        logger.info(<span class="string">f"Divide: {request.a} / {request.b} = {result}"</span>)
        
        <span class="keyword">return</span> calculator_pb2.Result(
            value=result,
            message=<span class="string">f"{request.a} / {request.b} = {result}"</span>,
            success=<span class="keyword">True</span>
        )
    
    <span class="keyword">def</span> <span class="function">CalculateStream</span>(<span class="keyword">self</span>, request_iterator, context):
        <span class="string">"""流式计算 - 处理多个运算请求"""</span>
        calculation_count = <span class="number">0</span>
        
        <span class="keyword">for</span> request <span class="keyword">in</span> request_iterator:
            calculation_count += <span class="number">1</span>
            
            <span class="comment"># 根据操作类型进行计算</span>
            <span class="keyword">if</span> request.operation == <span class="string">"add"</span>:
                result = request.a + request.b
            <span class="keyword">elif</span> request.operation == <span class="string">"subtract"</span>:
                result = request.a - request.b
            <span class="keyword">elif</span> request.operation == <span class="string">"multiply"</span>:
                result = request.a * request.b
            <span class="keyword">elif</span> request.operation == <span class="string">"divide"</span>:
                <span class="keyword">if</span> request.b == <span class="number">0</span>:
                    <span class="keyword">yield</span> calculator_pb2.Result(
                        value=<span class="number">0</span>,
                        message=<span class="string">f"计算 #{calculation_count}: 错误 - 除数不能为零"</span>,
                        success=<span class="keyword">False</span>
                    )
                    <span class="keyword">continue</span>
                result = request.a / request.b
            <span class="keyword">else</span>:
                <span class="keyword">yield</span> calculator_pb2.Result(
                    value=<span class="number">0</span>,
                    message=<span class="string">f"计算 #{calculation_count}: 未知操作 '{request.operation}'"</span>,
                    success=<span class="keyword">False</span>
                )
                <span class="keyword">continue</span>
            
            logger.info(<span class="string">f"Stream calculation #{calculation_count}: {request.a} {request.operation} {request.b} = {result}"</span>)
            
            <span class="keyword">yield</span> calculator_pb2.Result(
                value=result,
                message=<span class="string">f"计算 #{calculation_count}: {request.a} {request.operation} {request.b} = {result}"</span>,
                success=<span class="keyword">True</span>
            )
            
            <span class="comment"># 模拟处理时间</span>
            time.sleep(<span class="number">0.1</span>)

<span class="keyword">def</span> <span class="function">serve</span>():
    <span class="string">"""启动gRPC服务器"""</span>
    <span class="comment"># 创建gRPC服务器</span>
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))
    
    <span class="comment"># 添加服务到服务器</span>
    calculator_pb2_grpc.add_CalculatorServicer_to_server(
        CalculatorServicer(), server
    )
    
    <span class="comment"># 监听端口</span>
    listen_addr = <span class="string">'[::]:50051'</span>
    server.add_insecure_port(listen_addr)
    
    <span class="comment"># 启动服务器</span>
    server.start()
    logger.info(<span class="string">f"Calculator gRPC server started on {listen_addr}"</span>)
    
    <span class="keyword">try</span>:
        server.wait_for_termination()
    <span class="keyword">except</span> KeyboardInterrupt:
        logger.info(<span class="string">"Shutting down server..."</span>)
        server.stop(<span class="number">0</span>)

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    serve()
</code></pre>
            </div>
        </div>

        <div class="step">步骤 3: 实现gRPC客户端</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">🐍</span>
                calculator_client.py
            </div>
            <div class="code-content">
                <pre><code><span class="keyword">import</span> grpc
<span class="keyword">import</span> time
<span class="keyword">import</span> logging

<span class="comment"># 导入生成的gRPC代码</span>
<span class="keyword">import</span> calculator_pb2
<span class="keyword">import</span> calculator_pb2_grpc

<span class="comment"># 配置日志</span>
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

<span class="keyword">class</span> <span class="function">CalculatorClient</span>:
    <span class="string">"""计算器客户端"""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="keyword">self</span>, server_address=<span class="string">'localhost:50051'</span>):
        <span class="keyword">self</span>.server_address = server_address
        <span class="keyword">self</span>.channel = <span class="keyword">None</span>
        <span class="keyword">self</span>.stub = <span class="keyword">None</span>
    
    <span class="keyword">def</span> <span class="function">connect</span>(<span class="keyword">self</span>):
        <span class="string">"""连接到gRPC服务器"""</span>
        <span class="keyword">self</span>.channel = grpc.insecure_channel(<span class="keyword">self</span>.server_address)
        <span class="keyword">self</span>.stub = calculator_pb2_grpc.CalculatorStub(<span class="keyword">self</span>.channel)
        logger.info(<span class="string">f"Connected to gRPC server at {<span class="keyword">self</span>.server_address}"</span>)
    
    <span class="keyword">def</span> <span class="function">disconnect</span>(<span class="keyword">self</span>):
        <span class="string">"""断开连接"""</span>
        <span class="keyword">if</span> <span class="keyword">self</span>.channel:
            <span class="keyword">self</span>.channel.close()
            logger.info(<span class="string">"Disconnected from gRPC server"</span>)
    
    <span class="keyword">def</span> <span class="function">add</span>(<span class="keyword">self</span>, a, b):
        <span class="string">"""加法运算"""</span>
        request = calculator_pb2.BinaryOperation(a=a, b=b)
        response = <span class="keyword">self</span>.stub.Add(request)
        <span class="keyword">return</span> response
    
    <span class="keyword">def</span> <span class="function">subtract</span>(<span class="keyword">self</span>, a, b):
        <span class="string">"""减法运算"""</span>
        request = calculator_pb2.BinaryOperation(a=a, b=b)
        response = <span class="keyword">self</span>.stub.Subtract(request)
        <span class="keyword">return</span> response
    
    <span class="keyword">def</span> <span class="function">multiply</span>(<span class="keyword">self</span>, a, b):
        <span class="string">"""乘法运算"""</span>
        request = calculator_pb2.BinaryOperation(a=a, b=b)
        response = <span class="keyword">self</span>.stub.Multiply(request)
        <span class="keyword">return</span> response
    
    <span class="keyword">def</span> <span class="function">divide</span>(<span class="keyword">self</span>, a, b):
        <span class="string">"""除法运算"""</span>
        request = calculator_pb2.BinaryOperation(a=a, b=b)
        response = <span class="keyword">self</span>.stub.Divide(request)
        <span class="keyword">return</span> response
    
    <span class="keyword">def</span> <span class="function">calculate_stream</span>(<span class="keyword">self</span>, operations):
        <span class="string">"""流式计算"""</span>
        <span class="keyword">def</span> <span class="function">generate_requests</span>():
            <span class="keyword">for</span> op <span class="keyword">in</span> operations:
                <span class="keyword">yield</span> calculator_pb2.BinaryOperation(
                    a=op[<span class="string">'a'</span>], 
                    b=op[<span class="string">'b'</span>], 
                    operation=op[<span class="string">'operation'</span>]
                )
                time.sleep(<span class="number">0.5</span>)  <span class="comment"># 模拟间隔发送</span>
        
        responses = <span class="keyword">self</span>.stub.CalculateStream(generate_requests())
        <span class="keyword">return</span> responses

<span class="keyword">def</span> <span class="function">demo_basic_operations</span>():
    <span class="string">"""演示基本运算"""</span>
    client = CalculatorClient()
    client.connect()
    
    <span class="keyword">print</span>(<span class="string">"=== 基本运算演示 ==="</span>)
    
    <span class="comment"># 加法</span>
    result = client.add(<span class="number">10</span>, <span class="number">5</span>)
    <span class="keyword">print</span>(<span class="string">f"加法: {result.message} (成功: {result.success})"</span>)
    
    <span class="comment"># 减法</span>
    result = client.subtract(<span class="number">10</span>, <span class="number">3</span>)
    <span class="keyword">print</span>(<span class="string">f"减法: {result.message} (成功: {result.success})"</span>)
    
    <span class="comment"># 乘法</span>
    result = client.multiply(<span class="number">7</span>, <span class="number">8</span>)
    <span class="keyword">print</span>(<span class="string">f"乘法: {result.message} (成功: {result.success})"</span>)
    
    <span class="comment"># 除法</span>
    result = client.divide(<span class="number">20</span>, <span class="number">4</span>)
    <span class="keyword">print</span>(<span class="string">f"除法: {result.message} (成功: {result.success})"</span>)
    
    <span class="comment"># 除零测试</span>
    result = client.divide(<span class="number">10</span>, <span class="number">0</span>)
    <span class="keyword">print</span>(<span class="string">f"除零测试: {result.message} (成功: {result.success})"</span>)
    
    client.disconnect()

<span class="keyword">def</span> <span class="function">demo_stream_operations</span>():
    <span class="string">"""演示流式运算"""</span>
    client = CalculatorClient()
    client.connect()
    
    <span class="keyword">print</span>(<span class="string">"\n=== 流式运算演示 ==="</span>)
    
    <span class="comment"># 准备多个运算</span>
    operations = [
        {<span class="string">'a'</span>: <span class="number">10</span>, <span class="string">'b'</span>: <span class="number">5</span>, <span class="string">'operation'</span>: <span class="string">'add'</span>},
        {<span class="string">'a'</span>: <span class="number">15</span>, <span class="string">'b'</span>: <span class="number">3</span>, <span class="string">'operation'</span>: <span class="string">'multiply'</span>},
        {<span class="string">'a'</span>: <span class="number">20</span>, <span class="string">'b'</span>: <span class="number">4</span>, <span class="string">'operation'</span>: <span class="string">'divide'</span>},
        {<span class="string">'a'</span>: <span class="number">100</span>, <span class="string">'b'</span>: <span class="number">25</span>, <span class="string">'operation'</span>: <span class="string">'subtract'</span>},
        {<span class="string">'a'</span>: <span class="number">8</span>, <span class="string">'b'</span>: <span class="number">0</span>, <span class="string">'operation'</span>: <span class="string">'divide'</span>},  <span class="comment"># 除零测试</span>
    ]
    
    <span class="comment"># 发送流式请求并接收响应</span>
    responses = client.calculate_stream(operations)
    
    <span class="keyword">for</span> response <span class="keyword">in</span> responses:
        <span class="keyword">print</span>(<span class="string">f"流式计算结果: {response.message} (成功: {response.success})"</span>)
    
    client.disconnect()

<span class="keyword">def</span> <span class="function">interactive_demo</span>():
    <span class="string">"""交互式演示"""</span>
    client = CalculatorClient()
    client.connect()
    
    <span class="keyword">print</span>(<span class="string">"\n=== 交互式计算器 ==="</span>)
    <span class="keyword">print</span>(<span class="string">"输入 'quit' 退出"</span>)
    
    <span class="keyword">while</span> <span class="keyword">True</span>:
        <span class="keyword">try</span>:
            operation = input(<span class="string">"\n选择操作 (add/subtract/multiply/divide): "</span>).strip().lower()
            
            <span class="keyword">if</span> operation == <span class="string">'quit'</span>:
                <span class="keyword">break</span>
            
            <span class="keyword">if</span> operation <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'add'</span>, <span class="string">'subtract'</span>, <span class="string">'multiply'</span>, <span class="string">'divide'</span>]:
                <span class="keyword">print</span>(<span class="string">"无效操作！请输入 add, subtract, multiply 或 divide"</span>)
                <span class="keyword">continue</span>
            
            a = <span class="keyword">float</span>(input(<span class="string">"输入第一个数字: "</span>))
            b = <span class="keyword">float</span>(input(<span class="string">"输入第二个数字: "</span>))
            
            <span class="keyword">if</span> operation == <span class="string">'add'</span>:
                result = client.add(a, b)
            <span class="keyword">elif</span> operation == <span class="string">'subtract'</span>:
                result = client.subtract(a, b)
            <span class="keyword">elif</span> operation == <span class="string">'multiply'</span>:
                result = client.multiply(a, b)
            <span class="keyword">else</span>:  <span class="comment"># divide</span>
                result = client.divide(a, b)
            
            <span class="keyword">print</span>(<span class="string">f"结果: {result.message}"</span>)
            
        <span class="keyword">except</span> ValueError:
            <span class="keyword">print</span>(<span class="string">"请输入有效的数字！"</span>)
        <span class="keyword">except</span> KeyboardInterrupt:
            <span class="keyword">break</span>
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            <span class="keyword">print</span>(<span class="string">f"错误: {e}"</span>)
    
    client.disconnect()
    <span class="keyword">print</span>(<span class="string">"再见！"</span>)

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    <span class="keyword">try</span>:
        <span class="comment"># 运行演示</span>
        demo_basic_operations()
        demo_stream_operations()
        interactive_demo()
        
    <span class="keyword">except</span> grpc.RpcError <span class="keyword">as</span> e:
        <span class="keyword">print</span>(<span class="string">f"gRPC错误: {e.details()}"</span>)
        <span class="keyword">print</span>(<span class="string">"请确保服务器正在运行！"</span>)
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="keyword">print</span>(<span class="string">f"客户端错误: {e}"</span>)
</code></pre>
            </div>
        </div>

        <div class="step">步骤 4: 创建项目启动脚本</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">📜</span>
                run_demo.py
            </div>
            <div class="code-content">
                <pre><code><span class="keyword">import</span> subprocess
<span class="keyword">import</span> sys
<span class="keyword">import</span> time
<span class="keyword">import</span> threading
<span class="keyword">import</span> os

<span class="keyword">def</span> <span class="function">generate_proto_code</span>():
    <span class="string">"""生成Protocol Buffer代码"""</span>
    <span class="keyword">print</span>(<span class="string">"🔧 生成gRPC代码..."</span>)
    
    <span class="comment"># 创建proto文件</span>
    proto_content = <span class="string">'''syntax = "proto3";

package calculator;

service Calculator {
    rpc Add(BinaryOperation) returns (Result);
    rpc Subtract(BinaryOperation) returns (Result);
    rpc Multiply(BinaryOperation) returns (Result);
    rpc Divide(BinaryOperation) returns (Result);
    rpc CalculateStream(stream BinaryOperation) returns (stream Result);
}

message BinaryOperation {
    double a = 1;
    double b = 2;
    string operation = 3;
}

message Result {
    double value = 1;
    string message = 2;
    bool success = 3;
}'''</span>
    
    <span class="keyword">with</span> open(<span class="string">'calculator.proto'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:
        f.write(proto_content)
    
    <span class="comment"># 生成Python代码</span>
    <span class="keyword">try</span>:
        subprocess.run([
            sys.executable, <span class="string">'-m'</span>, <span class="string">'grpc_tools.protoc'</span>,
            <span class="string">'--proto_path=.'</span>,
            <span class="string">'--python_out=.'</span>,
            <span class="string">'--grpc_python_out=.'</span>,
            <span class="string">'calculator.proto'</span>
        ], check=<span class="keyword">True</span>)
        <span class="keyword">print</span>(<span class="string">"✅ gRPC代码生成成功！"</span>)
    <span class="keyword">except</span> subprocess.CalledProcessError:
        <span class="keyword">print</span>(<span class="string">"❌ 代码生成失败，请检查grpcio-tools是否安装"</span>)
        <span class="keyword">return</span> <span class="keyword">False</span>
    
    <span class="keyword">return</span> <span class="keyword">True</span>

<span class="keyword">def</span> <span class="function">check_dependencies</span>():
    <span class="string">"""检查依赖包"""</span>
    <span class="keyword">print</span>(<span class="string">"📦 检查依赖包..."</span>)
    
    required_packages = [<span class="string">'grpcio'</span>, <span class="string">'grpcio-tools'</span>]
    missing_packages = []
    
    <span class="keyword">for</span> package <span class="keyword">in</span> required_packages:
        <span class="keyword">try</span>:
            __import__(package.replace(<span class="string">'-'</span>, <span class="string">'_'</span>))
        <span class="keyword">except</span> ImportError:
            missing_packages.append(package)
    
    <span class="keyword">if</span> missing_packages:
        <span class="keyword">print</span>(<span class="string">f"❌ 缺少依赖包: {', '.join(missing_packages)}"</span>)
        <span class="keyword">print</span>(<span class="string">"请运行: pip install grpcio grpcio-tools"</span>)
        <span class="keyword">return</span> <span class="keyword">False</span>
    
    <span class="keyword">print</span>(<span class="string">"✅ 所有依赖包已安装"</span>)
    <span class="keyword">return</span> <span class="keyword">True</span>

<span class="keyword">def</span> <span class="function">run_server</span>():
    <span class="string">"""在后台运行服务器"""</span>
    <span class="keyword">import</span> calculator_server
    calculator_server.serve()

<span class="keyword">def</span> <span class="function">main</span>():
    <span class="string">"""主函数"""</span>
    <span class="keyword">print</span>(<span class="string">"🚀 gRPC Calculator Demo 启动中..."</span>)
    
    <span class="comment"># 检查依赖</span>
    <span class="keyword">if</span> <span class="keyword">not</span> check_dependencies():
        <span class="keyword">return</span>
    
    <span class="comment"># 生成代码</span>
    <span class="keyword">if</span> <span class="keyword">not</span> generate_proto_code():
        <span class="keyword">return</span>
    
    <span class="comment"># 启动服务器</span>
    <span class="keyword">print</span>(<span class="string">"🔥 启动gRPC服务器..."</span>)
    server_thread = threading.Thread(target=run_server, daemon=<span class="keyword">True</span>)
    server_thread.start()
    
    <span class="comment"># 等待服务器启动</span>
    time.sleep(<span class="number">2</span>)
    
    <span class="comment"># 运行客户端演示</span>
    <span class="keyword">print</span>(<span class="string">"🎯 启动客户端演示..."</span>)
    <span class="keyword">import</span> calculator_client
    
    <span class="keyword">try</span>:
        calculator_client.demo_basic_operations()
        calculator_client.demo_stream_operations()
        
        <span class="keyword">print</span>(<span class="string">"\n🎮 启动交互式演示..."</span>)
        calculator_client.interactive_demo()
        
    <span class="keyword">except</span> KeyboardInterrupt:
        <span class="keyword">print</span>(<span class="string">"\n👋 演示结束"</span>)

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    main()
</code></pre>
            </div>
        </div>

        <div class="step">步骤 5: 运行完整演示</div>

        <div class="demo-controls">
            <h3>🎮 演示说明</h3>
            <p>这个完整的gRPC演示包含：</p>
            <ul>
                <li><strong>Protocol Buffer定义</strong> - 定义服务接口和消息格式</li>
                <li><strong>服务端实现</strong> - 实现计算器服务，支持基本运算和流式处理</li>
                <li><strong>客户端实现</strong> - 调用远程服务的客户端</li>
                <li><strong>自动化脚本</strong> - 一键生成代码并运行演示</li>
            </ul>
            
            <div class="command-section">
                <h3>🔧 运行步骤</h3>
                <pre><code># 1. 安装依赖
pip install grpcio grpcio-tools

# 2. 保存所有代码文件到同一目录

# 3. 运行完整演示
python run_demo.py

# 或者分别运行：
# 终端1 - 启动服务器
python calculator_server.py

# 终端2 - 运行客户端
python calculator_client.py</code></pre>
            </div>
        </div>

        <div class="step">特性亮点</div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">🔧</span>
                    自动代码生成
                </div>
                <div class="code-content">
                    <p>• 自动生成Protocol Buffer代码</p>
                    <p>• 依赖检查和安装提示</p>
                    <p>• 一键启动完整演示</p>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">🌊</span>
                    流式处理
                </div>
                <div class="code-content">
                    <p>• 支持客户端流式发送</p>
                    <p>• 服务端流式响应</p>
                    <p>• 实时处理多个计算请求</p>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">🛡️</span>
                    错误处理
                </div>
                <div class="code-content">
                    <p>• 除零异常处理</p>
                    <p>• 网络连接错误处理</p>
                    <p>• 优雅的错误响应</p>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">🎮</span>
                    交互体验
                </div>
                <div class="code-content">
                    <p>• 基本运算演示</p>
                    <p>• 流式计算演示</p>
                    <p>• 交互式计算器模式</p>
                </div>
            </div>
        </div>

        <div class="command-section">
            <h3>🎯 学习要点</h3>
            <ol>
                <li><strong>Protocol Buffers</strong> - 高效的序列化格式，比JSON更快更小</li>
                <li><strong>服务定义</strong> - 使用.proto文件定义RPC服务接口</li>
                <li><strong>代码生成</strong> - 自动生成客户端和服务端代码</li>
                <li><strong>流式RPC</strong> - 支持客户端流、服务端流和双向流</li>
                <li><strong>错误处理</strong> - 优雅处理网络和业务异常</li>
                <li><strong>性能优势</strong> - HTTP/2支持，二进制协议，连接复用</li>
            </ol>
        </div>
    </div>
</body>
</html>
