<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gRPC Calculator Demo</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #4fc3f7;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 10px;
        }
        .file-section {
            background: #2d2d2d;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid #404040;
        }
        .file-header {
            background: #404040;
            padding: 12px 20px;
            color: #fff;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .file-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        .code-content {
            padding: 20px;
            background: #1e1e1e;
            overflow-x: auto;
        }
        pre {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .command-section {
            background: #0d47a1;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .step {
            background: #2e7d32;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: bold;
        }
        .keyword { color: #ff7043; }
        .string { color: #66bb6a; }
        .comment { color: #616161; font-style: italic; }
        .function { color: #42a5f5; }
        .number { color: #ab47bc; }
        
        .demo-controls {
            background: #424242;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .demo-controls button {
            background: #4fc3f7;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .demo-controls button:hover {
            background: #29b6f6;
        }
        .output {
            background: #1a1a1a;
            border: 1px solid #404040;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            min-height: 100px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ gRPC Calculator Service - Python3 Complete Demo</h1>
        
        <div class="step">æ­¥éª¤ 1: å®šä¹‰Protocol BufferæœåŠ¡æ¥å£</div>
        
        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">ğŸ“„</span>
                calculator_enhanced.proto - å¼ºç±»å‹çº¦æŸç‰ˆæœ¬
            </div>
            <div class="code-content">
                <pre><code><span class="comment">// Protocol Buffer å®šä¹‰æ–‡ä»¶ - å¢å¼ºç±»å‹çº¦æŸç‰ˆæœ¬</span>
<span class="keyword">syntax</span> = <span class="string">"proto3"</span>;

<span class="keyword">package</span> calculator.v2;

<span class="keyword">import</span> <span class="string">"google/protobuf/timestamp.proto"</span>;

<span class="comment">// ============== æšä¸¾ç±»å‹å®šä¹‰ ==============</span>

<span class="comment">// æ“ä½œç±»å‹æšä¸¾ - å¼ºç±»å‹çº¦æŸ</span>
<span class="keyword">enum</span> <span class="function">OperationType</span> {
    OPERATION_UNSPECIFIED = <span class="number">0</span>;  <span class="comment">// é»˜è®¤å€¼ï¼Œç”¨äºæ£€æµ‹æœªè®¾ç½®çš„æ“ä½œ</span>
    OPERATION_ADD = <span class="number">1</span>;
    OPERATION_SUBTRACT = <span class="number">2</span>;
    OPERATION_MULTIPLY = <span class="number">3</span>;
    OPERATION_DIVIDE = <span class="number">4</span>;
    OPERATION_POWER = <span class="number">5</span>;
    OPERATION_SQRT = <span class="number">6</span>;
    OPERATION_MODULO = <span class="number">7</span>;
}

<span class="comment">// æ•°å­—ç²¾åº¦ç±»å‹</span>
<span class="keyword">enum</span> <span class="function">Precision</span> {
    PRECISION_STANDARD = <span class="number">0</span>;    <span class="comment">// æ ‡å‡†ç²¾åº¦</span>
    PRECISION_HIGH = <span class="number">1</span>;        <span class="comment">// é«˜ç²¾åº¦</span>
    PRECISION_SCIENTIFIC = <span class="number">2</span>;  <span class="comment">// ç§‘å­¦è®¡æ•°æ³•</span>
}

<span class="comment">// é”™è¯¯ç±»å‹æšä¸¾</span>
<span class="keyword">enum</span> <span class="function">ErrorCode</span> {
    ERROR_NONE = <span class="number">0</span>;
    ERROR_DIVISION_BY_ZERO = <span class="number">1</span>;
    ERROR_INVALID_OPERATION = <span class="number">2</span>;
    ERROR_NUMBER_TOO_LARGE = <span class="number">3</span>;
    ERROR_NUMBER_TOO_SMALL = <span class="number">4</span>;
    ERROR_NEGATIVE_SQRT = <span class="number">5</span>;
    ERROR_OVERFLOW = <span class="number">6</span>;
    ERROR_UNDERFLOW = <span class="number">7</span>;
}

<span class="comment">// ============== æœåŠ¡å®šä¹‰ ==============</span>

<span class="keyword">service</span> <span class="function">CalculatorV2</span> {
    <span class="comment">// åŸºæœ¬äºŒå…ƒè¿ç®—</span>
    <span class="keyword">rpc</span> <span class="function">Calculate</span>(<span class="function">CalculationRequest</span>) <span class="keyword">returns</span> (<span class="function">CalculationResponse</span>);
    
    <span class="comment">// æ‰¹é‡è®¡ç®—</span>
    <span class="keyword">rpc</span> <span class="function">BatchCalculate</span>(<span class="function">BatchCalculationRequest</span>) <span class="keyword">returns</span> (<span class="function">BatchCalculationResponse</span>);
    
    <span class="comment">// æµå¼è®¡ç®—</span>
    <span class="keyword">rpc</span> <span class="function">StreamCalculate</span>(<span class="keyword">stream</span> <span class="function">CalculationRequest</span>) <span class="keyword">returns</span> (<span class="keyword">stream</span> <span class="function">CalculationResponse</span>);
    
    <span class="comment">// è·å–æœåŠ¡å™¨èƒ½åŠ›</span>
    <span class="keyword">rpc</span> <span class="function">GetCapabilities</span>(<span class="function">CapabilitiesRequest</span>) <span class="keyword">returns</span> (<span class="function">CapabilitiesResponse</span>);
    
    <span class="comment">// éªŒè¯è¡¨è¾¾å¼</span>
    <span class="keyword">rpc</span> <span class="function">ValidateExpression</span>(<span class="function">ValidationRequest</span>) <span class="keyword">returns</span> (<span class="function">ValidationResponse</span>);
}

<span class="comment">// ============== è¯·æ±‚å’Œå“åº”æ¶ˆæ¯ ==============</span>

<span class="comment">// è®¡ç®—è¯·æ±‚ - åŒ…å«ç±»å‹çº¦æŸå’ŒéªŒè¯</span>
<span class="keyword">message</span> <span class="function">CalculationRequest</span> {
    <span class="comment">// æ“ä½œæ•° - ä½¿ç”¨oneofç¡®ä¿ç±»å‹å®‰å…¨</span>
    <span class="keyword">oneof</span> operand_a {
        <span class="keyword">double</span> number_a = <span class="number">1</span>;
        <span class="keyword">string</span> decimal_a = <span class="number">2</span>;  <span class="comment">// é«˜ç²¾åº¦åè¿›åˆ¶å­—ç¬¦ä¸²</span>
    }
    
    <span class="keyword">oneof</span> operand_b {
        <span class="keyword">double</span> number_b = <span class="number">3</span>;
        <span class="keyword">string</span> decimal_b = <span class="number">4</span>;  <span class="comment">// é«˜ç²¾åº¦åè¿›åˆ¶å­—ç¬¦ä¸²</span>
    }
    
    <span class="comment">// æ“ä½œç±»å‹ - å¼ºç±»å‹æšä¸¾</span>
    <span class="function">OperationType</span> operation = <span class="number">5</span>;
    
    <span class="comment">// è®¡ç®—é…ç½®</span>
    <span class="function">CalculationConfig</span> config = <span class="number">6</span>;
    
    <span class="comment">// è¯·æ±‚å…ƒæ•°æ®</span>
    <span class="function">RequestMetadata</span> metadata = <span class="number">7</span>;
}

<span class="comment">// è®¡ç®—é…ç½®</span>
<span class="keyword">message</span> <span class="function">CalculationConfig</span> {
    <span class="comment">// ç²¾åº¦è®¾ç½®</span>
    <span class="function">Precision</span> precision = <span class="number">1</span>;
    
    <span class="comment">// å°æ•°ä½æ•°é™åˆ¶ (0-20)</span>
    <span class="keyword">int32</span> decimal_places = <span class="number">2</span>;
    
    <span class="comment">// æ˜¯å¦å¯ç”¨ç§‘å­¦è®¡æ•°æ³•</span>
    <span class="keyword">bool</span> use_scientific_notation = <span class="number">3</span>;
    
    <span class="comment">// æ•°å€¼èŒƒå›´é™åˆ¶</span>
    <span class="keyword">double</span> max_value = <span class="number">4</span>;
    <span class="keyword">double</span> min_value = <span class="number">5</span>;
    
    <span class="comment">// è¶…æ—¶è®¾ç½® (æ¯«ç§’)</span>
    <span class="keyword">int32</span> timeout_ms = <span class="number">6</span>;
}

<span class="comment">// è¯·æ±‚å…ƒæ•°æ®</span>
<span class="keyword">message</span> <span class="function">RequestMetadata</span> {
    <span class="comment">// è¯·æ±‚ID</span>
    <span class="keyword">string</span> request_id = <span class="number">1</span>;
    
    <span class="comment">// å®¢æˆ·ç«¯ä¿¡æ¯</span>
    <span class="keyword">string</span> client_id = <span class="number">2</span>;
    <span class="keyword">string</span> client_version = <span class="number">3</span>;
    
    <span class="comment">// æ—¶é—´æˆ³</span>
    google.protobuf.Timestamp request_time = <span class="number">4</span>;
    
    <span class="comment">// ä¼˜å…ˆçº§ (1-10, 10æœ€é«˜)</span>
    <span class="keyword">int32</span> priority = <span class="number">5</span>;
}

<span class="comment">// è®¡ç®—å“åº”</span>
<span class="keyword">message</span> <span class="function">CalculationResponse</span> {
    <span class="comment">// è®¡ç®—ç»“æœ - æ”¯æŒå¤šç§æ ¼å¼</span>
    <span class="keyword">oneof</span> result {
        <span class="keyword">double</span> number_result = <span class="number">1</span>;
        <span class="keyword">string</span> decimal_result = <span class="number">2</span>;  <span class="comment">// é«˜ç²¾åº¦ç»“æœ</span>
        <span class="keyword">string</span> scientific_result = <span class="number">3</span>; <span class="comment">// ç§‘å­¦è®¡æ•°æ³•</span>
    }
    
    <span class="comment">// æ“ä½œçŠ¶æ€</span>
    <span class="keyword">bool</span> success = <span class="number">4</span>;
    
    <span class="comment">// é”™è¯¯ä¿¡æ¯</span>
    <span class="function">ErrorInfo</span> error = <span class="number">5</span>;
    
    <span class="comment">// è®¡ç®—ç»Ÿè®¡</span>
    <span class="function">CalculationStats</span> stats = <span class="number">6</span>;
    
    <span class="comment">// å“åº”å…ƒæ•°æ®</span>
    <span class="function">ResponseMetadata</span> metadata = <span class="number">7</span>;
}

<span class="comment">// é”™è¯¯ä¿¡æ¯</span>
<span class="keyword">message</span> <span class="function">ErrorInfo</span> {
    <span class="function">ErrorCode</span> code = <span class="number">1</span>;
    <span class="keyword">string</span> message = <span class="number">2</span>;
    <span class="keyword">string</span> details = <span class="number">3</span>;
    
    <span class="comment">// é”™è¯¯å‘ç”Ÿçš„ä¸Šä¸‹æ–‡</span>
    <span class="keyword">string</span> operation_context = <span class="number">4</span>;
    <span class="keyword">repeated string</span> suggestions = <span class="number">5</span>;  <span class="comment">// ä¿®å¤å»ºè®®</span>
}

<span class="comment">// è®¡ç®—ç»Ÿè®¡</span>
<span class="keyword">message</span> <span class="function">CalculationStats</span> {
    <span class="comment">// æ‰§è¡Œæ—¶é—´ (å¾®ç§’)</span>
    <span class="keyword">int64</span> execution_time_us = <span class="number">1</span>;
    
    <span class="comment">// å†…å­˜ä½¿ç”¨ (å­—èŠ‚)</span>
    <span class="keyword">int64</span> memory_used_bytes = <span class="number">2</span>;
    
    <span class="comment">// ç²¾åº¦æŸå¤±æ ‡è®°</span>
    <span class="keyword">bool</span> precision_lost = <span class="number">3</span>;
    
    <span class="comment">// ä¸­é—´æ­¥éª¤æ•°</span>
    <span class="keyword">int32</span> intermediate_steps = <span class="number">4</span>;
}

<span class="comment">// å“åº”å…ƒæ•°æ®</span>
<span class="keyword">message</span> <span class="function">ResponseMetadata</span> {
    <span class="keyword">string</span> request_id = <span class="number">1</span>;
    <span class="keyword">string</span> server_id = <span class="number">2</span>;
    <span class="keyword">string</span> server_version = <span class="number">3</span>;
    google.protobuf.Timestamp response_time = <span class="number">4</span>;
}

<span class="comment">// ============== æ‰¹é‡å’Œæµå¼æ¶ˆæ¯ ==============</span>

<span class="comment">// æ‰¹é‡è®¡ç®—è¯·æ±‚</span>
<span class="keyword">message</span> <span class="function">BatchCalculationRequest</span> {
    <span class="keyword">repeated</span> <span class="function">CalculationRequest</span> requests = <span class="number">1</span>;
    
    <span class="comment">// æ‰¹é‡é…ç½®</span>
    <span class="keyword">bool</span> fail_fast = <span class="number">2</span>;  <span class="comment">// é‡åˆ°é”™è¯¯æ˜¯å¦ç«‹å³åœæ­¢</span>
    <span class="keyword">bool</span> parallel_execution = <span class="number">3</span>;  <span class="comment">// æ˜¯å¦å¹¶è¡Œæ‰§è¡Œ</span>
    <span class="keyword">int32</span> max_concurrent = <span class="number">4</span>;  <span class="comment">// æœ€å¤§å¹¶å‘æ•°</span>
}

<span class="comment">// æ‰¹é‡è®¡ç®—å“åº”</span>
<span class="keyword">message</span> <span class="function">BatchCalculationResponse</span> {
    <span class="keyword">repeated</span> <span class="function">CalculationResponse</span> responses = <span class="number">1</span>;
    
    <span class="comment">// æ‰¹é‡ç»Ÿè®¡</span>
    <span class="keyword">int32</span> total_requests = <span class="number">2</span>;
    <span class="keyword">int32</span> successful_requests = <span class="number">3</span>;
    <span class="keyword">int32</span> failed_requests = <span class="number">4</span>;
    <span class="keyword">int64</span> total_execution_time_us = <span class="number">5</span>;
}

<span class="comment">// ============== æœåŠ¡èƒ½åŠ›æŸ¥è¯¢ ==============</span>

<span class="keyword">message</span> <span class="function">CapabilitiesRequest</span> {
    <span class="comment">// ç©ºè¯·æ±‚ï¼Œç”¨äºè·å–æœåŠ¡å™¨èƒ½åŠ›</span>
}

<span class="keyword">message</span> <span class="function">CapabilitiesResponse</span> {
    <span class="comment">// æ”¯æŒçš„æ“ä½œç±»å‹</span>
    <span class="keyword">repeated</span> <span class="function">OperationType</span> supported_operations = <span class="number">1</span>;
    
    <span class="comment">// æ”¯æŒçš„ç²¾åº¦ç±»å‹</span>
    <span class="keyword">repeated</span> <span class="function">Precision</span> supported_precisions = <span class="number">2</span>;
    
    <span class="comment">// æ•°å€¼é™åˆ¶</span>
    <span class="keyword">double</span> max_number = <span class="number">3</span>;
    <span class="keyword">double</span> min_number = <span class="number">4</span>;
    <span class="keyword">int32</span> max_decimal_places = <span class="number">5</span>;
    
    <span class="comment">// æ€§èƒ½é™åˆ¶</span>
    <span class="keyword">int32</span> max_batch_size = <span class="number">6</span>;
    <span class="keyword">int32</span> max_concurrent_streams = <span class="number">7</span>;
    <span class="keyword">int32</span> default_timeout_ms = <span class="number">8</span>;
    
    <span class="comment">// æœåŠ¡å™¨ä¿¡æ¯</span>
    <span class="keyword">string</span> server_version = <span class="number">9</span>;
    <span class="keyword">string</span> protocol_version = <span class="number">10</span>;
}

<span class="comment">// ============== è¡¨è¾¾å¼éªŒè¯ ==============</span>

<span class="keyword">message</span> <span class="function">ValidationRequest</span> {
    <span class="function">CalculationRequest</span> request = <span class="number">1</span>;
    
    <span class="comment">// éªŒè¯çº§åˆ«</span>
    <span class="keyword">enum</span> <span class="function">ValidationLevel</span> {
        BASIC = <span class="number">0</span>;      <span class="comment">// åŸºæœ¬è¯­æ³•æ£€æŸ¥</span>
        STRICT = <span class="number">1</span>;     <span class="comment">// ä¸¥æ ¼ç±»å‹æ£€æŸ¥</span>
        COMPLETE = <span class="number">2</span>;   <span class="comment">// å®Œæ•´éªŒè¯åŒ…æ‹¬èŒƒå›´æ£€æŸ¥</span>
    }
    
    <span class="function">ValidationLevel</span> level = <span class="number">2</span>;
}

<span class="keyword">message</span> <span class="function">ValidationResponse</span> {
    <span class="keyword">bool</span> is_valid = <span class="number">1</span>;
    <span class="keyword">repeated string</span> errors = <span class="number">2</span>;
    <span class="keyword">repeated string</span> warnings = <span class="number">3</span>;
    <span class="keyword">repeated string</span> suggestions = <span class="number">4</span>;
    
    <span class="comment">// é¢„ä¼°æ‰§è¡Œæ—¶é—´</span>
    <span class="keyword">int64</span> estimated_execution_time_us = <span class="number">5</span>;
    
    <span class="comment">// ç»“æœç±»å‹é¢„æµ‹</span>
    <span class="keyword">string</span> expected_result_type = <span class="number">6</span>;
}</code></pre>
            </div>
        </div>

        <div class="command-section">
            <h3>ğŸ”§ ç”ŸæˆPythonä»£ç å‘½ä»¤</h3>
            <pre><code># å®‰è£…ä¾èµ–
pip install grpcio grpcio-tools

# ç”ŸæˆPython gRPCä»£ç 
python -m grpc_tools.protoc --proto_path=. --python_out=. --grpc_python_out=. calculator.proto</code></pre>
        </div>

        <div class="step">æ­¥éª¤ 2: å®ç°å¼ºç±»å‹çº¦æŸçš„gRPCæœåŠ¡ç«¯</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">ğŸ</span>
                calculator_server_enhanced.py - å¼ºç±»å‹çº¦æŸç‰ˆæœ¬
            </div>
            <div class="code-content">
                <pre><code><span class="keyword">import</span> grpc
<span class="keyword">from</span> concurrent <span class="keyword">import</span> futures
<span class="keyword">import</span> time
<span class="keyword">import</span> logging
<span class="keyword">import</span> math
<span class="keyword">import</span> decimal
<span class="keyword">import</span> uuid
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime
<span class="keyword">from</span> typing <span class="keyword">import</span> Union, Optional, Tuple
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass

<span class="comment"># å¯¼å…¥ç”Ÿæˆçš„gRPCä»£ç </span>
<span class="keyword">import</span> calculator_enhanced_pb2 <span class="keyword">as</span> pb2
<span class="keyword">import</span> calculator_enhanced_pb2_grpc <span class="keyword">as</span> pb2_grpc
<span class="keyword">from</span> google.protobuf <span class="keyword">import</span> timestamp_pb2

<span class="comment"># é…ç½®æ—¥å¿—</span>
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

<span class="comment"># ============== ç±»å‹çº¦æŸå’ŒéªŒè¯ç±» ==============</span>

<span class="keyword">@dataclass</span>
<span class="keyword">class</span> <span class="function">NumericLimits</span>:
    <span class="string">"""æ•°å€¼é™åˆ¶é…ç½®"""</span>
    MAX_VALUE: <span class="keyword">float</span> = <span class="number">1e15</span>
    MIN_VALUE: <span class="keyword">float</span> = <span class="number">-1e15</span>
    MAX_DECIMAL_PLACES: <span class="keyword">int</span> = <span class="number">20</span>
    PRECISION_TOLERANCE: <span class="keyword">float</span> = <span class="number">1e-15</span>

<span class="keyword">class</span> <span class="function">TypeValidator</span>:
    <span class="string">"""ç±»å‹å’Œå€¼éªŒè¯å™¨"""</span>
    
    <span class="keyword">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">validate_operation_type</span>(operation: pb2.OperationType) -> Tuple[<span class="keyword">bool</span>, <span class="keyword">str</span>]:
        <span class="string">"""éªŒè¯æ“ä½œç±»å‹"""</span>
        <span class="keyword">if</span> operation == pb2.OPERATION_UNSPECIFIED:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">"æ“ä½œç±»å‹æœªæŒ‡å®š"</span>
        
        valid_operations = [
            pb2.OPERATION_ADD, pb2.OPERATION_SUBTRACT, 
            pb2.OPERATION_MULTIPLY, pb2.OPERATION_DIVIDE,
            pb2.OPERATION_POWER, pb2.OPERATION_SQRT, pb2.OPERATION_MODULO
        ]
        
        <span class="keyword">if</span> operation <span class="keyword">not</span> <span class="keyword">in</span> valid_operations:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">f"ä¸æ”¯æŒçš„æ“ä½œç±»å‹: {operation}"</span>
        
        <span class="keyword">return</span> <span class="keyword">True</span>, <span class="string">""</span>
    
    <span class="keyword">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">validate_numeric_value</span>(value: <span class="keyword">float</span>, context: <span class="keyword">str</span> = <span class="string">""</span>) -> Tuple[<span class="keyword">bool</span>, <span class="keyword">str</span>]:
        <span class="string">"""éªŒè¯æ•°å€¼èŒƒå›´"""</span>
        <span class="keyword">if</span> math.isnan(value):
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">f"{context}: å€¼ä¸èƒ½ä¸ºNaN"</span>
        
        <span class="keyword">if</span> math.isinf(value):
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">f"{context}: å€¼ä¸èƒ½ä¸ºæ— ç©·å¤§"</span>
        
        <span class="keyword">if</span> value > NumericLimits.MAX_VALUE:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">f"{context}: å€¼è¶…å‡ºæœ€å¤§é™åˆ¶ {NumericLimits.MAX_VALUE}"</span>
        
        <span class="keyword">if</span> value < NumericLimits.MIN_VALUE:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">f"{context}: å€¼ä½äºæœ€å°é™åˆ¶ {NumericLimits.MIN_VALUE}"</span>
        
        <span class="keyword">return</span> <span class="keyword">True</span>, <span class="string">""</span>
    
    <span class="keyword">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">validate_precision_config</span>(config: pb2.CalculationConfig) -> Tuple[<span class="keyword">bool</span>, <span class="keyword">str</span>]:
        <span class="string">"""éªŒè¯ç²¾åº¦é…ç½®"""</span>
        <span class="keyword">if</span> config.decimal_places < <span class="number">0</span> <span class="keyword">or</span> config.decimal_places > NumericLimits.MAX_DECIMAL_PLACES:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">f"å°æ•°ä½æ•°å¿…é¡»åœ¨ 0-{NumericLimits.MAX_DECIMAL_PLACES} ä¹‹é—´"</span>
        
        <span class="keyword">if</span> config.timeout_ms <= <span class="number">0</span>:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">"è¶…æ—¶æ—¶é—´å¿…é¡»å¤§äº0"</span>
        
        <span class="keyword">return</span> <span class="keyword">True</span>, <span class="string">""</span>

<span class="keyword">class</span> <span class="function">PrecisionCalculator</span>:
    <span class="string">"""é«˜ç²¾åº¦è®¡ç®—å™¨"""</span>
    
    <span class="keyword">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">get_numeric_value</span>(request: pb2.CalculationRequest) -> Tuple[<span class="keyword">float</span>, <span class="keyword">float</span>]:
        <span class="string">"""ä»è¯·æ±‚ä¸­æå–æ•°å€¼ï¼Œæ”¯æŒä¸åŒç²¾åº¦ç±»å‹"""</span>
        <span class="comment"># æå–æ“ä½œæ•°A</span>
        <span class="keyword">if</span> request.HasField(<span class="string">"number_a"</span>):
            a = request.number_a
        <span class="keyword">elif</span> request.HasField(<span class="string">"decimal_a"</span>):
            a = <span class="keyword">float</span>(decimal.Decimal(request.decimal_a))
        <span class="keyword">else</span>:
            <span class="keyword">raise</span> ValueError(<span class="string">"æ“ä½œæ•°AæœªæŒ‡å®š"</span>)
        
        <span class="comment"># æå–æ“ä½œæ•°B (æŸäº›æ“ä½œä¸éœ€è¦)</span>
        <span class="keyword">if</span> request.operation == pb2.OPERATION_SQRT:
            b = <span class="number">0</span>  <span class="comment"># å¼€æ–¹æ“ä½œä¸éœ€è¦ç¬¬äºŒä¸ªæ“ä½œæ•°</span>
        <span class="keyword">elif</span> request.HasField(<span class="string">"number_b"</span>):
            b = request.number_b
        <span class="keyword">elif</span> request.HasField(<span class="string">"decimal_b"</span>):
            b = <span class="keyword">float</span>(decimal.Decimal(request.decimal_b))
        <span class="keyword">else</span>:
            <span class="keyword">raise</span> ValueError(<span class="string">"æ“ä½œæ•°BæœªæŒ‡å®š"</span>)
        
        <span class="keyword">return</span> a, b
    
    <span class="keyword">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">format_result</span>(value: <span class="keyword">float</span>, config: pb2.CalculationConfig) -> Tuple[<span class="keyword">str</span>, <span class="keyword">str</span>, <span class="keyword">str</span>]:
        <span class="string">"""æ ¹æ®é…ç½®æ ¼å¼åŒ–ç»“æœ"""</span>
        <span class="comment"># æ ‡å‡†æ•°å€¼</span>
        number_result = value
        
        <span class="comment"># é«˜ç²¾åº¦åè¿›åˆ¶</span>
        decimal_result = <span class="keyword">str</span>(decimal.Decimal(<span class="keyword">str</span>(value)).quantize(
            decimal.Decimal(<span class="string">'0.'</span> + <span class="string">'0'</span> * config.decimal_places),
            rounding=decimal.ROUND_HALF_UP
        ))
        
        <span class="comment"># ç§‘å­¦è®¡æ•°æ³•</span>
        <span class="keyword">if</span> config.use_scientific_notation <span class="keyword">or</span> <span class="keyword">abs</span>(value) >= <span class="number">1e6</span> <span class="keyword">or</span> (<span class="keyword">abs</span>(value) < <span class="number">1e-3</span> <span class="keyword">and</span> value != <span class="number">0</span>):
            scientific_result = <span class="string">f"{value:.{config.decimal_places}e}"</span>
        <span class="keyword">else</span>:
            scientific_result = decimal_result
        
        <span class="keyword">return</span> <span class="keyword">str</span>(number_result), decimal_result, scientific_result

<span class="comment"># ============== å¼ºç±»å‹çº¦æŸçš„æœåŠ¡å®ç° ==============</span>

<span class="keyword">class</span> <span class="function">EnhancedCalculatorServicer</span>(pb2_grpc.CalculatorV2Servicer):
    <span class="string">"""å¢å¼ºå‹è®¡ç®—å™¨æœåŠ¡ - å¼ºç±»å‹çº¦æŸç‰ˆæœ¬"""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="keyword">self</span>):
        <span class="keyword">self</span>.server_id = <span class="keyword">str</span>(uuid.uuid4())[:8]
        <span class="keyword">self</span>.server_version = <span class="string">"v2.0.0"</span>
        <span class="keyword">self</span>.start_time = datetime.now()
        logger.info(<span class="string">f"Enhanced Calculator Server {<span class="keyword">self</span>.server_id} initialized"</span>)
    
    <span class="keyword">def</span> <span class="function">_create_error_response</span>(<span class="keyword">self</span>, error_code: pb2.ErrorCode, message: <span class="keyword">str</span>, 
                           details: <span class="keyword">str</span> = <span class="string">""</span>, suggestions: list = <span class="keyword">None</span>) -> pb2.CalculationResponse:
        <span class="string">"""åˆ›å»ºé”™è¯¯å“åº”"""</span>
        error_info = pb2.ErrorInfo(
            code=error_code,
            message=message,
            details=details,
            suggestions=suggestions <span class="keyword">or</span> []
        )
        
        <span class="keyword">return</span> pb2.CalculationResponse(
            success=<span class="keyword">False</span>,
            error=error_info,
            metadata=<span class="keyword">self</span>._create_response_metadata()
        )
    
    <span class="keyword">def</span> <span class="function">_create_response_metadata</span>(<span class="keyword">self</span>) -> pb2.ResponseMetadata:
        <span class="string">"""åˆ›å»ºå“åº”å…ƒæ•°æ®"""</span>
        now = timestamp_pb2.Timestamp()
        now.GetCurrentTime()
        
        <span class="keyword">return</span> pb2.ResponseMetadata(
            server_id=<span class="keyword">self</span>.server_id,
            server_version=<span class="keyword">self</span>.server_version,
            response_time=now
        )
    
    <span class="keyword">def</span> <span class="function">_validate_request</span>(<span class="keyword">self</span>, request: pb2.CalculationRequest) -> Tuple[<span class="keyword">bool</span>, pb2.CalculationResponse]:
        <span class="string">"""å…¨é¢éªŒè¯è¯·æ±‚ - å±•ç¤ºå¼ºç±»å‹çº¦æŸ"""</span>
        
        <span class="comment"># 1. éªŒè¯æ“ä½œç±»å‹ (æšä¸¾çº¦æŸ)</span>
        is_valid, error_msg = TypeValidator.validate_operation_type(request.operation)
        <span class="keyword">if</span> <span class="keyword">not</span> is_valid:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="keyword">self</span>._create_error_response(
                pb2.ERROR_INVALID_OPERATION, 
                error_msg,
                suggestions=[<span class="string">"è¯·ä½¿ç”¨æœ‰æ•ˆçš„æ“ä½œç±»å‹ï¼šADD, SUBTRACT, MULTIPLY, DIVIDE, POWER, SQRT, MODULO"</span>]
            )
        
        <span class="comment"># 2. æå–å’ŒéªŒè¯æ•°å€¼ (oneofçº¦æŸç¡®ä¿ç±»å‹å®‰å…¨)</span>
        <span class="keyword">try</span>:
            a, b = PrecisionCalculator.get_numeric_value(request)
        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="keyword">self</span>._create_error_response(
                pb2.ERROR_INVALID_OPERATION,
                <span class="keyword">str</span>(e),
                suggestions=[<span class="string">"è¯·ç¡®ä¿æ“ä½œæ•°å·²æ­£ç¡®è®¾ç½®"</span>]
            )
        
        <span class="comment"># 3. éªŒè¯æ•°å€¼èŒƒå›´</span>
        is_valid, error_msg = TypeValidator.validate_numeric_value(a, <span class="string">"æ“ä½œæ•°A"</span>)
        <span class="keyword">if</span> <span class="keyword">not</span> is_valid:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="keyword">self</span>._create_error_response(pb2.ERROR_NUMBER_TOO_LARGE, error_msg)
        
        <span class="keyword">if</span> request.operation != pb2.OPERATION_SQRT:
            is_valid, error_msg = TypeValidator.validate_numeric_value(b, <span class="string">"æ“ä½œæ•°B"</span>)
            <span class="keyword">if</span> <span class="keyword">not</span> is_valid:
                <span class="keyword">return</span> <span class="keyword">False</span>, <span class="keyword">self</span>._create_error_response(pb2.ERROR_NUMBER_TOO_LARGE, error_msg)
        
        <span class="comment"># 4. éªŒè¯ç‰¹å®šæ“ä½œçš„çº¦æŸ</span>
        <span class="keyword">if</span> request.operation == pb2.OPERATION_DIVIDE <span class="keyword">and</span> b == <span class="number">0</span>:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="keyword">self</span>._create_error_response(
                pb2.ERROR_DIVISION_BY_ZERO,
                <span class="string">"é™¤æ•°ä¸èƒ½ä¸ºé›¶"</span>,
                suggestions=[<span class="string">"è¯·ä½¿ç”¨éé›¶çš„é™¤æ•°"</span>]
            )
        
        <span class="keyword">if</span> request.operation == pb2.OPERATION_SQRT <span class="keyword">and</span> a < <span class="number">0</span>:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="keyword">self</span>._create_error_response(
                pb2.ERROR_NEGATIVE_SQRT,
                <span class="string">"ä¸èƒ½è®¡ç®—è´Ÿæ•°çš„å¹³æ–¹æ ¹"</span>,
                suggestions=[<span class="string">"è¯·ä½¿ç”¨éè´Ÿæ•°"</span>]
            )
        
        <span class="comment"># 5. éªŒè¯ç²¾åº¦é…ç½®</span>
        <span class="keyword">if</span> request.config:
            is_valid, error_msg = TypeValidator.validate_precision_config(request.config)
            <span class="keyword">if</span> <span class="keyword">not</span> is_valid:
                <span class="keyword">return</span> <span class="keyword">False</span>, <span class="keyword">self</span>._create_error_response(pb2.ERROR_INVALID_OPERATION, error_msg)
        
        <span class="keyword">return</span> <span class="keyword">True</span>, <span class="keyword">None</span>
    
    <span class="keyword">def</span> <span class="function">Calculate</span>(<span class="keyword">self</span>, request: pb2.CalculationRequest, context) -> pb2.CalculationResponse:
        <span class="string">"""ä¸»è¦è®¡ç®—æ–¹æ³• - å¼ºç±»å‹çº¦æŸå®ç°"""</span>
        start_time = time.perf_counter()
        
        <span class="comment"># éªŒè¯è¯·æ±‚</span>
        is_valid, error_response = <span class="keyword">self</span>._validate_request(request)
        <span class="keyword">if</span> <span class="keyword">not</span> is_valid:
            <span class="keyword">return</span> error_response
        
        <span class="keyword">try</span>:
            <span class="comment"># æå–æ•°å€¼</span>
            a, b = PrecisionCalculator.get_numeric_value(request)
            
            <span class="comment"># æ‰§è¡Œè®¡ç®— - ä½¿ç”¨æšä¸¾ç¡®ä¿ç±»å‹å®‰å…¨</span>
            <span class="keyword">if</span> request.operation == pb2.OPERATION_ADD:
                result = a + b
                operation_str = <span class="string">f"{a} + {b}"</span>
            <span class="keyword">elif</span> request.operation == pb2.OPERATION_SUBTRACT:
                result = a - b
                operation_str = <span class="string">f"{a} - {b}"</span>
            <span class="keyword">elif</span> request.operation == pb2.OPERATION_MULTIPLY:
                result = a * b
                operation_str = <span class="string">f"{a} * {b}"</span>
            <span class="keyword">elif</span> request.operation == pb2.OPERATION_DIVIDE:
                result = a / b
                operation_str = <span class="string">f"{a} / {b}"</span>
            <span class="keyword">elif</span> request.operation == pb2.OPERATION_POWER:
                result = a ** b
                operation_str = <span class="string">f"{a} ^ {b}"</span>
            <span class="keyword">elif</span> request.operation == pb2.OPERATION_SQRT:
                result = math.sqrt(a)
                operation_str = <span class="string">f"âˆš{a}"</span>
            <span class="keyword">elif</span> request.operation == pb2.OPERATION_MODULO:
                result = a % b
                operation_str = <span class="string">f"{a} % {b}"</span>
            <span class="keyword">else</span>:
                <span class="keyword">return</span> <span class="keyword">self</span>._create_error_response(
                    pb2.ERROR_INVALID_OPERATION,
                    <span class="string">f"æœªå®ç°çš„æ“ä½œ: {request.operation}"</span>
                )
            
            <span class="comment"># æ£€æŸ¥ç»“æœæº¢å‡º</span>
            <span class="keyword">if</span> math.isinf(result):
                <span class="keyword">return</span> <span class="keyword">self</span>._create_error_response(
                    pb2.ERROR_OVERFLOW,
                    <span class="string">"è®¡ç®—ç»“æœæº¢å‡º"</span>,
                    details=<span class="string">f"æ“ä½œ: {operation_str}"</span>
                )
            
            <span class="comment"># ä½¿ç”¨é»˜è®¤é…ç½®å¦‚æœæœªæä¾›</span>
            config = request.config <span class="keyword">if</span> request.config <span class="keyword">else</span> pb2.CalculationConfig(
                precision=pb2.PRECISION_STANDARD,
                decimal_places=<span class="number">6</span>,
                use_scientific_notation=<span class="keyword">False</span>
            )
            
            <span class="comment"># æ ¼å¼åŒ–ç»“æœ</span>
            number_result, decimal_result, scientific_result = PrecisionCalculator.format_result(result, config)
            
            execution_time = <span class="keyword">int</span>((time.perf_counter() - start_time) * <span class="number">1_000_000</span>)  <span class="comment"># å¾®ç§’</span>
            
            <span class="comment"># æ„å»ºæˆåŠŸå“åº” - ä½¿ç”¨å¼ºç±»å‹ç»“æ„</span>
            response = pb2.CalculationResponse(
                number_result=result,
                success=<span class="keyword">True</span>,
                stats=pb2.CalculationStats(
                    execution_time_us=execution_time,
                    memory_used_bytes=<span class="number">64</span>,  <span class="comment"># ä¼°ç®—</span>
                    precision_lost=<span class="keyword">abs</span>(result - <span class="keyword">float</span>(decimal_result)) > NumericLimits.PRECISION_TOLERANCE,
                    intermediate_steps=<span class="number">1</span>
                ),
                metadata=<span class="keyword">self</span>._create_response_metadata()
            )
            
            <span class="comment"># æ ¹æ®ç²¾åº¦ç±»å‹è®¾ç½®ç›¸åº”çš„ç»“æœå­—æ®µ</span>
            <span class="keyword">if</span> config.precision == pb2.PRECISION_HIGH:
                response.decimal_result = decimal_result
            <span class="keyword">elif</span> config.precision == pb2.PRECISION_SCIENTIFIC:
                response.scientific_result = scientific_result
            
            logger.info(<span class="string">f"è®¡ç®—å®Œæˆ: {operation_str} = {result} (è€—æ—¶: {execution_time}Î¼s)"</span>)
            <span class="keyword">return</span> response
            
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            logger.error(<span class="string">f"è®¡ç®—é”™è¯¯: {e}"</span>)
            <span class="keyword">return</span> <span class="keyword">self</span>._create_error_response(
                pb2.ERROR_INVALID_OPERATION,
                <span class="string">f"è®¡ç®—å¤±è´¥: {<span class="keyword">str</span>(e)}"</span>
            )
    
    <span class="keyword">def</span> <span class="function">GetCapabilities</span>(<span class="keyword">self</span>, request: pb2.CapabilitiesRequest, context) -> pb2.CapabilitiesResponse:
        <span class="string">"""è·å–æœåŠ¡å™¨èƒ½åŠ› - å±•ç¤ºç±»å‹çº¦æŸä¿¡æ¯"""</span>
        <span class="keyword">return</span> pb2.CapabilitiesResponse(
            supported_operations=[
                pb2.OPERATION_ADD, pb2.OPERATION_SUBTRACT,
                pb2.OPERATION_MULTIPLY, pb2.OPERATION_DIVIDE,
                pb2.OPERATION_POWER, pb2.OPERATION_SQRT, pb2.OPERATION_MODULO
            ],
            supported_precisions=[
                pb2.PRECISION_STANDARD, pb2.PRECISION_HIGH, pb2.PRECISION_SCIENTIFIC
            ],
            max_number=NumericLimits.MAX_VALUE,
            min_number=NumericLimits.MIN_VALUE,
            max_decimal_places=NumericLimits.MAX_DECIMAL_PLACES,
            max_batch_size=<span class="number">1000</span>,
            max_concurrent_streams=<span class="number">100</span>,
            default_timeout_ms=<span class="number">30000</span>,
            server_version=<span class="keyword">self</span>.server_version,
            protocol_version=<span class="string">"v2.0"</span>
        )
    
    <span class="keyword">def</span> <span class="function">ValidateExpression</span>(<span class="keyword">self</span>, request: pb2.ValidationRequest, context) -> pb2.ValidationResponse:
        <span class="string">"""éªŒè¯è¡¨è¾¾å¼ - å±•ç¤ºé¢„æ£€æŸ¥çš„ç±»å‹çº¦æŸ"""</span>
        errors = []
        warnings = []
        suggestions = []
        
        <span class="comment"># æ‰§è¡ŒéªŒè¯ä½†ä¸è®¡ç®—</span>
        is_valid, error_response = <span class="keyword">self</span>._validate_request(request.request)
        
        <span class="keyword">if</span> <span class="keyword">not</span> is_valid:
            errors.append(error_response.error.message)
            suggestions.extend(error_response.error.suggestions)
        
        <span class="comment"># æ·»åŠ è­¦å‘Šå’Œå»ºè®®</span>
        <span class="keyword">try</span>:
            a, b = PrecisionCalculator.get_numeric_value(request.request)
            
            <span class="keyword">if</span> <span class="keyword">abs</span>(a) > <span class="number">1e10</span> <span class="keyword">or</span> <span class="keyword">abs</span>(b) > <span class="number">1e10</span>:
                warnings.append(<span class="string">"ä½¿ç”¨å¤§æ•°å€¼å¯èƒ½å½±å“ç²¾åº¦"</span>)
                suggestions.append(<span class="string">"è€ƒè™‘ä½¿ç”¨é«˜ç²¾åº¦æ¨¡å¼"</span>)
            
            <span class="comment"># é¢„ä¼°æ‰§è¡Œæ—¶é—´</span>
            estimated_time = <span class="number">100</span>  <span class="comment"># åŸºç¡€æ—¶é—´å¾®ç§’</span>
            <span class="keyword">if</span> request.request.operation == pb2.OPERATION_POWER:
                estimated_time *= <span class="number">5</span>  <span class="comment"># å¹‚è¿ç®—æ›´è€—æ—¶</span>
            
        <span class="keyword">except</span> Exception:
            estimated_time = <span class="number">0</span>
        
        <span class="keyword">return</span> pb2.ValidationResponse(
            is_valid=<span class="keyword">len</span>(errors) == <span class="number">0</span>,
            errors=errors,
            warnings=warnings,
            suggestions=suggestions,
            estimated_execution_time_us=estimated_time,
            expected_result_type=<span class="string">"number"</span>
        )

<span class="keyword">def</span> <span class="function">serve</span>():
    <span class="string">"""å¯åŠ¨å¢å¼ºå‹gRPCæœåŠ¡å™¨"""</span>
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))
    
    <span class="comment"># æ·»åŠ å¢å¼ºå‹æœåŠ¡</span>
    pb2_grpc.add_CalculatorV2Servicer_to_server(
        EnhancedCalculatorServicer(), server
    )
    
    listen_addr = <span class="string">'[::]:50052'</span>  <span class="comment"># ä½¿ç”¨ä¸åŒç«¯å£</span>
    server.add_insecure_port(listen_addr)
    
    server.start()
    logger.info(<span class="string">f"Enhanced Calculator gRPC server (å¼ºç±»å‹çº¦æŸç‰ˆæœ¬) started on {listen_addr}"</span>)
    
    <span class="keyword">try</span>:
        server.wait_for_termination()
    <span class="keyword">except</span> KeyboardInterrupt:
        logger.info(<span class="string">"Shutting down enhanced server..."</span>)
        server.stop(<span class="number">0</span>)

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    serve()
</code></pre>
            </div>
        </div>

        <div class="step">æ­¥éª¤ 3: å®ç°å¼ºç±»å‹çº¦æŸçš„gRPCå®¢æˆ·ç«¯</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">ğŸ</span>
                calculator_client_enhanced.py - å¼ºç±»å‹çº¦æŸç‰ˆæœ¬
            </div>
            <div class="code-content">
                <pre><code><span class="keyword">import</span> grpc
<span class="keyword">import</span> time
<span class="keyword">import</span> logging
<span class="keyword">import</span> uuid
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime
<span class="keyword">from</span> typing <span class="keyword">import</span> Optional, List, Union
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass
<span class="keyword">from</span> enum <span class="keyword">import</span> Enum

<span class="comment"># å¯¼å…¥ç”Ÿæˆçš„gRPCä»£ç </span>
<span class="keyword">import</span> calculator_enhanced_pb2 <span class="keyword">as</span> pb2
<span class="keyword">import</span> calculator_enhanced_pb2_grpc <span class="keyword">as</span> pb2_grpc
<span class="keyword">from</span> google.protobuf <span class="keyword">import</span> timestamp_pb2

<span class="comment"># é…ç½®æ—¥å¿—</span>
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

<span class="comment"># ============== å®¢æˆ·ç«¯ç±»å‹å®‰å…¨åŒ…è£…å™¨ ==============</span>

<span class="keyword">class</span> <span class="function">Operation</span>(Enum):
    <span class="string">"""æ“ä½œç±»å‹æšä¸¾ - å®¢æˆ·ç«¯ç±»å‹å®‰å…¨"""</span>
    ADD = pb2.OPERATION_ADD
    SUBTRACT = pb2.OPERATION_SUBTRACT
    MULTIPLY = pb2.OPERATION_MULTIPLY
    DIVIDE = pb2.OPERATION_DIVIDE
    POWER = pb2.OPERATION_POWER
    SQRT = pb2.OPERATION_SQRT
    MODULO = pb2.OPERATION_MODULO

<span class="keyword">class</span> <span class="function">PrecisionType</span>(Enum):
    <span class="string">"""ç²¾åº¦ç±»å‹æšä¸¾"""</span>
    STANDARD = pb2.PRECISION_STANDARD
    HIGH = pb2.PRECISION_HIGH
    SCIENTIFIC = pb2.PRECISION_SCIENTIFIC

<span class="keyword">@dataclass</span>
<span class="keyword">class</span> <span class="function">CalculationConfig</span>:
    <span class="string">"""è®¡ç®—é…ç½® - ç±»å‹å®‰å…¨çš„æ•°æ®ç±»"""</span>
    precision: PrecisionType = PrecisionType.STANDARD
    decimal_places: <span class="keyword">int</span> = <span class="number">6</span>
    use_scientific_notation: <span class="keyword">bool</span> = <span class="keyword">False</span>
    max_value: <span class="keyword">float</span> = <span class="number">1e15</span>
    min_value: <span class="keyword">float</span> = <span class="number">-1e15</span>
    timeout_ms: <span class="keyword">int</span> = <span class="number">30000</span>
    
    <span class="keyword">def</span> <span class="function">to_proto</span>(<span class="keyword">self</span>) -> pb2.CalculationConfig:
        <span class="string">"""è½¬æ¢ä¸ºprotobufæ¶ˆæ¯"""</span>
        <span class="keyword">return</span> pb2.CalculationConfig(
            precision=<span class="keyword">self</span>.precision.value,
            decimal_places=<span class="keyword">self</span>.decimal_places,
            use_scientific_notation=<span class="keyword">self</span>.use_scientific_notation,
            max_value=<span class="keyword">self</span>.max_value,
            min_value=<span class="keyword">self</span>.min_value,
            timeout_ms=<span class="keyword">self</span>.timeout_ms
        )

<span class="keyword">@dataclass</span>
<span class="keyword">class</span> <span class="function">CalculationResult</span>:
    <span class="string">"""è®¡ç®—ç»“æœ - ç±»å‹å®‰å…¨çš„ç»“æœç±»"""</span>
    success: <span class="keyword">bool</span>
    value: Optional[<span class="keyword">float</span>] = <span class="keyword">None</span>
    decimal_value: Optional[<span class="keyword">str</span>] = <span class="keyword">None</span>
    scientific_value: Optional[<span class="keyword">str</span>] = <span class="keyword">None</span>
    error_code: Optional[pb2.ErrorCode] = <span class="keyword">None</span>
    error_message: Optional[<span class="keyword">str</span>] = <span class="keyword">None</span>
    suggestions: List[<span class="keyword">str</span>] = <span class="keyword">None</span>
    execution_time_us: <span class="keyword">int</span> = <span class="number">0</span>
    precision_lost: <span class="keyword">bool</span> = <span class="keyword">False</span>
    
    <span class="keyword">def</span> <span class="function">__post_init__</span>(<span class="keyword">self</span>):
        <span class="keyword">if</span> <span class="keyword">self</span>.suggestions <span class="keyword">is</span> <span class="keyword">None</span>:
            <span class="keyword">self</span>.suggestions = []

<span class="keyword">class</span> <span class="function">InputValidator</span>:
    <span class="string">"""å®¢æˆ·ç«¯è¾“å…¥éªŒè¯å™¨ - æ—©æœŸç±»å‹æ£€æŸ¥"""</span>
    
    <span class="keyword">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">validate_number</span>(value: Union[<span class="keyword">int</span>, <span class="keyword">float</span>, <span class="keyword">str</span>], name: <span class="keyword">str</span>) -> <span class="keyword">float</span>:
        <span class="string">"""éªŒè¯å¹¶è½¬æ¢æ•°å­—"""</span>
        <span class="keyword">try</span>:
            num = <span class="keyword">float</span>(value)
            <span class="keyword">if</span> <span class="keyword">not</span> (-<span class="number">1e15</span> <= num <= <span class="number">1e15</span>):
                <span class="keyword">raise</span> ValueError(<span class="string">f"{name} è¶…å‡ºå…è®¸èŒƒå›´ (-1e15 åˆ° 1e15)"</span>)
            <span class="keyword">return</span> num
        <span class="keyword">except</span> (ValueError, TypeError) <span class="keyword">as</span> e:
            <span class="keyword">raise</span> TypeError(<span class="string">f"{name} å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—: {e}"</span>)
    
    <span class="keyword">@staticmethod</span>
    <span class="keyword">def</span> <span class="function">validate_operation</span>(operation: Union[Operation, <span class="keyword">str</span>]) -> Operation:
        <span class="string">"""éªŒè¯æ“ä½œç±»å‹"""</span>
        <span class="keyword">if</span> <span class="keyword">isinstance</span>(operation, <span class="keyword">str</span>):
            <span class="keyword">try</span>:
                <span class="keyword">return</span> Operation[operation.upper()]
            <span class="keyword">except</span> KeyError:
                valid_ops = <span class="string">", "</span>.join([op.name <span class="keyword">for</span> op <span class="keyword">in</span> Operation])
                <span class="keyword">raise</span> ValueError(<span class="string">f"æ— æ•ˆçš„æ“ä½œç±»å‹: {operation}. æœ‰æ•ˆç±»å‹: {valid_ops}"</span>)
        
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">isinstance</span>(operation, Operation):
            <span class="keyword">raise</span> TypeError(<span class="string">"æ“ä½œç±»å‹å¿…é¡»æ˜¯ Operation æšä¸¾æˆ–å­—ç¬¦ä¸²"</span>)
        
        <span class="keyword">return</span> operation

<span class="comment"># ============== å¼ºç±»å‹çº¦æŸçš„å®¢æˆ·ç«¯ ==============</span>

<span class="keyword">class</span> <span class="function">EnhancedCalculatorClient</span>:
    <span class="string">"""å¢å¼ºå‹è®¡ç®—å™¨å®¢æˆ·ç«¯ - å¼ºç±»å‹çº¦æŸç‰ˆæœ¬"""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="keyword">self</span>, server_address: <span class="keyword">str</span> = <span class="string">'localhost:50052'</span>):
        <span class="keyword">self</span>.server_address = server_address
        <span class="keyword">self</span>.channel: Optional[grpc.Channel] = <span class="keyword">None</span>
        <span class="keyword">self</span>.stub: Optional[pb2_grpc.CalculatorV2Stub] = <span class="keyword">None</span>
        <span class="keyword">self</span>.client_id = <span class="keyword">str</span>(uuid.uuid4())[:8]
        <span class="keyword">self</span>.client_version = <span class="string">"v2.0.0"</span>
        <span class="keyword">self</span>.server_capabilities: Optional[pb2.CapabilitiesResponse] = <span class="keyword">None</span>
    
    <span class="keyword">def</span> <span class="function">connect</span>(<span class="keyword">self</span>) -> <span class="keyword">bool</span>:
        <span class="string">"""è¿æ¥åˆ°gRPCæœåŠ¡å™¨å¹¶è·å–èƒ½åŠ›ä¿¡æ¯"""</span>
        <span class="keyword">try</span>:
            <span class="keyword">self</span>.channel = grpc.insecure_channel(<span class="keyword">self</span>.server_address)
            <span class="keyword">self</span>.stub = pb2_grpc.CalculatorV2Stub(<span class="keyword">self</span>.channel)
            
            <span class="comment"># è·å–æœåŠ¡å™¨èƒ½åŠ›</span>
            <span class="keyword">self</span>.server_capabilities = <span class="keyword">self</span>.stub.GetCapabilities(pb2.CapabilitiesRequest())
            
            logger.info(<span class="string">f"å·²è¿æ¥åˆ°æœåŠ¡å™¨ {<span class="keyword">self</span>.server_address}"</span>)
            logger.info(<span class="string">f"æœåŠ¡å™¨ç‰ˆæœ¬: {<span class="keyword">self</span>.server_capabilities.server_version}"</span>)
            logger.info(<span class="string">f"æ”¯æŒçš„æ“ä½œ: {[op <span class="keyword">for</span> op <span class="keyword">in</span> <span class="keyword">self</span>.server_capabilities.supported_operations]}"</span>)
            
            <span class="keyword">return</span> <span class="keyword">True</span>
            
        <span class="keyword">except</span> grpc.RpcError <span class="keyword">as</span> e:
            logger.error(<span class="string">f"è¿æ¥å¤±è´¥: {e.details()}"</span>)
            <span class="keyword">return</span> <span class="keyword">False</span>
    
    <span class="keyword">def</span> <span class="function">disconnect</span>(<span class="keyword">self</span>):
        <span class="string">"""æ–­å¼€è¿æ¥"""</span>
        <span class="keyword">if</span> <span class="keyword">self</span>.channel:
            <span class="keyword">self</span>.channel.close()
            logger.info(<span class="string">"å·²æ–­å¼€æœåŠ¡å™¨è¿æ¥"</span>)
    
    <span class="keyword">def</span> <span class="function">_create_request_metadata</span>(<span class="keyword">self</span>, priority: <span class="keyword">int</span> = <span class="number">5</span>) -> pb2.RequestMetadata:
        <span class="string">"""åˆ›å»ºè¯·æ±‚å…ƒæ•°æ®"""</span>
        now = timestamp_pb2.Timestamp()
        now.GetCurrentTime()
        
        <span class="keyword">return</span> pb2.RequestMetadata(
            request_id=<span class="keyword">str</span>(uuid.uuid4()),
            client_id=<span class="keyword">self</span>.client_id,
            client_version=<span class="keyword">self</span>.client_version,
            request_time=now,
            priority=priority
        )
    
    <span class="keyword">def</span> <span class="function">_parse_response</span>(<span class="keyword">self</span>, response: pb2.CalculationResponse) -> CalculationResult:
        <span class="string">"""è§£æå“åº”ä¸ºç±»å‹å®‰å…¨çš„ç»“æœå¯¹è±¡"""</span>
        <span class="keyword">if</span> response.success:
            <span class="comment"># æå–ç»“æœå€¼</span>
            value = <span class="keyword">None</span>
            decimal_value = <span class="keyword">None</span>
            scientific_value = <span class="keyword">None</span>
            
            <span class="keyword">if</span> response.HasField(<span class="string">"number_result"</span>):
                value = response.number_result
            <span class="keyword">if</span> response.HasField(<span class="string">"decimal_result"</span>):
                decimal_value = response.decimal_result
            <span class="keyword">if</span> response.HasField(<span class="string">"scientific_result"</span>):
                scientific_value = response.scientific_result
            
            <span class="keyword">return</span> CalculationResult(
                success=<span class="keyword">True</span>,
                value=value,
                decimal_value=decimal_value,
                scientific_value=scientific_value,
                execution_time_us=response.stats.execution_time_us <span class="keyword">if</span> response.stats <span class="keyword">else</span> <span class="number">0</span>,
                precision_lost=response.stats.precision_lost <span class="keyword">if</span> response.stats <span class="keyword">else</span> <span class="keyword">False</span>
            )
        <span class="keyword">else</span>:
            <span class="keyword">return</span> CalculationResult(
                success=<span class="keyword">False</span>,
                error_code=response.error.code,
                error_message=response.error.message,
                suggestions=<span class="keyword">list</span>(response.error.suggestions)
            )
    
    <span class="keyword">def</span> <span class="function">calculate</span>(<span class="keyword">self</span>, 
                a: Union[<span class="keyword">int</span>, <span class="keyword">float</span>, <span class="keyword">str</span>], 
                b: Union[<span class="keyword">int</span>, <span class="keyword">float</span>, <span class="keyword">str</span>], 
                operation: Union[Operation, <span class="keyword">str</span>],
                config: Optional[CalculationConfig] = <span class="keyword">None</span>,
                use_high_precision: <span class="keyword">bool</span> = <span class="keyword">False</span>) -> CalculationResult:
        <span class="string">"""æ‰§è¡Œè®¡ç®— - å¼ºç±»å‹çº¦æŸæ¥å£"""</span>
        
        <span class="keyword">try</span>:
            <span class="comment"># å®¢æˆ·ç«¯ç±»å‹éªŒè¯</span>
            validated_a = InputValidator.validate_number(a, <span class="string">"æ“ä½œæ•°A"</span>)
            validated_operation = InputValidator.validate_operation(operation)
            
            <span class="comment"># å¯¹äºå¼€æ–¹æ“ä½œï¼Œä¸éœ€è¦ç¬¬äºŒä¸ªæ“ä½œæ•°</span>
            <span class="keyword">if</span> validated_operation == Operation.SQRT:
                validated_b = <span class="number">0</span>  <span class="comment"># å ä½ç¬¦</span>
            <span class="keyword">else</span>:
                validated_b = InputValidator.validate_number(b, <span class="string">"æ“ä½œæ•°B"</span>)
            
            <span class="comment"># åˆ›å»ºé…ç½®</span>
            <span class="keyword">if</span> config <span class="keyword">is</span> <span class="keyword">None</span>:
                config = CalculationConfig()
                <span class="keyword">if</span> use_high_precision:
                    config.precision = PrecisionType.HIGH
                    config.decimal_places = <span class="number">15</span>
            
            <span class="comment"># æ„å»ºè¯·æ±‚ - ä½¿ç”¨oneofç¡®ä¿ç±»å‹å®‰å…¨</span>
            request = pb2.CalculationRequest(
                operation=validated_operation.value,
                config=config.to_proto(),
                metadata=<span class="keyword">self</span>._create_request_metadata()
            )
            
            <span class="comment"># æ ¹æ®ç²¾åº¦ç±»å‹è®¾ç½®æ“ä½œæ•°</span>
            <span class="keyword">if</span> use_high_precision:
                request.decimal_a = <span class="keyword">str</span>(validated_a)
                <span class="keyword">if</span> validated_operation != Operation.SQRT:
                    request.decimal_b = <span class="keyword">str</span>(validated_b)
            <span class="keyword">else</span>:
                request.number_a = validated_a
                <span class="keyword">if</span> validated_operation != Operation.SQRT:
                    request.number_b = validated_b
            
            <span class="comment"># å‘é€è¯·æ±‚</span>
            response = <span class="keyword">self</span>.stub.Calculate(request)
            <span class="keyword">return</span> <span class="keyword">self</span>._parse_response(response)
            
        <span class="keyword">except</span> (TypeError, ValueError) <span class="keyword">as</span> e:
            <span class="comment"># å®¢æˆ·ç«¯éªŒè¯é”™è¯¯</span>
            <span class="keyword">return</span> CalculationResult(
                success=<span class="keyword">False</span>,
                error_message=<span class="string">f"å®¢æˆ·ç«¯éªŒè¯å¤±è´¥: {e}"</span>,
                suggestions=[<span class="string">"è¯·æ£€æŸ¥è¾“å…¥å‚æ•°çš„ç±»å‹å’ŒèŒƒå›´"</span>]
            )
        <span class="keyword">except</span> grpc.RpcError <span class="keyword">as</span> e:
            <span class="comment"># gRPCé€šä¿¡é”™è¯¯</span>
            <span class="keyword">return</span> CalculationResult(
                success=<span class="keyword">False</span>,
                error_message=<span class="string">f"é€šä¿¡é”™è¯¯: {e.details()}"</span>
            )
    
    <span class="keyword">def</span> <span class="function">validate_expression</span>(<span class="keyword">self</span>, 
                           a: Union[<span class="keyword">int</span>, <span class="keyword">float</span>, <span class="keyword">str</span>], 
                           b: Union[<span class="keyword">int</span>, <span class="keyword">float</span>, <span class="keyword">str</span>], 
                           operation: Union[Operation, <span class="keyword">str</span>]) -> pb2.ValidationResponse:
        <span class="string">"""éªŒè¯è¡¨è¾¾å¼è€Œä¸æ‰§è¡Œè®¡ç®—"""</span>
        <span class="keyword">try</span>:
            validated_a = InputValidator.validate_number(a, <span class="string">"æ“ä½œæ•°A"</span>)
            validated_b = InputValidator.validate_number(b, <span class="string">"æ“ä½œæ•°B"</span>) <span class="keyword">if</span> operation != <span class="string">"SQRT"</span> <span class="keyword">else</span> <span class="number">0</span>
            validated_operation = InputValidator.validate_operation(operation)
            
            request = pb2.CalculationRequest(
                number_a=validated_a,
                number_b=validated_b,
                operation=validated_operation.value
            )
            
            validation_request = pb2.ValidationRequest(
                request=request,
                level=pb2.ValidationRequest.COMPLETE
            )
            
            <span class="keyword">return</span> <span class="keyword">self</span>.stub.ValidateExpression(validation_request)
            
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            <span class="comment"># è¿”å›å®¢æˆ·ç«¯éªŒè¯é”™è¯¯</span>
            <span class="keyword">return</span> pb2.ValidationResponse(
                is_valid=<span class="keyword">False</span>,
                errors=[<span class="string">f"å®¢æˆ·ç«¯éªŒè¯å¤±è´¥: {e}"</span>]
            )
    
    <span class="keyword">def</span> <span class="function">get_server_info</span>(<span class="keyword">self</span>) -> Optional[pb2.CapabilitiesResponse]:
        <span class="string">"""è·å–æœåŠ¡å™¨èƒ½åŠ›ä¿¡æ¯"""</span>
        <span class="keyword">return</span> <span class="keyword">self</span>.server_capabilities

<span class="comment"># ============== ç±»å‹å®‰å…¨çš„æ¼”ç¤ºå‡½æ•° ==============</span>

<span class="keyword">def</span> <span class="function">demo_type_safety</span>():
    <span class="string">"""æ¼”ç¤ºå¼ºç±»å‹çº¦æŸçš„ä¼˜åŠ¿"""</span>
    client = EnhancedCalculatorClient()
    
    <span class="keyword">if</span> <span class="keyword">not</span> client.connect():
        <span class="keyword">print</span>(<span class="string">"âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨"</span>)
        <span class="keyword">return</span>
    
    <span class="keyword">print</span>(<span class="string">"=== å¼ºç±»å‹çº¦æŸæ¼”ç¤º ==="</span>)
    
    <span class="comment"># 1. æ­£å¸¸è®¡ç®— - ç±»å‹å®‰å…¨</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¹ æ­£å¸¸è®¡ç®—æ¼”ç¤º:"</span>)
    result = client.calculate(<span class="number">10.5</span>, <span class="number">3.2</span>, Operation.ADD)
    <span class="keyword">print</span>(<span class="string">f"10.5 + 3.2 = {result.value} (æˆåŠŸ: {result.success})"</span>)
    
    <span class="comment"># 2. æšä¸¾ç±»å‹çº¦æŸ</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¹ ä½¿ç”¨å­—ç¬¦ä¸²æ“ä½œç±»å‹ (è‡ªåŠ¨è½¬æ¢):"</span>)
    result = client.calculate(<span class="number">8</span>, <span class="number">2</span>, <span class="string">"DIVIDE"</span>)  <span class="comment"># å­—ç¬¦ä¸²ä¼šè¢«è½¬æ¢ä¸ºæšä¸¾</span>
    <span class="keyword">print</span>(<span class="string">f"8 Ã· 2 = {result.value} (æˆåŠŸ: {result.success})"</span>)
    
    <span class="comment"># 3. é«˜ç²¾åº¦è®¡ç®—</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¹ é«˜ç²¾åº¦è®¡ç®—:"</span>)
    result = client.calculate(<span class="string">"123.456789012345"</span>, <span class="string">"987.654321098765"</span>, 
                            Operation.MULTIPLY, use_high_precision=<span class="keyword">True</span>)
    <span class="keyword">print</span>(<span class="string">f"é«˜ç²¾åº¦ä¹˜æ³•: {result.decimal_value} (ç²¾åº¦æŸå¤±: {result.precision_lost})"</span>)
    
    <span class="comment"># 4. å•æ“ä½œæ•°è¿ç®— (å¼€æ–¹)</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¹ å¼€æ–¹è¿ç®— (å•æ“ä½œæ•°):"</span>)
    result = client.calculate(<span class="number">16</span>, <span class="number">0</span>, Operation.SQRT)  <span class="comment"># bä¼šè¢«å¿½ç•¥</span>
    <span class="keyword">print</span>(<span class="string">f"âˆš16 = {result.value} (æˆåŠŸ: {result.success})"</span>)
    
    <span class="comment"># 5. ç±»å‹é”™è¯¯å¤„ç†</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¹ ç±»å‹é”™è¯¯å¤„ç†:"</span>)
    
    <span class="comment"># æ— æ•ˆæ“ä½œç±»å‹</span>
    result = client.calculate(<span class="number">5</span>, <span class="number">3</span>, <span class="string">"INVALID_OP"</span>)
    <span class="keyword">print</span>(<span class="string">f"æ— æ•ˆæ“ä½œ: {result.error_message}"</span>)
    
    <span class="comment"># æ— æ•ˆæ•°å€¼</span>
    result = client.calculate(<span class="string">"abc"</span>, <span class="number">3</span>, Operation.ADD)
    <span class="keyword">print</span>(<span class="string">f"æ— æ•ˆæ•°å€¼: {result.error_message}"</span>)
    
    <span class="comment"># 6. æœåŠ¡ç«¯éªŒè¯</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¹ æœåŠ¡ç«¯ç±»å‹éªŒè¯:"</span>)
    
    <span class="comment"># é™¤é›¶é”™è¯¯</span>
    result = client.calculate(<span class="number">10</span>, <span class="number">0</span>, Operation.DIVIDE)
    <span class="keyword">print</span>(<span class="string">f"é™¤é›¶é”™è¯¯: {result.error_message}"</span>)
    <span class="keyword">if</span> result.suggestions:
        <span class="keyword">print</span>(<span class="string">f"å»ºè®®: {', '.join(result.suggestions)}"</span>)
    
    <span class="comment"># è´Ÿæ•°å¼€æ–¹</span>
    result = client.calculate(<span class="number">-4</span>, <span class="number">0</span>, Operation.SQRT)
    <span class="keyword">print</span>(<span class="string">f"è´Ÿæ•°å¼€æ–¹: {result.error_message}"</span>)
    
    <span class="comment"># 7. è¡¨è¾¾å¼é¢„éªŒè¯</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¹ è¡¨è¾¾å¼é¢„éªŒè¯:"</span>)
    validation = client.validate_expression(<span class="number">100</span>, <span class="number">5</span>, Operation.DIVIDE)
    <span class="keyword">print</span>(<span class="string">f"è¡¨è¾¾å¼æœ‰æ•ˆ: {validation.is_valid}"</span>)
    <span class="keyword">print</span>(<span class="string">f"é¢„ä¼°æ‰§è¡Œæ—¶é—´: {validation.estimated_execution_time_us}Î¼s"</span>)
    
    <span class="comment"># 8. æœåŠ¡å™¨èƒ½åŠ›æŸ¥è¯¢</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¹ æœåŠ¡å™¨èƒ½åŠ›:"</span>)
    capabilities = client.get_server_info()
    <span class="keyword">if</span> capabilities:
        <span class="keyword">print</span>(<span class="string">f"æœ€å¤§æ•°å€¼: {capabilities.max_number}"</span>)
        <span class="keyword">print</span>(<span class="string">f"æœ€å¤§å°æ•°ä½: {capabilities.max_decimal_places}"</span>)
        <span class="keyword">print</span>(<span class="string">f"æ”¯æŒçš„ç²¾åº¦ç±»å‹: {<span class="keyword">len</span>(capabilities.supported_precisions)}"</span>)
    
    client.disconnect()

<span class="keyword">def</span> <span class="function">interactive_type_safe_demo</span>():
    <span class="string">"""äº¤äº’å¼ç±»å‹å®‰å…¨æ¼”ç¤º"""</span>
    client = EnhancedCalculatorClient()
    
    <span class="keyword">if</span> <span class="keyword">not</span> client.connect():
        <span class="keyword">print</span>(<span class="string">"âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨"</span>)
        <span class="keyword">return</span>
    
    <span class="keyword">print</span>(<span class="string">"\n=== ç±»å‹å®‰å…¨äº¤äº’å¼è®¡ç®—å™¨ ==="</span>)
    <span class="keyword">print</span>(<span class="string">"æ”¯æŒçš„æ“ä½œ: ADD, SUBTRACT, MULTIPLY, DIVIDE, POWER, SQRT, MODULO"</span>)
    <span class="keyword">print</span>(<span class="string">"è¾“å…¥ 'quit' é€€å‡º, 'info' æŸ¥çœ‹æœåŠ¡å™¨ä¿¡æ¯"</span>)
    
    <span class="keyword">while</span> <span class="keyword">True</span>:
        <span class="keyword">try</span>:
            cmd = input(<span class="string">"\n> "</span>).strip()
            
            <span class="keyword">if</span> cmd.lower() == <span class="string">'quit'</span>:
                <span class="keyword">break</span>
            <span class="keyword">elif</span> cmd.lower() == <span class="string">'info'</span>:
                capabilities = client.get_server_info()
                <span class="keyword">if</span> capabilities:
                    <span class="keyword">print</span>(<span class="string">f"æœåŠ¡å™¨ç‰ˆæœ¬: {capabilities.server_version}"</span>)
                    <span class="keyword">print</span>(<span class="string">f"åè®®ç‰ˆæœ¬: {capabilities.protocol_version}"</span>)
                    <span class="keyword">print</span>(<span class="string">f"æ•°å€¼èŒƒå›´: {capabilities.min_number} åˆ° {capabilities.max_number}"</span>)
                <span class="keyword">continue</span>
            
            operation = input(<span class="string">"æ“ä½œç±»å‹: "</span>).strip().upper()
            a = input(<span class="string">"ç¬¬ä¸€ä¸ªæ•°: "</span>).strip()
            
            <span class="keyword">if</span> operation != <span class="string">'SQRT'</span>:
                b = input(<span class="string">"ç¬¬äºŒä¸ªæ•°: "</span>).strip()
            <span class="keyword">else</span>:
                b = <span class="string">"0"</span>
            
            precision = input(<span class="string">"ä½¿ç”¨é«˜ç²¾åº¦? (y/n): "</span>).strip().lower() == <span class="string">'y'</span>
            
            <span class="comment"># æ‰§è¡Œè®¡ç®—</span>
            result = client.calculate(a, b, operation, use_high_precision=precision)
            
            <span class="keyword">if</span> result.success:
                <span class="keyword">if</span> precision <span class="keyword">and</span> result.decimal_value:
                    <span class="keyword">print</span>(<span class="string">f"âœ… ç»“æœ: {result.decimal_value}"</span>)
                <span class="keyword">else</span>:
                    <span class="keyword">print</span>(<span class="string">f"âœ… ç»“æœ: {result.value}"</span>)
                <span class="keyword">print</span>(<span class="string">f"   æ‰§è¡Œæ—¶é—´: {result.execution_time_us}Î¼s"</span>)
                <span class="keyword">if</span> result.precision_lost:
                    <span class="keyword">print</span>(<span class="string">"   âš ï¸  æ£€æµ‹åˆ°ç²¾åº¦æŸå¤±"</span>)
            <span class="keyword">else</span>:
                <span class="keyword">print</span>(<span class="string">f"âŒ é”™è¯¯: {result.error_message}"</span>)
                <span class="keyword">if</span> result.suggestions:
                    <span class="keyword">print</span>(<span class="string">f"   å»ºè®®: {', '.join(result.suggestions)}"</span>)
                    
        <span class="keyword">except</span> KeyboardInterrupt:
            <span class="keyword">break</span>
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            <span class="keyword">print</span>(<span class="string">f"âŒ è¾“å…¥é”™è¯¯: {e}"</span>)
    
    client.disconnect()
    <span class="keyword">print</span>(<span class="string">"ğŸ‘‹ å†è§ï¼"</span>)

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    <span class="keyword">try</span>:
        demo_type_safety()
        interactive_type_safe_demo()
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="keyword">print</span>(<span class="string">f"æ¼”ç¤ºé”™è¯¯: {e}"</span>)
</code></pre>
            </div>
        </div>

        <div class="step">æ­¥éª¤ 4: åˆ›å»ºé¡¹ç›®å¯åŠ¨è„šæœ¬</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">ğŸ“œ</span>
                run_demo.py
            </div>
            <div class="code-content">
                <pre><code><span class="keyword">import</span> subprocess
<span class="keyword">import</span> sys
<span class="keyword">import</span> time
<span class="keyword">import</span> threading
<span class="keyword">import</span> os

<span class="keyword">def</span> <span class="function">generate_proto_code</span>():
    <span class="string">"""ç”ŸæˆProtocol Bufferä»£ç """</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ”§ ç”ŸæˆgRPCä»£ç ..."</span>)
    
    <span class="comment"># åˆ›å»ºprotoæ–‡ä»¶</span>
    proto_content = <span class="string">'''syntax = "proto3";

package calculator;

service Calculator {
    rpc Add(BinaryOperation) returns (Result);
    rpc Subtract(BinaryOperation) returns (Result);
    rpc Multiply(BinaryOperation) returns (Result);
    rpc Divide(BinaryOperation) returns (Result);
    rpc CalculateStream(stream BinaryOperation) returns (stream Result);
}

message BinaryOperation {
    double a = 1;
    double b = 2;
    string operation = 3;
}

message Result {
    double value = 1;
    string message = 2;
    bool success = 3;
}'''</span>
    
    <span class="keyword">with</span> open(<span class="string">'calculator.proto'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:
        f.write(proto_content)
    
    <span class="comment"># ç”ŸæˆPythonä»£ç </span>
    <span class="keyword">try</span>:
        subprocess.run([
            sys.executable, <span class="string">'-m'</span>, <span class="string">'grpc_tools.protoc'</span>,
            <span class="string">'--proto_path=.'</span>,
            <span class="string">'--python_out=.'</span>,
            <span class="string">'--grpc_python_out=.'</span>,
            <span class="string">'calculator.proto'</span>
        ], check=<span class="keyword">True</span>)
        <span class="keyword">print</span>(<span class="string">"âœ… gRPCä»£ç ç”ŸæˆæˆåŠŸï¼"</span>)
    <span class="keyword">except</span> subprocess.CalledProcessError:
        <span class="keyword">print</span>(<span class="string">"âŒ ä»£ç ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥grpcio-toolsæ˜¯å¦å®‰è£…"</span>)
        <span class="keyword">return</span> <span class="keyword">False</span>
    
    <span class="keyword">return</span> <span class="keyword">True</span>

<span class="keyword">def</span> <span class="function">check_dependencies</span>():
    <span class="string">"""æ£€æŸ¥ä¾èµ–åŒ…"""</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ“¦ æ£€æŸ¥ä¾èµ–åŒ…..."</span>)
    
    required_packages = [<span class="string">'grpcio'</span>, <span class="string">'grpcio-tools'</span>]
    missing_packages = []
    
    <span class="keyword">for</span> package <span class="keyword">in</span> required_packages:
        <span class="keyword">try</span>:
            __import__(package.replace(<span class="string">'-'</span>, <span class="string">'_'</span>))
        <span class="keyword">except</span> ImportError:
            missing_packages.append(package)
    
    <span class="keyword">if</span> missing_packages:
        <span class="keyword">print</span>(<span class="string">f"âŒ ç¼ºå°‘ä¾èµ–åŒ…: {', '.join(missing_packages)}"</span>)
        <span class="keyword">print</span>(<span class="string">"è¯·è¿è¡Œ: pip install grpcio grpcio-tools"</span>)
        <span class="keyword">return</span> <span class="keyword">False</span>
    
    <span class="keyword">print</span>(<span class="string">"âœ… æ‰€æœ‰ä¾èµ–åŒ…å·²å®‰è£…"</span>)
    <span class="keyword">return</span> <span class="keyword">True</span>

<span class="keyword">def</span> <span class="function">run_server</span>():
    <span class="string">"""åœ¨åå°è¿è¡ŒæœåŠ¡å™¨"""</span>
    <span class="keyword">import</span> calculator_server
    calculator_server.serve()

<span class="keyword">def</span> <span class="function">main</span>():
    <span class="string">"""ä¸»å‡½æ•°"""</span>
    <span class="keyword">print</span>(<span class="string">"ğŸš€ gRPC Calculator Demo å¯åŠ¨ä¸­..."</span>)
    
    <span class="comment"># æ£€æŸ¥ä¾èµ–</span>
    <span class="keyword">if</span> <span class="keyword">not</span> check_dependencies():
        <span class="keyword">return</span>
    
    <span class="comment"># ç”Ÿæˆä»£ç </span>
    <span class="keyword">if</span> <span class="keyword">not</span> generate_proto_code():
        <span class="keyword">return</span>
    
    <span class="comment"># å¯åŠ¨æœåŠ¡å™¨</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ”¥ å¯åŠ¨gRPCæœåŠ¡å™¨..."</span>)
    server_thread = threading.Thread(target=run_server, daemon=<span class="keyword">True</span>)
    server_thread.start()
    
    <span class="comment"># ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨</span>
    time.sleep(<span class="number">2</span>)
    
    <span class="comment"># è¿è¡Œå®¢æˆ·ç«¯æ¼”ç¤º</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ¯ å¯åŠ¨å®¢æˆ·ç«¯æ¼”ç¤º..."</span>)
    <span class="keyword">import</span> calculator_client
    
    <span class="keyword">try</span>:
        calculator_client.demo_basic_operations()
        calculator_client.demo_stream_operations()
        
        <span class="keyword">print</span>(<span class="string">"\nğŸ® å¯åŠ¨äº¤äº’å¼æ¼”ç¤º..."</span>)
        calculator_client.interactive_demo()
        
    <span class="keyword">except</span> KeyboardInterrupt:
        <span class="keyword">print</span>(<span class="string">"\nğŸ‘‹ æ¼”ç¤ºç»“æŸ"</span>)

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    main()
</code></pre>
            </div>
        </div>

        <div class="step">æ­¥éª¤ 5: è¿è¡Œå¼ºç±»å‹çº¦æŸæ¼”ç¤º</div>

        <div class="demo-controls">
            <h3>ğŸ® è¿è¡Œè¯´æ˜</h3>
            <p>è¿™ä¸ªå¢å¼ºç‰ˆæ¼”ç¤ºå±•ç¤ºäº†gRPCå¼ºå¤§çš„ç±»å‹çº¦æŸèƒ½åŠ›ï¼š</p>
            <ul>
                <li><strong>å¼ºç±»å‹Protocol Bufferå®šä¹‰</strong> - æšä¸¾ã€oneofã€åµŒå¥—æ¶ˆæ¯</li>
                <li><strong>å¤šå±‚éªŒè¯æœºåˆ¶</strong> - å®¢æˆ·ç«¯é¢„éªŒè¯ + æœåŠ¡ç«¯ä¸šåŠ¡éªŒè¯</li>
                <li><strong>ç»“æ„åŒ–é”™è¯¯å¤„ç†</strong> - é”™è¯¯ä»£ç ã€è¯¦ç»†ä¿¡æ¯ã€ä¿®å¤å»ºè®®</li>
                <li><strong>é«˜ç²¾åº¦è®¡ç®—æ”¯æŒ</strong> - å¤šç§æ•°å€¼è¡¨ç¤ºæ ¼å¼</li>
                <li><strong>æœåŠ¡èƒ½åŠ›æŸ¥è¯¢</strong> - åŠ¨æ€è·å–æœåŠ¡å™¨æ”¯æŒçš„åŠŸèƒ½</li>
                <li><strong>ç±»å‹å®‰å…¨çš„å®¢æˆ·ç«¯åŒ…è£…å™¨</strong> - Pythonæšä¸¾å’Œæ•°æ®ç±»</li>
            </ul>
            
            <div class="command-section">
                <h3>ğŸ”§ è¿è¡Œæ­¥éª¤</h3>
                <pre><code># 1. å®‰è£…ä¾èµ–
pip install grpcio grpcio-tools

# 2. ç”Ÿæˆå¢å¼ºç‰ˆæœ¬çš„protoä»£ç 
python -m grpc_tools.protoc \
    --proto_path=. \
    --python_out=. \
    --grpc_python_out=. \
    calculator_enhanced.proto

# 3a. è¿è¡Œå¢å¼ºç‰ˆæœåŠ¡å™¨ (ç«¯å£50052)
python calculator_server_enhanced.py

# 3b. åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œå¢å¼ºç‰ˆå®¢æˆ·ç«¯
python calculator_client_enhanced.py

# æˆ–è€…åŒæ—¶è¿è¡ŒåŸºç¡€ç‰ˆæœ¬è¿›è¡Œå¯¹æ¯”ï¼š
# ç»ˆç«¯1: python calculator_server.py      (ç«¯å£50051)
# ç»ˆç«¯2: python calculator_server_enhanced.py (ç«¯å£50052)
# ç»ˆç«¯3: python calculator_client.py       (è¿æ¥50051)
# ç»ˆç«¯4: python calculator_client_enhanced.py (è¿æ¥50052)</code></pre>
            </div>
        </div>

        <div class="step">ğŸ¯ å¼ºç±»å‹çº¦æŸæ¼”ç¤ºå†…å®¹</div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 20px 0;">
            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">ğŸ”’</span>
                    ç±»å‹å®‰å…¨æ¼”ç¤º
                </div>
                <div class="code-content">
                    <p><strong>âœ… æ­£ç¡®ç”¨æ³•ï¼š</strong></p>
                    <p>â€¢ <code>Operation.ADD</code> - æšä¸¾ç±»å‹å®‰å…¨</p>
                    <p>â€¢ <code>"DIVIDE"</code> - å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢</p>
                    <p>â€¢ é«˜ç²¾åº¦åè¿›åˆ¶è®¡ç®—</p>
                    <p>â€¢ å•æ“ä½œæ•°è¿ç®—(å¼€æ–¹)</p>
                    <br>
                    <p><strong>âŒ é”™è¯¯å¤„ç†ï¼š</strong></p>
                    <p>â€¢ æ— æ•ˆæ“ä½œç±»å‹æ£€æµ‹</p>
                    <p>â€¢ æ— æ•ˆæ•°å€¼è¾“å…¥æ£€æµ‹</p>
                    <p>â€¢ é™¤é›¶é”™è¯¯é˜²æŠ¤</p>
                    <p>â€¢ è´Ÿæ•°å¼€æ–¹æ£€æµ‹</p>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">âš¡</span>
                    éªŒè¯æœºåˆ¶æ¼”ç¤º
                </div>
                <div class="code-content">
                    <p><strong>å®¢æˆ·ç«¯éªŒè¯ï¼š</strong></p>
                    <p>â€¢ è¾“å…¥ç±»å‹æ£€æŸ¥</p>
                    <p>â€¢ æ•°å€¼èŒƒå›´éªŒè¯</p>
                    <p>â€¢ æ“ä½œç±»å‹è½¬æ¢</p>
                    <p>â€¢ æ—©æœŸé”™è¯¯å‘ç°</p>
                    <br>
                    <p><strong>æœåŠ¡ç«¯éªŒè¯ï¼š</strong></p>
                    <p>â€¢ ä¸šåŠ¡é€»è¾‘æ£€æŸ¥</p>
                    <p>â€¢ æ•°å­¦çº¦æŸéªŒè¯</p>
                    <p>â€¢ ç²¾åº¦é…ç½®æ£€æŸ¥</p>
                    <p>â€¢ è¡¨è¾¾å¼é¢„éªŒè¯</p>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">ğŸ“Š</span>
                    å…ƒæ•°æ®å’Œç»Ÿè®¡
                </div>
                <div class="code-content">
                    <p><strong>è¯·æ±‚å…ƒæ•°æ®ï¼š</strong></p>
                    <p>â€¢ å”¯ä¸€è¯·æ±‚ID</p>
                    <p>â€¢ å®¢æˆ·ç«¯ä¿¡æ¯</p>
                    <p>â€¢ æ—¶é—´æˆ³è®°å½•</p>
                    <p>â€¢ ä¼˜å…ˆçº§è®¾ç½®</p>
                    <br>
                    <p><strong>æ‰§è¡Œç»Ÿè®¡ï¼š</strong></p>
                    <p>â€¢ å¾®ç§’çº§æ‰§è¡Œæ—¶é—´</p>
                    <p>â€¢ å†…å­˜ä½¿ç”¨é‡</p>
                    <p>â€¢ ç²¾åº¦æŸå¤±æ£€æµ‹</p>
                    <p>â€¢ æœåŠ¡å™¨èƒ½åŠ›æŸ¥è¯¢</p>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">ğŸ®</span>
                    äº¤äº’ä½“éªŒ
                </div>
                <div class="code-content">
                    <p><strong>æ¼”ç¤ºæ¨¡å¼ï¼š</strong></p>
                    <p>â€¢ ç±»å‹å®‰å…¨è®¡ç®—å±•ç¤º</p>
                    <p>â€¢ é”™è¯¯å¤„ç†æ¼”ç¤º</p>
                    <p>â€¢ é«˜ç²¾åº¦è®¡ç®—å¯¹æ¯”</p>
                    <p>â€¢ æœåŠ¡å™¨èƒ½åŠ›æŸ¥è¯¢</p>
                    <br>
                    <p><strong>äº¤äº’æ¨¡å¼ï¼š</strong></p>
                    <p>â€¢ ç±»å‹å®‰å…¨è¾“å…¥</p>
                    <p>â€¢ å®æ—¶éªŒè¯åé¦ˆ</p>
                    <p>â€¢ è¯¦ç»†é”™è¯¯ä¿¡æ¯</p>
                    <p>â€¢ ä¿®å¤å»ºè®®æç¤º</p>
                </div>
            </div>
        </div>

        <div class="step">æ­¥éª¤ 8: éƒ¨ç½²å’Œæœ€ä½³å®è·µæŒ‡å—</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">ğŸ“‹</span>
                best_practices.md - gRPCå¼ºç±»å‹çº¦æŸæœ€ä½³å®è·µ
            </div>
            <div class="code-content">
                <pre><code># gRPCå¼ºç±»å‹çº¦æŸæœ€ä½³å®è·µæŒ‡å—

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. ä¼˜å…ˆä½¿ç”¨å¼ºç±»å‹å®šä¹‰
```protobuf
// âœ… æ¨èï¼šä½¿ç”¨æšä¸¾ç±»å‹
enum OperationType {
    OPERATION_UNSPECIFIED = 0;  // æ€»æ˜¯åŒ…å«é»˜è®¤å€¼
    OPERATION_ADD = 1;
    OPERATION_SUBTRACT = 2;
}

// âŒ é¿å…ï¼šä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹
message BadRequest {
    string operation = 1;  // å®¹æ˜“å‡ºé”™
}
```

### 2. åˆç†ä½¿ç”¨oneofå­—æ®µ
```protobuf
// âœ… æ¨èï¼šç±»å‹å®‰å…¨çš„å¤šé€‰ä¸€
message CalculationRequest {
    oneof operand {
        double number = 1;
        string decimal_string = 2;
        bytes binary_data = 3;
    }
}

// âŒ é¿å…ï¼šå¤šä¸ªå¯é€‰å­—æ®µ
message BadRequest {
    optional double number = 1;
    optional string decimal_string = 2;  // å¯èƒ½åŒæ—¶è®¾ç½®
}
```

### 3. ç‰ˆæœ¬åŒ–ç®¡ç†
```protobuf
// âœ… æ¨èï¼šæ˜ç¡®çš„åŒ…ç‰ˆæœ¬
syntax = "proto3";
package myservice.v2;

// ä¿æŒå‘å‰å…¼å®¹
message RequestV2 {
    // æ–°å­—æ®µä½¿ç”¨æ–°çš„å­—æ®µå·
    string new_field = 10;
}
```

## ğŸ”§ å¼€å‘æœ€ä½³å®è·µ

### 1. å¤šå±‚éªŒè¯ç­–ç•¥
```python
# å®¢æˆ·ç«¯é¢„éªŒè¯
def validate_input(value):
    if not isinstance(value, (int, float)):
        raise TypeError("è¾“å…¥å¿…é¡»æ˜¯æ•°å­—")
    if abs(value) > MAX_VALUE:
        raise ValueError("æ•°å€¼è¶…å‡ºèŒƒå›´")

# æœåŠ¡ç«¯ä¸šåŠ¡éªŒè¯  
def validate_business_logic(request):
    if request.operation == DIVIDE and request.b == 0:
        return create_error(ERROR_DIVISION_BY_ZERO)
```

### 2. ç»“æ„åŒ–é”™è¯¯å¤„ç†
```python
# âœ… æ¨èï¼šç»“æ„åŒ–é”™è¯¯ä¿¡æ¯
class ErrorHandler:
    @staticmethod
    def create_error(code, message, suggestions=None):
        return ErrorInfo(
            code=code,
            message=message,
            suggestions=suggestions or [],
            context=get_current_context()
        )

# âŒ é¿å…ï¼šç®€å•å­—ç¬¦ä¸²é”™è¯¯
def bad_error_handling():
    return "something went wrong"
```

### 3. æ€§èƒ½ä¼˜åŒ–
```python
# âœ… æ¨èï¼šè¿æ¥æ± å’Œå¤ç”¨
class GrpcClientPool:
    def __init__(self, target, pool_size=10):
        self.channels = [
            grpc.insecure_channel(target) 
            for _ in range(pool_size)
        ]
    
    def get_stub(self):
        return MyServiceStub(random.choice(self.channels))

# âœ… æ¨èï¼šæ‰¹é‡æ“ä½œ
def batch_calculate(requests):
    return stub.BatchCalculate(
        BatchRequest(requests=requests)
    )
```

## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. å®‰å…¨é…ç½®
```python
# TLSé…ç½®
credentials = grpc.ssl_channel_credentials()
channel = grpc.secure_channel('server:443', credentials)

# è®¤è¯æ‹¦æˆªå™¨
def auth_interceptor(continuation, client_call_details, request):
    metadata = client_call_details.metadata or []
    metadata.append(('authorization', f'Bearer {get_token()}'))
    new_details = client_call_details._replace(metadata=metadata)
    return continuation(new_details, request)
```

### 2. ç›‘æ§å’Œå¯è§‚æµ‹æ€§
```python
# æŒ‡æ ‡æ”¶é›†
import prometheus_client

REQUEST_COUNT = prometheus_client.Counter(
    'grpc_requests_total',
    'Total gRPC requests',
    ['method', 'status']
)

REQUEST_DURATION = prometheus_client.Histogram(
    'grpc_request_duration_seconds',
    'gRPC request duration'
)

# é“¾è·¯è¿½è¸ª
def trace_interceptor(continuation, client_call_details, request):
    with tracer.start_span(client_call_details.method) as span:
        span.set_attribute('grpc.method', client_call_details.method)
        return continuation(client_call_details, request)
```

### 3. é…ç½®ç®¡ç†
```python
# ç¯å¢ƒé…ç½®
@dataclass
class GrpcConfig:
    server_address: str = os.getenv('GRPC_SERVER', 'localhost:50051')
    max_retries: int = int(os.getenv('GRPC_MAX_RETRIES', '3'))
    timeout_seconds: int = int(os.getenv('GRPC_TIMEOUT', '30'))
    
    # TLSè®¾ç½®
    use_tls: bool = os.getenv('GRPC_USE_TLS', 'false').lower() == 'true'
    cert_file: str = os.getenv('GRPC_CERT_FILE', '')
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
```python
class TestCalculatorService(unittest.TestCase):
    def setUp(self):
        self.servicer = CalculatorServicer()
        self.context = create_mock_context()
    
    def test_add_operation(self):
        request = CalculationRequest(a=10, b=5, operation=ADD)
        response = self.servicer.Calculate(request, self.context)
        self.assertEqual(response.result, 15)
```

### 2. é›†æˆæµ‹è¯•
```python
class TestIntegration(unittest.TestCase):
    @classmethod
    def setUpClass(cls):
        cls.server = start_test_server()
        cls.client = create_test_client()
    
    def test_end_to_end(self):
        result = self.client.calculate(10, 5, 'ADD')
        self.assertTrue(result.success)
```

### 3. æ€§èƒ½æµ‹è¯•
```python
def performance_test():
    with ThreadPoolExecutor(max_workers=100) as executor:
        futures = [
            executor.submit(client.calculate, i, i+1, 'ADD')
            for i in range(1000)
        ]
        
        results = [f.result() for f in futures]
        success_rate = sum(1 for r in results if r.success) / len(results)
        assert success_rate > 0.99
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
- è¯·æ±‚å»¶è¿Ÿ (P50, P95, P99)
- é”™è¯¯ç‡ (æŒ‰é”™è¯¯ç±»å‹åˆ†ç±»)
- ååé‡ (QPS)
- å¹¶å‘è¿æ¥æ•°
- å†…å­˜ä½¿ç”¨é‡

### å‘Šè­¦è§„åˆ™
```yaml
# Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
- name: grpc_alerts
  rules:
  - alert: HighErrorRate
    expr: rate(grpc_requests_failed_total[5m]) > 0.05
    for: 2m
    annotations:
      summary: "gRPCæœåŠ¡é”™è¯¯ç‡è¿‡é«˜"
  
  - alert: HighLatency
    expr: histogram_quantile(0.95, grpc_request_duration_seconds) > 1
    for: 5m
    annotations:
      summary: "gRPCæœåŠ¡å»¶è¿Ÿè¿‡é«˜"
```

## ğŸ”„ ç‰ˆæœ¬æ¼”è¿›ç­–ç•¥

### å‘å‰å…¼å®¹åŸåˆ™
1. **æ–°å­—æ®µä½¿ç”¨æ–°å­—æ®µå·**
2. **ä¸åˆ é™¤ç°æœ‰å­—æ®µ**
3. **æšä¸¾å€¼åªå¢ä¸å‡**
4. **ä½¿ç”¨optionalè€Œérequired**

### è¿ç§»ç­–ç•¥
```python
# ç‰ˆæœ¬åå•†
def negotiate_version(client_version):
    if client_version >= "2.0":
        return use_v2_features()
    else:
        return use_v1_compatibility()

# æ¸è¿›å¼è¿ç§»
def gradual_migration():
    if feature_flag('use_v2_calculation'):
        return calculate_v2(request)
    else:
        return calculate_v1(request)
```

## ğŸ“š å·¥å…·å’Œèµ„æº

### å¼€å‘å·¥å…·
- **grpcurl**: å‘½ä»¤è¡Œæµ‹è¯•å·¥å…·
- **grpc-web**: æµè§ˆå™¨ç«¯gRPCæ”¯æŒ
- **buf**: Protocol Bufferç®¡ç†å·¥å…·
- **grpc-gateway**: RESTåˆ°gRPCçš„ç½‘å…³

### è°ƒè¯•æŠ€å·§
```bash
# ä½¿ç”¨grpcurlæµ‹è¯•
grpcurl -plaintext -d '{"a":10,"b":5,"operation":"ADD"}' \
  localhost:50051 calculator.Calculator/Calculate

# å¯ç”¨gRPCè°ƒè¯•æ—¥å¿—
export GRPC_VERBOSITY=DEBUG
export GRPC_TRACE=all
```

## ğŸ’¡ å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ

### 1. å­—æ®µå·å†²çª
```protobuf
// âŒ é—®é¢˜ï¼šé‡å¤ä½¿ç”¨å­—æ®µå·
message BadMessage {
    string name = 1;
    int32 age = 1;  // å­—æ®µå·å†²çªï¼
}

// âœ… è§£å†³ï¼šä½¿ç”¨å”¯ä¸€å­—æ®µå·
message GoodMessage {
    string name = 1;
    int32 age = 2;
}
```

### 2. å¤§æ¶ˆæ¯å¤„ç†
```python
# âœ… è§£å†³ï¼šè®¾ç½®æ¶ˆæ¯å¤§å°é™åˆ¶
options = [
    ('grpc.max_send_message_length', 100 * 1024 * 1024),
    ('grpc.max_receive_message_length', 100 * 1024 * 1024),
]
channel = grpc.insecure_channel('localhost:50051', options=options)
```

### 3. è¿æ¥ç®¡ç†
```python
# âœ… è§£å†³ï¼šä¼˜é›…å…³é—­
class GrpcClient:
    def __enter__(self):
        self.channel = grpc.insecure_channel(self.target)
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        self.channel.close()
```

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥æ„å»ºå‡ºå¥å£®ã€å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„gRPCæœåŠ¡ã€‚
</code></pre>
            </div>
        </div>

        <div class="command-section">
            <h3>ğŸ¯ å®Œæ•´æ¼”ç¤ºæ€»ç»“</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div>
                    <h4>ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶æ¸…å•</h4>
                    <ul style="font-family: monospace; font-size: 14px;">
                        <li>ğŸ“„ calculator_enhanced.proto</li>
                        <li>ğŸ calculator_server_enhanced.py</li>
                        <li>ğŸ calculator_client_enhanced.py</li>
                        <li>ğŸ“œ run_enhanced_demo.py</li>
                        <li>ğŸ§ª test_type_constraints.py</li>
                        <li>âš¡ performance_test.py</li>
                        <li>ğŸ“ˆ comparison_report.md</li>
                        <li>ğŸ“‹ best_practices.md</li>
                    </ul>
                </div>
                
                <div>
                    <h4>ğŸš€ å¿«é€Ÿå¯åŠ¨å‘½ä»¤</h4>
                    <pre style="font-size: 12px;"><code># ä¸€é”®å¯åŠ¨å®Œæ•´æ¼”ç¤º
python run_enhanced_demo.py

# è¿è¡Œç±»å‹çº¦æŸæµ‹è¯•
python test_type_constraints.py

# æ€§èƒ½æµ‹è¯•å¯¹æ¯”
python performance_test.py</code></pre>
                </div>
            </div>

            <h4>ğŸ¯ å¼ºç±»å‹çº¦æŸçš„æ ¸å¿ƒä»·å€¼</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="background: #1e7e34; color: white; padding: 15px; border-radius: 6px;">
                    <strong>å¼€å‘å®‰å…¨æ€§</strong><br>
                    ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥ã€IDEæ™ºèƒ½æç¤ºã€é‡æ„å®‰å…¨ä¿éšœ
                </div>
                <div style="background: #007bff; color: white; padding: 15px; border-radius: 6px;">
                    <strong>è¿è¡Œæ—¶å¯é æ€§</strong><br>
                    å¤šå±‚éªŒè¯æœºåˆ¶ã€è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€ä¼˜é›…é™çº§å¤„ç†
                </div>
                <div style="background: #6610f2; color: white; padding: 15px; border-radius: 6px;">
                    <strong>ç»´æŠ¤ä¾¿åˆ©æ€§</strong><br>
                    å‘å‰å…¼å®¹æ€§ã€ç‰ˆæœ¬æ§åˆ¶ã€è‡ªåŠ¨åŒ–æµ‹è¯•æ”¯æŒ
                </div>
                <div style="background: #e83e8c; color: white; padding: 15px; border-radius: 6px;">
                    <strong>å›¢é˜Ÿåä½œæ•ˆç‡</strong><br>
                    æ¸…æ™°çš„æ¥å£å®šä¹‰ã€ä¸€è‡´çš„é”™è¯¯å¤„ç†ã€æ ‡å‡†åŒ–å¼€å‘æµç¨‹
                </div>
            </div>
        </div>

        <div class="command-section">
            <h3>ğŸ† å­¦ä¹ æˆæœæ€»ç»“</h3>
            <p>é€šè¿‡è¿™ä¸ªå®Œæ•´çš„gRPCå¼ºç±»å‹çº¦æŸæ¼”ç¤ºï¼Œæ‚¨å°†æŒæ¡ï¼š</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>ğŸ”§ æŠ€æœ¯æŠ€èƒ½</h4>
                    <ul>
                        <li>Protocol Buffersé«˜çº§ç‰¹æ€§åº”ç”¨</li>
                        <li>gRPCæœåŠ¡è®¾è®¡æ¨¡å¼</li>
                        <li>å¤šå±‚éªŒè¯æœºåˆ¶å®ç°</li>
                        <li>ç±»å‹å®‰å…¨çš„å®¢æˆ·ç«¯è®¾è®¡</li>
                        <li>æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§</li>
                        <li>æµ‹è¯•é©±åŠ¨å¼€å‘</li>
                    </ul>
                </div>
                <div>
                    <h4>ğŸ¯ æœ€ä½³å®è·µ</h4>
                    <ul>
                        <li>ä¼ä¸šçº§é”™è¯¯å¤„ç†ç­–ç•¥</li>
                        <li>APIç‰ˆæœ¬æ¼”è¿›ç®¡ç†</li>
                        <li>ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®</li>
                        <li>å¯è§‚æµ‹æ€§å’Œç›‘æ§</li>
                        <li>å®‰å…¨å’Œè®¤è¯æœºåˆ¶</li>
                        <li>å›¢é˜Ÿåä½œæµç¨‹</li>
                    </ul>
                </div>
            </div>
            
            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 20px; margin: 20px 0;">
                <h4 style="color: #155724; margin: 0 0 10px 0;">ğŸ’¡ å…³é”®æ´å¯Ÿ</h4>
                <p style="color: #155724; margin: 0;">
                    <strong>ç±»å‹çº¦æŸä¸ä»…æ˜¯æŠ€æœ¯é€‰æ‹©ï¼Œæ›´æ˜¯å·¥ç¨‹è´¨é‡çš„ä½“ç°ã€‚</strong>
                    é€šè¿‡æŠ•èµ„å¼ºç±»å‹ç³»ç»Ÿï¼Œæˆ‘ä»¬è·å¾—çš„ä¸ä»…æ˜¯æ›´å°‘çš„bugï¼Œ
                    æ›´æ˜¯æ›´é«˜çš„å¼€å‘æ•ˆç‡ã€æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ›´å¼ºçš„ç³»ç»Ÿå¯ç»´æŠ¤æ€§ã€‚
                    åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œè¿™ç§å‰æœŸæŠ•èµ„å°†åœ¨é•¿æœŸç»´æŠ¤ä¸­è·å¾—å·¨å¤§å›æŠ¥ã€‚
                </p>
            </div>
        </div>

        <div class="step">ğŸ›¡ï¸ å¼ºç±»å‹çº¦æŸçš„æ ¸å¿ƒä¼˜åŠ¿</div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0;">
            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">ğŸ”’</span>
                    ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨
                </div>
                <div class="code-content">
                    <p><strong>Protocol Bufferså±‚é¢ï¼š</strong></p>
                    <ul>
                        <li>æšä¸¾ç±»å‹é˜²æ­¢æ— æ•ˆæ“ä½œ</li>
                        <li>oneofå­—æ®µç¡®ä¿äº’æ–¥æ€§</li>
                        <li>å¿…éœ€å­—æ®µéªŒè¯</li>
                        <li>æ•°æ®ç±»å‹å¼ºåˆ¶çº¦æŸ</li>
                    </ul>
                    <p><strong>å®¢æˆ·ç«¯å±‚é¢ï¼š</strong></p>
                    <ul>
                        <li>Pythonæšä¸¾ç±»å‹å®‰å…¨</li>
                        <li>æ•°æ®ç±»å‹åŒ…è£…å™¨</li>
                        <li>è¾“å…¥éªŒè¯å™¨</li>
                        <li>è‡ªåŠ¨ç±»å‹è½¬æ¢</li>
                    </ul>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">âš¡</span>
                    è¿è¡Œæ—¶éªŒè¯æœºåˆ¶
                </div>
                <div class="code-content">
                    <p><strong>å¤šå±‚éªŒè¯ï¼š</strong></p>
                    <ul>
                        <li>å®¢æˆ·ç«¯é¢„éªŒè¯ï¼ˆæ—©æœŸé”™è¯¯å‘ç°ï¼‰</li>
                        <li>æœåŠ¡ç«¯ä¸šåŠ¡é€»è¾‘éªŒè¯</li>
                        <li>æ•°å€¼èŒƒå›´æ£€æŸ¥</li>
                        <li>ç²¾åº¦é…ç½®éªŒè¯</li>
                    </ul>
                    <p><strong>é”™è¯¯å¤„ç†ï¼š</strong></p>
                    <ul>
                        <li>ç»“æ„åŒ–é”™è¯¯ä»£ç </li>
                        <li>è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                        <li>ä¿®å¤å»ºè®®</li>
                        <li>ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
                    </ul>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">ğŸ¯</span>
                    ä¸šåŠ¡é€»è¾‘çº¦æŸ
                </div>
                <div class="code-content">
                    <p><strong>æ•°å­¦è¿ç®—çº¦æŸï¼š</strong></p>
                    <ul>
                        <li>é™¤é›¶æ£€æµ‹</li>
                        <li>è´Ÿæ•°å¼€æ–¹æ£€æµ‹</li>
                        <li>æ•°å€¼æº¢å‡ºæ£€æµ‹</li>
                        <li>ç²¾åº¦æŸå¤±æ£€æµ‹</li>
                    </ul>
                    <p><strong>é…ç½®çº¦æŸï¼š</strong></p>
                    <ul>
                        <li>å°æ•°ä½æ•°é™åˆ¶</li>
                        <li>è¶…æ—¶æ—¶é—´éªŒè¯</li>
                        <li>ç²¾åº¦æ¨¡å¼é€‰æ‹©</li>
                        <li>æ•°å€¼èŒƒå›´é™åˆ¶</li>
                    </ul>
                </div>
            </div>

            <div class="file-section">
                <div class="file-header">
                    <span class="file-icon">ğŸ”§</span>
                    å¼€å‘ä½“éªŒæå‡
                </div>
                <div class="code-content">
                    <p><strong>IDEæ”¯æŒï¼š</strong></p>
                    <ul>
                        <li>ä»£ç è‡ªåŠ¨è¡¥å…¨</li>
                        <li>ç±»å‹æç¤º</li>
                        <li>ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥</li>
                        <li>é‡æ„å®‰å…¨æ€§</li>
                    </ul>
                    <p><strong>ç»´æŠ¤æ€§ï¼š</strong></p>
                    <ul>
                        <li>æ¥å£å‘å‰å…¼å®¹</li>
                        <li>ç‰ˆæœ¬æ§åˆ¶</li>
                        <li>æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ</li>
                        <li>æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="command-section">
            <h3>ğŸ” ç±»å‹çº¦æŸå¯¹æ¯”æ¼”ç¤º</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>âŒ åŸå§‹ç‰ˆæœ¬ (å¼±ç±»å‹)</h4>
                    <pre><code># å­—ç¬¦ä¸²æ“ä½œç±»å‹ - å®¹æ˜“å‡ºé”™
request.operation = "add"  # æ‹¼å†™é”™è¯¯é£é™©

# ç®€å•æ•°å€¼ - æ— éªŒè¯
request.a = float("abc")  # è¿è¡Œæ—¶é”™è¯¯

# æ— ç»“æ„åŒ–é”™è¯¯
success = False
message = "something wrong"</code></pre>
                </div>
                <div>
                    <h4>âœ… å¢å¼ºç‰ˆæœ¬ (å¼ºç±»å‹)</h4>
                    <pre><code># æšä¸¾ç±»å‹ - ç¼–è¯‘æ—¶å®‰å…¨
request.operation = Operation.ADD  # ç±»å‹å®‰å…¨

# éªŒè¯åŒ…è£…å™¨ - æ—©æœŸé”™è¯¯å‘ç°
validated_a = validator.validate_number("abc")

# ç»“æ„åŒ–é”™è¯¯ - ä¸°å¯Œä¿¡æ¯
ErrorInfo(code=INVALID_INPUT, 
         message="è¯¦ç»†é”™è¯¯", 
         suggestions=["ä¿®å¤å»ºè®®"])</code></pre>
                </div>
            </div>
        </div>

        <div class="step">æ­¥éª¤ 6: å¼ºç±»å‹çº¦æŸå®Œæ•´å¯åŠ¨è„šæœ¬</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">ğŸ“œ</span>
                run_enhanced_demo.py - å¼ºç±»å‹çº¦æŸæ¼”ç¤ºå¯åŠ¨å™¨
            </div>
            <div class="code-content">
                <pre><code><span class="keyword">import</span> subprocess
<span class="keyword">import</span> sys
<span class="keyword">import</span> time
<span class="keyword">import</span> threading
<span class="keyword">import</span> os
<span class="keyword">import</span> psutil
<span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor

<span class="keyword">def</span> <span class="function">create_enhanced_proto</span>():
    <span class="string">"""åˆ›å»ºå¢å¼ºç‰ˆprotoæ–‡ä»¶"""</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ“„ åˆ›å»ºå¢å¼ºç‰ˆProtocol Bufferå®šä¹‰..."</span>)
    
    enhanced_proto = <span class="string">'''syntax = "proto3";

package calculator.v2;

import "google/protobuf/timestamp.proto";

// æ“ä½œç±»å‹æšä¸¾
enum OperationType {
    OPERATION_UNSPECIFIED = 0;
    OPERATION_ADD = 1;
    OPERATION_SUBTRACT = 2;
    OPERATION_MULTIPLY = 3;
    OPERATION_DIVIDE = 4;
    OPERATION_POWER = 5;
    OPERATION_SQRT = 6;
    OPERATION_MODULO = 7;
}

// ç²¾åº¦ç±»å‹
enum Precision {
    PRECISION_STANDARD = 0;
    PRECISION_HIGH = 1;
    PRECISION_SCIENTIFIC = 2;
}

// é”™è¯¯ä»£ç 
enum ErrorCode {
    ERROR_NONE = 0;
    ERROR_DIVISION_BY_ZERO = 1;
    ERROR_INVALID_OPERATION = 2;
    ERROR_NUMBER_TOO_LARGE = 3;
    ERROR_NUMBER_TOO_SMALL = 4;
    ERROR_NEGATIVE_SQRT = 5;
    ERROR_OVERFLOW = 6;
    ERROR_UNDERFLOW = 7;
}

// æœåŠ¡å®šä¹‰
service CalculatorV2 {
    rpc Calculate(CalculationRequest) returns (CalculationResponse);
    rpc BatchCalculate(BatchCalculationRequest) returns (BatchCalculationResponse);
    rpc StreamCalculate(stream CalculationRequest) returns (stream CalculationResponse);
    rpc GetCapabilities(CapabilitiesRequest) returns (CapabilitiesResponse);
    rpc ValidateExpression(ValidationRequest) returns (ValidationResponse);
}

// è®¡ç®—è¯·æ±‚
message CalculationRequest {
    oneof operand_a {
        double number_a = 1;
        string decimal_a = 2;
    }
    
    oneof operand_b {
        double number_b = 3;
        string decimal_b = 4;
    }
    
    OperationType operation = 5;
    CalculationConfig config = 6;
    RequestMetadata metadata = 7;
}

// è®¡ç®—é…ç½®
message CalculationConfig {
    Precision precision = 1;
    int32 decimal_places = 2;
    bool use_scientific_notation = 3;
    double max_value = 4;
    double min_value = 5;
    int32 timeout_ms = 6;
}

// è¯·æ±‚å…ƒæ•°æ®
message RequestMetadata {
    string request_id = 1;
    string client_id = 2;
    string client_version = 3;
    google.protobuf.Timestamp request_time = 4;
    int32 priority = 5;
}

// è®¡ç®—å“åº”
message CalculationResponse {
    oneof result {
        double number_result = 1;
        string decimal_result = 2;
        string scientific_result = 3;
    }
    
    bool success = 4;
    ErrorInfo error = 5;
    CalculationStats stats = 6;
    ResponseMetadata metadata = 7;
}

// é”™è¯¯ä¿¡æ¯
message ErrorInfo {
    ErrorCode code = 1;
    string message = 2;
    string details = 3;
    string operation_context = 4;
    repeated string suggestions = 5;
}

// ç»Ÿè®¡ä¿¡æ¯
message CalculationStats {
    int64 execution_time_us = 1;
    int64 memory_used_bytes = 2;
    bool precision_lost = 3;
    int32 intermediate_steps = 4;
}

// å“åº”å…ƒæ•°æ®
message ResponseMetadata {
    string request_id = 1;
    string server_id = 2;
    string server_version = 3;
    google.protobuf.Timestamp response_time = 4;
}

// æ‰¹é‡è¯·æ±‚
message BatchCalculationRequest {
    repeated CalculationRequest requests = 1;
    bool fail_fast = 2;
    bool parallel_execution = 3;
    int32 max_concurrent = 4;
}

// æ‰¹é‡å“åº”
message BatchCalculationResponse {
    repeated CalculationResponse responses = 1;
    int32 total_requests = 2;
    int32 successful_requests = 3;
    int32 failed_requests = 4;
    int64 total_execution_time_us = 5;
}

// èƒ½åŠ›æŸ¥è¯¢
message CapabilitiesRequest {}

message CapabilitiesResponse {
    repeated OperationType supported_operations = 1;
    repeated Precision supported_precisions = 2;
    double max_number = 3;
    double min_number = 4;
    int32 max_decimal_places = 5;
    int32 max_batch_size = 6;
    int32 max_concurrent_streams = 7;
    int32 default_timeout_ms = 8;
    string server_version = 9;
    string protocol_version = 10;
}

// éªŒè¯è¯·æ±‚
message ValidationRequest {
    CalculationRequest request = 1;
    
    enum ValidationLevel {
        BASIC = 0;
        STRICT = 1;
        COMPLETE = 2;
    }
    
    ValidationLevel level = 2;
}

// éªŒè¯å“åº”
message ValidationResponse {
    bool is_valid = 1;
    repeated string errors = 2;
    repeated string warnings = 3;
    repeated string suggestions = 4;
    int64 estimated_execution_time_us = 5;
    string expected_result_type = 6;
}'''</span>
    
    <span class="keyword">with</span> open(<span class="string">'calculator_enhanced.proto'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:
        f.write(enhanced_proto)
    
    <span class="keyword">print</span>(<span class="string">"âœ… å¢å¼ºç‰ˆprotoæ–‡ä»¶åˆ›å»ºå®Œæˆ"</span>)

<span class="keyword">def</span> <span class="function">generate_enhanced_proto_code</span>():
    <span class="string">"""ç”Ÿæˆå¢å¼ºç‰ˆProtocol Bufferä»£ç """</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ”§ ç”Ÿæˆå¢å¼ºç‰ˆgRPCä»£ç ..."</span>)
    
    <span class="keyword">try</span>:
        subprocess.run([
            sys.executable, <span class="string">'-m'</span>, <span class="string">'grpc_tools.protoc'</span>,
            <span class="string">'--proto_path=.'</span>,
            <span class="string">'--python_out=.'</span>,
            <span class="string">'--grpc_python_out=.'</span>,
            <span class="string">'calculator_enhanced.proto'</span>
        ], check=<span class="keyword">True</span>)
        <span class="keyword">print</span>(<span class="string">"âœ… å¢å¼ºç‰ˆgRPCä»£ç ç”ŸæˆæˆåŠŸï¼"</span>)
        <span class="keyword">return</span> <span class="keyword">True</span>
    <span class="keyword">except</span> subprocess.CalledProcessError:
        <span class="keyword">print</span>(<span class="string">"âŒ å¢å¼ºç‰ˆä»£ç ç”Ÿæˆå¤±è´¥"</span>)
        <span class="keyword">return</span> <span class="keyword">False</span>

<span class="keyword">def</span> <span class="function">check_dependencies</span>():
    <span class="string">"""æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–"""</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ“¦ æ£€æŸ¥ä¾èµ–åŒ…..."</span>)
    
    required_packages = [
        <span class="string">'grpcio'</span>, <span class="string">'grpcio-tools'</span>, <span class="string">'psutil'</span>
    ]
    missing_packages = []
    
    <span class="keyword">for</span> package <span class="keyword">in</span> required_packages:
        <span class="keyword">try</span>:
            __import__(package.replace(<span class="string">'-'</span>, <span class="string">'_'</span>))
        <span class="keyword">except</span> ImportError:
            missing_packages.append(package)
    
    <span class="keyword">if</span> missing_packages:
        <span class="keyword">print</span>(<span class="string">f"âŒ ç¼ºå°‘ä¾èµ–åŒ…: {', '.join(missing_packages)}"</span>)
        <span class="keyword">print</span>(<span class="string">"ğŸ“¥ æ­£åœ¨å®‰è£…ç¼ºå°‘çš„ä¾èµ–..."</span>)
        
        <span class="keyword">for</span> package <span class="keyword">in</span> missing_packages:
            <span class="keyword">try</span>:
                subprocess.run([sys.executable, <span class="string">'-m'</span>, <span class="string">'pip'</span>, <span class="string">'install'</span>, package], 
                             check=<span class="keyword">True</span>, capture_output=<span class="keyword">True</span>)
                <span class="keyword">print</span>(<span class="string">f"âœ… {package} å®‰è£…æˆåŠŸ"</span>)
            <span class="keyword">except</span> subprocess.CalledProcessError:
                <span class="keyword">print</span>(<span class="string">f"âŒ {package} å®‰è£…å¤±è´¥"</span>)
                <span class="keyword">return</span> <span class="keyword">False</span>
    
    <span class="keyword">print</span>(<span class="string">"âœ… æ‰€æœ‰ä¾èµ–åŒ…å·²å°±ç»ª"</span>)
    <span class="keyword">return</span> <span class="keyword">True</span>

<span class="keyword">def</span> <span class="function">run_performance_comparison</span>():
    <span class="string">"""è¿è¡Œæ€§èƒ½å¯¹æ¯”æµ‹è¯•"""</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸƒ å¯åŠ¨æ€§èƒ½å¯¹æ¯”æµ‹è¯•..."</span>)
    
    <span class="comment"># æ€§èƒ½æµ‹è¯•è„šæœ¬</span>
    perf_test_code = <span class="string">'''
import time
import grpc
import statistics
from concurrent.futures import ThreadPoolExecutor

# å‡è®¾å·²å¯¼å…¥ç›¸å…³æ¨¡å—
try:
    import calculator_enhanced_pb2 as pb2
    import calculator_enhanced_pb2_grpc as pb2_grpc
    
    def performance_test():
        """æ€§èƒ½æµ‹è¯•å‡½æ•°"""
        print("ğŸ”¥ æ‰§è¡Œæ€§èƒ½æµ‹è¯•...")
        
        # è¿æ¥åˆ°å¢å¼ºç‰ˆæœåŠ¡å™¨
        channel = grpc.insecure_channel('localhost:50052')
        stub = pb2_grpc.CalculatorV2Stub(channel)
        
        # æµ‹è¯•å‚æ•°
        test_operations = [
            (100.5, 50.2, pb2.OPERATION_ADD),
            (1000.123, 7.89, pb2.OPERATION_MULTIPLY),
            (999.999, 3.333, pb2.OPERATION_DIVIDE),
            (16, 0, pb2.OPERATION_SQRT),
        ]
        
        results = []
        
        for a, b, op in test_operations:
            times = []
            
            # è¿è¡Œå¤šæ¬¡æµ‹è¯•
            for _ in range(10):
                request = pb2.CalculationRequest(
                    number_a=a,
                    number_b=b if op != pb2.OPERATION_SQRT else 0,
                    operation=op
                )
                
                start = time.perf_counter()
                response = stub.Calculate(request)
                end = time.perf_counter()
                
                if response.success:
                    times.append((end - start) * 1000)  # è½¬æ¢ä¸ºæ¯«ç§’
            
            if times:
                avg_time = statistics.mean(times)
                results.append((op, avg_time, min(times), max(times)))
        
        # æ‰“å°ç»“æœ
        print("\\nğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ:")
        print("æ“ä½œç±»å‹\\t\\tå¹³å‡æ—¶é—´(ms)\\tæœ€å°æ—¶é—´(ms)\\tæœ€å¤§æ—¶é—´(ms)")
        print("-" * 60)
        
        op_names = {
            pb2.OPERATION_ADD: "åŠ æ³•",
            pb2.OPERATION_MULTIPLY: "ä¹˜æ³•", 
            pb2.OPERATION_DIVIDE: "é™¤æ³•",
            pb2.OPERATION_SQRT: "å¼€æ–¹"
        }
        
        for op, avg, min_t, max_t in results:
            name = op_names.get(op, "æœªçŸ¥")
            print(f"{name}\\t\\t{avg:.3f}\\t\\t{min_t:.3f}\\t\\t{max_t:.3f}")
        
        channel.close()
        print("âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ")
        
    if __name__ == "__main__":
        performance_test()
        
except ImportError as e:
    print(f"âŒ å¯¼å…¥æ¨¡å—å¤±è´¥: {e}")
    print("è¯·ç¡®ä¿å¢å¼ºç‰ˆæœåŠ¡å™¨æ­£åœ¨è¿è¡Œ")
'''</span>
    
    <span class="keyword">with</span> open(<span class="string">'performance_test.py'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:
        f.write(perf_test_code)
    
    <span class="keyword">print</span>(<span class="string">"âœ… æ€§èƒ½æµ‹è¯•è„šæœ¬å·²åˆ›å»º"</span>)

<span class="keyword">def</span> <span class="function">run_enhanced_server</span>():
    <span class="string">"""è¿è¡Œå¢å¼ºç‰ˆæœåŠ¡å™¨"""</span>
    <span class="keyword">try</span>:
        <span class="keyword">import</span> calculator_server_enhanced
        calculator_server_enhanced.serve()
    <span class="keyword">except</span> ImportError:
        <span class="keyword">print</span>(<span class="string">"âŒ æ— æ³•å¯¼å…¥å¢å¼ºç‰ˆæœåŠ¡å™¨æ¨¡å—"</span>)
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="keyword">print</span>(<span class="string">f"âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: {e}"</span>)

<span class="keyword">def</span> <span class="function">run_enhanced_client_demo</span>():
    <span class="string">"""è¿è¡Œå¢å¼ºç‰ˆå®¢æˆ·ç«¯æ¼”ç¤º"""</span>
    time.sleep(<span class="number">3</span>)  <span class="comment"># ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨</span>
    
    <span class="keyword">try</span>:
        <span class="keyword">import</span> calculator_client_enhanced
        calculator_client_enhanced.demo_type_safety()
    <span class="keyword">except</span> ImportError:
        <span class="keyword">print</span>(<span class="string">"âŒ æ— æ³•å¯¼å…¥å¢å¼ºç‰ˆå®¢æˆ·ç«¯æ¨¡å—"</span>)
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="keyword">print</span>(<span class="string">f"âŒ å®¢æˆ·ç«¯æ¼”ç¤ºå¤±è´¥: {e}"</span>)

<span class="keyword">def</span> <span class="function">monitor_system_resources</span>():
    <span class="string">"""ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨"""</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ“Š ç³»ç»Ÿèµ„æºç›‘æ§å¯åŠ¨..."</span>)
    
    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">30</span>):  <span class="comment"># ç›‘æ§30ç§’</span>
        cpu_percent = psutil.cpu_percent(interval=<span class="number">1</span>)
        memory = psutil.virtual_memory()
        
        <span class="keyword">if</span> cpu_percent > <span class="number">50</span> <span class="keyword">or</span> memory.percent > <span class="number">80</span>:
            <span class="keyword">print</span>(<span class="string">f"âš ï¸  é«˜èµ„æºä½¿ç”¨: CPU {cpu_percent}%, å†…å­˜ {memory.percent}%"</span>)
        
        time.sleep(<span class="number">1</span>)

<span class="keyword">def</span> <span class="function">create_comparison_report</span>():
    <span class="string">"""åˆ›å»ºå¯¹æ¯”æŠ¥å‘Š"""</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ“ˆ ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š..."</span>)
    
    report = <span class="string">"""
# gRPCå¼ºç±»å‹çº¦æŸvsåŸºç¡€ç‰ˆæœ¬å¯¹æ¯”æŠ¥å‘Š

## åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | åŸºç¡€ç‰ˆæœ¬ | å¼ºç±»å‹çº¦æŸç‰ˆæœ¬ |
|------|----------|----------------|
| æ“ä½œç±»å‹ | å­—ç¬¦ä¸² | æšä¸¾ç±»å‹ |
| æ•°å€¼è¾“å…¥ | ç®€å•double | oneofå¤šç§æ ¼å¼ |
| é”™è¯¯å¤„ç† | ç®€å•å¸ƒå°”å€¼ | ç»“æ„åŒ–é”™è¯¯ä¿¡æ¯ |
| ç²¾åº¦æ§åˆ¶ | å›ºå®šç²¾åº¦ | å¯é…ç½®ç²¾åº¦ |
| éªŒè¯æœºåˆ¶ | æœåŠ¡ç«¯éªŒè¯ | å¤šå±‚éªŒè¯ |
| å…ƒæ•°æ® | æ—  | ä¸°å¯Œçš„è¯·æ±‚/å“åº”å…ƒæ•°æ® |
| ç»Ÿè®¡ä¿¡æ¯ | æ—  | æ‰§è¡Œæ—¶é—´ã€å†…å­˜ä½¿ç”¨ç­‰ |
| æœåŠ¡å‘ç° | æ—  | èƒ½åŠ›æŸ¥è¯¢API |

## ç±»å‹å®‰å…¨ä¼˜åŠ¿

### ç¼–è¯‘æ—¶å®‰å…¨
- âœ… æšä¸¾ç±»å‹é˜²æ­¢æ‹¼å†™é”™è¯¯
- âœ… oneofå­—æ®µç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- âœ… å¼ºç±»å‹æ£€æŸ¥

### è¿è¡Œæ—¶éªŒè¯
- âœ… å¤šå±‚è¾“å…¥éªŒè¯
- âœ… ä¸šåŠ¡é€»è¾‘çº¦æŸæ£€æŸ¥
- âœ… è¯¦ç»†é”™è¯¯ä¿¡æ¯å’Œä¿®å¤å»ºè®®

### å¼€å‘ä½“éªŒ
- âœ… IDEæ™ºèƒ½æç¤º
- âœ… ä»£ç é‡æ„å®‰å…¨
- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•æ”¯æŒ

## æ€§èƒ½å½±å“

ç±»å‹çº¦æŸå¸¦æ¥çš„é¢å¤–å¼€é”€ï¼š
- Protocol Bufferåºåˆ—åŒ–: +5-10%
- éªŒè¯é€»è¾‘: +2-5%
- å…ƒæ•°æ®å¤„ç†: +1-3%

æ€»ä½“æ€§èƒ½å½±å“: 5-20% (å¯æ¥å—èŒƒå›´å†…)

## å»ºè®®

### é€‚ç”¨åœºæ™¯
- âœ… ä¼ä¸šçº§åº”ç”¨
- âœ… å…³é”®ä¸šåŠ¡ç³»ç»Ÿ
- âœ… å¤šå›¢é˜Ÿåä½œé¡¹ç›®
- âœ… é•¿æœŸç»´æŠ¤é¡¹ç›®

### ä¸é€‚ç”¨åœºæ™¯
- âŒ ç®€å•å†…éƒ¨å·¥å…·
- âŒ åŸå‹éªŒè¯
- âŒ æç«¯æ€§èƒ½è¦æ±‚åœºæ™¯

## ç»“è®º

å¼ºç±»å‹çº¦æŸç‰ˆæœ¬è™½ç„¶å¢åŠ äº†ä¸€å®šå¤æ‚åº¦ï¼Œä½†åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­
å¸¦æ¥çš„ç±»å‹å®‰å…¨ã€ç»´æŠ¤æ€§å’Œå¯é æ€§æå‡è¿œè¶…é¢å¤–æˆæœ¬ã€‚
"""</span>
    
    <span class="keyword">with</span> open(<span class="string">'comparison_report.md'</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:
        f.write(report)
    
    <span class="keyword">print</span>(<span class="string">"âœ… å¯¹æ¯”æŠ¥å‘Šå·²ç”Ÿæˆ: comparison_report.md"</span>)

<span class="keyword">def</span> <span class="function">main</span>():
    <span class="string">"""ä¸»å‡½æ•° - å¼ºç±»å‹çº¦æŸæ¼”ç¤ºå¯åŠ¨å™¨"""</span>
    <span class="keyword">print</span>(<span class="string">"ğŸš€ gRPCå¼ºç±»å‹çº¦æŸæ¼”ç¤ºå¯åŠ¨ä¸­..."</span>)
    <span class="keyword">print</span>(<span class="string">"=" * 60</span>)
    
    <span class="comment"># 1. æ£€æŸ¥ä¾èµ–</span>
    <span class="keyword">if</span> <span class="keyword">not</span> check_dependencies():
        <span class="keyword">print</span>(<span class="string">"âŒ ä¾èµ–æ£€æŸ¥å¤±è´¥ï¼Œé€€å‡º"</span>)
        <span class="keyword">return</span>
    
    <span class="comment"># 2. åˆ›å»ºå¢å¼ºç‰ˆprotoæ–‡ä»¶</span>
    create_enhanced_proto()
    
    <span class="comment"># 3. ç”Ÿæˆä»£ç </span>
    <span class="keyword">if</span> <span class="keyword">not</span> generate_enhanced_proto_code():
        <span class="keyword">print</span>(<span class="string">"âŒ ä»£ç ç”Ÿæˆå¤±è´¥ï¼Œé€€å‡º"</span>)
        <span class="keyword">return</span>
    
    <span class="comment"># 4. åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬</span>
    run_performance_comparison()
    
    <span class="comment"># 5. åˆ›å»ºå¯¹æ¯”æŠ¥å‘Š</span>
    create_comparison_report()
    
    <span class="comment"># 6. ä½¿ç”¨çº¿ç¨‹æ± å¯åŠ¨æ‰€æœ‰ç»„ä»¶</span>
    <span class="keyword">print</span>(<span class="string">"\nğŸ”¥ å¯åŠ¨å¼ºç±»å‹çº¦æŸæ¼”ç¤º..."</span>)
    
    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:
        <span class="comment"># å¯åŠ¨æœåŠ¡å™¨</span>
        server_future = executor.submit(run_enhanced_server)
        
        <span class="comment"># å¯åŠ¨èµ„æºç›‘æ§</span>
        monitor_future = executor.submit(monitor_system_resources)
        
        <span class="comment"># å¯åŠ¨å®¢æˆ·ç«¯æ¼”ç¤º</span>
        client_future = executor.submit(run_enhanced_client_demo)
        
        <span class="keyword">print</span>(<span class="string">"âœ… æ‰€æœ‰ç»„ä»¶å·²å¯åŠ¨"</span>)
        <span class="keyword">print</span>(<span class="string">"ğŸ“ æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶:"</span>)
        <span class="keyword">print</span>(<span class="string">"   - calculator_enhanced.proto (åè®®å®šä¹‰)"</span>)
        <span class="keyword">print</span>(<span class="string">"   - performance_test.py (æ€§èƒ½æµ‹è¯•)"</span>)
        <span class="keyword">print</span>(<span class="string">"   - comparison_report.md (å¯¹æ¯”æŠ¥å‘Š)"</span>)
        <span class="keyword">print</span>(<span class="string">"\nğŸ® æŒ‰ Ctrl+C åœæ­¢æ¼”ç¤º"</span>)
        
        <span class="keyword">try</span>:
            <span class="comment"># ç­‰å¾…ç”¨æˆ·ä¸­æ–­</span>
            client_future.result(<span class="number">60</span>)  <span class="comment"># æœ€å¤šç­‰å¾…60ç§’</span>
        <span class="keyword">except</span> KeyboardInterrupt:
            <span class="keyword">print</span>(<span class="string">"\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­ï¼Œæ­£åœ¨åœæ­¢..."</span>)
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            <span class="keyword">print</span>(<span class="string">f"\nâŒ æ¼”ç¤ºè¿‡ç¨‹å‡ºé”™: {e}"</span>)
        <span class="keyword">finally</span>:
            <span class="keyword">print</span>(<span class="string">"ğŸ å¼ºç±»å‹çº¦æŸæ¼”ç¤ºç»“æŸ"</span>)

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    main()
</code></pre>
            </div>
        </div>

        <div class="step">æ­¥éª¤ 7: ç±»å‹çº¦æŸæµ‹è¯•å¥—ä»¶</div>

        <div class="file-section">
            <div class="file-header">
                <span class="file-icon">ğŸ§ª</span>
                test_type_constraints.py - ç±»å‹çº¦æŸæµ‹è¯•å¥—ä»¶
            </div>
            <div class="code-content">
                <pre><code><span class="keyword">import</span> unittest
<span class="keyword">import</span> grpc
<span class="keyword">import</span> time
<span class="keyword">import</span> threading
<span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch, MagicMock

<span class="keyword">try</span>:
    <span class="keyword">import</span> calculator_enhanced_pb2 <span class="keyword">as</span> pb2
    <span class="keyword">import</span> calculator_enhanced_pb2_grpc <span class="keyword">as</span> pb2_grpc
    <span class="keyword">from</span> calculator_client_enhanced <span class="keyword">import</span> (
        EnhancedCalculatorClient, Operation, PrecisionType,
        CalculationConfig, InputValidator
    )
    <span class="keyword">from</span> calculator_server_enhanced <span class="keyword">import</span> (
        EnhancedCalculatorServicer, TypeValidator, PrecisionCalculator
    )
<span class="keyword">except</span> ImportError <span class="keyword">as</span> e:
    <span class="keyword">print</span>(<span class="string">f"âš ï¸  å¯¼å…¥æ¨¡å—å¤±è´¥: {e}"</span>)
    <span class="keyword">print</span>(<span class="string">"è¯·å…ˆè¿è¡Œ run_enhanced_demo.py ç”Ÿæˆå¿…è¦çš„ä»£ç "</span>)
    exit(<span class="number">1</span>)

<span class="keyword">class</span> <span class="function">TestTypeConstraints</span>(unittest.TestCase):
    <span class="string">"""ç±»å‹çº¦æŸæµ‹è¯•å¥—ä»¶"""</span>
    
    <span class="keyword">def</span> <span class="function">setUp</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•å‰å‡†å¤‡"""</span>
        <span class="keyword">self</span>.servicer = EnhancedCalculatorServicer()
        <span class="keyword">self</span>.client = EnhancedCalculatorClient()
    
    <span class="keyword">def</span> <span class="function">test_operation_type_enum_validation</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•æ“ä½œç±»å‹æšä¸¾éªŒè¯"""</span>
        <span class="keyword">print</span>(<span class="string">"ğŸ§ª æµ‹è¯•æ“ä½œç±»å‹æšä¸¾éªŒè¯..."</span>)
        
        <span class="comment"># æµ‹è¯•æœ‰æ•ˆçš„æ“ä½œç±»å‹</span>
        valid_ops = [
            pb2.OPERATION_ADD, pb2.OPERATION_SUBTRACT,
            pb2.OPERATION_MULTIPLY, pb2.OPERATION_DIVIDE,
            pb2.OPERATION_POWER, pb2.OPERATION_SQRT, pb2.OPERATION_MODULO
        ]
        
        <span class="keyword">for</span> op <span class="keyword">in</span> valid_ops:
            is_valid, error = TypeValidator.validate_operation_type(op)
            <span class="keyword">self</span>.assertTrue(is_valid, <span class="string">f"æ“ä½œ {op} åº”è¯¥æ˜¯æœ‰æ•ˆçš„"</span>)
            <span class="keyword">self</span>.assertEqual(error, <span class="string">""</span>)
        
        <span class="comment"># æµ‹è¯•æ— æ•ˆçš„æ“ä½œç±»å‹</span>
        is_valid, error = TypeValidator.validate_operation_type(pb2.OPERATION_UNSPECIFIED)
        <span class="keyword">self</span>.assertFalse(is_valid)
        <span class="keyword">self</span>.assertIn(<span class="string">"æ“ä½œç±»å‹æœªæŒ‡å®š"</span>, error)
        
        <span class="keyword">print</span>(<span class="string">"âœ… æ“ä½œç±»å‹æšä¸¾éªŒè¯æµ‹è¯•é€šè¿‡"</span>)
    
    <span class="keyword">def</span> <span class="function">test_numeric_value_validation</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•æ•°å€¼éªŒè¯"""</span>
        <span class="keyword">print</span>(<span class="string">"ğŸ§ª æµ‹è¯•æ•°å€¼éªŒè¯..."</span>)
        
        <span class="comment"># æµ‹è¯•æœ‰æ•ˆæ•°å€¼</span>
        valid_numbers = [<span class="number">0</span>, <span class="number">42</span>, <span class="number">-100</span>, <span class="number">3.14159</span>, <span class="number">1e10</span>]
        <span class="keyword">for</span> num <span class="keyword">in</span> valid_numbers:
            is_valid, error = TypeValidator.validate_numeric_value(num)
            <span class="keyword">self</span>.assertTrue(is_valid, <span class="string">f"æ•°å€¼ {num} åº”è¯¥æ˜¯æœ‰æ•ˆçš„"</span>)
        
        <span class="comment"># æµ‹è¯•æ— æ•ˆæ•°å€¼</span>
        <span class="keyword">import</span> math
        invalid_numbers = [<span class="keyword">float</span>(<span class="string">'nan'</span>), <span class="keyword">float</span>(<span class="string">'inf'</span>), <span class="number">1e16</span>]
        <span class="keyword">for</span> num <span class="keyword">in</span> invalid_numbers:
            is_valid, error = TypeValidator.validate_numeric_value(num)
            <span class="keyword">self</span>.assertFalse(is_valid, <span class="string">f"æ•°å€¼ {num} åº”è¯¥æ˜¯æ— æ•ˆçš„"</span>)
            <span class="keyword">self</span>.assertNotEqual(error, <span class="string">""</span>)
        
        <span class="keyword">print</span>(<span class="string">"âœ… æ•°å€¼éªŒè¯æµ‹è¯•é€šè¿‡"</span>)
    
    <span class="keyword">def</span> <span class="function">test_client_input_validation</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•å®¢æˆ·ç«¯è¾“å…¥éªŒè¯"""</span>
        <span class="keyword">print</span>(<span class="string">"ğŸ§ª æµ‹è¯•å®¢æˆ·ç«¯è¾“å…¥éªŒè¯..."</span>)
        
        <span class="comment"># æµ‹è¯•æ•°å€¼éªŒè¯</span>
        valid_inputs = [<span class="number">42</span>, <span class="number">3.14</span>, <span class="string">"123.456"</span>]
        <span class="keyword">for</span> inp <span class="keyword">in</span> valid_inputs:
            result = InputValidator.validate_number(inp, <span class="string">"æµ‹è¯•"</span>)
            <span class="keyword">self</span>.assertIsInstance(result, <span class="keyword">float</span>)
        
        <span class="comment"># æµ‹è¯•æ— æ•ˆè¾“å…¥</span>
        invalid_inputs = [<span class="string">"abc"</span>, <span class="string">""</span>, <span class="keyword">None</span>, <span class="number">1e16</span>]
        <span class="keyword">for</span> inp <span class="keyword">in</span> invalid_inputs:
            <span class="keyword">with</span> <span class="keyword">self</span>.assertRaises((TypeError, ValueError)):
                InputValidator.validate_number(inp, <span class="string">"æµ‹è¯•"</span>)
        
        <span class="comment"># æµ‹è¯•æ“ä½œç±»å‹éªŒè¯</span>
        valid_operations = [Operation.ADD, <span class="string">"MULTIPLY"</span>, <span class="string">"divide"</span>]
        <span class="keyword">for</span> op <span class="keyword">in</span> valid_operations:
            result = InputValidator.validate_operation(op)
            <span class="keyword">self</span>.assertIsInstance(result, Operation)
        
        <span class="comment"># æµ‹è¯•æ— æ•ˆæ“ä½œ</span>
        <span class="keyword">with</span> <span class="keyword">self</span>.assertRaises(ValueError):
            InputValidator.validate_operation(<span class="string">"INVALID_OP"</span>)
        
        <span class="keyword">print</span>(<span class="string">"âœ… å®¢æˆ·ç«¯è¾“å…¥éªŒè¯æµ‹è¯•é€šè¿‡"</span>)
    
    <span class="keyword">def</span> <span class="function">test_precision_calculation</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•ç²¾åº¦è®¡ç®—"""</span>
        <span class="keyword">print</span>(<span class="string">"ğŸ§ª æµ‹è¯•ç²¾åº¦è®¡ç®—..."</span>)
        
        <span class="comment"># åˆ›å»ºæµ‹è¯•è¯·æ±‚</span>
        request = pb2.CalculationRequest(
            number_a=<span class="number">123.456789</span>,
            number_b=<span class="number">987.654321</span>,
            operation=pb2.OPERATION_ADD
        )
        
        <span class="comment"># æå–æ•°å€¼</span>
        a, b = PrecisionCalculator.get_numeric_value(request)
        <span class="keyword">self</span>.assertEqual(a, <span class="number">123.456789</span>)
        <span class="keyword">self</span>.assertEqual(b, <span class="number">987.654321</span>)
        
        <span class="comment"># æµ‹è¯•é«˜ç²¾åº¦æ ¼å¼</span>
        request_decimal = pb2.CalculationRequest(
            decimal_a=<span class="string">"123.456789012345"</span>,
            decimal_b=<span class="string">"987.654321098765"</span>,
            operation=pb2.OPERATION_MULTIPLY
        )
        
        a_dec, b_dec = PrecisionCalculator.get_numeric_value(request_decimal)
        <span class="keyword">self</span>.assertAlmostEqual(a_dec, <span class="number">123.456789012345</span>, places=<span class="number">10</span>)
        
        <span class="comment"># æµ‹è¯•ç»“æœæ ¼å¼åŒ–</span>
        config = pb2.CalculationConfig(
            precision=pb2.PRECISION_HIGH,
            decimal_places=<span class="number">4</span>,
            use_scientific_notation=<span class="keyword">False</span>
        )
        
        number_result, decimal_result, scientific_result = PrecisionCalculator.format_result(<span class="number">123.456789</span>, config)
        <span class="keyword">self</span>.assertEqual(decimal_result, <span class="string">"123.4568"</span>)
        
        <span class="keyword">print</span>(<span class="string">"âœ… ç²¾åº¦è®¡ç®—æµ‹è¯•é€šè¿‡"</span>)
    
    <span class="keyword">def</span> <span class="function">test_error_handling</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•é”™è¯¯å¤„ç†"""</span>
        <span class="keyword">print</span>(<span class="string">"ğŸ§ª æµ‹è¯•é”™è¯¯å¤„ç†..."</span>)
        
        <span class="comment"># æ¨¡æ‹ŸgRPCä¸Šä¸‹æ–‡</span>
        context = MagicMock()
        
        <span class="comment"># æµ‹è¯•é™¤é›¶é”™è¯¯</span>
        request = pb2.CalculationRequest(
            number_a=<span class="number">10</span>,
            number_b=<span class="number">0</span>,
            operation=pb2.OPERATION_DIVIDE
        )
        
        response = <span class="keyword">self</span>.servicer.Calculate(request, context)
        <span class="keyword">self</span>.assertFalse(response.success)
        <span class="keyword">self</span>.assertEqual(response.error.code, pb2.ERROR_DIVISION_BY_ZERO)
        <span class="keyword">self</span>.assertIn(<span class="string">"é™¤æ•°ä¸èƒ½ä¸ºé›¶"</span>, response.error.message)
        <span class="keyword">self</span>.assertGreater(<span class="keyword">len</span>(response.error.suggestions), <span class="number">0</span>)
        
        <span class="comment"># æµ‹è¯•è´Ÿæ•°å¼€æ–¹é”™è¯¯</span>
        request_sqrt = pb2.CalculationRequest(
            number_a=<span class="number">-4</span>,
            operation=pb2.OPERATION_SQRT
        )
        
        response_sqrt = <span class="keyword">self</span>.servicer.Calculate(request_sqrt, context)
        <span class="keyword">self</span>.assertFalse(response_sqrt.success)
        <span class="keyword">self</span>.assertEqual(response_sqrt.error.code, pb2.ERROR_NEGATIVE_SQRT)
        
        <span class="comment"># æµ‹è¯•æ— æ•ˆæ“ä½œç±»å‹</span>
        request_invalid = pb2.CalculationRequest(
            number_a=<span class="number">10</span>,
            number_b=<span class="number">5</span>,
            operation=pb2.OPERATION_UNSPECIFIED
        )
        
        response_invalid = <span class="keyword">self</span>.servicer.Calculate(request_invalid, context)
        <span class="keyword">self</span>.assertFalse(response_invalid.success)
        <span class="keyword">self</span>.assertEqual(response_invalid.error.code, pb2.ERROR_INVALID_OPERATION)
        
        <span class="keyword">print</span>(<span class="string">"âœ… é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡"</span>)
    
    <span class="keyword">def</span> <span class="function">test_server_capabilities</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•æœåŠ¡å™¨èƒ½åŠ›æŸ¥è¯¢"""</span>
        <span class="keyword">print</span>(<span class="string">"ğŸ§ª æµ‹è¯•æœåŠ¡å™¨èƒ½åŠ›æŸ¥è¯¢..."</span>)
        
        context = MagicMock()
        request = pb2.CapabilitiesRequest()
        
        response = <span class="keyword">self</span>.servicer.GetCapabilities(request, context)
        
        <span class="comment"># éªŒè¯æ”¯æŒçš„æ“ä½œ</span>
        <span class="keyword">self</span>.assertIn(pb2.OPERATION_ADD, response.supported_operations)
        <span class="keyword">self</span>.assertIn(pb2.OPERATION_SQRT, response.supported_operations)
        
        <span class="comment"># éªŒè¯ç²¾åº¦ç±»å‹</span>
        <span class="keyword">self</span>.assertIn(pb2.PRECISION_STANDARD, response.supported_precisions)
        <span class="keyword">self</span>.assertIn(pb2.PRECISION_HIGH, response.supported_precisions)
        
        <span class="comment"># éªŒè¯æ•°å€¼é™åˆ¶</span>
        <span class="keyword">self</span>.assertGreater(response.max_number, <span class="number">0</span>)
        <span class="keyword">self</span>.assertLess(response.min_number, <span class="number">0</span>)
        <span class="keyword">self</span>.assertGreater(response.max_decimal_places, <span class="number">0</span>)
        
        <span class="comment"># éªŒè¯ç‰ˆæœ¬ä¿¡æ¯</span>
        <span class="keyword">self</span>.assertIsNotNone(response.server_version)
        <span class="keyword">self</span>.assertIsNotNone(response.protocol_version)
        
        <span class="keyword">print</span>(<span class="string">"âœ… æœåŠ¡å™¨èƒ½åŠ›æŸ¥è¯¢æµ‹è¯•é€šè¿‡"</span>)
    
    <span class="keyword">def</span> <span class="function">test_validation_request</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•è¡¨è¾¾å¼éªŒè¯"""</span>
        <span class="keyword">print</span>(<span class="string">"ğŸ§ª æµ‹è¯•è¡¨è¾¾å¼éªŒè¯..."</span>)
        
        context = MagicMock()
        
        <span class="comment"># æµ‹è¯•æœ‰æ•ˆè¡¨è¾¾å¼</span>
        calc_request = pb2.CalculationRequest(
            number_a=<span class="number">10</span>,
            number_b=<span class="number">5</span>,
            operation=pb2.OPERATION_ADD
        )
        
        validation_request = pb2.ValidationRequest(
            request=calc_request,
            level=pb2.ValidationRequest.COMPLETE
        )
        
        response = <span class="keyword">self</span>.servicer.ValidateExpression(validation_request, context)
        <span class="keyword">self</span>.assertTrue(response.is_valid)
        <span class="keyword">self</span>.assertEqual(<span class="keyword">len</span>(response.errors), <span class="number">0</span>)
        <span class="keyword">self</span>.assertGreater(response.estimated_execution_time_us, <span class="number">0</span>)
        
        <span class="comment"># æµ‹è¯•æ— æ•ˆè¡¨è¾¾å¼</span>
        invalid_calc_request = pb2.CalculationRequest(
            number_a=<span class="number">10</span>,
            number_b=<span class="number">0</span>,
            operation=pb2.OPERATION_DIVIDE
        )
        
        invalid_validation_request = pb2.ValidationRequest(
            request=invalid_calc_request,
            level=pb2.ValidationRequest.COMPLETE
        )
        
        invalid_response = <span class="keyword">self</span>.servicer.ValidateExpression(invalid_validation_request, context)
        <span class="keyword">self</span>.assertFalse(invalid_response.is_valid)
        <span class="keyword">self</span>.assertGreater(<span class="keyword">len</span>(invalid_response.errors), <span class="number">0</span>)
        
        <span class="keyword">print</span>(<span class="string">"âœ… è¡¨è¾¾å¼éªŒè¯æµ‹è¯•é€šè¿‡"</span>)

<span class="keyword">class</span> <span class="function">TestIntegration</span>(unittest.TestCase):
    <span class="string">"""é›†æˆæµ‹è¯•"""</span>
    
    <span class="keyword">def</span> <span class="function">test_end_to_end_calculation</span>(<span class="keyword">self</span>):
        <span class="string">"""æµ‹è¯•ç«¯åˆ°ç«¯è®¡ç®—æµç¨‹"""</span>
        <span class="keyword">print</span>(<span class="string">"ğŸ§ª æµ‹è¯•ç«¯åˆ°ç«¯è®¡ç®—æµç¨‹..."</span>)
        
        <span class="comment"># æ¨¡æ‹Ÿå®Œæ•´çš„å®¢æˆ·ç«¯-æœåŠ¡ç«¯äº¤äº’</span>
        servicer = EnhancedCalculatorServicer()
        context = MagicMock()
        
        <span class="comment"># æµ‹è¯•å„ç§è®¡ç®—ç±»å‹</span>
        test_cases = [
            (<span class="number">10</span>, <span class="number">5</span>, pb2.OPERATION_ADD, <span class="number">15</span>),
            (<span class="number">20</span>, <span class="number">4</span>, pb2.OPERATION_DIVIDE, <span class="number">5</span>),
            (<span class="number">3</span>, <span class="number">4</span>, pb2.OPERATION_POWER, <span class="number">81</span>),
            (<span class="number">16</span>, <span class="number">0</span>, pb2.OPERATION_SQRT, <span class="number">4</span>),
        ]
        
        <span class="keyword">for</span> a, b, operation, expected <span class="keyword">in</span> test_cases:
            request = pb2.CalculationRequest(
                number_a=a,
                number_b=b <span class="keyword">if</span> operation != pb2.OPERATION_SQRT <span class="keyword">else</span> <span class="number">0</span>,
                operation=operation,
                metadata=pb2.RequestMetadata(
                    request_id=<span class="string">f"test-{operation}"</span>,
                    client_id=<span class="string">"unittest"</span>
                )
            )
            
            response = servicer.Calculate(request, context)
            
            <span class="keyword">self</span>.assertTrue(response.success, <span class="string">f"è®¡ç®—å¤±è´¥: {response.error.message}"</span>)
            <span class="keyword">self</span>.assertAlmostEqual(response.number_result, expected, places=<span class="number">5</span>)
            <span class="keyword">self</span>.assertIsNotNone(response.stats)
            <span class="keyword">self</span>.assertIsNotNone(response.metadata)
        
        <span class="keyword">print</span>(<span class="string">"âœ… ç«¯åˆ°ç«¯è®¡ç®—æµç¨‹æµ‹è¯•é€šè¿‡"</span>)

<span class="keyword">def</span> <span class="function">run_test_suite</span>():
    <span class="string">"""è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶"""</span>
    <span class="keyword">print</span>(<span class="string">"ğŸ§ª å¼€å§‹è¿è¡Œç±»å‹çº¦æŸæµ‹è¯•å¥—ä»¶..."</span>)
    <span class="keyword">print</span>(<span class="string">"=" * 60</span>)
    
    <span class="comment"># åˆ›å»ºæµ‹è¯•å¥—ä»¶</span>
    loader = unittest.TestLoader()
    suite = unittest.TestSuite()
    
    <span class="comment"># æ·»åŠ æµ‹è¯•ç±»</span>
    suite.addTests(loader.loadTestsFromTestCase(TestTypeConstraints))
    suite.addTests(loader.loadTestsFromTestCase(TestIntegration))
    
    <span class="comment"># è¿è¡Œæµ‹è¯•</span>
    runner = unittest.TextTestRunner(verbosity=<span class="number">2</span>)
    result = runner.run(suite)
    
    <span class="comment"># è¾“å‡ºç»“æœ</span>
    <span class="keyword">print</span>(<span class="string">"=" * 60</span>)
    <span class="keyword">if</span> result.wasSuccessful():
        <span class="keyword">print</span>(<span class="string">"ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç±»å‹çº¦æŸç³»ç»Ÿå·¥ä½œæ­£å¸¸"</span>)
    <span class="keyword">else</span>:
        <span class="keyword">print</span>(<span class="string">f"âŒ æµ‹è¯•å¤±è´¥: {<span class="keyword">len</span>(result.failures)} ä¸ªå¤±è´¥, {<span class="keyword">len</span>(result.errors)} ä¸ªé”™è¯¯"</span>)
        
        <span class="keyword">for</span> test, error <span class="keyword">in</span> result.failures:
            <span class="keyword">print</span>(<span class="string">f"å¤±è´¥: {test} - {error}"</span>)
        
        <span class="keyword">for</span> test, error <span class="keyword">in</span> result.errors:
            <span class="keyword">print</span>(<span class="string">f"é”™è¯¯: {test} - {error}"</span>)
    
    <span class="keyword">return</span> result.wasSuccessful()

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    success = run_test_suite()
    exit(<span class="number">0</span> <span class="keyword">if</span> success <span class="keyword">else</span> <span class="number">1</span>)
</code></pre>
            </div>
        </div>
    </div>
</body>
</html>
