<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨æ„åŠ›æœºåˆ¶è¯¦è§£</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <script>
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #764ba2;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .attention-type {
            margin-bottom: 60px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .attention-type:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        h3 {
            color: #444;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .math-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        
        .visualization {
            margin: 30px 0;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        svg {
            width: 100%;
            height: auto;
            max-width: 1200px;
            display: block;
            margin: 0 auto;
        }
        
        .code-ref {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #764ba2;
            font-family: 'Courier New', monospace;
        }
        
        .code-ref h4 {
            color: #764ba2;
            margin-bottom: 10px;
        }
        
        .code-comment {
            color: #008000;
            font-style: italic;
        }
        
        .complexity-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .complexity-table th, .complexity-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .complexity-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }
        
        .complexity-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .feature-card:hover {
            transform: scale(1.05);
        }
        
        .feature-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .nav-menu {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        
        .nav-menu ul {
            list-style: none;
        }
        
        .nav-menu li {
            margin: 10px 0;
        }
        
        .nav-menu a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .nav-menu a:hover {
            color: #764ba2;
        }
        
        @media (max-width: 1200px) {
            .nav-menu {
                display: none;
            }
        }
        
        .highlight {
            background: linear-gradient(120deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .step-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .matrix-label {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            fill: #333;
        }
    </style>
</head>
<body>
    <div class="nav-menu">
        <ul>
            <li><a href="#full-attention">å…¨æ³¨æ„åŠ›</a></li>
            <li><a href="#sparse-attention">ç¨€ç–æ³¨æ„åŠ›</a></li>
            <li><a href="#linear-attention">çº¿æ€§æ³¨æ„åŠ›</a></li>
            <li><a href="#gqa">GQA</a></li>
            <li><a href="#mqa">MQA</a></li>
            <li><a href="#flash-attention">Flash</a></li>
            <li style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <a href="#training-inference">è®­ç»ƒvsæ¨ç†</a>
            </li>
            <li><a href="#model-scale">æ¨¡å‹è§„æ¨¡</a></li>
        </ul>
    </div>
    
    <div class="container">
        <h1>ğŸš€ å¤§è¯­è¨€æ¨¡å‹æ³¨æ„åŠ›æœºåˆ¶è¯¦è§£</h1>
        <p class="subtitle">æ·±å…¥ç†è§£Transformerçš„æ ¸å¿ƒï¼šä»æ•°å­¦åŸç†åˆ°ä»£ç å®ç°</p>
        
        <!-- è®­ç»ƒä¸æ¨ç†è¯¦è§£ -->
        <div class="attention-type" id="training-inference">
            <h2><span class="icon">ğŸ”„</span> è®­ç»ƒä¸æ¨ç†è¯¦è§£</h2>
            
            <h3>ğŸ“š QKVçš„æœ¬è´¨å«ä¹‰</h3>
            <div class="math-section">
                <p><b>Query (Q)ï¼šæŸ¥è¯¢å‘é‡</b></p>
                <ul style="margin-left: 20px;">
                    <li>ä»£è¡¨"æˆ‘åœ¨æ‰¾ä»€ä¹ˆä¿¡æ¯"</li>
                    <li>æ¯ä¸ªä½ç½®çš„tokenç”Ÿæˆä¸€ä¸ªQueryï¼Œç”¨äºæŸ¥è¯¢å…¶ä»–ä½ç½®çš„ä¿¡æ¯</li>
                </ul>
                
                <p style="margin-top: 15px;"><b>Key (K)ï¼šé”®å‘é‡</b></p>
                <ul style="margin-left: 20px;">
                    <li>ä»£è¡¨"æˆ‘èƒ½æä¾›ä»€ä¹ˆä¿¡æ¯"</li>
                    <li>æ¯ä¸ªä½ç½®çš„tokenç”Ÿæˆä¸€ä¸ªKeyï¼Œä¾›å…¶ä»–ä½ç½®æŸ¥è¯¢</li>
                </ul>
                
                <p style="margin-top: 15px;"><b>Value (V)ï¼šå€¼å‘é‡</b></p>
                <ul style="margin-left: 20px;">
                    <li>ä»£è¡¨"æˆ‘çš„å®é™…ä¿¡æ¯å†…å®¹"</li>
                    <li>æ ¹æ®Query-Keyçš„åŒ¹é…åº¦ï¼ŒValueè¢«åŠ æƒèšåˆ</li>
                </ul>
                
                <div class="step-box">
                    <b>æ³¨æ„åŠ›è¾“å‡ºçš„å«ä¹‰ï¼š</b>
                    <p>Attentionè¾“å‡ºæ˜¯æ‰€æœ‰ä½ç½®Valueçš„åŠ æƒå’Œï¼Œæƒé‡ç”±Queryä¸Keyçš„ç›¸ä¼¼åº¦å†³å®šã€‚</p>
                    <p>æœ¬è´¨ä¸Šæ˜¯ï¼š<em>"æ ¹æ®å½“å‰ä½ç½®çš„éœ€æ±‚(Q)ï¼Œä»æ‰€æœ‰ä½ç½®ä¸­æŒ‰ç›¸å…³æ€§(K)æå–ä¿¡æ¯(V)"</em></p>
                </div>
            </div>
            
            <h3>ğŸš€ è®­ç»ƒï¼šå¹¶è¡Œè®¡ç®—æ‰€æœ‰ä½ç½®</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 700">
                    <text x="600" y="30" text-anchor="middle" font-weight="bold" font-size="18">è®­ç»ƒæ—¶çš„å¹¶è¡Œè®¡ç®—ï¼ˆTeacher Forcingï¼‰</text>
                    
                    <!-- å·¦ä¾§ï¼šè¾“å…¥åºåˆ—å’Œå¤„ç†æµç¨‹ -->
                    <g transform="translate(50, 60)">
                        <text x="250" y="0" text-anchor="middle" font-weight="bold">è¾“å…¥åºåˆ—ï¼š"æˆ‘çˆ±åŒ—äº¬å¤©å®‰é—¨"</text>
                        
                        <!-- TokenåµŒå…¥ -->
                        <g transform="translate(0, 20)">
                            <rect x="0" y="0" width="60" height="40" fill="#667eea" opacity="0.7" stroke="#333"/>
                            <text x="30" y="25" text-anchor="middle" fill="white">æˆ‘</text>
                            
                            <rect x="70" y="0" width="60" height="40" fill="#667eea" opacity="0.7" stroke="#333"/>
                            <text x="100" y="25" text-anchor="middle" fill="white">çˆ±</text>
                            
                            <rect x="140" y="0" width="60" height="40" fill="#667eea" opacity="0.7" stroke="#333"/>
                            <text x="170" y="25" text-anchor="middle" fill="white">åŒ—äº¬</text>
                            
                            <rect x="210" y="0" width="60" height="40" fill="#667eea" opacity="0.7" stroke="#333"/>
                            <text x="240" y="25" text-anchor="middle" fill="white">å¤©å®‰</text>
                            
                            <rect x="280" y="0" width="60" height="40" fill="#667eea" opacity="0.7" stroke="#333"/>
                            <text x="310" y="25" text-anchor="middle" fill="white">é—¨</text>
                            
                            <rect x="350" y="0" width="60" height="40" fill="#667eea" opacity="0.7" stroke="#333"/>
                            <text x="380" y="25" text-anchor="middle" fill="white">[EOS]</text>
                        </g>
                        
                        <!-- å¹¶è¡Œç®­å¤´ -->
                        <g stroke="#333" stroke-width="2" marker-end="url(#arrowhead)" transform="translate(0, 20)">
                            <path d="M 30 45 L 30 75"/>
                            <path d="M 100 45 L 100 75"/>
                            <path d="M 170 45 L 170 75"/>
                            <path d="M 240 45 L 240 75"/>
                            <path d="M 310 45 L 310 75"/>
                            <path d="M 380 45 L 380 75"/>
                        </g>
                        
                        <!-- QKVç”Ÿæˆï¼ˆå¹¶è¡Œï¼‰ -->
                        <text x="200" y="120" text-anchor="middle" font-size="12">æ‰€æœ‰ä½ç½®åŒæ—¶ç”ŸæˆQã€Kã€V</text>
                        
                        <g transform="translate(0, 130)">
                            <rect x="0" y="0" width="420" height="30" fill="#f093fb" opacity="0.5"/>
                            <text x="210" y="20" text-anchor="middle">Q: [6Ã—d_model] å¹¶è¡Œè®¡ç®—</text>
                            
                            <rect x="0" y="35" width="420" height="30" fill="#764ba2" opacity="0.5"/>
                            <text x="210" y="55" text-anchor="middle">K: [6Ã—d_model] å¹¶è¡Œè®¡ç®—</text>
                            
                            <rect x="0" y="70" width="420" height="30" fill="#4facfe" opacity="0.5"/>
                            <text x="210" y="90" text-anchor="middle">V: [6Ã—d_model] å¹¶è¡Œè®¡ç®—</text>
                        </g>
                        
                        <!-- å› æœæ©ç  -->
                        <g transform="translate(0, 260)">
                            <text x="210" y="0" text-anchor="middle" font-weight="bold">å› æœæ©ç ï¼ˆCausal Maskï¼‰</text>
                            <rect x="50" y="10" width="300" height="300" fill="none" stroke="#333" stroke-width="2"/>
                            
                            <!-- ä¸‹ä¸‰è§’æ©ç  -->
                            <g opacity="0.7">
                                <!-- ç¬¬1è¡Œï¼šåªèƒ½çœ‹åˆ°"æˆ‘" -->
                                <rect x="50" y="10" width="50" height="50" fill="#00cc00"/>
                                
                                <!-- ç¬¬2è¡Œï¼šèƒ½çœ‹åˆ°"æˆ‘çˆ±" -->
                                <rect x="50" y="60" width="50" height="50" fill="#00cc00"/>
                                <rect x="100" y="60" width="50" height="50" fill="#00cc00"/>
                                
                                <!-- ç¬¬3è¡Œï¼šèƒ½çœ‹åˆ°"æˆ‘çˆ±åŒ—äº¬" -->
                                <rect x="50" y="110" width="50" height="50" fill="#00cc00"/>
                                <rect x="100" y="110" width="50" height="50" fill="#00cc00"/>
                                <rect x="150" y="110" width="50" height="50" fill="#00cc00"/>
                                
                                <!-- ç¬¬4è¡Œï¼šèƒ½çœ‹åˆ°"æˆ‘çˆ±åŒ—äº¬å¤©å®‰" -->
                                <rect x="50" y="160" width="50" height="50" fill="#00cc00"/>
                                <rect x="100" y="160" width="50" height="50" fill="#00cc00"/>
                                <rect x="150" y="160" width="50" height="50" fill="#00cc00"/>
                                <rect x="200" y="160" width="50" height="50" fill="#00cc00"/>
                                
                                <!-- ç¬¬5è¡Œï¼šèƒ½çœ‹åˆ°"æˆ‘çˆ±åŒ—äº¬å¤©å®‰é—¨" -->
                                <rect x="50" y="210" width="50" height="50" fill="#00cc00"/>
                                <rect x="100" y="210" width="50" height="50" fill="#00cc00"/>
                                <rect x="150" y="210" width="50" height="50" fill="#00cc00"/>
                                <rect x="200" y="210" width="50" height="50" fill="#00cc00"/>
                                <rect x="250" y="210" width="50" height="50" fill="#00cc00"/>
                                
                                <!-- ç¬¬6è¡Œï¼šèƒ½çœ‹åˆ°æ‰€æœ‰ -->
                                <rect x="50" y="260" width="50" height="50" fill="#00cc00"/>
                                <rect x="100" y="260" width="50" height="50" fill="#00cc00"/>
                                <rect x="150" y="260" width="50" height="50" fill="#00cc00"/>
                                <rect x="200" y="260" width="50" height="50" fill="#00cc00"/>
                                <rect x="250" y="260" width="50" height="50" fill="#00cc00"/>
                                <rect x="300" y="260" width="50" height="50" fill="#00cc00"/>
                            </g>
                            
                            <text x="200" y="340" text-anchor="middle" font-size="11" fill="#666">
                                ç»¿è‰²=å¯è§ï¼Œç™½è‰²=è¢«æ©ç ï¼ˆé˜²æ­¢çœ‹åˆ°æœªæ¥ï¼‰
                            </text>
                        </g>
                    </g>
                    
                    <!-- å³ä¾§ï¼šå¹¶è¡Œä¼˜åŠ¿è¯´æ˜ -->
                    <g transform="translate(650, 80)">
                        <rect x="0" y="0" width="450" height="220" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="10"/>
                        <text x="225" y="30" text-anchor="middle" font-weight="bold" fill="#2e7d32">ä¸ºä»€ä¹ˆè®­ç»ƒå¯ä»¥å¹¶è¡Œï¼Ÿ</text>
                        
                        <text x="20" y="60" font-size="13">1. Teacher Forcingï¼šè®­ç»ƒæ—¶çŸ¥é“å®Œæ•´ç­”æ¡ˆ</text>
                        <text x="20" y="85" font-size="13">2. å› æœæ©ç ï¼šç¡®ä¿æ¯ä¸ªä½ç½®åªçœ‹åˆ°ä¹‹å‰çš„å†…å®¹</text>
                        <text x="20" y="110" font-size="13">3. çŸ©é˜µè¿ç®—ï¼šæ‰€æœ‰ä½ç½®çš„æ³¨æ„åŠ›ä¸€æ¬¡è®¡ç®—</text>
                        <text x="20" y="135" font-size="13">4. GPUå¹¶è¡Œï¼šå……åˆ†åˆ©ç”¨GPUçš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›</text>
                        
                        <rect x="20" y="160" width="410" height="45" fill="#fff3cd" stroke="#ffc107" rx="5"/>
                        <text x="30" y="180" font-size="12">ğŸ’¡ ä¸€æ¬¡å‰å‘ä¼ æ’­å¤„ç†æ•´ä¸ªåºåˆ—ï¼Œ</text>
                        <text x="30" y="195" font-size="12">    è€Œä¸æ˜¯é€ä¸ªtokenè®¡ç®—</text>
                    </g>
                    
                    <!-- ç›®æ ‡è¾“å‡º -->
                    <g transform="translate(650, 350)">
                        <text x="225" y="0" text-anchor="middle" font-weight="bold">è®­ç»ƒç›®æ ‡ï¼ˆå³ç§»ä¸€ä½ï¼‰</text>
                        
                        <g transform="translate(0, 20)">
                            <rect x="0" y="0" width="60" height="40" fill="#ff6b6b" opacity="0.7" stroke="#333"/>
                            <text x="30" y="25" text-anchor="middle">çˆ±</text>
                            
                            <rect x="70" y="0" width="60" height="40" fill="#ff6b6b" opacity="0.7" stroke="#333"/>
                            <text x="100" y="25" text-anchor="middle">åŒ—äº¬</text>
                            
                            <rect x="140" y="0" width="60" height="40" fill="#ff6b6b" opacity="0.7" stroke="#333"/>
                            <text x="170" y="25" text-anchor="middle">å¤©å®‰</text>
                            
                            <rect x="210" y="0" width="60" height="40" fill="#ff6b6b" opacity="0.7" stroke="#333"/>
                            <text x="240" y="25" text-anchor="middle">é—¨</text>
                            
                            <rect x="280" y="0" width="60" height="40" fill="#ff6b6b" opacity="0.7" stroke="#333"/>
                            <text x="310" y="25" text-anchor="middle">[EOS]</text>
                            
                            <rect x="350" y="0" width="60" height="40" fill="#ff6b6b" opacity="0.7" stroke="#333"/>
                            <text x="380" y="25" text-anchor="middle">-</text>
                        </g>
                        
                        <text x="225" y="90" text-anchor="middle" font-size="12" fill="#666">
                            Loss = CrossEntropy(é¢„æµ‹è¾“å‡º, ç›®æ ‡è¾“å‡º)
                        </text>
                    </g>
                </svg>
            </div>
            
            <h3>ğŸ”® æ¨ç†ï¼šé€ä¸ªç”ŸæˆToken</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 750">
                    <text x="600" y="30" text-anchor="middle" font-weight="bold" font-size="18">æ¨ç†æ—¶çš„è‡ªå›å½’ç”Ÿæˆï¼ˆAuto-regressiveï¼‰</text>
                    
                    <!-- Step 1 -->
                    <g transform="translate(50, 80)">
                        <rect x="0" y="0" width="250" height="140" fill="#f0f0f0" stroke="#667eea" stroke-width="2" rx="10"/>
                        <text x="125" y="20" text-anchor="middle" font-weight="bold" fill="#667eea">Step 1: è¾“å…¥"æˆ‘"</text>
                        
                        <rect x="20" y="35" width="50" height="30" fill="#667eea" opacity="0.7"/>
                        <text x="45" y="55" text-anchor="middle" fill="white" font-size="12">æˆ‘</text>
                        
                        <path d="M 45 70 L 45 90" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <text x="45" y="110" text-anchor="middle" font-size="11">ç”ŸæˆQâ‚,Kâ‚,Vâ‚</text>
                        <text x="45" y="130" text-anchor="middle" font-size="11">Attn â†’ FFN</text>
                        
                        <rect x="150" y="70" width="50" height="30" fill="#00cc00" opacity="0.7"/>
                        <text x="175" y="90" text-anchor="middle" font-size="12">çˆ±</text>
                        
                        <text x="125" y="160" text-anchor="middle" font-size="11">è¾“å‡º: "çˆ±"</text>
                        <text x="125" y="180" text-anchor="middle" font-size="11" fill="#666">KV Cache: [Kâ‚,Vâ‚]</text>
                    </g>
                    
                    <!-- Step 2 -->
                    <g transform="translate(320, 80)">
                        <rect x="0" y="0" width="250" height="140" fill="#f0f0f0" stroke="#667eea" stroke-width="2" rx="10"/>
                        <text x="125" y="20" text-anchor="middle" font-weight="bold" fill="#667eea">Step 2: è¾“å…¥"æˆ‘çˆ±"</text>
                        
                        <rect x="20" y="35" width="50" height="30" fill="#667eea" opacity="0.5"/>
                        <text x="45" y="55" text-anchor="middle" fill="white" font-size="12">æˆ‘</text>
                        <rect x="75" y="35" width="50" height="30" fill="#667eea" opacity="0.7"/>
                        <text x="100" y="55" text-anchor="middle" fill="white" font-size="12">çˆ±</text>
                        
                        <path d="M 100 70 L 100 90" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <text x="75" y="110" text-anchor="middle" font-size="11">å¤ç”¨Kâ‚,Vâ‚</text>
                        <text x="75" y="130" text-anchor="middle" font-size="11">åªç®—Qâ‚‚,Kâ‚‚,Vâ‚‚</text>
                        
                        <rect x="150" y="70" width="50" height="30" fill="#00cc00" opacity="0.7"/>
                        <text x="175" y="90" text-anchor="middle" font-size="12">åŒ—äº¬</text>
                        
                        <text x="125" y="160" text-anchor="middle" font-size="11">è¾“å‡º: "åŒ—äº¬"</text>
                        <text x="125" y="180" text-anchor="middle" font-size="11" fill="#666">KV Cache: [Kâ‚,Vâ‚,Kâ‚‚,Vâ‚‚]</text>
                    </g>
                    
                    <!-- Step 3 -->
                    <g transform="translate(590, 80)">
                        <rect x="0" y="0" width="280" height="140" fill="#f0f0f0" stroke="#667eea" stroke-width="2" rx="10"/>
                        <text x="140" y="20" text-anchor="middle" font-weight="bold" fill="#667eea">Step 3: è¾“å…¥"æˆ‘çˆ±åŒ—äº¬"</text>
                        
                        <rect x="20" y="35" width="50" height="30" fill="#667eea" opacity="0.3"/>
                        <text x="45" y="55" text-anchor="middle" fill="white" font-size="12">æˆ‘</text>
                        <rect x="75" y="35" width="50" height="30" fill="#667eea" opacity="0.5"/>
                        <text x="100" y="55" text-anchor="middle" fill="white" font-size="12">çˆ±</text>
                        <rect x="130" y="35" width="50" height="30" fill="#667eea" opacity="0.7"/>
                        <text x="155" y="55" text-anchor="middle" fill="white" font-size="12">åŒ—äº¬</text>
                        
                        <path d="M 155 70 L 155 90" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <text x="100" y="110" text-anchor="middle" font-size="11">å¤ç”¨Kâ‚,Vâ‚,Kâ‚‚,Vâ‚‚</text>
                        <text x="100" y="130" text-anchor="middle" font-size="11">åªç®—Qâ‚ƒ,Kâ‚ƒ,Vâ‚ƒ</text>
                        
                        <rect x="200" y="70" width="50" height="30" fill="#00cc00" opacity="0.7"/>
                        <text x="225" y="90" text-anchor="middle" font-size="12">å¤©å®‰</text>
                        
                        <text x="140" y="160" text-anchor="middle" font-size="11">è¾“å‡º: "å¤©å®‰"</text>
                        <text x="140" y="180" text-anchor="middle" font-size="11" fill="#666">KV CacheæŒç»­å¢é•¿...</text>
                    </g>
                    
                    <!-- KV Cacheè¯´æ˜ -->
                    <g transform="translate(100, 250)">
                        <rect x="0" y="0" width="1000" height="180" fill="#fff3cd" stroke="#ffc107" stroke-width="2" rx="10"/>
                        <text x="500" y="30" text-anchor="middle" font-weight="bold" fill="#856404">KV Cacheæœºåˆ¶</text>
                        
                        <g transform="translate(50, 50)">
                            <text x="0" y="0" font-size="13">â€¢ æ¯æ­¥åªéœ€è®¡ç®—æ–°ä½ç½®çš„Qã€Kã€V</text>
                            <text x="0" y="25" font-size="13">â€¢ ä¹‹å‰ä½ç½®çš„Kã€Vä¿å­˜åœ¨ç¼“å­˜ä¸­å¤ç”¨</text>
                            <text x="0" y="50" font-size="13">â€¢ æ³¨æ„åŠ›è®¡ç®—: Q_new Ã— [K_cache; K_new]áµ€</text>
                            <text x="0" y="75" font-size="13">â€¢ å†…å­˜éœ€æ±‚: 2 Ã— n_layers Ã— seq_len Ã— n_heads Ã— d_head</text>
                            
                            <rect x="400" y="-10" width="500" height="90" fill="white" stroke="#856404" rx="5"/>
                            <text x="410" y="10" font-size="12" font-weight="bold">è®¡ç®—ç¤ºä¾‹ï¼ˆå•ä¸ªtokenï¼‰ï¼š</text>
                            <text x="410" y="30" font-size="11">1. è¾“å…¥embedding: [1 Ã— d_model]</text>
                            <text x="410" y="48" font-size="11">2. ç”ŸæˆQ_new: [1 Ã— n_heads Ã— d_head]</text>
                            <text x="410" y="66" font-size="11">3. Attention: Q_new Ã— K_cache^T â†’ [1 Ã— seq_len]</text>
                        </g>
                    </g>
                    
                    <!-- æ¨ç†ç‰¹ç‚¹ -->
                    <g transform="translate(100, 460)">
                        <rect x="0" y="0" width="450" height="170" fill="#ffe0e0" stroke="#ff0000" stroke-width="2" rx="10"/>
                        <text x="225" y="30" text-anchor="middle" font-weight="bold" fill="#cc0000">æ¨ç†ç“¶é¢ˆ</text>
                        
                        <text x="20" y="60" font-size="13">âŒ é¡ºåºä¾èµ–ï¼šå¿…é¡»ç­‰å‰ä¸€ä¸ªtokenç”Ÿæˆå®Œ</text>
                        <text x="20" y="85" font-size="13">âŒ å†…å­˜ç“¶é¢ˆï¼šKV Cacheéšåºåˆ—é•¿åº¦çº¿æ€§å¢é•¿</text>
                        <text x="20" y="110" font-size="13">âŒ ä½GPUåˆ©ç”¨ç‡ï¼šæ¯æ­¥åªå¤„ç†1ä¸ªtoken</text>
                        
                        <text x="225" y="145" text-anchor="middle" font-size="11" fill="#666">è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦GQA/MQAä¼˜åŒ–ï¼</text>
                    </g>
                    
                    <g transform="translate(580, 460)">
                        <rect x="0" y="0" width="450" height="170" fill="#e0ffe0" stroke="#00cc00" stroke-width="2" rx="10"/>
                        <text x="225" y="30" text-anchor="middle" font-weight="bold" fill="#00aa00">ä¼˜åŒ–æ–¹æ¡ˆ</text>
                        
                        <text x="20" y="60" font-size="13">âœ“ æ‰¹å¤„ç†ï¼šåŒæ—¶å¤„ç†å¤šä¸ªåºåˆ—</text>
                        <text x="20" y="85" font-size="13">âœ“ GQA/MQAï¼šå‡å°‘KV Cacheå†…å­˜</text>
                        <text x="20" y="110" font-size="13">âœ“ æŠ•æœºè§£ç ï¼šå°æ¨¡å‹é¢„æµ‹ï¼Œå¤§æ¨¡å‹éªŒè¯</text>
                        
                        <text x="225" y="145" text-anchor="middle" font-size="11" fill="#666">Flash Attentionä¹Ÿèƒ½åŠ é€Ÿæ¨ç†ï¼</text>
                    </g>
                </svg>
            </div>
        </div>
        
        <!-- æ¨¡å‹è§„æ¨¡è¯¦è§£ -->
        <div class="attention-type" id="model-scale">
            <h2><span class="icon">ğŸ“</span> ä¸»æµæ¨¡å‹è§„æ¨¡è¯¦è§£</h2>
            
            <h3>ğŸ¯ å…¸å‹æ¨¡å‹å‚æ•°é…ç½®</h3>
            <table class="complexity-table">
                <thead>
                    <tr>
                        <th>æ¨¡å‹</th>
                        <th>å‚æ•°é‡</th>
                        <th>å±‚æ•°</th>
                        <th>éšè—ç»´åº¦</th>
                        <th>æ³¨æ„åŠ›å¤´æ•°</th>
                        <th>å¤´ç»´åº¦</th>
                        <th>è¯è¡¨å¤§å°</th>
                        <th>æœ€å¤§åºåˆ—é•¿åº¦</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><b>GPT-3</b></td>
                        <td>175B</td>
                        <td>96</td>
                        <td>12,288</td>
                        <td>96</td>
                        <td>128</td>
                        <td>50,257</td>
                        <td>2,048</td>
                    </tr>
                    <tr>
                        <td><b>Llama 2-7B</b></td>
                        <td>7B</td>
                        <td>32</td>
                        <td>4,096</td>
                        <td>32 (Q) / 8 (KV)</td>
                        <td>128</td>
                        <td>32,000</td>
                        <td>4,096</td>
                    </tr>
                    <tr>
                        <td><b>Llama 2-70B</b></td>
                        <td>70B</td>
                        <td>80</td>
                        <td>8,192</td>
                        <td>64 (Q) / 8 (KV)</td>
                        <td>128</td>
                        <td>32,000</td>
                        <td>4,096</td>
                    </tr>
                    <tr>
                        <td><b>Mistral-7B</b></td>
                        <td>7B</td>
                        <td>32</td>
                        <td>4,096</td>
                        <td>32 (Q) / 8 (KV)</td>
                        <td>128</td>
                        <td>32,000</td>
                        <td>32,768</td>
                    </tr>
                    <tr>
                        <td><b>PaLM</b></td>
                        <td>540B</td>
                        <td>118</td>
                        <td>18,432</td>
                        <td>48 (MQA)</td>
                        <td>256</td>
                        <td>256,000</td>
                        <td>2,048</td>
                    </tr>
                    <tr>
                        <td><b>Claude 3</b></td>
                        <td>~100B</td>
                        <td>~80</td>
                        <td>~12,288</td>
                        <td>~96</td>
                        <td>128</td>
                        <td>~100,000</td>
                        <td>200,000</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>ğŸ“Š çŸ©é˜µè§„æ¨¡è®¡ç®—ç¤ºä¾‹ï¼ˆä»¥Llama 2-7Bä¸ºä¾‹ï¼‰</h3>
            <div class="math-section">
                <p><b>å•å±‚æ³¨æ„åŠ›çŸ©é˜µè§„æ¨¡ï¼š</b></p>
                
                <div class="step-box">
                    <p><b>å‚æ•°è®¾ç½®ï¼š</b></p>
                    <ul style="margin-left: 20px;">
                        <li>d_model = 4,096ï¼ˆéšè—ç»´åº¦ï¼‰</li>
                        <li>n_heads = 32ï¼ˆæŸ¥è¯¢å¤´æ•°ï¼‰</li>
                        <li>n_kv_heads = 8ï¼ˆKVå¤´æ•°ï¼ŒGQAï¼‰</li>
                        <li>d_head = 128ï¼ˆæ¯ä¸ªå¤´çš„ç»´åº¦ï¼‰</li>
                        <li>seq_len = 4,096ï¼ˆåºåˆ—é•¿åº¦ï¼‰</li>
                    </ul>
                </div>
                
                <p style="margin-top: 20px;"><b>æƒé‡çŸ©é˜µå¤§å°ï¼š</b></p>
                <ul style="margin-left: 20px;">
                    <li>W_q: [4096 Ã— 4096] = 16.8Må‚æ•°</li>
                    <li>W_k: [4096 Ã— 1024] = 4.2Må‚æ•°ï¼ˆGQAä¼˜åŒ–ï¼‰</li>
                    <li>W_v: [4096 Ã— 1024] = 4.2Må‚æ•°ï¼ˆGQAä¼˜åŒ–ï¼‰</li>
                    <li>W_o: [4096 Ã— 4096] = 16.8Må‚æ•°</li>
                    <li><b>å•å±‚æ³¨æ„åŠ›æ€»è®¡ï¼š42Må‚æ•°</b></li>
                </ul>
                
                <p style="margin-top: 20px;"><b>è¿è¡Œæ—¶çŸ©é˜µå¤§å°ï¼ˆæ‰¹æ¬¡=1ï¼‰ï¼š</b></p>
                <ul style="margin-left: 20px;">
                    <li>Q: [4096 Ã— 32 Ã— 128] = 16MBï¼ˆFP32ï¼‰</li>
                    <li>K: [4096 Ã— 8 Ã— 128] = 4MBï¼ˆGQAä¼˜åŒ–ï¼‰</li>
                    <li>V: [4096 Ã— 8 Ã— 128] = 4MBï¼ˆGQAä¼˜åŒ–ï¼‰</li>
                    <li>æ³¨æ„åŠ›åˆ†æ•°: [32 Ã— 4096 Ã— 4096] = 2.1GBï¼ˆå¦‚ä¸ç”¨Flashï¼‰</li>
                </ul>
            </div>
            
            <h3>ğŸ’¾ å†…å­˜éœ€æ±‚åˆ†æ</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 500">
                    <text x="600" y="30" text-anchor="middle" font-weight="bold" font-size="18">ä¸åŒæ¨¡å‹çš„æ˜¾å­˜éœ€æ±‚å¯¹æ¯”</text>
                    
                    <!-- è®­ç»ƒå†…å­˜ -->
                    <g transform="translate(100, 80)">
                        <text x="250" y="0" text-anchor="middle" font-weight="bold">è®­ç»ƒæ—¶æ˜¾å­˜éœ€æ±‚ï¼ˆæ··åˆç²¾åº¦ï¼‰</text>
                        
                        <!-- 7Bæ¨¡å‹ -->
                        <g transform="translate(0, 20)">
                            <rect x="0" y="0" width="500" height="40" fill="#e0e0e0" stroke="#333"/>
                            <rect x="0" y="0" width="140" height="40" fill="#667eea" opacity="0.7"/>
                            <text x="10" y="25" fill="white" font-weight="bold">7Bæ¨¡å‹</text>
                            <text x="510" y="25" font-size="12">~56GBï¼ˆå‚æ•°14GB + æ¢¯åº¦14GB + ä¼˜åŒ–å™¨28GBï¼‰</text>
                        </g>
                        
                        <!-- 13Bæ¨¡å‹ -->
                        <g transform="translate(0, 70)">
                            <rect x="0" y="0" width="500" height="40" fill="#e0e0e0" stroke="#333"/>
                            <rect x="0" y="0" width="260" height="40" fill="#764ba2" opacity="0.7"/>
                            <text x="10" y="25" fill="white" font-weight="bold">13Bæ¨¡å‹</text>
                            <text x="510" y="25" font-size="12">~104GBï¼ˆå‚æ•°26GB + æ¢¯åº¦26GB + ä¼˜åŒ–å™¨52GBï¼‰</text>
                        </g>
                        
                        <!-- 70Bæ¨¡å‹ -->
                        <g transform="translate(0, 120)">
                            <rect x="0" y="0" width="500" height="40" fill="#e0e0e0" stroke="#333"/>
                            <rect x="0" y="0" width="500" height="40" fill="#f093fb" opacity="0.7"/>
                            <text x="10" y="25" fill="white" font-weight="bold">70Bæ¨¡å‹</text>
                            <text x="510" y="25" font-size="12">~560GBï¼ˆéœ€è¦å¤šå¡å¹¶è¡Œï¼‰</text>
                        </g>
                        
                        <text x="250" y="200" text-anchor="middle" font-size="11" fill="#666">
                            è§„åˆ™ï¼šè®­ç»ƒæ˜¾å­˜ â‰ˆ æ¨¡å‹å‚æ•° Ã— 8ï¼ˆæ··åˆç²¾åº¦ï¼‰
                        </text>
                    </g>
                    
                    <!-- æ¨ç†å†…å­˜ -->
                    <g transform="translate(100, 320)">
                        <text x="250" y="0" text-anchor="middle" font-weight="bold">æ¨ç†æ—¶æ˜¾å­˜éœ€æ±‚ï¼ˆFP16ï¼‰</text>
                        
                        <!-- åŸºç¡€æ¨¡å‹å†…å­˜ -->
                        <g transform="translate(0, 20)">
                            <rect x="0" y="0" width="200" height="30" fill="#00cc00" opacity="0.7"/>
                            <text x="100" y="20" text-anchor="middle" fill="white">æ¨¡å‹æƒé‡</text>
                            <text x="210" y="20" font-size="12">7B: 14GB</text>
                        </g>
                        
                        <!-- KV Cache -->
                        <g transform="translate(0, 60)">
                            <rect x="0" y="0" width="300" height="30" fill="#ff6b6b" opacity="0.7"/>
                            <text x="150" y="20" text-anchor="middle" fill="white">KV Cacheï¼ˆseq=4096ï¼‰</text>
                            <text x="310" y="20" font-size="12">æ ‡å‡†: 16GB</text>
                        </g>
                        
                        <g transform="translate(0, 100)">
                            <rect x="0" y="0" width="75" height="30" fill="#ffc107" opacity="0.7"/>
                            <text x="37" y="20" text-anchor="middle">GQA</text>
                            <text x="85" y="20" font-size="12">4GBï¼ˆèŠ‚çœ75%ï¼‰</text>
                        </g>
                        
                        <g transform="translate(0, 140)">
                            <rect x="0" y="0" width="37" height="30" fill="#4caf50" opacity="0.7"/>
                            <text x="18" y="20" text-anchor="middle" font-size="11">MQA</text>
                            <text x="47" y="20" font-size="12">2GBï¼ˆèŠ‚çœ87.5%ï¼‰</text>
                        </g>
                    </g>
                    
                    <!-- GPUé…ç½®å»ºè®® -->
                    <g transform="translate(650, 80)">
                        <rect x="0" y="0" width="450" height="400" fill="#f8f9fa" stroke="#667eea" stroke-width="2" rx="10"/>
                        <text x="225" y="30" text-anchor="middle" font-weight="bold" fill="#667eea">GPUé…ç½®å»ºè®®</text>
                        
                        <g transform="translate(20, 50)">
                            <text x="0" y="20" font-size="14" font-weight="bold">æ¨ç†éƒ¨ç½²ï¼š</text>
                            <text x="20" y="45" font-size="12">â€¢ 7Bæ¨¡å‹ï¼šRTX 4090 (24GB)</text>
                            <text x="20" y="70" font-size="12">â€¢ 13Bæ¨¡å‹ï¼šA100 40GB æˆ– 2Ã—RTX 4090</text>
                            <text x="20" y="95" font-size="12">â€¢ 70Bæ¨¡å‹ï¼š4Ã—A100 80GB</text>
                            
                            <text x="0" y="140" font-size="14" font-weight="bold">è®­ç»ƒå¾®è°ƒï¼š</text>
                            <text x="20" y="165" font-size="12">â€¢ 7Bæ¨¡å‹ï¼šA100 80GB</text>
                            <text x="20" y="190" font-size="12">â€¢ 13Bæ¨¡å‹ï¼š2Ã—A100 80GB</text>
                            <text x="20" y="215" font-size="12">â€¢ 70Bæ¨¡å‹ï¼š8Ã—A100 80GB</text>
                            
                            <text x="0" y="260" font-size="14" font-weight="bold">ä¼˜åŒ–æŠ€å·§ï¼š</text>
                            <text x="20" y="285" font-size="12">â€¢ ä½¿ç”¨GQA/MQAå‡å°‘KV Cache</text>
                            <text x="20" y="310" font-size="12">â€¢ é‡åŒ–ï¼ˆINT8/INT4ï¼‰å‡å°‘æƒé‡å†…å­˜</text>
                            <text x="20" y="335" font-size="12">â€¢ Flash Attentionå‡å°‘æ¿€æ´»å†…å­˜</text>
                        </g>
                    </g>
                </svg>
            </div>
            
            <div class="code-ref">
                <h4>ğŸ“ å†…å­˜è®¡ç®—å…¬å¼</h4>
                <pre>
<span class="code-comment"># è®­ç»ƒæ—¶å†…å­˜éœ€æ±‚ï¼ˆAdamä¼˜åŒ–å™¨ï¼‰</span>
training_memory = (
    model_params * 2 +     <span class="code-comment"># FP16æ¨¡å‹æƒé‡</span>
    model_params * 2 +     <span class="code-comment"># FP16æ¢¯åº¦</span>  
    model_params * 4 * 2   <span class="code-comment"># FP32 AdamçŠ¶æ€ï¼ˆmå’Œvï¼‰</span>
)

<span class="code-comment"># æ¨ç†æ—¶å†…å­˜éœ€æ±‚</span>
inference_memory = (
    model_params * 2 +     <span class="code-comment"># FP16æ¨¡å‹æƒé‡</span>
    kv_cache_memory        <span class="code-comment"># KVç¼“å­˜</span>
)

<span class="code-comment"># KV Cacheè®¡ç®—</span>
<span class="code-comment"># æ ‡å‡†MHA:</span>
kv_cache = 2 * n_layers * seq_len * n_heads * d_head * batch_size * 2  <span class="code-comment"># FP16</span>

<span class="code-comment"># GQA (n_kv_heads < n_heads):</span>
kv_cache_gqa = 2 * n_layers * seq_len * n_kv_heads * d_head * batch_size * 2

<span class="code-comment"># MQA (n_kv_heads = 1):</span>
kv_cache_mqa = 2 * n_layers * seq_len * 1 * d_head * batch_size * 2

<span class="code-comment"># ç¤ºä¾‹ï¼šLlama 2-7Bï¼Œseq_len=4096, batch=1</span>
<span class="code-comment"># æ ‡å‡†ï¼š2 * 32 * 4096 * 32 * 128 * 1 * 2 = 2GB</span>
<span class="code-comment"># GQAï¼š 2 * 32 * 4096 * 8 * 128 * 1 * 2 = 512MBï¼ˆèŠ‚çœ75%ï¼‰</span></pre>
            </div>
        </div>
        
        <!-- 1. å…¨æ³¨æ„åŠ› -->
        <div class="attention-type" id="full-attention">
            <h2><span class="icon">1</span> å…¨æ³¨æ„åŠ› (Full/Dense Attention)</h2>
            
            <h3>ğŸ“ æ•°å­¦åŸç†</h3>
            <div class="math-section">
                <p><b>ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ› (Scaled Dot-Product Attention):</b></p>
                <p>$\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V$</p>
                
                <div class="step-box">
                    <b>è®¡ç®—æ­¥éª¤åˆ†è§£ï¼š</b>
                    <ol style="margin-left: 20px; line-height: 2;">
                        <li><b>æ­¥éª¤1ï¼š</b> è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° $S = QK^T$ ï¼ˆQueryä¸Keyçš„ç›¸ä¼¼åº¦ï¼‰</li>
                        <li><b>æ­¥éª¤2ï¼š</b> ç¼©æ”¾ $S_{scaled} = \frac{S}{\sqrt{d_k}}$ ï¼ˆé˜²æ­¢æ¢¯åº¦æ¶ˆå¤±ï¼‰</li>
                        <li><b>æ­¥éª¤3ï¼š</b> å½’ä¸€åŒ– $A = \text{softmax}(S_{scaled})$ ï¼ˆå¾—åˆ°æ³¨æ„åŠ›æƒé‡ï¼‰</li>
                        <li><b>æ­¥éª¤4ï¼š</b> åŠ æƒæ±‚å’Œ $O = AV$ ï¼ˆæ ¹æ®æƒé‡èšåˆValueï¼‰</li>
                    </ol>
                </div>
                
                <p style="margin-top: 20px;">å…¶ä¸­ï¼š</p>
                <ul style="margin-left: 20px;">
                    <li>$Q \in \mathbb{R}^{n \times d_k}$ï¼šæŸ¥è¯¢çŸ©é˜µ (Queries)</li>
                    <li>$K \in \mathbb{R}^{n \times d_k}$ï¼šé”®çŸ©é˜µ (Keys)</li>
                    <li>$V \in \mathbb{R}^{n \times d_v}$ï¼šå€¼çŸ©é˜µ (Values)</li>
                    <li>$n$ï¼šåºåˆ—é•¿åº¦ï¼Œ$d_k$ï¼šé”®/æŸ¥è¯¢ç»´åº¦ï¼Œ$d_v$ï¼šå€¼ç»´åº¦</li>
                </ul>
            </div>
            
            <h3>ğŸ¨ å›¾å½¢åŒ–è§£é‡Š - åˆ†æ­¥éª¤å±•ç¤º</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 600">
                    <!-- æ ‡é¢˜ -->
                    <text x="600" y="30" text-anchor="middle" font-weight="bold" font-size="18">æ³¨æ„åŠ›è®¡ç®—è¯¦ç»†æ­¥éª¤</text>
                    
                    <!-- æ­¥éª¤1: Q Ã— K^T -->
                    <g transform="translate(50, 60)">
                        <text x="100" y="0" text-anchor="middle" font-weight="bold" fill="#667eea">æ­¥éª¤1: è®¡ç®—ç›¸ä¼¼åº¦</text>
                        
                        <!-- QçŸ©é˜µ -->
                        <rect x="0" y="20" width="60" height="100" fill="#667eea" opacity="0.7" rx="5"/>
                        <text x="30" y="75" text-anchor="middle" class="matrix-label" fill="white">Q</text>
                        <text x="30" y="135" text-anchor="middle" font-size="12">[nÃ—d_k]</text>
                        
                        <!-- Ã— ç¬¦å· -->
                        <text x="85" y="75" text-anchor="middle" font-size="20">Ã—</text>
                        
                        <!-- K^TçŸ©é˜µ (æ³¨æ„ç»´åº¦æ˜¯è½¬ç½®åçš„) -->
                        <rect x="110" y="20" width="100" height="60" fill="#764ba2" opacity="0.7" rx="5"/>
                        <text x="160" y="55" text-anchor="middle" class="matrix-label" fill="white">K^T</text>
                        <text x="160" y="95" text-anchor="middle" font-size="12">[d_kÃ—n]</text>
                        
                        <!-- = ç¬¦å· -->
                        <text x="235" y="75" text-anchor="middle" font-size="20">=</text>
                        
                        <!-- SçŸ©é˜µ -->
                        <rect x="260" y="20" width="100" height="100" fill="#f093fb" opacity="0.7" rx="5"/>
                        <text x="310" y="75" text-anchor="middle" class="matrix-label" fill="white">S</text>
                        <text x="310" y="135" text-anchor="middle" font-size="12">[nÃ—n]</text>
                        
                        <!-- è¯´æ˜æ–‡å­— -->
                        <text x="180" y="160" text-anchor="middle" font-size="11" fill="#666">
                            æ¯ä¸ªQueryä¸æ‰€æœ‰Keyçš„ç‚¹ç§¯
                        </text>
                    </g>
                    
                    <!-- æ­¥éª¤2: ç¼©æ”¾ -->
                    <g transform="translate(450, 60)">
                        <text x="100" y="0" text-anchor="middle" font-weight="bold" fill="#667eea">æ­¥éª¤2: ç¼©æ”¾</text>
                        
                        <!-- SçŸ©é˜µ -->
                        <rect x="0" y="20" width="100" height="100" fill="#f093fb" opacity="0.7" rx="5"/>
                        <text x="50" y="75" text-anchor="middle" class="matrix-label" fill="white">S</text>
                        
                        <!-- Ã· ç¬¦å· -->
                        <text x="125" y="75" text-anchor="middle" font-size="20">Ã·</text>
                        
                        <!-- sqrt(d_k) -->
                        <rect x="150" y="55" width="50" height="30" fill="#ffc107" opacity="0.7" rx="5"/>
                        <text x="175" y="75" text-anchor="middle" font-size="12">âˆšd_k</text>
                        
                        <!-- = ç¬¦å· -->
                        <text x="225" y="75" text-anchor="middle" font-size="20">=</text>
                        
                        <!-- S_scaledçŸ©é˜µ -->
                        <rect x="250" y="20" width="100" height="100" fill="#ff6b6b" opacity="0.7" rx="5"/>
                        <text x="300" y="75" text-anchor="middle" class="matrix-label" fill="white">S'</text>
                        <text x="300" y="135" text-anchor="middle" font-size="12">[nÃ—n]</text>
                        
                        <!-- è¯´æ˜æ–‡å­— -->
                        <text x="175" y="160" text-anchor="middle" font-size="11" fill="#666">
                            é˜²æ­¢softmaxæ¢¯åº¦æ¶ˆå¤±
                        </text>
                    </g>
                    
                    <!-- æ­¥éª¤3: Softmax -->
                    <g transform="translate(850, 60)">
                        <text x="100" y="0" text-anchor="middle" font-weight="bold" fill="#667eea">æ­¥éª¤3: å½’ä¸€åŒ–</text>
                        
                        <!-- S_scaledçŸ©é˜µ -->
                        <rect x="0" y="20" width="100" height="100" fill="#ff6b6b" opacity="0.7" rx="5"/>
                        <text x="50" y="75" text-anchor="middle" class="matrix-label" fill="white">S'</text>
                        
                        <!-- softmaxç®­å¤´ -->
                        <path d="M 110 70 L 140 70" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="125" y="60" text-anchor="middle" font-size="11">softmax</text>
                        <text x="125" y="90" text-anchor="middle" font-size="10" fill="#666">(æŒ‰è¡Œ)</text>
                        
                        <!-- AçŸ©é˜µ -->
                        <rect x="150" y="20" width="100" height="100" fill="#f5576c" opacity="0.7" rx="5"/>
                        <text x="200" y="75" text-anchor="middle" class="matrix-label" fill="white">A</text>
                        <text x="200" y="135" text-anchor="middle" font-size="12">[nÃ—n]</text>
                        
                        <!-- è¯´æ˜æ–‡å­— -->
                        <text x="125" y="160" text-anchor="middle" font-size="11" fill="#666">
                            æ¯è¡Œå’Œä¸º1çš„æƒé‡çŸ©é˜µ
                        </text>
                    </g>
                    
                    <!-- æ­¥éª¤4: A Ã— V -->
                    <g transform="translate(250, 250)">
                        <text x="250" y="0" text-anchor="middle" font-weight="bold" fill="#667eea">æ­¥éª¤4: åŠ æƒèšåˆ</text>
                        
                        <!-- AçŸ©é˜µ -->
                        <rect x="0" y="20" width="100" height="100" fill="#f5576c" opacity="0.7" rx="5"/>
                        <text x="50" y="75" text-anchor="middle" class="matrix-label" fill="white">A</text>
                        <text x="50" y="135" text-anchor="middle" font-size="12">[nÃ—n]</text>
                        
                        <!-- Ã— ç¬¦å· -->
                        <text x="125" y="75" text-anchor="middle" font-size="20">Ã—</text>
                        
                        <!-- VçŸ©é˜µ -->
                        <rect x="150" y="20" width="60" height="100" fill="#4facfe" opacity="0.7" rx="5"/>
                        <text x="180" y="75" text-anchor="middle" class="matrix-label" fill="white">V</text>
                        <text x="180" y="135" text-anchor="middle" font-size="12">[nÃ—d_v]</text>
                        
                        <!-- = ç¬¦å· -->
                        <text x="235" y="75" text-anchor="middle" font-size="20">=</text>
                        
                        <!-- OutputçŸ©é˜µ -->
                        <rect x="260" y="20" width="60" height="100" fill="#00f2fe" opacity="0.7" rx="5"/>
                        <text x="290" y="75" text-anchor="middle" class="matrix-label" fill="white">O</text>
                        <text x="290" y="135" text-anchor="middle" font-size="12">[nÃ—d_v]</text>
                        
                        <!-- è¯´æ˜æ–‡å­— -->
                        <text x="160" y="160" text-anchor="middle" font-size="11" fill="#666">
                            æ ¹æ®æ³¨æ„åŠ›æƒé‡ç»„åˆValue
                        </text>
                    </g>
                    
                    <!-- è¿æ¥çº¿å±•ç¤ºæµç¨‹ -->
                    <g stroke="#667eea" stroke-width="2" fill="none" stroke-dasharray="5,5">
                        <path d="M 360 130 Q 400 180, 350 250"/>
                        <path d="M 800 130 Q 850 180, 350 270"/>
                    </g>
                    
                    <!-- ç»´åº¦ç¤ºä¾‹æ¡† -->
                    <g transform="translate(650, 350)">
                        <rect x="0" y="0" width="400" height="180" fill="#f8f9fa" stroke="#667eea" stroke-width="2" rx="10"/>
                        <text x="200" y="25" text-anchor="middle" font-weight="bold" fill="#667eea">ç»´åº¦ç¤ºä¾‹ï¼ˆn=4, d_k=64, d_v=64ï¼‰</text>
                        
                        <text x="20" y="55" font-size="13">Q: [4Ã—64] Ã— K^T: [64Ã—4] = S: [4Ã—4]</text>
                        <text x="20" y="80" font-size="13">S: [4Ã—4] Ã· âˆš64 = S': [4Ã—4]</text>
                        <text x="20" y="105" font-size="13">softmax(S'): [4Ã—4] = A: [4Ã—4]</text>
                        <text x="20" y="130" font-size="13">A: [4Ã—4] Ã— V: [4Ã—64] = O: [4Ã—64]</text>
                        
                        <text x="20" y="160" font-size="11" fill="#666">ğŸ’¡ è¾“å‡ºç»´åº¦ä¸è¾“å…¥Qç›¸åŒï¼Œä½†å†…å®¹æ˜¯Vçš„åŠ æƒç»„åˆ</text>
                    </g>
                    
                    <!-- ç®­å¤´å®šä¹‰ -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
                        </marker>
                    </defs>
                </svg>
            </div>
            
            <div class="code-ref">
                <h4>ğŸ“ ä»£ç å®ç°ä¸æ­¥éª¤å¯¹åº”</h4>
                <pre>
<span class="code-comment"># æ­¥éª¤1: è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼ˆQueryä¸Keyçš„ç›¸ä¼¼åº¦ï¼‰</span>
scores = torch.matmul(Q, K.transpose(-2, -1))  <span class="code-comment"># [batch, heads, n, d_k] Ã— [batch, heads, d_k, n] = [batch, heads, n, n]</span>

<span class="code-comment"># æ­¥éª¤2: ç¼©æ”¾ï¼ˆé˜²æ­¢softmaxçš„æ¢¯åº¦æ¶ˆå¤±ï¼‰</span>
scores = scores / math.sqrt(d_k)  <span class="code-comment"># é™¤ä»¥âˆšd_kï¼Œä½¿æ–¹å·®ç¨³å®šåœ¨1é™„è¿‘</span>

<span class="code-comment"># æ­¥éª¤3: åº”ç”¨softmaxå¾—åˆ°æ³¨æ„åŠ›æƒé‡ï¼ˆæ¯è¡Œå½’ä¸€åŒ–ï¼‰</span>
attn_weights = F.softmax(scores, dim=-1)  <span class="code-comment"># [batch, heads, n, n]ï¼Œæ¯è¡Œå’Œä¸º1</span>

<span class="code-comment"># æ­¥éª¤4: ä½¿ç”¨æ³¨æ„åŠ›æƒé‡å¯¹Valueè¿›è¡ŒåŠ æƒæ±‚å’Œ</span>
output = torch.matmul(attn_weights, V)  <span class="code-comment"># [batch, heads, n, n] Ã— [batch, heads, n, d_v] = [batch, heads, n, d_v]</span>

<span class="code-comment"># å…³é”®ç‚¹è§£é‡Šï¼š</span>
<span class="code-comment"># - Qçš„æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªä½ç½®çš„æŸ¥è¯¢å‘é‡</span>
<span class="code-comment"># - Kçš„æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªä½ç½®çš„é”®å‘é‡</span>
<span class="code-comment"># - scores[i,j]è¡¨ç¤ºä½ç½®iå¯¹ä½ç½®jçš„æ³¨æ„åŠ›åˆ†æ•°</span>
<span class="code-comment"># - softmaxä½¿å¾—æ¯ä¸ªä½ç½®çš„æ³¨æ„åŠ›æƒé‡å’Œä¸º1</span>
<span class="code-comment"># - æœ€ç»ˆè¾“å‡ºæ˜¯Vçš„åŠ æƒç»„åˆï¼Œæƒé‡ç”±Qå’ŒKçš„ç›¸ä¼¼åº¦å†³å®š</span></pre>
            </div>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>âœ… ä¼˜åŠ¿</h4>
                    <p>å®Œæ•´çš„ä¸Šä¸‹æ–‡å»ºæ¨¡èƒ½åŠ›</p>
                </div>
                <div class="feature-card">
                    <h4>âš ï¸ åŠ£åŠ¿</h4>
                    <p>O(nÂ²)å¤æ‚åº¦ï¼Œé•¿åºåˆ—è®¡ç®—æ˜‚è´µ</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ’¡ åº”ç”¨</h4>
                    <p>GPT-3, BERT, æ ‡å‡†Transformer</p>
                </div>
            </div>
            
            <h3 style="margin-top: 40px;">ğŸ† ä¸»æµæ¨¡å‹é‡‡ç”¨æƒ…å†µ</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border-left: 4px solid #4caf50;">
                    <h4 style="color: #2e7d32; margin-bottom: 10px;">GPTç³»åˆ—</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>GPT-3: Full Attention</li>
                        <li>GPT-4: Flash Attention + Sparse</li>
                    </ul>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; border-left: 4px solid #2196f3;">
                    <h4 style="color: #1565c0; margin-bottom: 10px;">Llamaç³»åˆ—</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>Llama 1: Full Attention</li>
                        <li>Llama 2/3: GQA + RoPE</li>
                    </ul>
                </div>
                
                <div style="background: #fce4ec; padding: 15px; border-radius: 10px; border-left: 4px solid #e91e63;">
                    <h4 style="color: #880e4f; margin-bottom: 10px;">Googleç³»åˆ—</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>PaLM: MQA</li>
                        <li>Gemini: Flash + GQAæ··åˆ</li>
                    </ul>
                </div>
                
                <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; border-left: 4px solid #9c27b0;">
                    <h4 style="color: #6a1b9a; margin-bottom: 10px;">å…¶ä»–æ¨¡å‹</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>Mistral/Mixtral: GQA (4å¤´)</li>
                        <li>Falcon: MQA</li>
                        <li>Claude: Flash Attention</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 2. ç¨€ç–æ³¨æ„åŠ› -->
        <div class="attention-type" id="sparse-attention">
            <h2><span class="icon">2</span> ç¨€ç–æ³¨æ„åŠ› (Sparse Attention)</h2>
            
            <h3>ğŸ“ æ•°å­¦åŸç†</h3>
            <div class="math-section">
                <p><b>å±€éƒ¨çª—å£æ³¨æ„åŠ› (Local/Sliding Window):</b></p>
                <p>$\text{LocalAttn}(Q, K, V)_i = \text{softmax}\left(\frac{Q_i K_{[i-w:i+w]}^T}{\sqrt{d_k}}\right)V_{[i-w:i+w]}$</p>
                <p>å…¶ä¸­ $w$ æ˜¯çª—å£åŠå¾„ï¼Œæ¯ä¸ªä½ç½®åªå…³æ³¨é‚»è¿‘çš„ $2w+1$ ä¸ªä½ç½®</p>
                
                <p style="margin-top: 20px;"><b>å—ç¨€ç–æ³¨æ„åŠ› (Block Sparse):</b></p>
                <p>å°†åºåˆ—åˆ†æˆå¤§å°ä¸º $b$ çš„å—ï¼š</p>
                <p>$\text{BlockAttn}(Q^{(i)}, K^{(i)}, V^{(i)}) = \text{softmax}\left(\frac{Q^{(i)}(K^{(i)})^T}{\sqrt{d_k}}\right)V^{(i)}$</p>
            </div>
            
            <h3>ğŸ¨ å›¾å½¢åŒ–è§£é‡Š</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 500">
                    <!-- å±€éƒ¨æ³¨æ„åŠ›æ¨¡å¼ -->
                    <g transform="translate(100, 50)">
                        <text x="200" y="0" text-anchor="middle" font-weight="bold">å±€éƒ¨çª—å£æ³¨æ„åŠ›</text>
                        
                        <!-- æ³¨æ„åŠ›çŸ©é˜µå¯è§†åŒ– -->
                        <rect x="0" y="20" width="400" height="400" fill="none" stroke="#333" stroke-width="2"/>
                        
                        <!-- çª—å£æ¨¡å¼ï¼ˆå¯¹è§’çº¿ï¼‰ -->
                        <g opacity="0.7">
                            <!-- çª—å£å— -->
                            <rect x="0" y="20" width="100" height="100" fill="#667eea"/>
                            <rect x="50" y="70" width="100" height="100" fill="#667eea"/>
                            <rect x="100" y="120" width="100" height="100" fill="#667eea"/>
                            <rect x="150" y="170" width="100" height="100" fill="#667eea"/>
                            <rect x="200" y="220" width="100" height="100" fill="#667eea"/>
                            <rect x="250" y="270" width="100" height="100" fill="#667eea"/>
                            <rect x="300" y="320" width="100" height="100" fill="#667eea"/>
                        </g>
                        
                        <!-- ç»´åº¦æ ‡æ³¨ -->
                        <text x="-30" y="220" text-anchor="middle" font-size="12">ä½ç½®i</text>
                        <text x="200" y="450" text-anchor="middle" font-size="12">ä½ç½®j</text>
                        
                        <!-- ç¤ºä¾‹è¯´æ˜ -->
                        <g transform="translate(0, 460)">
                            <rect x="0" y="0" width="15" height="15" fill="#667eea" opacity="0.7"/>
                            <text x="25" y="12" font-size="12">æœ‰æ³¨æ„åŠ›è¿æ¥</text>
                            <rect x="150" y="0" width="15" height="15" fill="none" stroke="#333"/>
                            <text x="175" y="12" font-size="12">æ— æ³¨æ„åŠ›è¿æ¥</text>
                        </g>
                    </g>
                    
                    <!-- å—ç¨€ç–æ³¨æ„åŠ›æ¨¡å¼ -->
                    <g transform="translate(650, 50)">
                        <text x="200" y="0" text-anchor="middle" font-weight="bold">å—ç¨€ç–æ³¨æ„åŠ›</text>
                        
                        <!-- æ³¨æ„åŠ›çŸ©é˜µ -->
                        <rect x="0" y="20" width="400" height="400" fill="none" stroke="#333" stroke-width="2"/>
                        
                        <!-- å—æ¨¡å¼ -->
                        <g opacity="0.7">
                            <rect x="0" y="20" width="100" height="100" fill="#764ba2"/>
                            <rect x="100" y="120" width="100" height="100" fill="#764ba2"/>
                            <rect x="200" y="220" width="100" height="100" fill="#764ba2"/>
                            <rect x="300" y="320" width="100" height="100" fill="#764ba2"/>
                        </g>
                        
                        <!-- å—å¤§å°æ ‡æ³¨ -->
                        <path d="M 0 20 L 0 120" stroke="#333" stroke-width="1"/>
                        <text x="-30" y="75" text-anchor="middle" font-size="11">å—1</text>
                        <path d="M 100 120 L 100 220" stroke="#333" stroke-width="1"/>
                        <text x="70" y="175" text-anchor="middle" font-size="11">å—2</text>
                    </g>
                </svg>
            </div>
            
            <div class="code-ref">
                <h4>ğŸ“ ä»£ç å®ç°</h4>
                <pre>
<span class="code-comment"># å±€éƒ¨çª—å£æ³¨æ„åŠ›ï¼šæ¯ä¸ªä½ç½®åªå…³æ³¨çª—å£å†…çš„ä½ç½®</span>
def create_local_mask(seq_len, window_size):
    mask = torch.zeros(seq_len, seq_len)
    for i in range(seq_len):
        start = max(0, i - window_size // 2)
        end = min(seq_len, i + window_size // 2 + 1)
        mask[i, start:end] = 1  <span class="code-comment"># ä½ç½®iåªå…³æ³¨[start:end]èŒƒå›´</span>
    return mask

<span class="code-comment"># å—ç¨€ç–æ³¨æ„åŠ›ï¼šå°†åºåˆ—åˆ†å—ï¼Œå—å†…å…¨è¿æ¥</span>
Q = Q.view(batch, heads, n_blocks, block_size, d_k)  <span class="code-comment"># é‡å¡‘ä¸ºå—</span>
K = K.view(batch, heads, n_blocks, block_size, d_k)
scores = torch.matmul(Q, K.transpose(-2, -1))  <span class="code-comment"># å—å†…è®¡ç®—æ³¨æ„åŠ›</span>

<span class="code-comment"># å¤æ‚åº¦åˆ†æï¼š</span>
<span class="code-comment"># - å±€éƒ¨æ³¨æ„åŠ›: O(n Ã— window_size Ã— d) è€Œé O(nÂ² Ã— d)</span>
<span class="code-comment"># - å—ç¨€ç–: O(n Ã— block_size Ã— d) è€Œé O(nÂ² Ã— d)</span></pre>
            </div>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>âœ… ä¼˜åŠ¿</h4>
                    <p>çº¿æ€§å¤æ‚åº¦ï¼Œé•¿åºåˆ—é«˜æ•ˆ</p>
                </div>
                <div class="feature-card">
                    <h4>âš ï¸ åŠ£åŠ¿</h4>
                    <p>å¯èƒ½ä¸¢å¤±é•¿è·ç¦»ä¾èµ–</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ’¡ åº”ç”¨</h4>
                    <p>Longformer, BigBird, Sparse Transformer</p>
                </div>
            </div>
        </div>
        
        <!-- 3. çº¿æ€§æ³¨æ„åŠ› -->
        <div class="attention-type" id="linear-attention">
            <h2><span class="icon">3</span> çº¿æ€§æ³¨æ„åŠ› (Linear Attention)</h2>
            
            <h3>ğŸ“ æ•°å­¦åŸç†</h3>
            <div class="math-section">
                <p><b>æ ¸æŠ€å·§ (Kernel Trick):</b></p>
                <p>æ ‡å‡†æ³¨æ„åŠ›ï¼š$O = \text{softmax}(QK^T)V = \frac{\exp(QK^T)}{\text{rowsum}(\exp(QK^T))}V$</p>
                <p>çº¿æ€§æ³¨æ„åŠ›ï¼ˆæ”¹å˜è®¡ç®—é¡ºåºï¼‰ï¼š$O = \frac{\phi(Q)(\phi(K)^TV)}{\phi(Q)\text{sum}(\phi(K))}$</p>
                
                <div class="step-box">
                    <b>å…³é”®ä¼˜åŒ–ï¼šæ”¹å˜çŸ©é˜µä¹˜æ³•é¡ºåº</b>
                    <ul style="margin-left: 20px;">
                        <li>æ ‡å‡†æ–¹å¼ï¼š$(QK^T)V$ - å…ˆç®—$QK^T$å¾—åˆ°$nÃ—n$çŸ©é˜µï¼Œå¤æ‚åº¦$O(n^2d)$</li>
                        <li>çº¿æ€§æ–¹å¼ï¼š$Q(K^TV)$ - å…ˆç®—$K^TV$å¾—åˆ°$dÃ—d$çŸ©é˜µï¼Œå¤æ‚åº¦$O(nd^2)$</li>
                        <li>å½“$d \ll n$æ—¶ï¼Œæ˜¾è‘—é™ä½è®¡ç®—å¤æ‚åº¦</li>
                    </ul>
                </div>
            </div>
            
            <h3>ğŸ¨ å›¾å½¢åŒ–è§£é‡Š</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 600">
                    <!-- æ ‡å‡†æ³¨æ„åŠ›è®¡ç®—é¡ºåº -->
                    <g transform="translate(100, 50)">
                        <text x="200" y="0" text-anchor="middle" font-weight="bold" fill="#667eea">æ ‡å‡†æ³¨æ„åŠ› O(nÂ²d)</text>
                        
                        <!-- ç¬¬ä¸€æ­¥ï¼šQ Ã— K^T -->
                        <text x="50" y="40" font-size="12" fill="#666">ç¬¬1æ­¥:</text>
                        <rect x="0" y="50" width="60" height="100" fill="#667eea" opacity="0.7"/>
                        <text x="30" y="105" text-anchor="middle" class="matrix-label" fill="white">Q</text>
                        <text x="30" y="165" text-anchor="middle" font-size="11">[nÃ—d]</text>
                        
                        <text x="75" y="100" text-anchor="middle">Ã—</text>
                        
                        <rect x="90" y="70" width="100" height="60" fill="#764ba2" opacity="0.7"/>
                        <text x="140" y="105" text-anchor="middle" class="matrix-label" fill="white">K^T</text>
                        <text x="140" y="145" text-anchor="middle" font-size="11">[dÃ—n]</text>
                        
                        <text x="205" y="100" text-anchor="middle">=</text>
                        
                        <rect x="220" y="50" width="100" height="100" fill="#f093fb" opacity="0.7"/>
                        <text x="270" y="105" text-anchor="middle" class="matrix-label" fill="white">Attn</text>
                        <text x="270" y="165" text-anchor="middle" font-size="11">[nÃ—n]</text>
                        <text x="270" y="180" text-anchor="middle" font-size="11" fill="red">å¤§çŸ©é˜µ!</text>
                        
                        <!-- ç¬¬äºŒæ­¥ï¼šAttn Ã— V -->
                        <text x="50" y="220" font-size="12" fill="#666">ç¬¬2æ­¥:</text>
                        <rect x="0" y="230" width="100" height="100" fill="#f093fb" opacity="0.7"/>
                        <text x="50" y="285" text-anchor="middle" class="matrix-label" fill="white">Attn</text>
                        
                        <text x="115" y="280" text-anchor="middle">Ã—</text>
                        
                        <rect x="130" y="230" width="60" height="100" fill="#4facfe" opacity="0.7"/>
                        <text x="160" y="285" text-anchor="middle" class="matrix-label" fill="white">V</text>
                        <text x="160" y="345" text-anchor="middle" font-size="11">[nÃ—d]</text>
                        
                        <text x="205" y="280" text-anchor="middle">=</text>
                        
                        <rect x="220" y="230" width="60" height="100" fill="#00f2fe" opacity="0.7"/>
                        <text x="250" y="285" text-anchor="middle" class="matrix-label" fill="white">O</text>
                        <text x="250" y="345" text-anchor="middle" font-size="11">[nÃ—d]</text>
                        
                        <!-- å¤æ‚åº¦æ ‡æ³¨ -->
                        <rect x="0" y="380" width="320" height="40" fill="#ffe0e0" stroke="#ff0000" rx="5"/>
                        <text x="160" y="405" text-anchor="middle" font-size="12" fill="#ff0000">
                            æ€»å¤æ‚åº¦: O(nÂ²d) - éœ€è¦å­˜å‚¨nÃ—nçŸ©é˜µ
                        </text>
                    </g>
                    
                    <!-- çº¿æ€§æ³¨æ„åŠ›è®¡ç®—é¡ºåº -->
                    <g transform="translate(650, 50)">
                        <text x="200" y="0" text-anchor="middle" font-weight="bold" fill="#667eea">çº¿æ€§æ³¨æ„åŠ› O(ndÂ²)</text>
                        
                        <!-- ç¬¬ä¸€æ­¥ï¼šK^T Ã— V -->
                        <text x="50" y="40" font-size="12" fill="#666">ç¬¬1æ­¥:</text>
                        <rect x="0" y="70" width="100" height="60" fill="#764ba2" opacity="0.7"/>
                        <text x="50" y="105" text-anchor="middle" class="matrix-label" fill="white">K^T</text>
                        <text x="50" y="145" text-anchor="middle" font-size="11">[dÃ—n]</text>
                        
                        <text x="115" y="100" text-anchor="middle">Ã—</text>
                        
                        <rect x="130" y="50" width="60" height="100" fill="#4facfe" opacity="0.7"/>
                        <text x="160" y="105" text-anchor="middle" class="matrix-label" fill="white">V</text>
                        <text x="160" y="165" text-anchor="middle" font-size="11">[nÃ—d]</text>
                        
                        <text x="205" y="100" text-anchor="middle">=</text>
                        
                        <rect x="220" y="70" width="60" height="60" fill="#ffc107" opacity="0.7"/>
                        <text x="250" y="105" text-anchor="middle" class="matrix-label">KV</text>
                        <text x="250" y="145" text-anchor="middle" font-size="11">[dÃ—d]</text>
                        <text x="250" y="160" text-anchor="middle" font-size="11" fill="green">å°çŸ©é˜µ!</text>
                        
                        <!-- ç¬¬äºŒæ­¥ï¼šQ Ã— KV -->
                        <text x="50" y="220" font-size="12" fill="#666">ç¬¬2æ­¥:</text>
                        <rect x="0" y="230" width="60" height="100" fill="#667eea" opacity="0.7"/>
                        <text x="30" y="285" text-anchor="middle" class="matrix-label" fill="white">Q</text>
                        <text x="30" y="345" text-anchor="middle" font-size="11">[nÃ—d]</text>
                        
                        <text x="75" y="280" text-anchor="middle">Ã—</text>
                        
                        <rect x="90" y="250" width="60" height="60" fill="#ffc107" opacity="0.7"/>
                        <text x="120" y="285" text-anchor="middle" class="matrix-label">KV</text>
                        <text x="120" y="325" text-anchor="middle" font-size="11">[dÃ—d]</text>
                        
                        <text x="165" y="280" text-anchor="middle">=</text>
                        
                        <rect x="180" y="230" width="60" height="100" fill="#00f2fe" opacity="0.7"/>
                        <text x="210" y="285" text-anchor="middle" class="matrix-label" fill="white">O</text>
                        <text x="210" y="345" text-anchor="middle" font-size="11">[nÃ—d]</text>
                        
                        <!-- å¤æ‚åº¦æ ‡æ³¨ -->
                        <rect x="0" y="380" width="280" height="40" fill="#e0ffe0" stroke="#00cc00" rx="5"/>
                        <text x="140" y="405" text-anchor="middle" font-size="12" fill="#00cc00">
                            æ€»å¤æ‚åº¦: O(ndÂ²) - åªéœ€dÃ—dçŸ©é˜µ
                        </text>
                    </g>
                    
                    <!-- å¯¹æ¯”è¯´æ˜ -->
                    <g transform="translate(200, 480)">
                        <rect x="0" y="0" width="800" height="80" fill="#f8f9fa" stroke="#667eea" stroke-width="2" rx="10"/>
                        <text x="400" y="25" text-anchor="middle" font-weight="bold" fill="#667eea">æ•ˆç‡å¯¹æ¯”ï¼ˆå‡è®¾n=2048, d=64ï¼‰</text>
                        <text x="200" y="50" font-size="12">æ ‡å‡†æ³¨æ„åŠ›: 2048Â² Ã— 64 = 268M æ“ä½œ</text>
                        <text x="200" y="70" font-size="12">çº¿æ€§æ³¨æ„åŠ›: 2048 Ã— 64Â² = 8.4M æ“ä½œ</text>
                        <text x="600" y="60" font-size="14" fill="#00cc00" font-weight="bold">é€Ÿåº¦æå‡ 32å€ï¼</text>
                    </g>
                </svg>
            </div>
            
            <div class="code-ref">
                <h4>ğŸ“ ä»£ç å®ç°</h4>
                <pre>
<span class="code-comment"># çº¿æ€§æ³¨æ„åŠ›æ ¸å¿ƒï¼šæ”¹å˜è®¡ç®—é¡ºåº</span>

<span class="code-comment"># æ ‡å‡†æ³¨æ„åŠ›ï¼ˆä½æ•ˆï¼‰</span>
attn = torch.matmul(Q, K.transpose(-2, -1))  <span class="code-comment"># [n, d] Ã— [d, n] = [n, n] å¤§çŸ©é˜µï¼</span>
output = torch.matmul(attn, V)               <span class="code-comment"># [n, n] Ã— [n, d] = [n, d]</span>

<span class="code-comment"># çº¿æ€§æ³¨æ„åŠ›ï¼ˆé«˜æ•ˆï¼‰</span>
<span class="code-comment"># æ­¥éª¤1: å…ˆè®¡ç®—K^T Vï¼Œå¾—åˆ°å°çŸ©é˜µ</span>
KV = torch.matmul(K.transpose(-2, -1), V)    <span class="code-comment"># [d, n] Ã— [n, d] = [d, d] å°çŸ©é˜µï¼</span>

<span class="code-comment"># æ­¥éª¤2: è®¡ç®—å½’ä¸€åŒ–å› å­</span>
Z = 1 / (torch.einsum('nd,d->n', Q, K.sum(dim=0)) + eps)  <span class="code-comment"># [n]</span>

<span class="code-comment"># æ­¥éª¤3: Qä¸KVç›¸ä¹˜å¹¶å½’ä¸€åŒ–</span>
output = torch.matmul(Q, KV) * Z.unsqueeze(-1)  <span class="code-comment"># [n, d] Ã— [d, d] = [n, d]</span>

<span class="code-comment"># å…³é”®ç‚¹ï¼š</span>
<span class="code-comment"># - é¿å…äº†nÃ—nçš„æ³¨æ„åŠ›çŸ©é˜µ</span>
<span class="code-comment"># - å½“d << næ—¶ï¼Œæ•ˆç‡æå‡å·¨å¤§</span>
<span class="code-comment"># - éœ€è¦ç‰¹å¾æ˜ å°„Ï†æ¥ä¿è¯éè´Ÿæ€§</span></pre>
            </div>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>âœ… ä¼˜åŠ¿</h4>
                    <p>O(n)å¤æ‚åº¦ï¼Œé€‚åˆè¶…é•¿åºåˆ—(>32K)</p>
                </div>
                <div class="feature-card">
                    <h4>âš ï¸ åŠ£åŠ¿</h4>
                    <p>å¯èƒ½æŸå¤±è¡¨è¾¾èƒ½åŠ›ï¼Œç²¾åº¦ç•¥ä½</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ’¡ åº”ç”¨</h4>
                    <p>Performer, Linformer, Linear Transformer, NystrÃ¶m</p>
                </div>
            </div>
        </div>
        
        <!-- 4. GQA -->
        <div class="attention-type" id="gqa">
            <h2><span class="icon">4</span> åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› (GQA)</h2>
            
            <h3>ğŸ“ æ•°å­¦åŸç†</h3>
            <div class="math-section">
                <p><b>æ ¸å¿ƒæ€æƒ³ï¼š</b>å°†æŸ¥è¯¢å¤´åˆ†æˆGç»„ï¼Œæ¯ç»„å…±äº«é”®å€¼å¯¹</p>
                <p>$$\text{GQA}(Q^{(g)}, K^{(g/G)}, V^{(g/G)}) = \text{softmax}\left(\frac{Q^{(g)}(K^{(g/G)})^T}{\sqrt{d_k}}\right)V^{(g/G)}$$</p>
                
                <div class="step-box">
                    <b>å†…å­˜èŠ‚çœè®¡ç®—ï¼š</b>
                    <ul style="margin-left: 20px;">
                        <li>MHA KVç¼“å­˜: $2 Ã— n_{heads} Ã— seq\_len Ã— d_k$</li>
                        <li>GQA KVç¼“å­˜: $2 Ã— n_{kv\_heads} Ã— seq\_len Ã— d_k$</li>
                        <li>èŠ‚çœæ¯”ä¾‹: $1 - \frac{n_{kv\_heads}}{n_{heads}}$</li>
                    </ul>
                </div>
            </div>
            
            <h3>ğŸ¨ å›¾å½¢åŒ–è§£é‡Š</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 400">
                    <text x="600" y="30" text-anchor="middle" font-weight="bold" font-size="16">GQA: 8ä¸ªQå¤´ï¼Œ2ä¸ªKVå¤´ï¼ˆ4:1åˆ†ç»„ï¼‰</text>
                    
                    <!-- Query heads -->
                    <g transform="translate(100, 80)">
                        <text x="100" y="-10" text-anchor="middle" font-weight="bold">Query Heads (8ä¸ª)</text>
                        
                        <!-- ç¬¬ä¸€ç»„Qå¤´ -->
                        <g fill="#667eea" opacity="0.8">
                            <rect x="0" y="0" width="40" height="50" stroke="#333"/>
                            <text x="20" y="30" text-anchor="middle" font-size="12" fill="white">Qâ‚</text>
                            <rect x="45" y="0" width="40" height="50" stroke="#333"/>
                            <text x="65" y="30" text-anchor="middle" font-size="12" fill="white">Qâ‚‚</text>
                            <rect x="90" y="0" width="40" height="50" stroke="#333"/>
                            <text x="110" y="30" text-anchor="middle" font-size="12" fill="white">Qâ‚ƒ</text>
                            <rect x="135" y="0" width="40" height="50" stroke="#333"/>
                            <text x="155" y="30" text-anchor="middle" font-size="12" fill="white">Qâ‚„</text>
                        </g>
                        
                        <!-- ç¬¬äºŒç»„Qå¤´ -->
                        <g fill="#667eea" opacity="0.6">
                            <rect x="0" y="60" width="40" height="50" stroke="#333"/>
                            <text x="20" y="90" text-anchor="middle" font-size="12" fill="white">Qâ‚…</text>
                            <rect x="45" y="60" width="40" height="50" stroke="#333"/>
                            <text x="65" y="90" text-anchor="middle" font-size="12" fill="white">Qâ‚†</text>
                            <rect x="90" y="60" width="40" height="50" stroke="#333"/>
                            <text x="110" y="90" text-anchor="middle" font-size="12" fill="white">Qâ‚‡</text>
                            <rect x="135" y="60" width="40" height="50" stroke="#333"/>
                            <text x="155" y="90" text-anchor="middle" font-size="12" fill="white">Qâ‚ˆ</text>
                        </g>
                    </g>
                    
                    <!-- è¿æ¥çº¿ -->
                    <g stroke="#333" stroke-width="1.5" fill="none">
                        <!-- ç¬¬ä¸€ç»„è¿æ¥ -->
                        <path d="M 275 105 Q 400 105, 500 130" stroke="#667eea"/>
                        <path d="M 275 105 Q 400 110, 500 130" stroke="#667eea"/>
                        <path d="M 275 105 Q 400 115, 500 130" stroke="#667eea"/>
                        <path d="M 275 105 Q 400 120, 500 130" stroke="#667eea"/>
                        
                        <!-- ç¬¬äºŒç»„è¿æ¥ -->
                        <path d="M 275 165 Q 400 165, 500 210" stroke="#667eea" opacity="0.6"/>
                        <path d="M 275 165 Q 400 170, 500 210" stroke="#667eea" opacity="0.6"/>
                        <path d="M 275 165 Q 400 175, 500 210" stroke="#667eea" opacity="0.6"/>
                        <path d="M 275 165 Q 400 180, 500 210" stroke="#667eea" opacity="0.6"/>
                    </g>
                    
                    <!-- KV heads -->
                    <g transform="translate(500, 100)">
                        <text x="50" y="-10" text-anchor="middle" font-weight="bold">KV Pairs (2ä¸ª)</text>
                        <rect x="0" y="10" width="100" height="60" fill="#764ba2" opacity="0.8" stroke="#333"/>
                        <text x="50" y="45" text-anchor="middle" font-size="14" fill="white">Kâ‚,Vâ‚</text>
                        
                        <rect x="0" y="90" width="100" height="60" fill="#764ba2" opacity="0.6" stroke="#333"/>
                        <text x="50" y="125" text-anchor="middle" font-size="14" fill="white">Kâ‚‚,Vâ‚‚</text>
                    </g>
                    
                    <!-- å†…å­˜å¯¹æ¯” -->
                    <g transform="translate(700, 100)">
                        <text x="200" y="-10" text-anchor="middle" font-weight="bold">KVç¼“å­˜å†…å­˜å¯¹æ¯”</text>
                        
                        <!-- MHA -->
                        <rect x="0" y="10" width="400" height="30" fill="#e0e0e0" stroke="#333"/>
                        <rect x="0" y="10" width="400" height="30" fill="#667eea" opacity="0.5"/>
                        <text x="200" y="30" text-anchor="middle" font-size="12">MHA: 8ä¸ªKVå¤´ (100%)</text>
                        
                        <!-- GQA -->
                        <rect x="0" y="60" width="400" height="30" fill="#e0e0e0" stroke="#333"/>
                        <rect x="0" y="60" width="100" height="30" fill="#764ba2" opacity="0.8"/>
                        <text x="200" y="80" text-anchor="middle" font-size="12">GQA: 2ä¸ªKVå¤´ (25%)</text>
                        
                        <text x="200" y="120" text-anchor="middle" font-size="14" fill="green" font-weight="bold">
                            èŠ‚çœ75%å†…å­˜ï¼
                        </text>
                        
                        <!-- è®¡ç®—ç¤ºä¾‹ -->
                        <rect x="0" y="150" width="400" height="100" fill="#f8f9fa" stroke="#667eea" rx="5"/>
                        <text x="10" y="170" font-size="11">ç¤ºä¾‹ï¼ˆseq_len=2048, d_k=64ï¼‰ï¼š</text>
                        <text x="10" y="190" font-size="11">MHA: 2 Ã— 8 Ã— 2048 Ã— 64 Ã— 4B = 8MB</text>
                        <text x="10" y="210" font-size="11">GQA: 2 Ã— 2 Ã— 2048 Ã— 64 Ã— 4B = 2MB</text>
                        <text x="10" y="230" font-size="11" fill="green">æ¯å±‚èŠ‚çœ6MBï¼Œ12å±‚æ¨¡å‹èŠ‚çœ72MBï¼</text>
                    </g>
                </svg>
            </div>
            
            <div class="code-ref">
                <h4>ğŸ“ ä»£ç å®ç°</h4>
                <pre>
<span class="code-comment"># GQAæ ¸å¿ƒå®ç°</span>
class GroupedQueryAttention(nn.Module):
    def __init__(self, d_model, n_heads=8, n_kv_heads=2):
        <span class="code-comment"># n_heads: Queryå¤´æ•°é‡ï¼ˆå¦‚8ï¼‰</span>
        <span class="code-comment"># n_kv_heads: KVå¤´æ•°é‡ï¼ˆå¦‚2ï¼‰</span>
        <span class="code-comment"># n_groups: æ¯ä¸ªKVå¤´æœåŠ¡çš„Qå¤´æ•°ï¼ˆ8/2=4ï¼‰</span>
        self.n_groups = n_heads // n_kv_heads
        
        <span class="code-comment"># Qä½¿ç”¨å…¨éƒ¨ç»´åº¦ï¼ŒKVä½¿ç”¨æ›´å°‘ç»´åº¦</span>
        self.W_q = nn.Linear(d_model, d_model)              <span class="code-comment"># 8ä¸ªå¤´</span>
        self.W_k = nn.Linear(d_model, n_kv_heads * d_k)     <span class="code-comment"># 2ä¸ªå¤´</span>
        self.W_v = nn.Linear(d_model, n_kv_heads * d_k)     <span class="code-comment"># 2ä¸ªå¤´</span>
    
    def forward(self, x):
        <span class="code-comment"># è®¡ç®—Q, K, V</span>
        Q = self.W_q(x).view(batch, seq, n_heads, d_k)      <span class="code-comment"># [B, N, 8, d]</span>
        K = self.W_k(x).view(batch, seq, n_kv_heads, d_k)   <span class="code-comment"># [B, N, 2, d]</span>
        V = self.W_v(x).view(batch, seq, n_kv_heads, d_k)   <span class="code-comment"># [B, N, 2, d]</span>
        
        <span class="code-comment"># å…³é”®æ­¥éª¤ï¼šé‡å¤KVä»¥åŒ¹é…Qçš„å¤´æ•°</span>
        K = K.repeat_interleave(self.n_groups, dim=2)       <span class="code-comment"># [B, N, 8, d]</span>
        V = V.repeat_interleave(self.n_groups, dim=2)       <span class="code-comment"># [B, N, 8, d]</span>
        
        <span class="code-comment"># æ ‡å‡†æ³¨æ„åŠ›è®¡ç®—</span>
        attn = torch.matmul(Q, K.transpose(-2, -1)) / sqrt(d_k)
        attn = F.softmax(attn, dim=-1)
        output = torch.matmul(attn, V)</pre>
            </div>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>âœ… ä¼˜åŠ¿</h4>
                    <p>å‡å°‘KVç¼“å­˜50-75%ï¼Œä¿æŒæ¨¡å‹è´¨é‡</p>
                </div>
                <div class="feature-card">
                    <h4>âš ï¸ åŠ£åŠ¿</h4>
                    <p>éœ€è¦è°ƒæ•´KVå¤´æ•°é‡çš„è¶…å‚æ•°</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ’¡ åº”ç”¨</h4>
                    <p>Llama 2, Llama 3, Mistral, Mixtral</p>
                </div>
            </div>
        </div>
        
        <!-- 5. MQA -->
        <div class="attention-type" id="mqa">
            <h2><span class="icon">5</span> å¤šæŸ¥è¯¢æ³¨æ„åŠ› (MQA)</h2>
            
            <h3>ğŸ“ æ•°å­¦åŸç†</h3>
            <div class="math-section">
                <p><b>æ ¸å¿ƒæ€æƒ³ï¼š</b>æ‰€æœ‰æŸ¥è¯¢å¤´å…±äº«å•ä¸€çš„é”®å€¼å¯¹</p>
                <p>$$\text{MQA}(Q^{(h)}, K, V) = \text{softmax}\left(\frac{Q^{(h)}K^T}{\sqrt{d_k}}\right)V$$</p>
                <p>KVç¼“å­˜ä» $O(n \cdot h \cdot d)$ é™åˆ° $O(n \cdot d)$</p>
            </div>
            
            <h3>ğŸ¨ å›¾å½¢åŒ–è§£é‡Š</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 350">
                    <text x="600" y="30" text-anchor="middle" font-weight="bold" font-size="16">MQA: æ‰€æœ‰æŸ¥è¯¢å¤´å…±äº«å•ä¸ªKVå¯¹</text>
                    
                    <!-- Query heads -->
                    <g transform="translate(150, 100)">
                        <text x="100" y="-10" text-anchor="middle" font-weight="bold">8ä¸ªQuery Heads</text>
                        <rect x="0" y="0" width="200" height="40" fill="#667eea" opacity="0.8" stroke="#333"/>
                        <text x="100" y="25" text-anchor="middle" fill="white">Qâ‚ Qâ‚‚ Qâ‚ƒ Qâ‚„ Qâ‚… Qâ‚† Qâ‚‡ Qâ‚ˆ</text>
                        
                        <!-- è¡¨ç¤º8ä¸ªç‹¬ç«‹çš„å¤´ -->
                        <g transform="translate(0, 50)">
                            <circle cx="25" cy="10" r="5" fill="#667eea"/>
                            <circle cx="50" cy="10" r="5" fill="#667eea"/>
                            <circle cx="75" cy="10" r="5" fill="#667eea"/>
                            <circle cx="100" cy="10" r="5" fill="#667eea"/>
                            <circle cx="125" cy="10" r="5" fill="#667eea"/>
                            <circle cx="150" cy="10" r="5" fill="#667eea"/>
                            <circle cx="175" cy="10" r="5" fill="#667eea"/>
                            <circle cx="200" cy="10" r="5" fill="#667eea"/>
                        </g>
                    </g>
                    
                    <!-- è¿æ¥çº¿ï¼ˆæ‰€æœ‰Qå¤´è¿åˆ°åŒä¸€ä¸ªKVï¼‰ -->
                    <g stroke="#333" stroke-width="1.5" fill="none">
                        <path d="M 350 120 Q 450 120, 550 150"/>
                        <path d="M 350 125 Q 450 130, 550 150"/>
                        <path d="M 350 130 Q 450 140, 550 150"/>
                        <path d="M 350 135 Q 450 150, 550 150"/>
                    </g>
                    
                    <!-- Single KV -->
                    <g transform="translate(550, 120)">
                        <text x="60" y="-10" text-anchor="middle" font-weight="bold">å•ä¸ªKVå¯¹</text>
                        <rect x="0" y="10" width="120" height="60" fill="#764ba2" opacity="0.8" stroke="#333" stroke-width="2"/>
                        <text x="60" y="45" text-anchor="middle" font-size="16" fill="white">K, V</text>
                        <text x="60" y="85" text-anchor="middle" font-size="11">å…±äº«ç»™æ‰€æœ‰Qå¤´</text>
                    </g>
                    
                    <!-- å†…å­˜èŠ‚çœå¯è§†åŒ– -->
                    <g transform="translate(750, 100)">
                        <text x="150" y="-10" text-anchor="middle" font-weight="bold">KVç¼“å­˜å¯¹æ¯”</text>
                        
                        <!-- MHA -->
                        <rect x="0" y="10" width="300" height="30" fill="#667eea" opacity="0.5" stroke="#333"/>
                        <text x="310" y="30" font-size="12">MHA: 8Ã—nÃ—d</text>
                        
                        <!-- MQA -->
                        <rect x="0" y="60" width="37.5" height="30" fill="#764ba2" opacity="0.8" stroke="#333"/>
                        <text x="310" y="80" font-size="12">MQA: 1Ã—nÃ—d</text>
                        
                        <text x="150" y="120" text-anchor="middle" font-size="14" fill="green" font-weight="bold">
                            èŠ‚çœ87.5%å†…å­˜ï¼
                        </text>
                        
                        <!-- æé™ä¼˜åŒ–è¯´æ˜ -->
                        <rect x="0" y="150" width="300" height="80" fill="#fff3cd" stroke="#ffc107" rx="5"/>
                        <text x="10" y="170" font-size="11">ğŸ’¡ æé™å†…å­˜ä¼˜åŒ–ï¼š</text>
                        <text x="10" y="190" font-size="11">â€¢ æ¨ç†æ—¶KVç¼“å­˜æœ€å°åŒ–</text>
                        <text x="10" y="210" font-size="11">â€¢ é€‚åˆè¾¹ç¼˜è®¾å¤‡éƒ¨ç½²</text>
                    </g>
                </svg>
            </div>
            
            <div class="code-ref">
                <h4>ğŸ“ ä»£ç å®ç°</h4>
                <pre>
<span class="code-comment"># MQAæ ¸å¿ƒå®ç°</span>
class MultiQueryAttention(nn.Module):
    def __init__(self, d_model, n_heads=8):
        <span class="code-comment"># Qæœ‰å¤šä¸ªå¤´ï¼ŒKå’ŒVåªæœ‰å•å¤´</span>
        self.W_q = nn.Linear(d_model, d_model)     <span class="code-comment"># è¾“å‡º8ä¸ªå¤´çš„Q</span>
        self.W_k = nn.Linear(d_model, d_k)         <span class="code-comment"># è¾“å‡º1ä¸ªå¤´çš„K</span>
        self.W_v = nn.Linear(d_model, d_k)         <span class="code-comment"># è¾“å‡º1ä¸ªå¤´çš„V</span>
    
    def forward(self, x):
        <span class="code-comment"># è®¡ç®—Qï¼ˆå¤šå¤´ï¼‰å’ŒKVï¼ˆå•å¤´ï¼‰</span>
        Q = self.W_q(x).view(batch, seq, n_heads, d_k)  <span class="code-comment"># [B, N, 8, d]</span>
        K = self.W_k(x).view(batch, seq, 1, d_k)        <span class="code-comment"># [B, N, 1, d]</span>
        V = self.W_v(x).view(batch, seq, 1, d_k)        <span class="code-comment"># [B, N, 1, d]</span>
        
        <span class="code-comment"># å…³é”®ï¼šæ‰©å±•KVåˆ°æ‰€æœ‰å¤´ï¼ˆå¹¿æ’­ï¼‰</span>
        K = K.expand(-1, -1, n_heads, -1)               <span class="code-comment"># [B, N, 8, d]</span>
        V = V.expand(-1, -1, n_heads, -1)               <span class="code-comment"># [B, N, 8, d]</span>
        
        <span class="code-comment"># æ ‡å‡†æ³¨æ„åŠ›è®¡ç®—</span>
        attn = torch.matmul(Q, K.transpose(-2, -1)) / sqrt(d_k)
        
<span class="code-comment"># å†…å­˜åˆ†æï¼ˆseq_len=2048, d=64, 8å¤´ï¼‰ï¼š</span>
<span class="code-comment"># MHA KVç¼“å­˜: 2 Ã— 8 Ã— 2048 Ã— 64 Ã— 4B = 8MB</span>
<span class="code-comment"># MQA KVç¼“å­˜: 2 Ã— 1 Ã— 2048 Ã— 64 Ã— 4B = 1MB</span>
<span class="code-comment"># èŠ‚çœ: 87.5%ï¼</span></pre>
            </div>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>âœ… ä¼˜åŠ¿</h4>
                    <p>æœ€å°KVç¼“å­˜(èŠ‚çœ87.5%)ï¼Œæ¨ç†æœ€å¿«</p>
                </div>
                <div class="feature-card">
                    <h4>âš ï¸ åŠ£åŠ¿</h4>
                    <p>å¯èƒ½é™ä½æ¨¡å‹æ€§èƒ½ï¼Œè®­ç»ƒä¸ç¨³å®š</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ’¡ åº”ç”¨</h4>
                    <p>PaLM, Falcon, StarCoder, SantaCoder</p>
                </div>
            </div>
        </div>
        
        <!-- 6. Flash Attention -->
        <div class="attention-type" id="flash-attention">
            <h2><span class="icon">6</span> Flash Attention</h2>
            
            <h3>ğŸ“ æ•°å­¦åŸç†</h3>
            <div class="math-section">
                <p><b>åœ¨çº¿Softmax (Online Softmax)ï¼š</b></p>
                <p>æ•°å€¼ç¨³å®šçš„å¢é‡è®¡ç®—ï¼š</p>
                <p>$$m^{new} = \max(m^{old}, \text{rowmax}(S))$$</p>
                <p>$$l^{new} = e^{m^{old}-m^{new}}l^{old} + \text{rowsum}(e^{S-m^{new}})$$</p>
                <p>$$O^{new} = \frac{e^{m^{old}-m^{new}}l^{old}O^{old} + e^{S-m^{new}}V}{l^{new}}$$</p>
                
                <div class="step-box">
                    <b>åˆ†å—ç­–ç•¥ï¼š</b>
                    <ul style="margin-left: 20px;">
                        <li>å°†Qåˆ†æˆå¤§å°ä¸ºB_rçš„å—</li>
                        <li>å°†K,Våˆ†æˆå¤§å°ä¸ºB_cçš„å—</li>
                        <li>é€å—åœ¨SRAMä¸­è®¡ç®—ï¼Œå‡å°‘HBMè®¿é—®</li>
                    </ul>
                </div>
            </div>
            
            <h3>ğŸ¨ å›¾å½¢åŒ–è§£é‡Š</h3>
            <div class="visualization">
                <svg viewBox="0 0 1200 500">
                    <text x="600" y="30" text-anchor="middle" font-weight="bold" font-size="16">Flash Attention: åˆ†å—è®¡ç®—ä¸å†…å­˜ä¼˜åŒ–</text>
                    
                    <!-- å†…å­˜å±‚æ¬¡ -->
                    <g transform="translate(100, 80)">
                        <text x="150" y="-10" text-anchor="middle" font-weight="bold">GPUå†…å­˜å±‚æ¬¡</text>
                        
                        <!-- SRAM (å¿«é€Ÿå°å†…å­˜) -->
                        <rect x="0" y="0" width="300" height="50" fill="#00f2fe" opacity="0.7" stroke="#333"/>
                        <text x="150" y="30" text-anchor="middle">SRAM (20KB, 19TB/s)</text>
                        
                        <!-- HBM (æ…¢é€Ÿå¤§å†…å­˜) -->
                        <rect x="0" y="80" width="300" height="100" fill="#667eea" opacity="0.5" stroke="#333"/>
                        <text x="150" y="135" text-anchor="middle">HBM (40GB, 1.5TB/s)</text>
                        
                        <!-- æ•°æ®ç§»åŠ¨ç®­å¤´ -->
                        <g stroke-width="2" marker-end="url(#arrowhead)">
                            <path d="M 100 50 L 100 80" stroke="#ff0000"/>
                            <text x="120" y="65" font-size="11" fill="#ff0000">å†™å›</text>
                            <path d="M 200 80 L 200 50" stroke="#00cc00"/>
                            <text x="220" y="65" font-size="11" fill="#00cc00">åŠ è½½</text>
                        </g>
                        
                        <!-- ç“¶é¢ˆè¯´æ˜ -->
                        <rect x="0" y="200" width="300" height="60" fill="#ffe0e0" stroke="#ff0000" rx="5"/>
                        <text x="10" y="220" font-size="11">âŒ æ ‡å‡†æ³¨æ„åŠ›é—®é¢˜ï¼š</text>
                        <text x="10" y="240" font-size="11">nÃ—nçŸ©é˜µå¤ªå¤§ï¼Œæ— æ³•æ”¾å…¥SRAM</text>
                    </g>
                    
                    <!-- åˆ†å—è®¡ç®—å¯è§†åŒ– -->
                    <g transform="translate(500, 80)">
                        <text x="300" y="-10" text-anchor="middle" font-weight="bold">åˆ†å—è®¡ç®—ç­–ç•¥</text>
                        
                        <!-- Qçš„åˆ†å— -->
                        <g>
                            <text x="30" y="20" font-size="12">Qå—</text>
                            <rect x="0" y="30" width="60" height="200" fill="#667eea" opacity="0.3" stroke="#333"/>
                            <!-- å½“å‰å¤„ç†çš„å— -->
                            <rect x="0" y="30" width="60" height="50" fill="#667eea" opacity="0.8" stroke="#333" stroke-width="2"/>
                            <text x="30" y="60" text-anchor="middle" font-size="11" fill="white">Qâ‚</text>
                            <rect x="0" y="80" width="60" height="50" fill="#667eea" opacity="0.4" stroke="#333"/>
                            <rect x="0" y="130" width="60" height="50" fill="#667eea" opacity="0.4" stroke="#333"/>
                            <rect x="0" y="180" width="60" height="50" fill="#667eea" opacity="0.4" stroke="#333"/>
                        </g>
                        
                        <!-- K,Vçš„åˆ†å— -->
                        <g transform="translate(100, 0)">
                            <text x="100" y="20" font-size="12">K,Vå—</text>
                            <rect x="0" y="30" width="200" height="60" fill="#764ba2" opacity="0.3" stroke="#333"/>
                            <!-- å½“å‰å¤„ç†çš„å— -->
                            <rect x="0" y="30" width="50" height="60" fill="#764ba2" opacity="0.8" stroke="#333" stroke-width="2"/>
                            <text x="25" y="65" text-anchor="middle" font-size="11" fill="white">Kâ‚Vâ‚</text>
                            <rect x="50" y="30" width="50" height="60" fill="#764ba2" opacity="0.4" stroke="#333"/>
                            <rect x="100" y="30" width="50" height="60" fill="#764ba2" opacity="0.4" stroke="#333"/>
                            <rect x="150" y="30" width="50" height="60" fill="#764ba2" opacity="0.4" stroke="#333"/>
                        </g>
                        
                        <!-- è¾“å‡ºå— -->
                        <g transform="translate(350, 0)">
                            <text x="30" y="20" font-size="12">è¾“å‡º</text>
                            <rect x="0" y="30" width="60" height="50" fill="#00f2fe" opacity="0.8" stroke="#333" stroke-width="2"/>
                            <text x="30" y="60" text-anchor="middle" font-size="11">Oâ‚</text>
                        </g>
                        
                        <!-- è®¡ç®—æµç¨‹ç®­å¤´ -->
                        <g stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)">
                            <path d="M 65 55 L 95 55"/>
                            <path d="M 300 60 L 345 55"/>
                        </g>
                        
                        <!-- SRAMæ ‡æ³¨ -->
                        <rect x="0" y="250" width="400" height="40" fill="#e0ffe0" stroke="#00cc00" rx="5"/>
                        <text x="200" y="275" text-anchor="middle" font-size="12" fill="#00cc00">
                            âœ“ å½“å‰å—å®Œå…¨åœ¨SRAMä¸­è®¡ç®—
                        </text>
                    </g>
                    
                    <!-- ç®—æ³•æµç¨‹ -->
                    <g transform="translate(100, 380)">
                        <rect x="0" y="0" width="1000" height="100" fill="#f8f9fa" stroke="#667eea" stroke-width="2" rx="10"/>
                        <text x="500" y="25" text-anchor="middle" font-weight="bold" fill="#667eea">Flash Attentionç®—æ³•æµç¨‹</text>
                        
                        <text x="20" y="50" font-size="12">for i in range(0, N, Br):  <span class="code-comment" fill="#008000"># éå†Qå—</span></text>
                        <text x="40" y="70" font-size="12">for j in range(0, N, Bc):  <span class="code-comment" fill="#008000"># éå†KVå—</span></text>
                        <text x="60" y="90" font-size="12">åœ¨SRAMä¸­è®¡ç®— Q[i]Ã—K[j]^TÃ—V[j]ï¼Œå¢é‡æ›´æ–°O[i]</text>
                    </g>
                </svg>
            </div>
            
            <div class="code-ref">
                <h4>ğŸ“ ä»£ç å®ç°</h4>
                <pre>
<span class="code-comment"># Flash Attentionæ ¸å¿ƒå¾ªç¯</span>
def flash_attention_forward(Q, K, V):
    <span class="code-comment"># Q: [batch, heads, N, d]</span>
    <span class="code-comment"># åˆ†å—å¤§å°ï¼ˆé€‚é…SRAMå¤§å°ï¼‰</span>
    Br = 64  <span class="code-comment"># Qå—å¤§å°</span>
    Bc = 64  <span class="code-comment"># KVå—å¤§å°</span>
    
    N = Q.shape[2]
    O = torch.zeros_like(Q)  <span class="code-comment"># è¾“å‡º</span>
    L = torch.zeros(batch, heads, N)  <span class="code-comment"># å½’ä¸€åŒ–å› å­</span>
    
    <span class="code-comment"># å¤–å¾ªç¯ï¼šéå†Qçš„å—</span>
    for i in range(0, N, Br):
        Qi = Q[:, :, i:i+Br, :]  <span class="code-comment"># åŠ è½½Qå—åˆ°SRAM</span>
        Oi = torch.zeros_like(Qi)
        Li = torch.zeros(batch, heads, Br) - float('inf')
        Mi = torch.full_like(Li, -float('inf'))  <span class="code-comment"># æœ€å¤§å€¼</span>
        
        <span class="code-comment"># å†…å¾ªç¯ï¼šéå†KVçš„å—</span>
        for j in range(0, N, Bc):
            Kj = K[:, :, j:j+Bc, :]  <span class="code-comment"># åŠ è½½KVå—åˆ°SRAM</span>
            Vj = V[:, :, j:j+Bc, :]
            
            <span class="code-comment"># åœ¨SRAMä¸­è®¡ç®—æ³¨æ„åŠ›</span>
            Sij = torch.matmul(Qi, Kj.transpose(-2, -1)) / sqrt(d)
            
            <span class="code-comment"># åœ¨çº¿softmaxï¼ˆæ•°å€¼ç¨³å®šï¼‰</span>
            Mi_new = torch.max(Mi, Sij.max(dim=-1)[0])
            Pij = torch.exp(Sij - Mi_new.unsqueeze(-1))
            
            <span class="code-comment"># å¢é‡æ›´æ–°è¾“å‡º</span>
            Li = torch.exp(Mi - Mi_new) * Li + Pij.sum(dim=-1)
            Oi = torch.exp(Mi - Mi_new).unsqueeze(-1) * Oi + torch.matmul(Pij, Vj)
            Mi = Mi_new
        
        <span class="code-comment"># å½’ä¸€åŒ–å¹¶å†™å›HBM</span>
        O[:, :, i:i+Br, :] = Oi / Li.unsqueeze(-1)
    
    return O

<span class="code-comment"># å…³é”®ä¼˜åŒ–ï¼š</span>
<span class="code-comment"># 1. é¿å…å­˜å‚¨nÃ—næ³¨æ„åŠ›çŸ©é˜µ</span>
<span class="code-comment"># 2. åˆ†å—è®¡ç®—ï¼Œæ¯å—éƒ½åœ¨SRAMä¸­</span>
<span class="code-comment"># 3. IOå¤æ‚åº¦ä»O(NÂ²) â†’ O(NÂ²/M)ï¼ŒMæ˜¯SRAMå¤§å°</span></pre>
            </div>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>âœ… ä¼˜åŠ¿</h4>
                    <p>2-4å€é€Ÿåº¦æå‡ï¼ŒO(n)å†…å­˜ï¼Œæ•°å€¼ç¨³å®š</p>
                </div>
                <div class="feature-card">
                    <h4>âš ï¸ åŠ£åŠ¿</h4>
                    <p>éœ€è¦CUDA kernelä¼˜åŒ–ï¼Œå®ç°å¤æ‚</p>
                </div>
                <div class="feature-card">
                    <h4>ğŸ’¡ åº”ç”¨</h4>
                    <p>GPT-4, Claude, Gemini, ç°ä»£å¤§æ¨¡å‹æ ‡é…</p>
                </div>
            </div>
        </div>
        
        <!-- æ€§èƒ½å¯¹æ¯”è¡¨æ ¼ -->
        <div class="attention-type">
            <h2><span class="icon">ğŸ“Š</span> æ€§èƒ½å¯¹æ¯”æ€»ç»“</h2>
            
            <table class="complexity-table">
                <thead>
                    <tr>
                        <th>æ³¨æ„åŠ›æœºåˆ¶</th>
                        <th>æ—¶é—´å¤æ‚åº¦</th>
                        <th>å†…å­˜å¤æ‚åº¦</th>
                        <th>KVç¼“å­˜</th>
                        <th>æœ€é€‚åˆåœºæ™¯</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="highlight">Full Attention</span></td>
                        <td>O(nÂ²d)</td>
                        <td>O(nÂ²)</td>
                        <td>O(nhd)</td>
                        <td>çŸ­åºåˆ—ï¼Œå®Œæ•´å»ºæ¨¡</td>
                    </tr>
                    <tr>
                        <td><span class="highlight">Local Attention</span></td>
                        <td>O(nwd)</td>
                        <td>O(nw)</td>
                        <td>O(nhd)</td>
                        <td>é•¿åºåˆ—ï¼Œå±€éƒ¨ä¾èµ–</td>
                    </tr>
                    <tr>
                        <td><span class="highlight">Linear Attention</span></td>
                        <td>O(ndÂ²)</td>
                        <td>O(nd)</td>
                        <td>O(nhd)</td>
                        <td>è¶…é•¿åºåˆ—</td>
                    </tr>
                    <tr>
                        <td><span class="highlight">GQA</span></td>
                        <td>O(nÂ²d)</td>
                        <td>O(nÂ²)</td>
                        <td>O(n(h/G)d)</td>
                        <td>æ¨ç†ä¼˜åŒ–</td>
                    </tr>
                    <tr>
                        <td><span class="highlight">MQA</span></td>
                        <td>O(nÂ²d)</td>
                        <td>O(nÂ²)</td>
                        <td>O(nd)</td>
                        <td>æé™å†…å­˜ä¼˜åŒ–</td>
                    </tr>
                    <tr>
                        <td><span class="highlight">Flash Attention</span></td>
                        <td>O(nÂ²d)</td>
                        <td>O(n)</td>
                        <td>O(nhd)</td>
                        <td>è®­ç»ƒåŠ é€Ÿ</td>
                    </tr>
                </tbody>
            </table>
            
            <h3 style="margin-top: 40px;">ğŸ” ç‰¹æ€§å¯¹æ¯”</h3>
            <table class="complexity-table">
                <thead>
                    <tr>
                        <th>ç‰¹æ€§</th>
                        <th>Full</th>
                        <th>Sparse</th>
                        <th>Linear</th>
                        <th>GQA</th>
                        <th>MQA</th>
                        <th>Flash</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><b>æ¨¡å‹è´¨é‡</b></td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                    </tr>
                    <tr>
                        <td><b>æ¨ç†é€Ÿåº¦</b></td>
                        <td>â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­â­â­</td>
                    </tr>
                    <tr>
                        <td><b>å†…å­˜æ•ˆç‡</b></td>
                        <td>â­</td>
                        <td>â­â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                    </tr>
                    <tr>
                        <td><b>é•¿åºåˆ—æ”¯æŒ</b></td>
                        <td>â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­</td>
                        <td>â­â­</td>
                        <td>â­â­â­</td>
                    </tr>
                    <tr>
                        <td><b>å®ç°éš¾åº¦</b></td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                        <td>â­</td>
                    </tr>
                    <tr>
                        <td><b>ä¸»æµé‡‡ç”¨åº¦</b></td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­â­</td>
                        <td>â­â­</td>
                        <td>â­â­â­â­â­</td>
                        <td>â­â­â­â­</td>
                        <td>â­â­â­â­â­</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 10px;">
                <h3>ğŸ’¡ é€‰æ‹©å»ºè®®</h3>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li><b>è®­ç»ƒé˜¶æ®µï¼š</b>Flash Attention + Full Attentionï¼ˆé€Ÿåº¦ä¸ç²¾åº¦å¹¶é‡ï¼‰</li>
                    <li><b>æ¨ç†ä¼˜åŒ–ï¼š</b>GQAï¼ˆLlamaç³»åˆ—ï¼‰æˆ–MQAï¼ˆPaLMç³»åˆ—ï¼‰å‡å°‘KVç¼“å­˜</li>
                    <li><b>ä¸­ç­‰æ–‡æœ¬ï¼ˆ1K-8Kï¼‰ï¼š</b>Local Attentionï¼ˆLongformerï¼‰æˆ–ç¨€ç–æ¨¡å¼</li>
                    <li><b>é•¿æ–‡æœ¬ï¼ˆ8K-32Kï¼‰ï¼š</b>å—ç¨€ç–ï¼ˆBigBirdï¼‰æˆ–æ··åˆæ³¨æ„åŠ›</li>
                    <li><b>è¶…é•¿æ–‡æœ¬ï¼ˆ>32Kï¼‰ï¼š</b>Linear Attentionï¼ˆPerformerï¼‰æˆ–Linformer</li>
                    <li><b>è¾¹ç¼˜è®¾å¤‡ï¼š</b>MQA + é‡åŒ– + Flash Attentionç»„åˆ</li>
                    <li><b>å®æ—¶æœåŠ¡ï¼š</b>GQAï¼ˆ4ä¸ªKVå¤´ï¼‰+ Flash Attention v2</li>
                </ul>
                
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                    <h4 style="color: #856404;">ğŸ¯ å®è·µç»éªŒ</h4>
                    <ul style="margin-left: 20px; line-height: 1.8; color: #856404;">
                        <li>ä¸åŒå±‚å¯ä»¥ä½¿ç”¨ä¸åŒæ³¨æ„åŠ›ï¼šåº•å±‚Localï¼Œä¸­å±‚Sparseï¼Œé¡¶å±‚Full</li>
                        <li>Flash Attentionå·²æˆä¸ºè®­ç»ƒæ ‡é…ï¼Œå‡ ä¹æ— éœ€æƒè¡¡</li>
                        <li>GQAæ˜¯ç›®å‰æœ€å¹³è¡¡çš„é€‰æ‹©ï¼ˆLlama 2/3é‡‡ç”¨ï¼‰</li>
                        <li>çº¿æ€§æ³¨æ„åŠ›è™½ç„¶å¿«ä½†ç²¾åº¦æŸå¤±æ˜æ˜¾ï¼Œè°¨æ…ä½¿ç”¨</li>
                        <li>æ ¹æ®ç¡¬ä»¶é€‰æ‹©ï¼šA100/H100ç”¨Flashï¼Œæ¶ˆè´¹çº§GPUç”¨GQA/MQA</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
